import{k as e,l as t,u as r,V as n,w as s,e as o,i,j as a,b as c}from"./index-DSODixev.js";import{e as u,r as l,h as d}from"./react-vendor-rw3WIpbI.js";import{p as f,V as m}from"./VirtualizedProfileColumn-DmUCIHyG.js";import{L as p}from"./Layout-BEHB3xN1.js";import{u as h}from"./ModalScrollContext-B4LhHMrN.js";import{s as g}from"./TagPage.module-BpGvzkuE.js";import"./atproto-JNpM3I1p.js";import"./virtual-SmD9oKU4.js";import"./PostCard-C-ger2IZ.js";import"./PostActionsMenu-DZOqguUL.js";import"./date-Ct-NsrQr.js";import"./artboards-DNvSVVrd.js";import"./artboardsPds-DWUixJ9h.js";import"./PostText-C5AD0Pm1.js";import"./postCache-CTqU0alO.js";import"./Icons-Kc82ZfZx.js";function w(e){return{post:e}}function v(e){const t=o(e.post);return t?null!=t.aspectRatio&&t.aspectRatio>0?100+280/t.aspectRatio:320:180}function j(e,t){if(t<1)return[];const r=Array.from({length:t},()=>[]),n=Array(t).fill(0);for(let s=0;s<e.length;s++){const o=e[s],i=v(o),a=r.map(e=>e.length),c=0===a.length?0:Math.min(...a);let u=-1;for(let e=0;e<t;e++)r[e].length>c+1||(-1===u||n[e]<n[u]||n[e]===n[u]&&r[e].length<r[u].length)&&(u=e);-1===u&&(u=0),r[u].push({item:o,originalIndex:s}),n[u]+=i}return r}function x({tag:d,inModal:p=!1,onRegisterRefresh:v}){const x=u(),{session:y}=e(),{viewMode:R}=t(),{isModalOpen:k,openPostModal:M}=r(),[b,A]=l.useState([]),[E,N]=l.useState(),[C,L]=l.useState(!0),[S,I]=l.useState(!1),[P,U]=l.useState(null),[O,T]=l.useState(0),[F,$]=l.useState(!1),[D,V]=l.useState({}),z=l.useRef([]),K=l.useRef(null),q=l.useRef([]),B=l.useRef(!1),H=l.useRef(0),X=l.useRef([]),Y=l.useRef(!1),G=l.useRef(-1),J=h(),Q=l.useRef(null),[W,Z]=l.useState(0),_=l.useCallback(async e=>{if(d)try{e?I(!0):L(!0),U(null);const{posts:t,cursor:r}=await n(d,e),s=t.map(w);A(t=>e?[...t,...s]:s),N(r)}catch(t){U(t instanceof Error?t.message:"Failed to load tag")}finally{L(!1),I(!1)}},[d]);l.useEffect(()=>{d&&(A([]),N(void 0),_())},[d,_]),l.useEffect(()=>{v?.(()=>_())},[v,_]);const{nsfwPreference:ee,unblurredUris:te,setUnblurred:re}=s(),ne=b.filter(e=>o(e.post)).filter(e=>"sfw"!==ee||!i(e.post)),se="1"===R?1:"2"===R?2:3;return X.current=ne,H.current=O,l.useLayoutEffect(()=>{if(p||!Q.current)return;const e=Q.current,t=()=>Z(e.getBoundingClientRect().top+window.scrollY);t();const r=new ResizeObserver(t);return r.observe(e),()=>r.disconnect()},[p,ne.length]),B.current=S,l.useEffect(()=>{if(!E)return;const e=se,t=e>=2?q.current[0]:K.current;if(!t)return;const r=new IntersectionObserver(e=>{e[0]?.isIntersecting&&!B.current&&(B.current=!0,_(E))},{rootMargin:"600px",threshold:0});if(r.observe(t),e>=2){const t=q.current;for(let n=1;n<e;n++){const e=t[n];e&&r.observe(e)}}return()=>r.disconnect()},[E,_,se]),l.useEffect(()=>{T(e=>ne.length?Math.min(e,ne.length-1):0)},[ne.length]),l.useEffect(()=>{if(!Y.current)return;if(Y.current=!1,O===G.current)return;G.current=O;const e=O,t=requestAnimationFrame(()=>{const t=z.current[e];t&&t.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})});return()=>cancelAnimationFrame(t)},[O]),l.useEffect(()=>{const e=e=>{if(!p&&k)return;const t=e.target;if("INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName||t.isContentEditable)return void("Escape"===e.key&&(e.preventDefault(),t.blur()));if(e.ctrlKey||e.metaKey)return;if(0===ne.length)return;const r=X.current,n=H.current,s=e.key.toLowerCase();if("w"!==s&&"s"!==s&&"a"!==s&&"d"!==s&&"e"!==s&&"enter"!==s&&"f"!==s&&"c"!==s&&"ArrowUp"!==e.key&&"ArrowDown"!==e.key&&"ArrowLeft"!==e.key&&"ArrowRight"!==e.key||e.preventDefault(),"w"===s||"ArrowUp"===e.key)return Y.current=!0,void T(e=>Math.max(0,e-se));if("s"===s||"ArrowDown"===e.key)return Y.current=!0,void T(e=>Math.min(r.length-1,e+se));if("a"===s||"ArrowLeft"===e.key)return Y.current=!0,void T(e=>Math.max(0,e-1));if("d"===s||"ArrowRight"===e.key)return Y.current=!0,void T(e=>Math.min(r.length-1,e+1));if("e"===s||"enter"===s){const e=r[n];return void(e&&(p?M(e.post.uri):x(`/post/${encodeURIComponent(e.post.uri)}`)))}if("f"===s&&y){const e=r[n];if(!e?.post?.uri||!e?.post?.cid)return;const t=e.post.uri,s=t in D?D[t]??void 0:e.post.viewer?.like;return void(s?c.deleteLike(s).then(()=>{V(e=>({...e,[t]:null}))}).catch(()=>{}):c.like(t,e.post.cid).then(e=>{V(r=>({...r,[t]:e.uri}))}).catch(()=>{}))}"c"===s&&$(!0)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[ne.length,se,x,k,p,M,D,y]),d?a.jsxs("div",{className:g.wrap,children:[a.jsx("header",{className:g.header,children:a.jsxs("h2",{className:g.title,children:["#",d]})}),P&&a.jsx("p",{className:g.error,children:P}),C?a.jsx("div",{className:g.loading,children:"Loading…"}):0===ne.length?a.jsx("div",{className:g.empty,children:"No posts with images or videos for this tag."}):a.jsxs(a.Fragment,{children:[a.jsx("div",{ref:Q,className:`${f.gridColumns} ${f[`gridView${R}`]}`,"data-view-mode":R,children:j(ne,se).map((e,t)=>a.jsx(m,{column:e,colIndex:t,scrollMargin:W,scrollRef:p?J:null,loadMoreSentinelRef:E?e=>{se>=2?q.current[t]=e:K.current=e}:void 0,hasCursor:!!E,keyboardFocusIndex:O,keyboardAddOpen:F,actionsMenuOpenForIndex:null,nsfwPreference:ee,unblurredUris:te,setUnblurred:re,likeOverrides:D,setLikeOverrides:V,openPostModal:p?M:e=>x(`/post/${encodeURIComponent(e)}`),cardRef:e=>t=>{z.current[e]=t},onActionsMenuOpenChange:()=>{},onMouseEnter:e=>T(e),onAddClose:()=>$(!1),constrainMediaHeight:1===se,isSelected:e=>e===O},t))}),S&&a.jsx("div",{className:f.loadingMore,children:"Loading…"})]})]}):null}function y(){const{tag:e}=d(),t=e?decodeURIComponent(e):"";return t?a.jsx(p,{title:`#${t}`,showNav:!0,children:a.jsx(x,{tag:t})}):a.jsx(p,{title:"Tag",showNav:!0,children:a.jsx("div",{className:g.wrap,children:a.jsx("p",{className:g.empty,children:"No tag specified."})})})}export{x as TagContent,y as default};
