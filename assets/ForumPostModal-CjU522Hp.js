import{k as e,z as s,W as a,X as t,j as l,Y as n,Z as r,_ as i,$ as c,b as o,a0 as d,a1 as u,a2 as m}from"./index-C92fSBT1.js";import{b as p,L as h}from"./react-vendor-DGaPsC2e.js";import{A as f}from"./AppModal-DGJJoDV2.js";import{u as x}from"./useListKeyboardNav-3q-0e0hq.js";import{a as y,b}from"./PostActionsMenu-B3ZLjaQs.js";import{a as j,P as g}from"./PostText-4SKFSD3X.js";import{C as v}from"./Layout-CULUiZuc.js";import{R as _,g as N}from"./PostDetailPage-CWyy07l3.js";import{p as k}from"./PostDetailPage.module-TDaRGCAY.js";import{g as C,b as w,p as S,d as R,e as A,f as E}from"./forum-BIzz4ecR.js";import"./atproto-3-1TCh3S.js";import"./ModalTopBarSlotContext-XWKZv5-E.js";import"./ModalScrollContext-BMSdggb0.js";import"./usePullToRefresh-DVlCPYCP.js";import"./Icons-BCPupX3c.js";import"./postCache-CTqU0alO.js";import"./artboards-DNvSVVrd.js";const P="_wrap_lbd08_1",T="_loading_lbd08_6",F="_error_lbd08_12",L="_avatarPlaceholder_lbd08_18",D="_docTitle_lbd08_32",U="_docBody_lbd08_39",B="_docMedia_lbd08_46",I="_docMediaImg_lbd08_53",M="_docLink_lbd08_62",$="_externalLink_lbd08_67",H="_actions_lbd08_76",W="_actionBtn_lbd08_84",z="_actionBtnPrimary_lbd08_85",K="_actionBtnDanger_lbd08_86",q="_deleteConfirmText_lbd08_123",O="_editForm_lbd08_129",V="_editLabel_lbd08_133",Y="_editInput_lbd08_140",G="_editTextarea_lbd08_153",Z="_mediaDropZone_lbd08_174",X="_mediaInputHidden_lbd08_192",J="_addMediaBtn_lbd08_200",Q="_mediaDropHint_lbd08_215",ee="_mediaPreviews_lbd08_220",se="_mediaPreviewWrap_lbd08_228",ae="_mediaPreviewImg_lbd08_233",te="_mediaPreviewRemove_lbd08_243",le="_editActions_lbd08_267",ne="_replySection_lbd08_273",re="_replyFormWrap_lbd08_279",ie="_replySectionTitle_lbd08_289",ce="_replyToBtn_lbd08_328",oe="_commentBadge_lbd08_343",de="_replyForm_lbd08_279",ue="_replyTextarea_lbd08_356",me="_replySubmit_lbd08_375",pe="_repliesSection_lbd08_396",he="_replyList_lbd08_402",fe="_replyItem_lbd08_411",xe="_replyItemNested_lbd08_431",ye="_replyText_lbd08_356",be="_replyItemActions_lbd08_442",je="_viewPostLink_lbd08_449",ge="_likeBtn_lbd08_459",ve="_likeBtnLiked_lbd08_460",_e="_muted_lbd08_478";function Ne({documentUri:d,onClose:u,onRegisterRefresh:m}){const f=d,[N,C]=p.useState(null),[w,S]=p.useState(!0),[R,A]=p.useState(null),[E,Ne]=p.useState([]),[ke,Ce]=p.useState(!1),[we,Se]=p.useState(""),[Re,Ae]=p.useState(!1),[Ee,Pe]=p.useState(!1),[Te,Fe]=p.useState(""),[Le,De]=p.useState(""),[Ue,Be]=p.useState([]),[Ie,Me]=p.useState([]),[$e,He]=p.useState(!1),We=p.useRef(null),ze=p.useRef(null),Ke=p.useRef(null),qe=p.useRef(null),Oe=p.useRef(null),[Ve,Ye]=p.useState(0),[Ge,Ze]=p.useState(!1),[Xe,Je]=p.useState(!1),[Qe,es]=p.useState(null),[ss,as]=p.useState({}),[ts,ls]=p.useState({}),[ns,rs]=p.useState({handle:""}),{session:is,sessionsList:cs,switchAccount:os}=e(),ds=is?.did??"",us=p.useRef(null),ms=p.useRef(!1),ps=is?.did&&N?.did===is.did,hs=N?function(e){if(!e.baseUrl)return null;const s=e.baseUrl.replace(/\/$/,""),a=(e.path??"").replace(/^\//,"");return a?`${s}/${a}`:s}(N):null,fs=N?.baseUrl?function(e){try{return new URL(e).hostname}catch{return""}}(N.baseUrl):"",xs=p.useMemo(()=>Ie.map(e=>URL.createObjectURL(e)),[Ie]);p.useEffect(()=>()=>xs.forEach(e=>URL.revokeObjectURL(e)),[xs]),p.useEffect(()=>{if(!is?.did)return void rs({handle:""});let e=!1;return s.getProfile({actor:is.did}).then(s=>{if(e)return;const a=s.data;rs({handle:a.handle??is.did,avatar:a.avatar})}).catch(()=>{e||rs({handle:is.handle??is.did})}),()=>{e=!0}},[is?.did]),p.useEffect(()=>{if(!Qe)return;const e=requestAnimationFrame(()=>{us.current?.focus()});return()=>cancelAnimationFrame(e)},[Qe]);const ys=p.useCallback(async()=>{if(!f)return;S(!0),A(null);let e=!1;try{const s=await a(f);if(s)ms.current=!1,C(s),Fe(s.title??""),De(s.body??""),Be(s.mediaRefs??[]),Me([]);else{if(!ms.current&&f.startsWith("at://"))return ms.current=!0,e=!0,void setTimeout(()=>ys(),600);A("Post not found or not a blog post.")}}catch(s){A(s instanceof Error?s.message:"Failed to load post")}finally{e||S(!1)}},[f]),bs=p.useCallback(async()=>{if(f&&fs){Ce(!0);try{const e=await t(f,fs,hs);Ne(e)}catch{Ne([])}finally{Ce(!1)}}},[f,fs,hs]),js=p.useMemo(()=>N?function(e){const s=[];return function e(a,t){for(const l of a)s.push({reply:l.reply,depth:t}),e(l.children,t+1)}(e,0),s}(function(e,s){const a=new Map;for(const l of e){const e=l.replyTo??s;a.has(e)||a.set(e,[]),a.get(e).push(l)}const t=(e,s)=>new Date(e.record?.createdAt??0).getTime()-new Date(s.record?.createdAt??0).getTime();return function e(s){return(a.get(s)??[]).slice().sort(t).map(s=>({reply:s,children:e(s.uri)}))}(s)}(E,N.uri)):[],[E,N?.uri]);p.useEffect(()=>{ms.current=!1,C(null),ys()},[ys]),p.useEffect(()=>{if(!f)return;const e=()=>{"visible"===document.visibilityState&&ys()};return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)},[f,ys]),p.useEffect(()=>{N&&bs()},[N,bs]),p.useEffect(()=>{m?.(()=>ys())},[m,ys]);const gs=1+js.length+(is?1:0),vs=p.useCallback(e=>{if(0===e)requestAnimationFrame(()=>{Ke.current?.focus(),Ke.current?.scrollIntoView({behavior:"smooth",block:"nearest"})});else if(e<=js.length){const s=e-1,a=Oe.current?.querySelectorAll("[data-forum-reply-index]")?.[s];a&&requestAnimationFrame(()=>{a.focus(),a.scrollIntoView({behavior:"smooth",block:"nearest"})})}else requestAnimationFrame(()=>{qe.current?.focus(),qe.current?.scrollIntoView({behavior:"smooth",block:"nearest"})})},[js.length]);async function _s(e){if(e.preventDefault(),is&&N&&we.trim()&&!Re){Ae(!0);try{await c(N.uri,we.trim(),Qe?.uri),Se(""),es(null),await bs()}catch(s){alert(s instanceof Error?s.message:"Failed to post")}finally{Ae(!1)}}}async function Ns(){if(N&&f&&!$e){He(!0);try{let e=[...Ue];if(Ie.length>0){const s=await Promise.all(Ie.map(e=>r(e)));e=[...e,...s]}const s=await i(f,{title:Te,body:Le.trim(),media:e});C(s),Be(s.mediaRefs??[]),Me([]),Pe(!1)}catch(e){alert(e instanceof Error?e.message:"Failed to save")}finally{He(!1)}}}return p.useEffect(()=>{N&&Ye(0)},[f]),p.useEffect(()=>{gs<=0||Ye(e=>Math.min(Math.max(0,e),gs-1))},[gs]),p.useEffect(()=>{gs<=0||vs(Ve)},[Ve,gs,vs]),x({enabled:!!N&&gs>0,itemCount:gs,focusedIndex:Ve,setFocusedIndex:Ye,onActivate:vs,useCapture:!1}),f?l.jsxs("div",{className:P,children:[w&&l.jsx("div",{className:T,children:"Loading…"}),R&&l.jsx("p",{className:F,children:R}),N&&!w&&l.jsxs(l.Fragment,{children:[l.jsx("article",{ref:Ke,tabIndex:-1,className:`${k.postBlock} ${k.rootPostBlock}`,onFocus:()=>Ye(0),onMouseEnter:()=>Ye(0),children:l.jsxs("div",{className:k.postBlockContent,children:[l.jsxs("div",{className:k.postHead,children:[N.authorAvatar?l.jsx("img",{src:N.authorAvatar,alt:"",className:k.avatar,loading:"lazy"}):l.jsx("span",{className:L,"aria-hidden":!0,children:(N.authorHandle??N.did).slice(0,1).toUpperCase()}),l.jsxs("div",{className:k.authorRow,children:[l.jsxs(j,{handle:N.authorHandle??N.did,className:k.handleLink,children:["@",N.authorHandle??N.did]}),N.createdAt&&l.jsx("span",{className:k.postTimestamp,title:b(N.createdAt),children:y(N.createdAt)})]})]}),Ee?l.jsxs("div",{className:O,onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),$e||Ns())},children:[l.jsxs("label",{className:V,children:["Title",l.jsx("input",{type:"text",className:Y,value:Te,onChange:e=>Fe(e.target.value),placeholder:"Title"})]}),l.jsxs("label",{className:V,children:["Body",l.jsx("textarea",{className:G,value:Le,onChange:e=>De(e.target.value),placeholder:"Write your post…",rows:8})]}),l.jsxs("div",{className:V,children:["Media",l.jsxs("div",{className:Z,onDrop:function(e){e.preventDefault();const s=e.dataTransfer.files;if(!s?.length)return;const a=["image/jpeg","image/png","image/gif","image/webp"],t=Array.from(s).filter(e=>a.includes(e.type)).slice(0,4-Ue.length-Ie.length);Me(e=>[...e,...t].slice(0,4-Ue.length))},onDragOver:function(e){e.preventDefault(),e.dataTransfer.dropEffect="copy"},children:[l.jsx("input",{ref:We,id:"forum-edit-media-input",type:"file",accept:"image/jpeg,image/png,image/gif,image/webp",multiple:!0,className:X,onChange:function(e){const s=e.target.files;if(!s?.length)return;const a=["image/jpeg","image/png","image/gif","image/webp"],t=Array.from(s).filter(e=>a.includes(e.type)).slice(0,4-Ue.length-Ie.length);Me(e=>[...e,...t].slice(0,4-Ue.length)),e.target.value=""}}),l.jsx("button",{type:"button",className:J,onClick:function(){We.current?.click()},children:"Add image"}),l.jsx("span",{className:Q,children:"or drag and drop images here"}),Ue.length+Ie.length>0&&l.jsxs("div",{className:ee,children:[N.media?.slice(0,Ue.length).map((e,s)=>l.jsxs("div",{className:se,children:[l.jsx("img",{src:e.url,alt:"",className:ae,loading:"lazy"}),l.jsx("button",{type:"button",className:te,onClick:()=>{return e=s,void Be(s=>s.filter((s,a)=>a!==e));var e},"aria-label":"Remove",children:"×"})]},`existing-${s}`)),Ie.map((e,s)=>l.jsxs("div",{className:se,children:[l.jsx("img",{src:xs[s],alt:"",className:ae,loading:"lazy"}),l.jsx("button",{type:"button",className:te,onClick:()=>{return e=s,void Me(s=>s.filter((s,a)=>a!==e));var e},"aria-label":"Remove",children:"×"})]},`new-${s}`))]})]})]}),l.jsxs("div",{className:le,children:[l.jsx("button",{type:"button",className:W,onClick:()=>Pe(!1),disabled:$e,children:"Cancel"}),l.jsx("button",{type:"button",className:z,onClick:Ns,disabled:$e,children:$e?"Saving…":"Save"})]})]}):l.jsxs(l.Fragment,{children:[l.jsx("h1",{className:D,children:N.title||"Untitled"}),N.body&&l.jsx("div",{className:U,children:l.jsx(g,{text:N.body})}),N.media&&N.media.length>0&&l.jsx("div",{className:B,children:N.media.map((e,s)=>l.jsx("img",{src:e.url,alt:"",className:I,loading:"lazy"},s))}),hs&&l.jsx("p",{className:M,children:l.jsx("a",{href:hs,target:"_blank",rel:"noopener noreferrer",className:$,children:"Open full post →"})}),ps&&l.jsxs("div",{className:H,children:[l.jsx("button",{type:"button",className:W,onClick:()=>Pe(!0),children:"Edit"}),Ge?l.jsxs(l.Fragment,{children:[l.jsx("span",{className:q,children:"Delete this post?"}),l.jsx("button",{type:"button",className:W,onClick:()=>Ze(!1),disabled:Xe,children:"Cancel"}),l.jsx("button",{type:"button",className:K,onClick:async function(){if(f&&Ge&&!Xe){Je(!0);try{await n(f),u()}catch(e){alert(e instanceof Error?e.message:"Failed to delete")}finally{Je(!1)}}},disabled:Xe,children:Xe?"Deleting…":"Yes, delete"})]}):l.jsx("button",{type:"button",className:K,onClick:()=>Ze(!0),children:"Delete"})]})]})]})}),is&&!Qe&&l.jsx("section",{className:ne,children:l.jsxs("div",{ref:qe,className:re,tabIndex:-1,onFocus:()=>Ye(gs-1),onMouseEnter:()=>Ye(gs-1),children:[l.jsx("h2",{className:ie,children:"Reply"}),l.jsxs("form",{ref:ze,onSubmit:_s,className:de,children:[l.jsx("textarea",{className:ue,value:we,onChange:e=>Se(e.target.value),onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),we.trim()&&!Re&&ze.current?.requestSubmit())},placeholder:"Write a reply…",rows:3,disabled:Re}),l.jsx("button",{type:"submit",className:me,disabled:Re||!we.trim(),children:Re?"Posting…":"Post reply"})]})]})}),l.jsxs("section",{className:pe,children:[l.jsx("h2",{className:ie,children:"Replies & discussion"}),ke?l.jsx("p",{className:_e,children:"Loading…"}):0===js.length?l.jsx("p",{className:_e,children:"No replies yet. Post a reply above or share this post."}):l.jsx("ul",{ref:Oe,className:he,children:js.map(({reply:e,depth:s},a)=>{const t=!!(ts[e.uri]??e.viewer?.like),n=ss[e.uri],r=e.author.handle??e.author.did,i=!0===e.isComment;return l.jsxs("li",{className:s>0?`${fe} ${xe}`:fe,"data-forum-reply-index":a,tabIndex:-1,onFocus:()=>Ye(1+a),onMouseEnter:()=>Ye(1+a),style:{marginLeft:20*s},children:[l.jsxs("div",{className:k.postHead,children:[e.author.avatar?l.jsx("img",{src:e.author.avatar,alt:"",className:k.avatar,loading:"lazy"}):l.jsx("span",{className:L,"aria-hidden":!0,children:r.slice(0,1).toUpperCase()}),l.jsxs("div",{className:k.authorRow,children:[l.jsxs(j,{handle:r,className:k.handleLink,children:["@",r]}),i&&l.jsx("span",{className:oe,children:"standard.site comment"}),e.record?.createdAt&&l.jsx("span",{className:k.postTimestamp,title:b(e.record.createdAt),children:y(e.record.createdAt)})]})]}),e.record?.text&&l.jsx("div",{className:ye,children:l.jsx(g,{text:e.record.text,facets:e.isComment?void 0:e.record.facets})}),l.jsxs("div",{className:be,children:[is&&l.jsx("button",{type:"button",className:ce,onClick:()=>{es(e)},children:"Reply"}),!i&&l.jsx(h,{to:`/post/${encodeURIComponent(e.uri)}`,className:je,children:"View post"}),is&&!i&&l.jsxs("button",{type:"button",className:t?ve:ge,onClick:()=>async function(e){if(e.isComment)return;const s=ts[e.uri]??e.viewer?.like,a=!!s;as(s=>({...s,[e.uri]:!0}));try{if(a)await o.deleteLike(s),ls(s=>{const a={...s};return delete a[e.uri],a});else{const s=await o.like(e.uri,e.cid);ls(a=>({...a,[e.uri]:s.uri}))}await bs()}catch{}finally{as(s=>({...s,[e.uri]:!1}))}}(e),disabled:n,title:t?"Remove like":"Like",children:["♥ ",e.likeCount??0]})]}),is&&Qe?.uri===e.uri&&l.jsx("div",{className:k.inlineReplyFormWrap,children:l.jsxs("form",{onSubmit:_s,className:k.inlineReplyForm,children:[l.jsxs("div",{className:k.inlineReplyFormHeader,children:[l.jsx("button",{type:"button",className:k.cancelReply,onClick:()=>es(null),"aria-label":"Cancel reply",children:"×"}),ns.handle&&cs?.length&&ds?l.jsx(_,{replyAs:ns,sessionsList:cs,switchAccount:os,currentDid:ds}):l.jsxs("p",{className:k.replyAs,children:[l.jsx("span",{className:k.replyAsLabel,children:"Replying as"}),l.jsxs("span",{className:k.replyAsUserChip,children:[ns.avatar?l.jsx("img",{src:ns.avatar,alt:"",className:k.replyAsAvatar,loading:"lazy"}):l.jsx("span",{className:k.replyAsAvatarPlaceholder,"aria-hidden":!0,children:ns.handle.slice(0,1).toUpperCase()}),l.jsxs("span",{className:k.replyAsHandle,children:["@",ns.handle]})]})]})]}),l.jsx(v,{inputRef:us,placeholder:`Reply to @${r}…`,value:we,onChange:Se,onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),we.trim()&&!Re&&e.target.form?.requestSubmit())},className:k.textarea,rows:2,maxLength:300}),l.jsx("p",{className:k.hint,children:"⌘ Enter or ⌘ E to post"}),l.jsx("button",{type:"submit",className:k.submit,disabled:Re||!we.trim(),children:Re?"Posting…":"Post reply"})]})})]},e.uri)})})]})]})]}):(u(),null)}function ke({documentUri:s,onClose:a,onRegisterRefresh:t}){const[n,r]=p.useState(null),[i,c]=p.useState([]),[o,h]=p.useState(!0),[f,x]=p.useState(null),[v,_]=p.useState(""),[B,I]=p.useState(!1),[M,$]=p.useState(null),[Z,X]=p.useState(!1),[J,Q]=p.useState(""),[ee,se]=p.useState("");p.useEffect(()=>{n&&(Q(n.title??""),se(n.body??""))},[n]);const[ae,te]=p.useState(!1),[re,be]=p.useState(!1),[je,Ne]=p.useState(!1),[ke,Ce]=p.useState({}),[we,Se]=p.useState({}),{session:Re}=e(),Ae=p.useCallback(async()=>{if(s){h(!0),x(null);try{const[e,a]=await Promise.all([C(s),w(s,Re?.did?[Re.did]:[])]);if(r(e),c(a),Re?.did){const e=await d();Ce(e)}const t=e?.uri?[e.uri]:[];if(a.forEach(e=>t.push(e.uri)),t.length>0){const e=await N(t);Se(e)}}catch(e){x(e instanceof Error?e.message:"Failed to load post")}finally{h(!1)}}},[s,Re?.did]);async function Ee(e){if(e.preventDefault(),Re&&n&&v.trim()&&!B){I(!0);try{await E({postUri:s,text:v.trim(),replyToUri:M?.uri}),_(""),$(null);const e=await w(s,[Re.did]);c(e)}catch(a){alert(a instanceof Error?a.message:"Failed to post")}finally{I(!1)}}}async function Pe(e,s){if(Re)try{const a=await m(e,s);Ce(s=>({...s,[e]:a})),Se(s=>({...s,[e]:(s[e]??0)+1}))}catch{}}async function Te(e){if(Re)try{await u(e);const s=Object.entries(ke).find(([,s])=>s===e)?.[0];s&&(Ce(e=>{const a={...e};return delete a[s],a}),Se(e=>({...e,[s]:Math.max(0,(e[s]??0)-1)})))}catch{}}if(p.useEffect(()=>{Ae()},[Ae]),p.useEffect(()=>{t?.(()=>Ae())},[t,Ae]),!s||!s.includes("app.artsky.forum.post"))return null;if(o)return l.jsx("div",{className:T,children:"Loading…"});if(f||!n)return l.jsx("p",{className:F,children:f??"Post not found"});const Fe=Re?.did===n.did,Le=we[n.uri]??0,De=!!ke[n.uri],Ue=function(e){const s=[];return function e(a,t){for(const l of a)s.push({reply:l.reply,depth:t}),e(l.children,t+1)}(e,0),s}(function(e,s){const a=new Map;for(const l of e){const e=l.replyTo??s;a.has(e)||a.set(e,[]),a.get(e).push(l)}const t=(e,s)=>new Date(e.record?.createdAt??0).getTime()-new Date(s.record?.createdAt??0).getTime();return function e(s){return(a.get(s)??[]).slice().sort(t).map(s=>({reply:s,children:e(s.uri)}))}(s)}(i,s));return l.jsxs("div",{className:P,children:[l.jsx("article",{className:`${k.postBlock} ${k.rootPostBlock}`,children:l.jsxs("div",{className:k.postBlockContent,children:[l.jsxs("div",{style:{display:"flex",gap:"var(--space-sm)",marginBottom:"var(--space-sm)"},children:[n.isPinned&&l.jsx("span",{className:oe,children:"Pinned"}),n.isWiki&&l.jsx("span",{className:oe,children:"Wiki"})]}),l.jsxs("div",{className:k.postHead,children:[n.authorAvatar?l.jsx("img",{src:n.authorAvatar,alt:"",className:k.avatar,loading:"lazy"}):l.jsx("span",{className:L,"aria-hidden":!0,children:(n.authorHandle??n.did).slice(0,1).toUpperCase()}),l.jsxs("div",{className:k.authorRow,children:[l.jsxs(j,{handle:n.authorHandle??n.did,className:k.handleLink,children:["@",n.authorHandle??n.did]}),n.createdAt&&l.jsx("span",{className:k.postTimestamp,title:b(n.createdAt),children:y(n.createdAt)})]})]}),Z?l.jsxs("div",{className:O,children:[l.jsxs("label",{className:V,children:["Title",l.jsx("input",{type:"text",className:Y,value:J,onChange:e=>Q(e.target.value),placeholder:"Title"})]}),l.jsxs("label",{className:V,children:["Body",l.jsx("textarea",{className:G,value:ee,onChange:e=>se(e.target.value),placeholder:"Write your post…",rows:8})]}),l.jsxs("div",{className:le,children:[l.jsx("button",{type:"button",className:W,onClick:()=>X(!1),disabled:ae,children:"Cancel"}),l.jsx("button",{type:"button",className:z,onClick:async function(){if(n&&!ae){te(!0);try{await A(s,{title:J,body:ee});const e=await C(s);r(e),X(!1)}catch(e){alert(e instanceof Error?e.message:"Failed to save")}finally{te(!1)}}},disabled:ae,children:ae?"Saving…":"Save"})]})]}):l.jsxs(l.Fragment,{children:[l.jsx("h1",{className:D,children:n.title||"Untitled"}),n.body&&l.jsx("div",{className:U,children:l.jsx(g,{text:n.body})}),n.tags&&n.tags.length>0&&l.jsx("div",{style:{display:"flex",gap:"var(--space-xs)",marginTop:"var(--space-md)",flexWrap:"wrap"},children:n.tags.map(e=>l.jsxs("span",{className:oe,children:["#",e]},e))}),l.jsxs("div",{style:{display:"flex",gap:"var(--space-sm)",marginTop:"var(--space-md)",alignItems:"center"},children:[l.jsxs("button",{type:"button",className:De?ve:ge,onClick:()=>De?Te(ke[n.uri]):Pe(n.uri,n.cid),disabled:!Re,title:De?"Remove downvote":"Downvote",children:["↓ ",Le]}),l.jsxs("span",{style:{fontSize:"var(--font-sm)",color:"var(--muted)"},children:[i.length," repl",1===i.length?"y":"ies"]})]}),Fe&&l.jsxs("div",{className:H,style:{marginTop:"var(--space-md)"},children:[l.jsx("button",{type:"button",className:W,onClick:()=>X(!0),children:"Edit"}),!n.isWiki&&l.jsx("button",{type:"button",className:W,onClick:async function(){if(n)try{await S(s);const e=await C(s);r(e)}catch(e){alert(e instanceof Error?e.message:"Failed to promote")}},children:"Promote to Wiki"}),re?l.jsxs(l.Fragment,{children:[l.jsx("span",{className:q,children:"Delete this post?"}),l.jsx("button",{type:"button",className:W,onClick:()=>be(!1),disabled:je,children:"Cancel"}),l.jsx("button",{type:"button",className:K,onClick:async function(){if(re&&!je){Ne(!0);try{await R(s),a()}catch(e){alert(e instanceof Error?e.message:"Failed to delete")}finally{Ne(!1)}}},disabled:je,children:je?"Deleting…":"Yes, delete"})]}):l.jsx("button",{type:"button",className:K,onClick:()=>be(!0),children:"Delete"})]})]})]})}),Re&&!M&&l.jsxs("section",{className:ne,children:[l.jsx("h2",{className:ie,children:"Reply"}),l.jsxs("form",{onSubmit:Ee,className:de,children:[l.jsx("textarea",{className:ue,value:v,onChange:e=>_(e.target.value),placeholder:"Write a reply… Use @username for mentions",rows:3,disabled:B}),l.jsx("button",{type:"submit",className:me,disabled:B||!v.trim(),children:B?"Posting…":"Post reply"})]})]}),l.jsxs("section",{className:pe,children:[l.jsxs("h2",{className:ie,children:["Replies (",i.length,")"]}),0===Ue.length?l.jsx("p",{className:_e,children:"No replies yet."}):l.jsx("ul",{className:he,children:Ue.map(({reply:e,depth:s})=>{const a=we[e.uri]??0,t=!!ke[e.uri],n=e.author.handle??e.author.did;return l.jsxs("li",{className:s>0?`${fe} ${xe}`:fe,style:{marginLeft:20*s},children:[l.jsxs("div",{className:k.postHead,children:[e.author.avatar?l.jsx("img",{src:e.author.avatar,alt:"",className:k.avatar,loading:"lazy"}):l.jsx("span",{className:L,"aria-hidden":!0,children:n.slice(0,1).toUpperCase()}),l.jsxs("div",{className:k.authorRow,children:[l.jsxs(j,{handle:n,className:k.handleLink,children:["@",n]}),e.record?.createdAt&&l.jsx("span",{className:k.postTimestamp,title:b(e.record.createdAt),children:y(e.record.createdAt)})]})]}),e.record?.text&&l.jsx("div",{className:ye,children:l.jsx(g,{text:e.record.text})}),l.jsxs("div",{style:{display:"flex",gap:"var(--space-sm)",alignItems:"center",marginTop:"var(--space-xs)"},children:[Re&&l.jsx("button",{type:"button",className:ce,onClick:()=>$(e),children:"Reply"}),Re&&l.jsxs("button",{type:"button",className:t?ve:ge,onClick:()=>t?Te(ke[e.uri]):Pe(e.uri,e.cid),title:t?"Remove downvote":"Downvote",children:["↓ ",a]})]}),Re&&M?.uri===e.uri&&l.jsx("div",{style:{marginTop:"var(--space-sm)"},children:l.jsxs("form",{onSubmit:Ee,className:de,children:[l.jsx("textarea",{className:ue,value:v,onChange:e=>_(e.target.value),placeholder:`Reply to @${n}…`,rows:2,disabled:B,autoFocus:!0}),l.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginTop:"0.35rem"},children:[l.jsx("button",{type:"button",className:W,onClick:()=>$(null),children:"Cancel"}),l.jsx("button",{type:"submit",className:z,disabled:B||!v.trim(),children:B?"Posting…":"Post reply"})]})]})})]},e.uri)})})]})]})}function Ce({documentUri:e,onClose:s,onBack:a,canGoBack:t}){const[n,r]=p.useState(null),i=e.includes("app.artsky.forum.post");return l.jsx(f,{ariaLabel:"Forum post",onClose:s,onBack:a,canGoBack:t,onPullToRefresh:n?()=>n():void 0,children:i?l.jsx(ke,{documentUri:e,onClose:s,onRegisterRefresh:e=>r(()=>e)}):l.jsx(Ne,{documentUri:e,onClose:s,onRegisterRefresh:e=>r(()=>e)})})}export{Ce as default};
