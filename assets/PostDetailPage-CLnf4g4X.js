import{j as e,u as t,g as s,k as o,b as n,D as a,a5 as r,a2 as i,a6 as l,a7 as c,a8 as d,a9 as u,a3 as m,a4 as p,aa as h,ab as f}from"./index-ynHOX9ls.js";import{b as x,d as v,f as y,u as j}from"./react-vendor-DGaPsC2e.js";import{takeInitialPostForUri as g,getCachedThread as N}from"./postCache-CTqU0alO.js";import{g as b,i as w,c as C,a as A}from"./artboards-DNvSVVrd.js";import{a as k,b as P}from"./date-Ct-NsrQr.js";import{C as R,a as q,L}from"./Layout-Bn9U8ZeW.js";import{a as S,P as E}from"./PostText-s8DIV7Si.js";import{l as D,P as I}from"./PostActionsMenu-DNJAQgri.js";import{p as U}from"./PostDetailPage.module-D4C8450G.js";async function M(e){const t=new URLSearchParams({target:e,collection:"app.artsky.feed.downvote",path:".subject.uri"});try{const e=await fetch(`https://constellation.microcosm.blue/links/count/distinct-dids?${t}`,{headers:{Accept:"application/json"}});if(!e.ok)return 0;const s=await e.json();return"number"==typeof s.total?s.total:0}catch{return 0}}async function F(e){const t=[...new Set(e)],s=await Promise.all(t.map(async e=>({uri:e,count:await M(e)}))),o={};for(const{uri:n,count:a}of s)o[n]=a;return o}function T({playlistUrl:t,poster:s,className:o,controls:n=!0,playsInline:a=!0,preload:r="metadata",autoPlay:i=!1,controlsHiddenUntilTap:l=!1}){const c=x.useRef(null),[d,u]=x.useState(!l),m=l?d:n;return x.useEffect(()=>{if(!t||!c.current)return;const e=c.current;let s;var o;return/\.m3u8(\?|$)/i.test(o=t)||o.includes("m3u8")?D().then(o=>{if(c.current)if(o.isSupported()){const n=new o;n.loadSource(t),n.attachMedia(e),n.on(o.Events.ERROR,()=>{}),s=()=>{n.destroy()}}else e.canPlayType("application/vnd.apple.mpegurl")&&(e.src=t,s=()=>{e.removeAttribute("src")})}).catch(()=>{e.canPlayType("application/vnd.apple.mpegurl")&&(e.src=t)}):(e.src=t,s=()=>{e.removeAttribute("src")}),()=>{s?.()}},[t]),x.useEffect(()=>{if(!i||!c.current)return;const e=c.current;function t(){e.play().catch(()=>{})}return e.readyState>=2?t():e.addEventListener("loadeddata",t,{once:!0}),()=>e.removeEventListener("loadeddata",t)},[i,t]),e.jsx("video",{ref:c,className:o,poster:s,controls:m,playsInline:a,preload:r,autoPlay:i,muted:i,onClick:l&&!d?()=>u(!0):void 0})}const $=18;function B(){return e.jsx("svg",{width:$,height:$,viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":!0,children:e.jsx("path",{d:"M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"})})}function H(){return e.jsx("svg",{width:$,height:$,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:e.jsx("path",{d:"M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"})})}function V(){return e.jsxs("svg",{width:$,height:$,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:[e.jsx("path",{d:"M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H3c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2z"}),e.jsx("path",{d:"M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-5c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2z"})]})}function z({replyAs:t,sessionsList:s,switchAccount:o,currentDid:n}){const[r,i]=x.useState(!1),[l,c]=x.useState({}),d=x.useRef(null);x.useEffect(()=>{if(!r)return;const e=e=>{d.current?.contains(e.target)||i(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[r]);const u=x.useMemo(()=>s.map(e=>e.did).sort().join(","),[s]);x.useEffect(()=>{if(0===s.length)return void c({});let e=!1;return s.forEach(t=>{a.getProfile({actor:t.did}).then(s=>{if(e)return;const o=s.data;c(e=>({...e,[t.did]:{avatar:o.avatar,handle:o.handle}}))}).catch(()=>{})}),()=>{e=!0}},[u,s]);const m=s.length>1;return e.jsxs("p",{className:U.replyAs,children:[e.jsx("span",{className:U.replyAsLabel,children:"Replying as"}),e.jsxs("span",{className:U.replyAsUserChip,children:[t.avatar?e.jsx("img",{src:t.avatar,alt:"",className:U.replyAsAvatar,loading:"lazy"}):e.jsx("span",{className:U.replyAsAvatarPlaceholder,"aria-hidden":!0,children:t.handle.slice(0,1).toUpperCase()}),e.jsx("div",{className:U.replyAsHandleWrap,ref:d,children:m?e.jsxs(e.Fragment,{children:[e.jsxs("button",{type:"button",className:U.replyAsHandleBtn,onClick:()=>i(e=>!e),"aria-expanded":r,"aria-haspopup":"true",children:["@",t.handle]}),r&&e.jsx("div",{className:U.replyAsDropdown,role:"menu",children:s.map(t=>{const s=l[t.did],a=s?.handle??t.handle??t.did,r=t.did===n;return e.jsxs("button",{type:"button",role:"menuitem",className:r?U.replyAsDropdownItemActive:U.replyAsDropdownItem,onClick:async()=>{await o(t.did)&&i(!1)},children:[s?.avatar?e.jsx("img",{src:s.avatar,alt:"",className:U.replyAsDropdownAvatar,loading:"lazy"}):e.jsx("span",{className:U.replyAsDropdownAvatarPlaceholder,"aria-hidden":!0,children:(a||t.did).slice(0,1).toUpperCase()}),e.jsxs("span",{className:U.replyAsDropdownHandle,children:["@",a]}),r&&e.jsx("span",{className:U.replyAsDropdownCheck,"aria-hidden":!0,children:"✓"})]},t.did)})})]}):e.jsxs("span",{className:U.replyAsHandle,children:["@",t.handle]})})]})]})}function W(e){return e&&"object"==typeof e&&"post"in e&&!!e.post}function O(e,t){return e.flatMap(e=>{const s=e.post.uri,o=e.post.author?.handle??e.post.author?.did??"";if(t.has(s))return[{uri:s,handle:o}];return[{uri:s,handle:o},...O("replies"in e&&Array.isArray(e.replies)?e.replies.filter(e=>W(e)):[],t)]})}function Q(e,t){for(const s of e){if(s.post.uri===t)return s;const e=Q("replies"in s&&Array.isArray(s.replies)?s.replies.filter(e=>W(e)):[],t);if(e)return e}return null}function K(e){if(!W(e))return[];const t=[e.post.uri],s="replies"in e&&Array.isArray(e.replies)?e.replies.filter(e=>W(e)):[];for(const o of s)t.push(...K(o));return t}function _(e){if("undefined"==typeof window)return()=>{};const t=window.matchMedia("(min-width: 768px)");return t.addEventListener("change",e),()=>t.removeEventListener("change",e)}function X(){return"undefined"!=typeof window&&window.innerWidth>=768}function G({items:t,autoPlayFirstVideo:s=!1,hideVideoControlsUntilTap:o=!1,onFocusItem:n,onDoubleTapLike:a}){const r=x.useRef(0),i=x.useRef(0);if(0===t.length)return null;const l=s?t.findIndex(e=>"video"===e.type&&e.videoPlaylist):-1;return e.jsx("div",{className:U.galleryWrap,onTouchEnd:e=>{if(!a||1!==e.changedTouches.length)return;const t=Date.now();t-r.current<400?(r.current=0,e.preventDefault(),a()):r.current=t},onClick:e=>{if(!a)return;const t=Date.now();t-i.current<400?(i.current=0,e.stopPropagation(),e.preventDefault(),a()):i.current=t},children:e.jsx("div",{className:U.gallery,children:t.map((t,s)=>{if("video"===t.type&&t.videoPlaylist){const a=t.aspectRatio??16/9;return e.jsx("div",{className:U.galleryVideoWrap,style:{aspectRatio:a},"data-media-item":s,tabIndex:0,onFocus:()=>n?.(s),children:e.jsx(T,{playlistUrl:t.videoPlaylist,poster:t.url||void 0,className:U.galleryVideo,autoPlay:s===l,preload:s===l?"metadata":"none",controlsHiddenUntilTap:o})},s)}const a="image"===t.type&&null!=t.aspectRatio?t.aspectRatio:1;return e.jsx("div",{className:U.galleryImageBtn,style:{aspectRatio:a,"--media-aspect":a},"data-media-item":s,tabIndex:0,onFocus:()=>n?.(s),children:e.jsx("img",{src:t.url,alt:"",className:U.galleryMedia,loading:"lazy"})},s)})})})}function J({node:t,depth:s=0,collapsedThreads:o,onToggleCollapse:a,onReply:r,rootPostUri:i,rootPostCid:c,replyingTo:d,replyComment:u,setReplyComment:m,onReplySubmit:p,replyPosting:h,clearReplyingTo:f,commentFormRef:v,replyAs:y,sessionsList:j,switchAccount:g,currentDid:N,focusedCommentUri:b,onCommentMediaFocus:w,onLike:C,onDownvote:A,likeOverrides:L,myDownvotes:D,downvoteCounts:M,downvoteCountOptimisticDelta:F,likeLoadingUri:T,downvoteLoadingUri:$,openActionsMenuCommentUri:B,onActionsMenuOpenChange:H,onViewQuotes:V}){const[O,Q]=x.useState(null),K=x.useRef(null);if(x.useEffect(()=>{if(!O)return;const e=e=>{K.current?.contains(e.target)||Q(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[O]),!W(t))return null;const{post:_}=t,X=_,Y=void 0!==L?.[_.uri]?L[_.uri]:X.viewer?.like,Z=D?.[_.uri],ee=X.likeCount??0,te=!!X.viewer?.like,se=(!!Y?1:0)-(te?1:0),oe=Math.max(0,ee+se),ne=M?.[_.uri]??X.downvoteCount??0,ae=F?.[_.uri]??0,re=Math.max(0,ne+ae),ie=l(_),le=_.record?.text??"",ce=_.author.handle??_.author.did,de=_.author.avatar??void 0,ue=_.record?.createdAt,me="replies"in t&&Array.isArray(t.replies)?t.replies:[],pe=me.length>0,he=pe&&o?.has(_.uri),fe=!!a,xe=d?.uri===_.uri,ve=b===_.uri,ye=T===_.uri,je=$===_.uri;return e.jsxs("article",{className:`${U.postBlock} ${ve?U.commentFocused:""}`,style:{marginLeft:2*s},"data-comment-uri":_.uri,tabIndex:-1,children:[fe&&e.jsxs("div",{className:U.collapseColumn,children:[e.jsx("button",{type:"button",className:U.collapseBtn,onClick:()=>a?.(_.uri),"aria-label":he?"Expand this comment":"Collapse this comment",title:he?"Expand this comment":"Collapse this comment",children:e.jsx("span",{className:U.collapseIcon,"aria-hidden":!0,children:"−"})}),e.jsx("button",{type:"button",className:U.collapseStrip,onClick:()=>a?.(_.uri),"aria-label":he?"Expand this comment":"Collapse this comment",title:he?"Expand this comment":"Collapse this comment"})]}),e.jsxs("div",{className:U.postBlockContent,children:[e.jsxs("div",{className:U.commentContentWrap,"data-comment-content":_.uri,tabIndex:-1,children:[e.jsxs("div",{className:U.postHead,children:[de&&e.jsx("img",{src:de,alt:"",className:U.avatar,loading:"lazy"}),e.jsxs("div",{className:U.authorRow,children:[e.jsxs(S,{handle:ce,className:U.handleLink,children:["@",ce]}),ue&&e.jsx("span",{className:U.postTimestamp,title:P(ue),children:k(ue)})]})]}),ie.length>0&&e.jsx(G,{items:ie,onFocusItem:e=>w?.(_.uri,e),onDoubleTapLike:C?()=>C(_.uri,_.cid,Y??null):void 0}),le&&e.jsx("p",{className:U.postText,children:e.jsx(E,{text:le,facets:_.record?.facets,interactive:!0})}),(r||C||A)&&e.jsxs("div",{className:U.replyBtnRow,children:[r&&e.jsxs("button",{type:"button",className:U.replyBtn,onClick:()=>r(_.uri,_.cid,ce),children:[e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:e.jsx("path",{d:"M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"})}),e.jsx("span",{children:"Reply"})]}),C&&e.jsxs("button",{type:"button",className:Y?U.commentLikeBtnLiked:U.commentLikeBtn,onClick:()=>C(_.uri,_.cid,Y??null),disabled:ye,title:Y?"Remove like":"Like","aria-label":Y?"Remove like":"Like",children:["↑",` ${oe}`]}),C&&A&&e.jsx("span",{className:U.commentVoteTotal,"aria-label":`Score: ${oe-re} (upvotes minus downvotes)`,children:oe-re}),A&&e.jsxs("button",{type:"button",className:Z?U.commentDownvoteBtnActive:U.commentDownvoteBtn,onClick:()=>A(_.uri,_.cid,Z??null),disabled:je,title:Z?"Remove downvote":"Downvote (syncs across AT Protocol)","aria-label":Z?"Remove downvote":"Downvote",children:["↓",` ${re}`]}),N&&e.jsxs("div",{className:U.commentRepostWrap,ref:K,children:[e.jsxs("button",{type:"button",className:U.commentRepostBtn,onClick:()=>Q(O===_.uri?null:_.uri),"aria-expanded":O===_.uri,"aria-haspopup":"true",title:"Repost or quote",children:[e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":!0,children:e.jsx("path",{d:"M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"})}),e.jsx("span",{children:"Repost"})]}),O===_.uri&&e.jsxs("div",{className:U.commentRepostDropdown,role:"menu",children:[e.jsx("button",{type:"button",className:U.commentRepostDropdownItem,role:"menuitem",onClick:async()=>{Q(null);try{const e=_;e.viewer?.repost?await n.deleteRepost(e.viewer.repost):await n.repost(_.uri,_.cid)}catch(e){}},children:_.viewer?.repost?"Remove repost":"Repost"}),e.jsx("button",{type:"button",className:U.commentRepostDropdownItem,role:"menuitem",onClick:()=>{Q(null),V&&V(_.uri)},children:"Quote post"})]})]}),e.jsx(I,{postUri:_.uri,postCid:_.cid,authorDid:_.author.did,rootUri:i??_.uri,isOwnPost:N===_.author.did,compact:!0,verticalIcon:!0,className:U.commentActionsMenu,open:H?B===_.uri:void 0,onOpenChange:H?e=>H(_.uri,e):void 0,postedAt:_.record?.createdAt,onViewQuotes:V})]}),xe&&d&&m&&p&&f&&v&&e.jsx("div",{className:U.inlineReplyFormWrap,children:e.jsxs("form",{ref:v,onSubmit:p,className:U.inlineReplyForm,children:[e.jsxs("div",{className:U.inlineReplyFormHeader,children:[e.jsx("button",{type:"button",className:U.cancelReply,onClick:f,"aria-label":"Cancel reply",children:"×"}),y&&(j&&g&&N?e.jsx(z,{replyAs:y,sessionsList:j,switchAccount:g,currentDid:N}):e.jsxs("p",{className:U.replyAs,children:[e.jsx("span",{className:U.replyAsLabel,children:"Replying as"}),e.jsxs("span",{className:U.replyAsUserChip,children:[y.avatar?e.jsx("img",{src:y.avatar,alt:"",className:U.replyAsAvatar,loading:"lazy"}):e.jsx("span",{className:U.replyAsAvatarPlaceholder,"aria-hidden":!0,children:y.handle.slice(0,1).toUpperCase()}),e.jsxs("span",{className:U.replyAsHandle,children:["@",y.handle]})]})]}))]}),e.jsx(R,{placeholder:`Reply to @${d.handle}…`,value:u??"",onChange:e=>m?.(e),onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),(u??"").trim()&&!h&&v.current?.requestSubmit())},className:U.textarea,rows:2,maxLength:300,autoFocus:!0}),e.jsxs("div",{className:U.commentFormFooter,children:[e.jsx(q,{used:(u??"").length,max:300}),e.jsx("p",{className:U.hint,children:"⌘ Enter or ⌘ E to post"})]}),e.jsx("button",{type:"submit",className:U.submit,disabled:h||!(u??"").trim(),children:h?"Posting…":"Post reply"})]})})]}),pe&&e.jsx("div",{className:U.repliesContainer,children:he?e.jsxs("button",{type:"button",className:U.repliesCollapsed,onClick:()=>a?.(_.uri),children:[me.length," reply",1!==me.length?"s":""]}):e.jsx("div",{className:U.replies,children:me.map((t,n)=>{if(!W(t))return null;const l=s+1;if(o?.has(t.post.uri)){const s="replies"in t&&Array.isArray(t.replies)?t.replies.length:0,o=0===s?"Comment":`${s} reply${1!==s?"s":""}`,r=t.post.author?.handle??t.post.author?.did??"";return e.jsx("div",{className:U.collapsedCommentWrap,style:{marginLeft:12*l},"data-comment-uri":t.post.uri,tabIndex:-1,children:e.jsxs("button",{type:"button",className:U.collapsedCommentBtn,onClick:()=>a?.(t.post.uri),children:[e.jsx("span",{className:U.collapsedCommentExpandIcon,"aria-hidden":!0,children:"+"}),t.post.author?.avatar?e.jsx("img",{src:t.post.author.avatar,alt:"",className:U.collapsedCommentAvatar,loading:"lazy"}):e.jsx("span",{className:U.collapsedCommentAvatarPlaceholder,"aria-hidden":!0,children:r.slice(0,1).toUpperCase()}),e.jsxs("span",{className:U.collapsedCommentHandle,children:["@",r]}),e.jsx("span",{className:U.collapsedCommentLabel,children:o})]})},`${t.post.uri}-${n}`)}return e.jsx(J,{node:t,depth:l,collapsedThreads:o,onToggleCollapse:a,onReply:r,rootPostUri:i,rootPostCid:c,replyingTo:d,replyComment:u,setReplyComment:m,onReplySubmit:p,replyPosting:h,clearReplyingTo:f,commentFormRef:v,replyAs:y,sessionsList:j,switchAccount:g,currentDid:N,focusedCommentUri:b,onCommentMediaFocus:w,onLike:C,onDownvote:A,likeOverrides:L,myDownvotes:D,downvoteCounts:M,downvoteCountOptimisticDelta:F,likeLoadingUri:T,downvoteLoadingUri:$,openActionsMenuCommentUri:B,onActionsMenuOpenChange:H,onViewQuotes:V},`${t.post.uri}-${n}`)})})})]})]})}function Y({uri:y,initialOpenReply:j,initialFocusedCommentUri:D,onClose:M,onAuthorHandle:T,onRegisterRefresh:$}){const Y=v(),{openProfileModal:Z,openPostModal:ee,openQuotesModal:te}=t(),se=x.useSyncExternalStore(_,X,()=>!1),oe=y,[ne,ae]=x.useState(null),[re,ie]=x.useState(!0),[le,ce]=x.useState(null),[de,ue]=x.useState(""),[me,pe]=x.useState(!1),[he,fe]=x.useState(new Set),[xe,ve]=x.useState(null),[ye,je]=x.useState(()=>new Set),[ge,Ne]=x.useState(!1),[be,we]=x.useState(!1),[Ce,Ae]=x.useState(null),[ke,Pe]=x.useState(!1),[Re,qe]=x.useState(!1),[Le,Se]=x.useState(null),[Ee,De]=x.useState(null),[Ie,Ue]=x.useState(null),[Me,Fe]=x.useState({}),[Te,$e]=x.useState({}),[Be,He]=x.useState({}),[Ve,ze]=x.useState({}),[We,Oe]=x.useState(null),[Qe,Ke]=x.useState(null),[_e,Xe]=x.useState(null),[Ge,Je]=x.useState(""),[Ye,Ze]=x.useState(!1),[et,tt]=x.useState(!1),[st,ot]=x.useState(!1),[nt,at]=x.useState(""),[rt,it]=x.useState([]),[lt,ct]=x.useState([]),[dt,ut]=x.useState(!1),[mt,pt]=x.useState(null),ht=x.useRef(null),ft=x.useRef(null),[xt,vt]=x.useState(0),yt=x.useRef(null),jt=x.useRef(null),gt=x.useRef(null),Nt=x.useRef(null),bt=x.useRef(null),[wt,Ct]=x.useState(0),[At,kt]=x.useState(!1),Pt=x.useRef(null),[Rt,qt]=x.useState("score"),[Lt,St]=x.useState(0),Et=x.useRef(0),Dt=x.useRef(!1),It=x.useRef(null),Ut=x.useRef(0),Mt=b(),Ft=s(),{session:Tt,sessionsList:$t,switchAccount:Bt}=o(),[Ht,Vt]=x.useState(null);x.useEffect(()=>{const e=Tt??Ft;if(!e?.did)return void Vt(null);const t=e.handle??e.did;n.getProfile({actor:e.did}).then(e=>Vt({handle:e.data.handle??t,avatar:e.data.avatar})).catch(()=>Vt({handle:t}))},[Tt?.did,Ft?.did]);const zt=Ht??(Ft?{handle:Ft.handle??Ft.did}:null),Wt=ne&&W(ne)&&Ft?.did===ne.post.author.did,Ot=ne&&W(ne)?ne.post.author.viewer:void 0,Qt=Ot?.following??Ce,Kt=!!Qt||be,_t=ne&&W(ne)?ne.post.viewer:void 0,Xt=_t?.like??Le,Gt=_t?.repost??Ee,Jt=!!Xt,Yt=!!Gt;function Zt(e){je(t=>{const s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})}async function es(){if(!ne||!W(ne)||ke)return;const{uri:e,cid:t}=ne.post;Pe(!0);try{if(Jt)await n.deleteLike(Xt),Se(null);else{const s=await n.like(e,t);Se(s.uri)}}catch{}finally{Pe(!1)}}const ts=["image/jpeg","image/png","image/gif","image/webp"];function ss(e){const t=Array.from(e).filter(e=>ts.includes(e.type)),s=Math.min(t.length,4-rt.length);s<=0||(it(e=>[...e,...t.slice(0,s)]),ct(e=>[...e,...t.slice(0,s).map(()=>"")]))}function os(){ot(!1),pt(null)}async function ns(e){if(e.preventDefault(),!ne||!W(ne)||dt||!Ft?.did)return;if(nt.trim()||rt.length>0){pt(null),ut(!0);try{await f(ne.post.uri,ne.post.cid,nt,rt.length>0?rt:void 0,lt.length>0?lt:void 0),os(),Y("/feed")}catch(t){pt(t instanceof Error?t.message:"Failed to post quote")}finally{ut(!1)}}}const as=x.useCallback(async()=>{if(!oe)return;ce(null);const e=s()?n:a;let t=!1;const o=g(oe),l=N(oe);if(o){const e=o.post??o;if(e&&"object"==typeof e&&e.uri===oe){ae({$type:"app.bsky.feed.defs#threadViewPost",post:e,replies:[]});const s=e.record?.reply;ie(!!s),t=!0}}else l&&W(l)&&(ae(l),ie(!1),t=!0);t||ie(!0);try{const t=(await r(oe,e)).data.thread;ae(t),ie(!1),ze({});const o=W(t)?K(t):[];o.length>0?F(o).then(He).catch(()=>{}):He({}),s()?i().then($e).catch(()=>{}):$e({})}catch(c){ce(c instanceof Error?c.message:"Failed to load post")}finally{ie(!1)}},[oe,Tt?.did]);async function rs(e){if(e.preventDefault(),!ne||!W(ne)||!de.trim())return;const t=ne.post,s=Ie??{uri:t.uri,cid:t.cid};pe(!0);try{await h(t.uri,t.cid,s.uri,s.cid,de.trim()),ue(""),Ue(null),await as()}catch(o){alert(o instanceof Error?o.message:"Failed to post comment")}finally{pe(!1)}}function is(e,t,s){Ue({uri:e,cid:t,handle:s});const o=document.querySelector(`.${U.commentForm} textarea`);o?.focus()}async function ls(e,t,s){Oe(e);try{if(s)await n.deleteLike(s),Fe(t=>({...t,[e]:null}));else{const s=await n.like(e,t);Fe(t=>({...t,[e]:s.uri}))}}catch{}finally{Oe(null)}}async function cs(e,t,s){Ke(e);try{if(s)await m(s),$e(t=>{const s={...t};return delete s[e],s}),ze(t=>({...t,[e]:(t[e]??0)-1}));else{const s=await p(e,t);$e(t=>({...t,[e]:s})),ze(t=>({...t,[e]:(t[e]??0)+1}))}}catch{}finally{Ke(null)}}function ds(){if(!ne||!W(ne))return;if(!(he.size>0||Ge.trim().length>0))return;const e=ne.post,t=u(e),s=l(e),o=s.length>0?s.map(e=>e.url):void 0,n={uri:e.uri,cid:e.cid,authorHandle:e.author.handle,text:e.record?.text?.slice(0,200),thumb:t?.url??o?.[0],thumbs:o},a=[];if(Ge.trim()){const e=C(Ge.trim());A(e.id,n),a.push(e.id),Je("")}he.forEach(e=>{A(e,n),a.push(e)}),ve(a[0]??null),fe(new Set),Ze(!1)}x.useEffect(()=>{as()},[as]),x.useEffect(()=>{$?.(()=>as())},[$,as]),x.useEffect(()=>{if(!ne||!W(ne)||!j)return;const e=ne.post.author?.handle??ne.post.author?.did??"";Ue({uri:ne.post.uri,cid:ne.post.cid,handle:e}),requestAnimationFrame(()=>{const e=document.querySelector(`.${U.commentForm} textarea`);e?.focus()})},[ne,j]),x.useEffect(()=>{if(!Ie)return;const e=e=>{if("Escape"===e.key){e.preventDefault(),Ue(null);const t=document.activeElement;t instanceof HTMLElement&&t.blur()}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[Ie]);const us=x.useMemo(()=>rt.map(e=>URL.createObjectURL(e)),[rt]);x.useEffect(()=>()=>us.forEach(e=>URL.revokeObjectURL(e)),[us]),x.useEffect(()=>{if(et)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e);function e(e){const t=e.target;ft.current?.contains(t)||tt(!1)}},[et]);const ms=ne&&W(ne)?l(ne.post):[],ps=ms.length>0,hs=ne&&W(ne)&&"replies"in ne&&Array.isArray(ne.replies)&&ne.replies.length>0,fs=1+(ps?1:0)+(hs?1:0),xs=ne&&W(ne)&&"replies"in ne&&Array.isArray(ne.replies)?ne.replies.filter(e=>W(e)):[],vs=x.useCallback(e=>{const t=e.post,s=t.likeCount??0,o=!!t.viewer?.like,n=(!!(void 0!==Me[e.post.uri]?Me[e.post.uri]:t.viewer?.like)?1:0)-(o?1:0);return Math.max(0,s+n)},[Me]),ys=x.useCallback(e=>(Be[e.post.uri]??0)+(Ve[e.post.uri]??0),[Be,Ve]),js=x.useCallback((e,t)=>{const s=e+t;if(0===s)return 0;const o=1.96,n=e/s,a=1+o*o/s,r=n+o*o/(2*s),i=o*Math.sqrt((n*(1-n)+o*o/(4*s))/s);return Math.max(0,(r-i)/a)},[]),gs=x.useMemo(()=>{const e=e=>e.post.record?.createdAt??"",t=(t,s)=>e(s).localeCompare(e(t));return"newest"===Rt?[...xs].sort((t,s)=>e(s).localeCompare(e(t))):"oldest"===Rt?[...xs].sort((t,s)=>e(t).localeCompare(e(s))):[...xs].sort((e,s)=>{const o=vs(e),n=vs(s),a=ys(e),r=ys(s);if("likes"===Rt)return n!==o?n-o:t(e,s);if("score"===Rt){const i=o-a,l=n-r;return l!==i?l-i:t(e,s)}if("controversial"===Rt){const i=o+a,l=n+r,c=i>0?o*a/i:0,d=l>0?n*r/l:0;return d!==c?d-c:t(e,s)}const i=js(o,a),l=js(n,r);return l!==i?l-i:t(e,s)})},[xs,Rt,vs,ys,js]),Ns=x.useMemo(()=>O(gs,ye),[gs,ye]),bs=x.useRef(Ns);bs.current=Ns,Et.current=Lt;const ws=x.useMemo(()=>{const e=[];for(let t=0;t<ms.length;t++)e.push({type:"rootMedia",index:t});e.push({type:"description"});for(const t of Ns){const s=Q(gs,t.uri),o=s?l(s.post):[];for(let n=0;n<o.length;n++)e.push({type:"commentMedia",commentUri:t.uri,mediaIndex:n});e.push({type:"comment",commentUri:t.uri})}return e.push({type:"replyForm"}),e},[ms.length,Ns,gs]),Cs=ws.length,As=x.useCallback((e,t)=>{const s=ws.findIndex(s=>"commentMedia"===s.type&&s.commentUri===e&&s.mediaIndex===t);if(s>=0){St(s);const t=Ns.findIndex(t=>t.uri===e);t>=0&&Ct(t)}},[ws,Ns]),ks=ne&&W(ne)?ne.post.uri:null;if(x.useEffect(()=>{if(ne&&W(ne)&&T){const e=ne.post.author?.handle??ne.post.author?.did??"";e&&T(e)}},[ne,T]),x.useEffect(()=>{ks&&St(0)},[ks]),x.useEffect(()=>{Cs<=0||St(e=>Math.min(Math.max(0,e),Cs-1))},[Cs]),x.useEffect(()=>{const e=e=>{const t=e.target;if("INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName||t.isContentEditable)return void("Escape"===e.key&&(e.preventDefault(),t.blur()));if(e.ctrlKey||e.metaKey)return;const s=e.key.toLowerCase();if("f"===s)return void(ne&&W(ne)&&(e.preventDefault(),es()));if("r"===s){const t=ne;if(!t||!W(t))return;e.preventDefault();if(hs&&xt===fs-1&&Ns.length>0&&wt>=0&&wt<Ns.length){const e=Ns[wt],t=Q(xs,e.uri);t&&is(t.post.uri,t.post.cid,e.handle)}else if(xt===(ps?1:0)){const e=t.post.author?.handle??t.post.author?.did??"";is(t.post.uri,t.post.cid,e)}return}const o=hs&&(xt===fs-1||(bt.current?.contains(t)??!1)),n=Nt.current?.contains(t)??!1,a=gt.current?.contains(t)??!1,r=jt.current?.contains(t)??!1;if("e"===s||"enter"===s){if(e.preventDefault(),(At||r)&&yt.current){const e=yt.current.querySelector("textarea");return void(e&&(e.focus(),kt(!0)))}if(o&&Ns.length>0&&wt>=0&&wt<Ns.length){const e=Ns[wt];return void(e?.handle&&Z(e.handle))}if((n||a)&&ne&&W(ne)){const e=ne.post.author?.handle??ne.post.author?.did??"";return void(e&&Z(e))}return}if("m"===s||"`"===s){const t=document.activeElement?.closest?.('[role="menu"]');if(t&&null!=_e)return e.preventDefault(),void Xe(null);if(ne&&W(ne)&&ws.length>0){const t=Et.current,s=ws[t];if(s){let t=null;"description"===s.type||"rootMedia"===s.type?t=ne.post.uri:"comment"!==s.type&&"commentMedia"!==s.type||(t=s.commentUri),null!=t&&(e.preventDefault(),Xe(_e===t?null:t))}}return}const i="w"===s||"ArrowUp"===e.key,l="s"===s||"d"===s||"a"===s||"ArrowDown"===e.key||"ArrowRight"===e.key||"ArrowLeft"===e.key;if(!i&&!l)return;if(!ne||!W(ne))return;const c=ws.length;if(c<=0)return;const d=(e,t)=>{const s=ws[e];if(s)if(kt("replyForm"===s.type),"rootMedia"===s.type){vt(0),Ct(0);const e=gt.current?.querySelectorAll("[data-media-item]"),t=e?.[s.index];t&&requestAnimationFrame(()=>{t.focus(),t.scrollIntoView({behavior:"smooth",block:"center"})})}else if("description"===s.type)vt(ps?1:0),Ct(0),requestAnimationFrame(()=>{Nt.current?.focus(),Nt.current?.scrollIntoView({behavior:"smooth",block:"center"})});else if("commentMedia"===s.type){vt(fs-1);const e=Ns.findIndex(e=>e.uri===s.commentUri);Ct(e>=0?e:0),requestAnimationFrame(()=>{const e=bt.current;if(!e)return;const t=Array.from(e.querySelectorAll("[data-comment-uri]")).find(e=>e.getAttribute("data-comment-uri")===s.commentUri),o=t?.querySelectorAll("[data-media-item]")?.[s.mediaIndex];o&&(o.focus({preventScroll:!0}),o.scrollIntoView({behavior:"smooth",block:"center"}))})}else if("comment"===s.type){const o=ws.filter(e=>"commentMedia"===e.type&&e.commentUri===s.commentUri).length,n=void 0!==t?ws[t]:void 0;if("commentMedia"===n?.type&&n.commentUri===s.commentUri&&o>0&&n.mediaIndex===o-1&&e+1<ws.length)return St(e+1),void d(e+1,e);vt(fs-1);const a=Ns.findIndex(e=>e.uri===s.commentUri);Ct(a>=0?a:0);const r=o>0&&void 0!==t?e<t?o-1:0:-1;if(r>=0){const e=ws.findIndex(e=>"commentMedia"===e.type&&e.commentUri===s.commentUri&&e.mediaIndex===r);e>=0&&St(e)}requestAnimationFrame(()=>{const e=bt.current;if(!e)return;const t=Array.from(e.querySelectorAll("[data-comment-uri]")).find(e=>e.getAttribute("data-comment-uri")===s.commentUri);if(!t)return;const o=t.querySelector("[data-comment-content]")||t;if(r>=0){const e=o.querySelectorAll("[data-media-item]")?.[r];e&&(e.focus({preventScroll:!0}),e.scrollIntoView({behavior:"smooth",block:"center"}))}else o.focus({preventScroll:!0}),o.scrollIntoView({behavior:"smooth",block:"center"})})}else vt(fs-1),Ct(Ns.length-1),requestAnimationFrame(()=>{jt.current?.focus(),jt.current?.scrollIntoView({behavior:"smooth",block:"center"})})},u=Et.current,m=i?Math.max(0,u-1):Math.min(c-1,u+1);m!==u&&(e.preventDefault(),e.stopPropagation(),Dt.current=!0,St(m),d(m,u))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[fs,xt,hs,Ns,wt,At,ne,ps,is,ms.length,Z,ws,es,_e]),x.useEffect(()=>{if(fs<=1)return;if(0===xt||ps&&1===xt)return;let e=null;hs&&xt===fs-1&&(e=bt.current),e&&e.scrollIntoView({behavior:"smooth",block:"start"})},[xt,ps,hs,fs]),x.useEffect(()=>{xt===fs-1&&hs&&Ut.current!==fs-1&&Ct(0),Ut.current=xt},[xt,fs,hs]),x.useEffect(()=>{Ns.length>0&&Ct(e=>Math.min(e,Ns.length-1))},[Ns.length]),x.useEffect(()=>{if(!D||!ne||!W(ne)||0===Ns.length)return;if(It.current===D)return;It.current=D;const e=Ns.findIndex(e=>e.uri===D);if(e<0)return;Ct(e);const t=ws.findIndex(e=>("comment"===e.type||"commentMedia"===e.type)&&e.commentUri===D);t>=0&&St(t),requestAnimationFrame(()=>{const e=bt.current;if(!e)return;const t=Array.from(e.querySelectorAll("[data-comment-uri]")).find(e=>e.getAttribute("data-comment-uri")===D);if(t){(t.querySelector("[data-comment-content]")||t).scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}})},[D,ne,Ns,ws]),x.useEffect(()=>{if(!Dt.current)return;if(!(hs&&xt===fs-1)||fs<=1)return;const e=bs.current;wt<0||wt>=e.length||(Dt.current=!1)},[wt,hs,xt,fs]),x.useEffect(()=>{if(!Dt.current)return;const e=ws[Lt];!e||"comment"!==e.type&&"commentMedia"!==e.type||(Dt.current=!1)},[Lt,ws]),!oe)return M&&M(),null;const Ps=ne&&W(ne)?l(ne.post):[],Rs=e.jsxs("div",{className:`${U.wrap}${M?` ${U.wrapInModal}`:""}${re?` ${U.wrapLoading}`:""}`,children:[re&&!ne&&e.jsx("div",{className:U.loading,"aria-live":"polite",children:"Loading…"}),le&&e.jsx("p",{className:U.error,children:le}),ne&&W(ne)&&e.jsxs(e.Fragment,{children:[(()=>{const t=ne.post.record?.reply,s="parent"in ne&&ne.parent&&W(ne.parent);return re&&t&&!s?e.jsxs("div",{className:U.parentPostWrap,children:[e.jsx("p",{className:U.quotedPostLabel,children:"Replying to"}),e.jsx("div",{className:`${U.quotedPostCard} ${U.parentSkeleton}`,children:e.jsxs("div",{className:U.quotedPostHead,children:[e.jsx("span",{className:U.quotedPostAvatarPlaceholder,"aria-hidden":!0,children:"•"}),e.jsx("span",{className:U.quotedPostHandle,children:"Loading…"})]})})]}):s?(()=>{const t=ne.parent,s=t&&"post"in t?t.post:void 0;if(!s)return null;const o=s.author?.handle??s.author?.did??"",n=s.record?.text??"",a=l(s)[0];return e.jsxs("div",{className:U.parentPostWrap,children:[e.jsx("p",{className:U.quotedPostLabel,children:"Replying to"}),e.jsxs("button",{type:"button",className:U.quotedPostCard,onClick:()=>{M?ee(s.uri):Y(`/post/${encodeURIComponent(s.uri)}`)},children:[e.jsxs("div",{className:U.quotedPostHead,children:[s.author?.avatar?e.jsx("img",{src:s.author.avatar,alt:"",className:U.quotedPostAvatar,loading:"lazy"}):e.jsx("span",{className:U.quotedPostAvatarPlaceholder,"aria-hidden":!0,children:o.slice(0,1).toUpperCase()}),e.jsxs(S,{handle:o,className:U.quotedPostHandle,onClick:e=>e.stopPropagation(),children:["@",o]}),s.record?.createdAt&&e.jsx("span",{className:U.quotedPostTime,title:P(s.record.createdAt),children:k(s.record.createdAt)})]}),a&&e.jsx("div",{className:U.quotedPostMedia,children:"image"===a.type?e.jsx("img",{src:a.url,alt:"",loading:"lazy",className:U.quotedPostThumb}):a.videoPlaylist?e.jsx("div",{className:U.quotedPostVideoThumb,style:{backgroundImage:a.url?`url(${a.url})`:void 0}}):null}),n?e.jsx("p",{className:U.quotedPostText,children:e.jsx(E,{text:n,facets:s.record?.facets,maxLength:200,stopPropagation:!0})}):null]})]})})():null})(),e.jsxs("article",{className:`${U.postBlock} ${U.rootPostBlock}`,children:[Ps.length>0&&e.jsx("div",{ref:gt,onMouseEnter:()=>!M&&ms.length>0&&St(0),children:e.jsx(G,{items:Ps,autoPlayFirstVideo:!0,hideVideoControlsUntilTap:!se,onFocusItem:e=>!M&&St(e),onDoubleTapLike:M?void 0:es})}),e.jsxs("div",{ref:Nt,className:U.rootPostDescription,tabIndex:-1,onFocus:()=>!M&&St(ms.length),onMouseEnter:()=>!M&&St(ms.length),children:[e.jsxs("div",{className:U.postHead,children:[ne.post.author.avatar&&e.jsx("img",{src:ne.post.author.avatar,alt:"",className:U.avatar,loading:"lazy"}),e.jsxs("div",{className:U.authorRow,children:[e.jsxs(S,{handle:ne.post.author.handle??ne.post.author.did,className:U.handleLink,children:["@",ne.post.author.handle??ne.post.author.did]}),!Wt&&(Kt?e.jsxs("button",{type:"button",className:`${U.followBtn} ${U.followBtnFollowing}`,onClick:async function(){if(Qt&&!ge){Ne(!0);try{await n.deleteFollow(Qt),Ae(null),we(!1)}catch{}finally{Ne(!1)}}},disabled:ge,title:"Unfollow",children:[e.jsx("span",{className:U.followLabelDefault,children:"Following"}),e.jsx("span",{className:U.followLabelHover,children:"Unfollow"})]}):e.jsx("button",{type:"button",className:U.followBtn,onClick:async function(){if(ne&&W(ne)&&!ge&&!Kt){Ne(!0);try{const e=await n.follow(ne.post.author.did);Ae(e.uri),we(!0)}catch{}finally{Ne(!1)}}},disabled:ge,children:ge?"Following…":"Follow"})),ne.post.record?.createdAt&&e.jsx("span",{className:U.postTimestamp,title:P(ne.post.record.createdAt),children:k(ne.post.record.createdAt)})]})]}),ne.post.record?.text&&e.jsx("p",{className:U.postText,children:e.jsx(E,{text:ne.post.record.text,facets:ne.post.record?.facets,interactive:!0})}),(()=>{const t=c(ne.post);return t?e.jsxs("div",{className:U.quotedPostWrap,children:[e.jsx("p",{className:U.quotedPostLabel,children:"Link"}),e.jsxs("a",{href:t.uri,target:"_blank",rel:"noopener noreferrer",className:U.quotedPostCard,children:[t.thumb?e.jsx("div",{className:U.quotedPostMedia,children:e.jsx("img",{src:t.thumb,alt:"",loading:"lazy",className:U.quotedPostThumb})}):null,e.jsx("p",{className:U.quotedPostText,children:t.title}),t.description?e.jsx("p",{className:U.quotedPostText,children:e.jsx(E,{text:t.description,maxLength:200,stopPropagation:!0})}):null]})]}):null})(),(()=>{const t=d(ne.post);if(!t)return null;const s=t.author?.handle??t.author?.did??"",o=t.record?.text??"",n=l(t)[0];return e.jsxs("div",{className:U.quotedPostWrap,children:[e.jsx("p",{className:U.quotedPostLabel,children:"Quoting"}),e.jsxs("button",{type:"button",className:U.quotedPostCard,onClick:()=>{M?ee(t.uri):Y(`/post/${encodeURIComponent(t.uri)}`)},children:[e.jsxs("div",{className:U.quotedPostHead,children:[t.author?.avatar?e.jsx("img",{src:t.author.avatar,alt:"",className:U.quotedPostAvatar,loading:"lazy"}):e.jsx("span",{className:U.quotedPostAvatarPlaceholder,"aria-hidden":!0,children:s.slice(0,1).toUpperCase()}),e.jsxs(S,{handle:s,className:U.quotedPostHandle,onClick:e=>e.stopPropagation(),children:["@",s]}),t.record?.createdAt&&e.jsx("span",{className:U.quotedPostTime,title:P(t.record.createdAt),children:k(t.record.createdAt)})]}),n&&e.jsx("div",{className:U.quotedPostMedia,children:"image"===n.type?e.jsx("img",{src:n.url,alt:"",loading:"lazy",className:U.quotedPostThumb}):n.videoPlaylist?e.jsx("div",{className:U.quotedPostVideoThumb,style:{backgroundImage:n.url?`url(${n.url})`:void 0}}):null}),o?e.jsx("p",{className:U.quotedPostText,children:e.jsx(E,{text:o,facets:t.record?.facets,maxLength:200,stopPropagation:!0})}):null]})]})})()]}),e.jsxs("section",{className:U.actions,"aria-label":"Post actions",children:[e.jsxs("div",{className:U.actionRow,children:[e.jsxs("div",{className:U.addToBoardWrap,children:[e.jsxs("button",{type:"button",className:U.addToBoardTrigger,onClick:()=>Ze(e=>!e),"aria-expanded":Ye,"aria-haspopup":"true",children:[e.jsx("span",{className:U.likeRepostBtnIcon,"aria-hidden":!0,children:e.jsx(H,{})}),"Collect ",Ye?"▾":"▸"]}),Ye&&e.jsxs("div",{className:U.boardDropdown,children:[0===Mt.length?null:e.jsx(e.Fragment,{children:Mt.map(t=>{const s=w(t.id,ne.post.uri),o=he.has(t.id);return e.jsxs("label",{className:U.boardCheckLabel,children:[e.jsx("input",{type:"checkbox",checked:o,onChange:()=>{return!s&&(e=t.id,void fe(t=>{const s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s}));var e},disabled:s,className:U.boardCheckbox}),e.jsx("span",{className:U.boardCheckText,children:s?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:U.boardCheckIcon,"aria-hidden":!0,children:"✓"})," ",t.name]}):t.name})]},t.id)})}),e.jsx("div",{className:U.boardDropdownNew,children:e.jsx("input",{type:"text",placeholder:"New collection name",value:Ge,onChange:e=>Je(e.target.value),className:U.newBoardInput,onKeyDown:e=>"Enter"===e.key&&(e.preventDefault(),ds())})}),e.jsx("div",{className:U.boardDropdownActions,children:e.jsx("button",{type:"button",className:U.addBtn,onClick:ds,disabled:0===he.size&&!Ge.trim(),children:"Add to selected"})})]})]}),e.jsxs("button",{type:"button",className:`${U.likeRepostBtn} ${Jt?U.likeRepostBtnActive:""}`,onClick:es,disabled:ke,title:Jt?"Remove like":"Like",children:[ke?"…":Jt?"♥":"♡"," Like"]}),ne&&W(ne)&&Ft&&e.jsxs("button",{type:"button",className:`${U.likeRepostBtn} ${Te[ne.post.uri]?U.likeRepostBtnDownvoteActive:""}`,onClick:()=>cs(ne.post.uri,ne.post.cid,Te[ne.post.uri]??null),disabled:Qe===ne.post.uri,title:Te[ne.post.uri]?"Remove downvote":"Downvote (syncs across AT Protocol)","aria-label":Te[ne.post.uri]?"Remove downvote":"Downvote",children:[Qe===ne.post.uri?"…":"↓"," Downvote",(()=>{const e=Be[ne.post.uri]??ne.post.downvoteCount??0,t=Ve[ne.post.uri]??0,s=Math.max(0,e+t);return s>0?` ${s}`:""})()]}),e.jsxs("div",{className:U.repostWrap,ref:ft,children:[e.jsxs("button",{type:"button",className:`${U.likeRepostBtn} ${Yt?U.likeRepostBtnActive:""} ${et?U.repostTriggerOpen:""}`,onClick:()=>tt(e=>!e),disabled:Re,title:Yt?"Remove repost":"Repost or quote","aria-expanded":et,"aria-haspopup":"true",children:[e.jsx("span",{className:U.likeRepostBtnIcon,"aria-hidden":!0,children:e.jsx(B,{})}),Re?"…":"Repost ▾"]}),et&&e.jsxs("div",{className:U.repostDropdown,role:"menu",children:[e.jsx("button",{type:"button",className:U.repostDropdownItem,role:"menuitem",onClick:()=>{tt(!1),async function(){if(!ne||!W(ne)||Re)return;const{uri:e,cid:t}=ne.post;qe(!0);try{if(Yt)await n.deleteRepost(Gt),De(null);else{const s=await n.repost(e,t);De(s.uri)}}catch{}finally{qe(!1)}}()},disabled:Re,children:Yt?"Remove repost":"Repost"}),e.jsx("button",{type:"button",className:U.repostDropdownItem,role:"menuitem",onClick:function(){tt(!1),ot(!0),at(""),it([]),ct([]),pt(null)},disabled:!Ft?.did,children:"Quote post"})]})]}),ne&&W(ne)&&e.jsxs("button",{type:"button",className:U.likeRepostBtn,onClick:()=>te(ne.post.uri),title:"View posts that quote this","aria-label":"View quotes",children:[e.jsx("span",{className:U.likeRepostBtnIcon,"aria-hidden":!0,children:e.jsx(V,{})}),"View Quotes"]}),ne&&W(ne)&&e.jsx(I,{postUri:ne.post.uri,postCid:ne.post.cid,authorDid:ne.post.author.did,rootUri:ne.post.uri,isOwnPost:Ft?.did===ne.post.author.did,compact:!0,verticalIcon:!0,open:_e===ne.post.uri,onOpenChange:e=>Xe(e?ne.post.uri:null),onHidden:()=>Y("/feed"),postedAt:ne.post.record?.createdAt,onViewQuotes:te})]}),xe&&e.jsxs("p",{className:U.added,children:["Added to ",Mt.find(e=>e.id===xe)?.name]})]})]}),ne&&W(ne)&&e.jsx("div",{className:U.inlineReplyFormWrap,children:e.jsx("div",{children:e.jsxs("form",{ref:Pt,onSubmit:async function(e){if(e.preventDefault(),!ne||!W(ne)||!de.trim())return;const t=ne.post;pe(!0);try{await h(t.uri,t.cid,t.uri,t.cid,de.trim()),ue(""),await as()}catch(s){alert(s instanceof Error?s.message:"Failed to post comment")}finally{pe(!1)}},className:U.commentForm,children:[zt&&e.jsx("div",{className:U.inlineReplyFormHeader,children:$t&&Tt?.did?e.jsx(z,{replyAs:zt,sessionsList:$t,switchAccount:Bt,currentDid:Tt.did}):e.jsxs("p",{className:U.replyAs,children:[e.jsx("span",{className:U.replyAsLabel,children:"Replying as"}),e.jsxs("span",{className:U.replyAsUserChip,children:[zt.avatar?e.jsx("img",{src:zt.avatar,alt:"",className:U.replyAsAvatar,loading:"lazy"}):e.jsx("span",{className:U.replyAsAvatarPlaceholder,"aria-hidden":!0,children:zt.handle.slice(0,1).toUpperCase()}),e.jsxs("span",{className:U.replyAsHandle,children:["@",zt.handle]})]})]})}),e.jsx(R,{placeholder:"Write a comment…",value:de,onChange:ue,onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),de.trim()&&!me&&Pt.current?.requestSubmit())},className:U.textarea,rows:3,maxLength:300}),e.jsx("p",{className:U.hint,children:"⌘ Enter or ⌘ E to post"}),e.jsx("button",{type:"submit",className:U.submit,disabled:me||!de.trim(),children:me?"Posting…":"Post comment"})]})})}),"replies"in ne&&Array.isArray(ne.replies)&&ne.replies.length>0&&e.jsxs("div",{ref:bt,className:`${U.replies} ${U.repliesTopLevel}`,children:[e.jsxs("div",{className:U.commentSortRow,children:[e.jsx("label",{htmlFor:"comment-sort",className:U.commentSortLabel,children:"Sort:"}),e.jsxs("select",{id:"comment-sort",className:U.commentSortSelect,value:Rt,onChange:e=>qt(e.target.value),"aria-label":"Comment sort order",children:[e.jsx("option",{value:"newest",children:"Newest"}),e.jsx("option",{value:"oldest",children:"Oldest"}),e.jsx("option",{value:"likes",children:"Most liked"}),e.jsx("option",{value:"score",children:"Score (↑ − ↓)"}),e.jsx("option",{value:"controversial",children:"Controversial"}),e.jsx("option",{value:"best",children:"Best"})]})]}),e.jsx("div",{onFocusCapture:e=>{if(M)return;const t=e.target,s=t.closest?.("[data-comment-uri]");if(!s)return;const o=s.getAttribute("data-comment-uri");if(!o)return;const n=t.closest?.("[data-media-item]");if(n){const e=n.getAttribute("data-media-item");if(null!=e){const t=ws.findIndex(t=>"commentMedia"===t.type&&t.commentUri===o&&t.mediaIndex===parseInt(e,10));t>=0&&St(t)}return}const a=ws.findIndex(e=>"comment"===e.type&&e.commentUri===o);if(a>=0){St(a);const e=Ns.findIndex(e=>e.uri===o);e>=0&&Ct(e)}},children:gs.map((t,s)=>{const o=ws[Lt],n="comment"===o?.type||"commentMedia"===o?.type?o.commentUri:void 0,a=ws.findIndex(e=>"comment"===e.type&&e.commentUri===t.post.uri),r=hs&&"comment"===o?.type&&o.commentUri===t.post.uri;if(ye.has(t.post.uri)){const o="replies"in t&&Array.isArray(t.replies)?t.replies.length:0,n=0===o?"Comment":`${o} reply${1!==o?"s":""}`,i=t.post.author?.handle??t.post.author?.did??"";return e.jsx("div",{className:U.topLevelCommentWrap,"data-comment-uri":t.post.uri,tabIndex:-1,onMouseEnter:()=>{!M&&a>=0&&(St(a),Ct(Ns.findIndex(e=>e.uri===t.post.uri)))},children:e.jsx("div",{className:`${U.collapsedCommentWrap} ${r?U.commentFocused:""}`,style:{marginLeft:0},onFocus:()=>!M&&a>=0&&St(a),children:e.jsxs("button",{type:"button",className:U.collapsedCommentBtn,onClick:()=>Zt(t.post.uri),children:[e.jsx("span",{className:U.collapsedCommentExpandIcon,"aria-hidden":!0,children:"+"}),t.post.author?.avatar?e.jsx("img",{src:t.post.author.avatar,alt:"",className:U.collapsedCommentAvatar,loading:"lazy"}):e.jsx("span",{className:U.collapsedCommentAvatarPlaceholder,"aria-hidden":!0,children:i.slice(0,1).toUpperCase()}),e.jsxs("span",{className:U.collapsedCommentHandle,children:["@",i]}),e.jsx("span",{className:U.collapsedCommentLabel,children:n})]})})},`${t.post.uri}-${s}`)}return e.jsx("div",{className:U.topLevelCommentWrap,onMouseEnter:()=>{!M&&a>=0&&(St(a),Ct(Ns.findIndex(e=>e.uri===t.post.uri)))},children:e.jsx(J,{node:t,depth:0,collapsedThreads:ye,onToggleCollapse:Zt,onReply:is,rootPostUri:ne.post.uri,rootPostCid:ne.post.cid,replyingTo:Ie,replyComment:de,setReplyComment:ue,onReplySubmit:rs,replyPosting:me,clearReplyingTo:()=>Ue(null),commentFormRef:yt,replyAs:zt,sessionsList:$t,switchAccount:Bt,currentDid:Tt?.did??void 0,focusedCommentUri:n,onCommentMediaFocus:As,onLike:Tt?ls:void 0,onDownvote:Tt?cs:void 0,likeOverrides:Me,myDownvotes:Te,downvoteCounts:Be,downvoteCountOptimisticDelta:Ve,likeLoadingUri:We,downvoteLoadingUri:Qe,openActionsMenuCommentUri:_e,onActionsMenuOpenChange:(e,t)=>Xe(t?e:null),onViewQuotes:te})},`${t.post.uri}-${s}`)})})]}),ne&&W(ne)&&"replies"in ne&&Array.isArray(ne.replies)&&ne.replies.length>=6&&(!Ie||Ie.uri===ne.post.uri)&&e.jsx("div",{className:U.inlineReplyFormWrap,children:e.jsx("div",{ref:jt,tabIndex:-1,className:At?U.commentFormWrapFocused:void 0,onFocus:()=>!M&&St(ws.length-1),onMouseEnter:()=>!M&&St(ws.length-1),onBlur:()=>{requestAnimationFrame(()=>{yt.current?.contains(document.activeElement)||kt(!1)})},children:e.jsxs("form",{ref:yt,onSubmit:rs,className:U.commentForm,children:[zt&&e.jsxs("div",{className:U.inlineReplyFormHeader,children:[Ie&&e.jsx("button",{type:"button",className:U.cancelReply,onClick:()=>Ue(null),"aria-label":"Cancel reply",children:"×"}),$t&&Tt?.did?e.jsx(z,{replyAs:zt,sessionsList:$t,switchAccount:Bt,currentDid:Tt.did}):e.jsxs("p",{className:U.replyAs,children:[e.jsx("span",{className:U.replyAsLabel,children:"Replying as"}),e.jsxs("span",{className:U.replyAsUserChip,children:[zt.avatar?e.jsx("img",{src:zt.avatar,alt:"",className:U.replyAsAvatar,loading:"lazy"}):e.jsx("span",{className:U.replyAsAvatarPlaceholder,"aria-hidden":!0,children:zt.handle.slice(0,1).toUpperCase()}),e.jsxs("span",{className:U.replyAsHandle,children:["@",zt.handle]})]})]})]}),e.jsx(R,{placeholder:Ie?`Reply to @${Ie.handle}…`:"Write a comment…",value:de,onChange:ue,onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),de.trim()&&!me&&yt.current?.requestSubmit())},className:U.textarea,rows:3,maxLength:300}),e.jsx("p",{className:U.hint,children:"⌘ Enter or ⌘ E to post"}),e.jsx("button",{type:"submit",className:U.submit,disabled:me||!de.trim(),children:me?"Posting…":"Post comment"})]})})})]}),st&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:U.quoteComposerBackdrop,onClick:os,"aria-hidden":!0}),e.jsx("div",{className:U.quoteComposerOverlay,role:"dialog","aria-label":"Quote post",onClick:os,onDragOver:e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"},onDrop:e=>{e.preventDefault(),e.dataTransfer?.files?.length&&ss(e.dataTransfer.files)},children:e.jsxs("div",{className:U.quoteComposerCard,onClick:e=>e.stopPropagation(),children:[e.jsx("h2",{className:U.quoteComposerTitle,children:"Quote post"}),Ft?.did?e.jsxs(e.Fragment,{children:[ne&&W(ne)&&(()=>{const t=ne.post,s=t.author?.handle??t.author?.did??"",o=t.record?.text??"",n=l(t)[0];return e.jsxs("div",{className:U.quoteComposerQuotedWrap,children:[e.jsx("p",{className:U.quotedPostLabel,children:"Quoting"}),e.jsxs("div",{className:U.quoteComposerQuotedCard,children:[e.jsxs("div",{className:U.quotedPostHead,children:[t.author?.avatar?e.jsx("img",{src:t.author.avatar,alt:"",className:U.quotedPostAvatar,loading:"lazy"}):e.jsx("span",{className:U.quotedPostAvatarPlaceholder,"aria-hidden":!0,children:s.slice(0,1).toUpperCase()}),e.jsxs("span",{className:U.quotedPostHandle,children:["@",s]}),t.record?.createdAt&&e.jsx("span",{className:U.quotedPostTime,title:P(t.record.createdAt),children:k(t.record.createdAt)})]}),n&&e.jsx("div",{className:U.quotedPostMedia,children:"image"===n.type?e.jsx("img",{src:n.url,alt:"",loading:"lazy",className:U.quotedPostThumb}):n.videoPlaylist?e.jsx("div",{className:U.quotedPostVideoThumb,style:{backgroundImage:n.url?`url(${n.url})`:void 0}}):null}),o?e.jsx("p",{className:U.quotedPostText,children:e.jsx(E,{text:o,facets:t.record?.facets,maxLength:300,stopPropagation:!0})}):null]})]})})(),e.jsxs("form",{onSubmit:ns,onKeyDown:e=>{(e.metaKey||e.ctrlKey)&&"Enter"===e.key&&(e.preventDefault(),ns(e))},children:[e.jsx(R,{className:U.quoteComposerTextarea,value:nt,onChange:at,placeholder:"Add your thoughts...",rows:4,maxLength:300,disabled:dt,autoFocus:!0}),rt.length>0&&e.jsxs("div",{className:U.quoteComposerMediaSection,children:[e.jsx("div",{className:U.quoteComposerPreviews,children:rt.map((t,s)=>e.jsxs("div",{className:U.quoteComposerPreviewWrap,children:[e.jsx("img",{src:us[s],alt:"",className:U.quoteComposerPreviewImg}),e.jsx("button",{type:"button",className:U.quoteComposerPreviewRemove,onClick:()=>{return e=s,it(t=>t.filter((t,s)=>s!==e)),void ct(t=>t.filter((t,s)=>s!==e));var e},"aria-label":"Remove image",disabled:dt,children:"×"})]},s))}),e.jsx("p",{className:U.quoteComposerAltPrompt,children:"Describe each image for accessibility (alt text)."}),e.jsx("div",{className:U.quoteComposerAltFields,children:rt.map((t,s)=>e.jsxs("div",{className:U.quoteComposerAltRow,children:[e.jsxs("label",{htmlFor:`quote-alt-${s}`,className:U.quoteComposerAltLabel,children:["Image ",s+1]}),e.jsx("input",{id:`quote-alt-${s}`,type:"text",className:U.quoteComposerAltInput,placeholder:"Describe this image",value:lt[s]??"",onChange:e=>{const t=e.target.value.slice(0,1e3);ct(e=>{const o=[...e];for(;o.length<rt.length;)o.push("");return o[s]=t,o})},maxLength:1e3,disabled:dt})]},s))})]}),e.jsxs("div",{className:U.quoteComposerFooter,children:[e.jsxs("div",{className:U.quoteComposerFooterLeft,children:[e.jsx("input",{ref:ht,type:"file",accept:"image/jpeg,image/png,image/gif,image/webp",multiple:!0,className:U.quoteComposerFileInput,onChange:e=>{e.target.files?.length&&ss(e.target.files),e.target.value=""}}),e.jsx("button",{type:"button",className:U.quoteComposerAddMedia,onClick:()=>ht.current?.click(),disabled:dt||rt.length>=4,title:"Add photo","aria-label":"Add photo",children:"Add media"}),e.jsx(q,{used:nt.length,max:300})]}),e.jsxs("div",{className:U.quoteComposerActions,children:[e.jsx("button",{type:"button",className:U.quoteComposerCancel,onClick:os,disabled:dt,children:"Cancel"}),e.jsx("button",{type:"submit",className:U.quoteComposerSubmit,disabled:dt||!nt.trim()&&0===rt.length,children:dt?"Posting…":"Quote post"})]})]}),mt&&e.jsx("p",{className:U.quoteComposerError,children:mt})]})]}):e.jsx("p",{className:U.quoteComposerSignIn,children:"Log in to quote posts."})]})})]})]});return M?Rs:e.jsx(L,{title:"Post",showNav:!0,children:Rs})}const Z=Object.freeze(Object.defineProperty({__proto__:null,PostDetailContent:Y,ReplyAsRow:z,default:function(){const{uri:t}=y(),s=v(),o=j(),n=t?decodeURIComponent(t):"";return n?e.jsx(L,{title:"Post",showNav:!0,children:e.jsx(Y,{uri:n,initialOpenReply:o.state?.openReply})}):(s("/feed",{replace:!0}),null)}},Symbol.toStringTag,{value:"Module"}));export{Y as P,z as R,Z as a,F as g};
