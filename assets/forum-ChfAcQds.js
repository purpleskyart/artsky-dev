import{g as t,a3 as r,b as e,z as o,a4 as a}from"./index-DUt1g_SH.js";const i=[],d="app.artsky.forum.post",n="app.artsky.forum.reply",c="app.artsky.forum.wiki",s="artsky-forum-drafts";async function l(r){const o=t();if(!o?.did)throw new Error("Not logged in");const a=`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,i=await e.com.atproto.repo.putRecord({repo:o.did,collection:d,rkey:a,record:{$type:d,title:r.title.trim(),body:r.body.trim(),tags:r.tags??[],createdAt:(new Date).toISOString()},validate:!1});return{uri:i.data.uri,cid:i.data.cid}}async function u(){const o=t();if(!o?.did)return[];const a=e,d=new Set([o.did,...i]);try{const{dids:t}=await r(a,o.did,{limit:100});t.forEach(t=>d.add(t))}catch{}const n=new Map;await Promise.all(Array.from(d).map(async t=>{try{const{posts:r}=await p(t,{limit:20});for(const t of r)n.has(t.uri)||n.set(t.uri,t)}catch{}}));const c=Array.from(n.values());return c.sort((t,r)=>{const e=new Date(t.createdAt??0).getTime();return new Date(r.createdAt??0).getTime()-e}),c}async function p(r,a){const i=t()?e:o;try{const t=await i.com.atproto.repo.listRecords({repo:r,collection:d,limit:a?.limit??30,cursor:a?.cursor,reverse:!0});return{posts:(t.data.records??[]).map(t=>{const e=t.value,o=t.uri.split("/").pop()??"";return{uri:t.uri,cid:t.cid,did:r,rkey:o,title:e.title,body:e.body,tags:e.tags,createdAt:e.createdAt,isPinned:e.isPinned,isWiki:e.isWiki}}),cursor:t.data.cursor}}catch{return{posts:[],cursor:void 0}}}async function y(r){const i=a(r);if(!i)return null;const n=t()?e:o;try{const t=await n.com.atproto.repo.getRecord({repo:i.did,collection:d,rkey:i.rkey}),r=t.data.value;let e,o;try{const t=(await n.getProfile({actor:i.did})).data;e=t.handle,o=t.avatar}catch{}return{uri:t.data.uri,cid:t.data.cid,did:i.did,rkey:i.rkey,title:r.title,body:r.body,tags:r.tags,createdAt:r.createdAt,isPinned:r.isPinned,isWiki:r.isWiki,authorHandle:e,authorAvatar:o}}catch{return null}}async function w(r,o){const a=await y(r);if(!a)throw new Error("Post not found");const i=t();if(!i?.did||i.did!==a.did)throw new Error("Not authorized");await e.com.atproto.repo.putRecord({repo:i.did,collection:d,rkey:a.rkey,record:{$type:d,title:(o.title??a.title??"").trim(),body:(o.body??a.body??"").trim(),tags:o.tags??a.tags??[],createdAt:a.createdAt,isPinned:a.isPinned,isWiki:a.isWiki,editedAt:(new Date).toISOString()},validate:!1})}async function g(r){const o=t();if(!o?.did)throw new Error("Not logged in");const i=a(r);if(!i)throw new Error("Invalid URI");await e.com.atproto.repo.deleteRecord({repo:o.did,collection:d,rkey:i.rkey})}async function f(r){const o=t();if(!o?.did)throw new Error("Not logged in");const a=`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,i=await e.com.atproto.repo.putRecord({repo:o.did,collection:n,rkey:a,record:{$type:n,subject:r.postUri,replyTo:r.replyToUri,text:r.text.trim(),createdAt:(new Date).toISOString()},validate:!1});return{uri:i.data.uri,cid:i.data.cid}}async function m(r,a=[]){const i=t()?e:o,d=t(),c=[...new Set([...d?.did?[d.did]:[],...a])],s=[],l=new Set;for(const t of c)try{const e=await i.com.atproto.repo.listRecords({repo:t,collection:n,limit:100});for(const o of e.data.records??[]){const e=o.value;if(e.subject!==r||l.has(o.uri))continue;l.add(o.uri);let a={did:t,handle:t};try{const r=(await i.getProfile({actor:t})).data;a={did:t,handle:r.handle??t,avatar:r.avatar,displayName:r.displayName}}catch{}s.push({uri:o.uri,cid:o.cid,replyTo:e.replyTo,author:a,record:{text:e.text,createdAt:e.createdAt},isComment:!0})}}catch{}return s.sort((t,r)=>new Date(t.record?.createdAt??0).getTime()-new Date(r.record?.createdAt??0).getTime()),s}async function h(r){const o=await y(r);if(!o)throw new Error("Post not found");const a=t();if(!a?.did)throw new Error("Not logged in");const i=`wiki-${Date.now().toString(36)}`;await e.com.atproto.repo.putRecord({repo:a.did,collection:c,rkey:i,record:{$type:c,sourcePost:r,title:o.title,body:o.body,tags:o.tags,createdAt:(new Date).toISOString(),lastEditedAt:(new Date).toISOString()},validate:!1}),await e.com.atproto.repo.putRecord({repo:a.did,collection:d,rkey:o.rkey,record:{$type:d,title:o.title,body:o.body,tags:o.tags,createdAt:o.createdAt,isPinned:o.isPinned,isWiki:!0},validate:!1})}function k(t){const r=function(){try{const t=localStorage.getItem(s);return t?JSON.parse(t):[]}catch{return[]}}(),e={id:`draft-${Date.now()}`,...t,savedAt:(new Date).toISOString()};r.push(e);try{localStorage.setItem(s,JSON.stringify(r))}catch{}return e}export{p as a,m as b,l as c,g as d,w as e,f,y as g,u as l,h as p,k as s};
