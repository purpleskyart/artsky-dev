import{u as e,g as t,a as n,b as s,c as r,d as o,j as i,e as a,f as l,i as c,h as d,k as u,l as f,m as p,n as m,o as h,p as g,q as y,r as x,s as w,t as _,v,w as b,x as E,y as M}from"./index-Cos7Ao7g.js";import{b as j,h as S,u as N,d as k,i as T}from"./react-vendor-DGaPsC2e.js";import{u as I,F as A,L as R}from"./Layout-C96F8kdd.js";import{u as C}from"./usePullToRefresh-DVlCPYCP.js";import{P as O}from"./PostCard-DKMnmYb4.js";import{setInitialPostForUri as F}from"./postCache-CTqU0alO.js";import{s as P}from"./FeedPage.module-BzgruK7v.js";import"./atproto-3-1TCh3S.js";import"./Icons-BNUJF1V_.js";import"./PostText-BK2IkZic.js";import"./PostActionsMenu-BFlvRje_.js";import"./date-Ct-NsrQr.js";import"./artboards-DNvSVVrd.js";import"./artboardsPds-DWUixJ9h.js";function L(e,t){let n;return function(...s){void 0!==n&&clearTimeout(n),n=setTimeout(()=>{n=void 0,e(...s)},t)}}function U(e,t=150){const n=function(e=150){const[t,n]=j.useState(()=>"undefined"!=typeof window?window.innerWidth:0);return j.useEffect(()=>{const t=L(()=>{n(window.innerWidth)},e);return n(window.innerWidth),window.addEventListener("resize",t,{passive:!0}),()=>{window.removeEventListener("resize",t)}},[e]),t}(t);return j.useMemo(()=>{const t="1"===e?1:"2"===e?2:3;return Math.min(3,Math.max(1,t))},[e,n])}const D="artsky-recommendations-shown";function H(){try{const e=localStorage.getItem(D);if(!e)return{};const t=JSON.parse(e);return"object"==typeof t&&null!==t?t:{}}catch{return{}}}const B="_wrap_ljlgs_1",Y="_subtext_ljlgs_10",z="_sortRow_ljlgs_18",$="_sortLabel_ljlgs_26",q="_sortSelect_ljlgs_31",K="_loading_ljlgs_46",W="_empty_ljlgs_47",G="_list_ljlgs_54",V="_item_ljlgs_65",J="_profileBtn_ljlgs_72",X="_avatar_ljlgs_97",Q="_avatarPlaceholder_ljlgs_106",Z="_info_ljlgs_121",ee="_handle_ljlgs_127",te="_reason_ljlgs_135",ne="_actions_ljlgs_140",se="_infoBtn_ljlgs_150",re="_infoIcon_ljlgs_174",oe="_followBtn_ljlgs_179",ie="_dismissBtn_ljlgs_199",ae="_detailBackdrop_ljlgs_226",le="_detailPanel_ljlgs_237",ce="_detailHeader_ljlgs_250",de="_detailTitle_ljlgs_258",ue="_detailClose_ljlgs_265",fe="_detailBody_ljlgs_284",pe="_detailSummary_ljlgs_289",me="_detailList_ljlgs_295",he="_detailListItem_ljlgs_304",ge="_detailProfileBtn_ljlgs_308",ye="_detailAvatar_ljlgs_332",xe="_detailAvatarPlaceholder_ljlgs_340",we="_detailProfileInfo_ljlgs_354",_e="_detailDisplayName_ljlgs_360",ve="_detailHandle_ljlgs_368",be="_detailLoading_ljlgs_376";function Ee(){const{openProfileModal:a}=e(),[l,c]=j.useState([]),[d,u]=j.useState(!1),[f,p]=j.useState(null),[m,h]=j.useState(()=>new Set),[g,y]=j.useState("count"),[x,w]=j.useState(null),[_,v]=j.useState(null),[b,E]=j.useState(!1),M=j.useMemo(()=>l,[l]),N=j.useCallback(async()=>{const e=t(),o=e?.did;if(o){u(!0);try{const e="mutuals"===g?await n(s,o,{maxSuggestions:20}):await r(s,o,{maxSuggestions:20}),t=H(),i=Date.now()-6048e5,a=e.filter(e=>!m.has(e.did)&&(!t[e.did]||t[e.did]<i)).slice(0,8);c(a)}catch{c([])}finally{u(!1)}}},[m,g]);j.useEffect(()=>{N()},[N]);const k=j.useCallback(async e=>{w(e.did),v(null),E(!0);try{const n=t(),r=n?.did;if(!r)return;const i=await o(s,r,e.did,{source:"mutuals"===g?"mutuals":"peopleYouFollow"});v(i)}catch{v({count:0,followedBy:[]})}finally{E(!1)}},[g]),T=j.useCallback(async(e,t)=>{p(e);try{await s.follow(e),c(t=>t.filter(t=>t.did!==e))}catch{}finally{p(null)}},[]),I=j.useCallback(e=>{!function(e){if(0===e.length)return;const t=Date.now(),n={...H()};for(const o of e)n[o]=t;const s=Object.entries(n),r=s.length<=500?s:s.sort((e,t)=>(t[1]??0)-(e[1]??0)).slice(0,500);try{localStorage.setItem(D,JSON.stringify(Object.fromEntries(r)))}catch{}}([e]),h(t=>new Set(t).add(e)),c(t=>t.filter(t=>t.did!==e))},[]),A=x?l.find(e=>e.did===x):null;return i.jsxs("div",{className:B,"aria-label":"Suggested accounts to follow",children:[i.jsx("p",{className:Y,children:"Accounts followed by people you follow. New suggestions each time you open."}),l.length>0&&i.jsxs("div",{className:z,children:[i.jsx("span",{className:$,children:"Sort by:"}),i.jsxs("select",{className:q,value:g,onChange:e=>y(e.target.value),"aria-label":"Sort suggestions",children:[i.jsx("option",{value:"count",children:"Most followed by people you follow"}),i.jsx("option",{value:"mutuals",children:"Most followed by mutuals"})]})]}),d&&0===l.length?i.jsx("p",{className:K,children:"Loading…"}):0===l.length?i.jsx("p",{className:W,children:"No suggestions right now. Follow more accounts to see recommendations."}):i.jsx("ul",{className:G,children:M.map(e=>i.jsxs("li",{className:V,children:[i.jsxs("button",{type:"button",className:J,onClick:()=>a(e.handle),"aria-label":`View @${e.handle} profile`,children:[e.avatar?i.jsx("img",{src:e.avatar,alt:"",className:X,loading:"lazy"}):i.jsx("span",{className:Q,"aria-hidden":!0,children:(e.displayName??e.handle).slice(0,1).toUpperCase()}),i.jsxs("span",{className:Z,children:[i.jsxs("span",{className:ee,children:["@",e.handle]}),i.jsx("span",{className:te,children:"mutuals"===g?1===e.count?"Followed by 1 mutual":`Followed by ${e.count} mutuals`:1===e.count?"Followed by 1 person you follow":`Followed by ${e.count} people you follow`})]})]}),i.jsxs("div",{className:ne,children:[i.jsx("button",{type:"button",className:se,onClick:t=>{t.stopPropagation(),k(e)},"aria-label":"Why we recommend this account",title:"Why we recommend this account",children:i.jsx(Me,{})}),i.jsx("button",{type:"button",className:oe,onClick:()=>T(e.did,e.handle),disabled:f===e.did,children:f===e.did?"…":"Follow"}),i.jsx("button",{type:"button",className:ie,onClick:()=>I(e.did),"aria-label":"Not now",title:"Hide this suggestion for a week",children:"×"})]})]},e.did))}),x&&A&&S.createPortal(i.jsx("div",{className:ae,role:"dialog","aria-modal":"true","aria-labelledby":"suggestion-detail-title",onClick:()=>w(null),children:i.jsxs("div",{className:le,onClick:e=>e.stopPropagation(),children:[i.jsxs("div",{className:ce,children:[i.jsxs("h3",{id:"suggestion-detail-title",className:de,children:["Why we recommend @",A.handle]}),i.jsx("button",{type:"button",className:ue,onClick:()=>w(null),"aria-label":"Close",children:"×"})]}),b?i.jsx("p",{className:be,children:"Loading…"}):_?i.jsxs("div",{className:fe,children:[i.jsx("p",{className:pe,children:_.fromMutuals?1===_.count?"Followed by 1 mutual:":`Followed by ${_.count} mutuals:`:1===_.count?"Followed by 1 person you follow:":`Followed by ${_.count} people you follow:`}),i.jsx("ul",{className:me,children:_.followedBy.map(e=>i.jsx("li",{className:he,children:i.jsxs("button",{type:"button",className:ge,onClick:()=>{a(e.handle),w(null)},children:[e.avatar?i.jsx("img",{src:e.avatar,alt:"",className:ye,loading:"lazy"}):i.jsx("span",{className:xe,"aria-hidden":!0,children:(e.displayName??e.handle).slice(0,1).toUpperCase()}),i.jsxs("span",{className:we,children:[e.displayName&&i.jsx("span",{className:_e,children:e.displayName}),i.jsxs("span",{className:ve,children:["@",e.handle]})]})]})},e.did))})]}):null]})}),document.body)]})}function Me(){return i.jsx("svg",{className:re,viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":!0,children:i.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})}const je=j.memo(function(e){const t=j.useRef(null);return function(e,t){const[n,s]=j.useState(!0),r=j.useRef(null);j.useEffect(()=>{const n=e.current;if(n)return r.current=new IntersectionObserver(e=>{for(const t of e)s(t.isIntersecting)},{rootMargin:t?.rootMargin??"400px 0px 400px 0px",threshold:t?.threshold??0,...t}),r.current.observe(n),()=>{r.current&&(r.current.disconnect(),r.current=null)}},[e,t])}(t,{rootMargin:"1200px 0px 1200px 0px",threshold:0}),i.jsx(O,{...e,cardRef:n=>{t.current=n,e.cardRef(n)},onAspectRatio:void 0})}),Se="_wrap_a6pg0_1",Ne="_seen_a6pg0_11",ke="_header_a6pg0_15",Te="_repostIcon_a6pg0_25",Ie="_title_a6pg0_32",Ae="_scrollWrap_a6pg0_38",Re="_track_a6pg0_54",Ce="_tile_a6pg0_60",Oe="_tileImg_a6pg0_86",Fe="_tilePlaceholder_a6pg0_94",Pe="_tileHandle_a6pg0_107";function Le(){return i.jsx("svg",{className:Te,viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":!0,children:i.jsx("path",{d:"M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"})})}function Ue({items:e,onPostClick:t,cardRef:n,seen:s,"data-post-uri":r}){if(0===e.length)return null;const o=e=>e.reason?.by;return i.jsxs("div",{ref:n,className:`${Se} ${s?Ne:""}`,"data-post-uri":r??e[0]?.post?.uri,role:"article","aria-label":`${e.length} reposts`,children:[i.jsxs("div",{className:ke,children:[i.jsx(Le,{}),i.jsxs("span",{className:Ie,children:[e.length," reposts"]})]}),i.jsx("div",{className:Ae,children:i.jsx("div",{className:Re,children:e.map(e=>{const n=e.post.uri,s=(e=>o(e)?.handle??o(e)?.did??e.post.author?.handle??e.post.author?.did??"")(e),r=a(e.post),l=e.post.author?.avatar,c=r?.url??l;return i.jsxs("button",{type:"button",className:Ce,onClick:()=>t(n,{initialItem:e}),"aria-label":s?`Repost by @${s}, open post`:"Open post",children:[c?i.jsx("img",{src:c,alt:"",className:Oe,loading:"lazy"}):i.jsx("span",{className:Fe,children:(e.post.author?.displayName??s??e.post.author?.did??"?").slice(0,1).toUpperCase()}),s?i.jsxs("span",{className:Pe,children:["@",s]}):null]},n)})})})]})}const De=j.memo(function({entry:e,originalIndex:t,isSelected:n,focusedMediaIndex:s,openAddDropdown:r,actionsMenuOpenForIndex:o,nsfwPreference:a,unblurredUris:l,likeOverrides:d,seenUris:u,onMediaRef:f,onActionsMenuOpenChange:p,onMouseEnter:m,onAddClose:h,setUnblurred:g,setLikeOverrides:y,openPostModal:x,cardRef:w}){const _="post"===e.type?e.item.post.uri:e.items[0].post.uri;return i.jsx("div",{ref:w(t),className:P.gridItem,"data-selected":n||void 0,"data-post-uri":_,onMouseEnter:()=>m(t),children:"post"===e.type?i.jsx(je,{item:e.item,isSelected:n,focusedMediaIndex:s,onMediaRef:(e,n)=>f(t,e,n),cardRef:()=>{},openAddDropdown:r,onAddClose:h,onActionsMenuOpenChange:e=>p(t,e),cardIndex:t,actionsMenuOpenForIndex:o,onPostClick:(e,t)=>{t?.initialItem&&F(e,t.initialItem),x(e,t?.openReply)},fillCell:!1,nsfwBlurred:"blurred"===a&&c(e.item.post)&&!l.has(e.item.post.uri),onNsfwUnblur:()=>g(e.item.post.uri,!0),likedUriOverride:d[e.item.post.uri],onLikedChange:(e,t)=>y(e,t??null),seen:u.has(e.item.post.uri)}):i.jsx(Ue,{items:e.items,onPostClick:(e,t)=>{t?.initialItem&&F(e,t.initialItem),x(e)},cardRef:()=>{},seen:u.has(e.items[0].post.uri),"data-post-uri":e.items[0].post.uri})},_)},(e,t)=>{const n="post"===e.entry.type?e.entry.item.post.uri:e.entry.items[0].post.uri,s="post"===t.entry.type?t.entry.item.post.uri:t.entry.items[0].post.uri;return n===s&&(e.isSelected===t.isSelected&&(e.focusedMediaIndex===t.focusedMediaIndex&&(e.openAddDropdown===t.openAddDropdown&&(e.actionsMenuOpenForIndex===t.actionsMenuOpenForIndex&&(e.nsfwPreference===t.nsfwPreference&&(e.likeOverrides[n]===t.likeOverrides[s]&&(e.seenUris.has(n)===t.seenUris.has(s)&&e.unblurredUris.has(n)===t.unblurredUris.has(s))))))))}),He=j.memo(function({column:e,loadMoreSentinelRef:t,hasCursor:n,keyboardFocusIndex:s,focusTargets:r,focusSetByMouse:o,keyboardAddOpen:a,actionsMenuOpenForIndex:c,nsfwPreference:d,unblurredUris:u,setUnblurred:f,likeOverrides:p,setLikeOverrides:m,seenUris:h,openPostModal:g,cardRef:y,onMediaRef:x,onActionsMenuOpenChange:w,onMouseEnter:_,onAddClose:v}){if(0===e.length)return i.jsx("div",{className:P.gridColumn,children:n&&null!=t&&i.jsx("div",{ref:t,className:P.loadMoreSentinel,"aria-hidden":!0})});const b=r[s]?.cardIndex??-1;return i.jsxs("div",{className:P.gridColumn,children:[e.map(({entry:e,originalIndex:t})=>{const n=b===t,E=!n||o&&l("post"===e.type?e.item.post:e.items[0].post).length>1?void 0:r[s]?.mediaIndex;return i.jsx(De,{entry:e,originalIndex:t,isSelected:n,focusedMediaIndex:E,openAddDropdown:n&&a,actionsMenuOpenForIndex:c,nsfwPreference:d,unblurredUris:u,likeOverrides:p,seenUris:h,onMediaRef:x,onActionsMenuOpenChange:w,onMouseEnter:_,onAddClose:v,setUnblurred:f,setLikeOverrides:m,openPostModal:g,cardRef:y},"post"===e.type?e.item.post.uri:e.items[0].post.uri)}),n&&null!=t&&i.jsx("div",{ref:t,className:P.loadMoreSentinel,"aria-hidden":!0})]})});function Be(e,t){switch(t.type){case"SET_ITEMS":return{...e,items:t.items,cursor:t.cursor,loading:!1,error:null};case"APPEND_ITEMS":return{...e,items:[...e.items,...t.items],cursor:t.cursor,loadingMore:!1,error:null};case"UPDATE_ITEMS":return{...e,items:t.updater(e.items)};case"SET_LOADING":return{...e,loading:t.loading};case"SET_LOADING_MORE":return{...e,loadingMore:t.loadingMore};case"SET_ERROR":return{...e,error:t.error,loading:!1,loadingMore:!1};case"SET_KEYBOARD_FOCUS":return{...e,keyboardFocusIndex:t.index};case"SET_ACTIONS_MENU_OPEN":return{...e,actionsMenuOpenForIndex:t.index};case"MARK_SEEN":{const n=new Set(e.seenUris);if(t.uris.forEach(e=>n.add(e)),n.size>2500){const t=Array.from(n),s=new Set(t.slice(-2e3));return{...e,seenUris:s}}return{...e,seenUris:n}}case"RESET_SEEN_SNAPSHOT":return{...e,seenUrisAtReset:new Set(e.seenUris)};case"CLEAR_SEEN":return{...e,seenUris:new Set,seenUrisAtReset:new Set};default:return e}}function Ye(e){const t=new Set;return e.filter(e=>{const n=e?.post?.uri;return!(!n||t.has(n))&&(t.add(n),!0)})}const ze="artsky-seen-posts";function $e(){const e=h.get(ze);return e&&Array.isArray(e)?new Set(e):new Set}const qe=[{kind:"timeline",label:"Following"},{kind:"custom",label:"What's Hot",uri:"at://did:plc:z72i7hdynmk6r22z27h6tvur/app.bsky.feed.generator/whats-hot"}];function Ke(e){if("undefined"==typeof window)return()=>{};const t=window.matchMedia("(min-width: 768px)");return t.addEventListener("change",e),()=>t.removeEventListener("change",e)}function We(){return"undefined"!=typeof window&&window.innerWidth>=768}function Ge(e){return"app.bsky.feed.defs#reasonRepost"===e.reason?.$type}function Ve(e){const t=e.post.record?.createdAt,n=e.post.indexedAt,s=t??n??"";return s?new Date(s).getTime():0}function Je(e){const t=[];let n=0,s=[],r=0,o=0;function i(){if(s.length>=4)t.push({type:"carousel",items:[...s],entryIndex:n++});else for(const e of s)t.push({type:"post",item:e,entryIndex:n++});s=[]}for(const a of e){if(!Ge(a)){i(),t.push({type:"post",item:a,entryIndex:n++});continue}const e=Ve(a);if(0===s.length){s.push(a),r=e,o=e;continue}const l=Math.min(r,e),c=Math.max(o,e);c-l<=36e5?(s.push(a),r=l,o=c):(i(),s=[a],r=e,o=e)}return i(),t}function Xe(e){if("carousel"===e.type)return 200;const t=a(e.item.post);return t?null!=t.aspectRatio&&t.aspectRatio>0?100+280/t.aspectRatio:320:180}function Qe(e,t){const n=Math.max(e.top,t.top),s=Math.min(e.bottom,t.bottom);return Math.max(0,s-n)}function Ze(){const t=N(),n=k(),r=T(),o=j.useSyncExternalStore(Ke,We,()=>!1),{openLoginModal:S}=d(),{session:O}=u(),{viewMode:F}=f(),[D,H]=j.useState(qe[0]),[,B]=j.useState([]),{likeOverrides:Y,setLikeOverride:z}=p(),[$,q]=j.useReducer(Be,{items:[],cursor:void 0,loading:!0,loadingMore:!1,error:null,keyboardFocusIndex:-1,actionsMenuOpenForIndex:null,seenUris:$e(),seenUrisAtReset:new Set}),K=j.useRef([]),W=j.useRef(!1),G=j.useRef(0),[V,J]=j.useState(!1),{openPostModal:X,isModalOpen:Q}=e(),Z=j.useRef([]),ee=j.useRef({}),te=j.useRef([]),ne=j.useRef(-1),se=j.useRef(null),re=j.useRef(-1),oe=j.useRef(!1),ie=j.useRef(!1),[ae,le]=j.useState(!1),[ce,de]=j.useState(!1),[ue,fe]=j.useState(null),pe=j.useRef(null),me=j.useRef(null),he=j.useRef(t.pathname),ge=j.useRef($.seenUris);ge.current=$.seenUris;const ye=m(),[xe,we]=j.useState(!1),_e=j.useRef(null);j.useEffect(()=>{if(ye)return ye.setClearSeenHandler(()=>{requestAnimationFrame(()=>{h.remove(ze),ge.current=new Set,q({type:"CLEAR_SEEN"})})}),()=>{ye.setClearSeenHandler(null)}},[ye]),j.useEffect(()=>{if(ye)return ye.setHomeClickHandler(()=>{requestAnimationFrame(()=>{window.scrollTo(0,0)})}),()=>{ye.setHomeClickHandler(null)}},[ye]),j.useEffect(()=>{if(ye)return ye.setHideSeenOnlyHandler(e=>{requestAnimationFrame(()=>{const t=ge.current.size;q({type:"RESET_SEEN_SNAPSHOT"}),e(0===t?"No read posts in feed":`${t} read posts hidden`)})}),()=>{ye.setHideSeenOnlyHandler(null)}},[ye]);const ve=j.useCallback(async()=>{if(O)try{const e=(await g()).filter(e=>"feed"===e.type&&e.pinned),t=await Promise.all(e.map(async e=>({kind:"custom",label:await y(e.value).catch(()=>e.value),uri:e.value})));B(t)}catch{B([])}else B([])},[O]);j.useEffect(()=>{ve()},[ve]),j.useEffect(()=>{let e;let t="undefined"!=typeof window?window.scrollY:0,n=t;const s=L(()=>{const s=window.scrollY,r=document.body.classList.contains("feed-scrolling"),o=s<n;if(n=s,o)return r&&(document.body.classList.remove("feed-scrolling"),e&&(clearTimeout(e),e=void 0)),void(t=s);r?(e&&clearTimeout(e),e=setTimeout(()=>{document.body.classList.remove("feed-scrolling"),t=window.scrollY,e=void 0},200)):s-t>=48&&(document.body.classList.add("feed-scrolling"),e&&clearTimeout(e),e=setTimeout(()=>{document.body.classList.remove("feed-scrolling"),t=window.scrollY,e=void 0},200))},16);return window.addEventListener("scroll",s,{passive:!0}),()=>{window.removeEventListener("scroll",s),e&&clearTimeout(e),document.body.classList.remove("feed-scrolling")}},[]),j.useEffect(()=>{const e=he.current!==t.pathname;he.current=t.pathname,"POP"!==r&&e&&window.scrollTo(0,0)},[t.pathname,r]),j.useEffect(()=>{const e=t.state?.feedSource;e&&(H(e),n(t.pathname,{replace:!0}))},[t.state,t.pathname,n]);const{entries:be,totalPercent:Me}=x(),je=I(),Se=j.useRef(null),Ne=j.useRef("unknown"),ke=j.useRef([]);ke.current=$.items;const Te=j.useCallback(async(e,t)=>{const n=Math.min(3,Math.max(1,"1"===F?1:"2"===F?2:3)),r=n>=2?10*n:30;if(!e&&window.scrollY>100)q({type:"SET_LOADING",loading:!1});else try{if(t?.aborted)return;if(q(e?{type:"SET_LOADING_MORE",loadingMore:!0}:{type:"SET_LOADING",loading:!0}),q({type:"SET_ERROR",error:null}),O){if(be.length>=2&&Me>=99){const n=!!e;let s;if(n&&e)try{s=JSON.parse(e)}catch{s=void 0}const{feed:o,cursors:i}=await _(be.map(e=>({source:e.source,percent:e.percent})),r,s,t);if(t?.aborted)return;const a=()=>{const e=Ye(n?[...ke.current,...o]:o),t=Object.keys(i).length>0?JSON.stringify(i):void 0;q(n?{type:"APPEND_ITEMS",items:o,cursor:t}:{type:"SET_ITEMS",items:e,cursor:t})};n?j.startTransition(a):a()}else if(1===be.length){const t=be[0].source;if("timeline"===t.kind){const t=await s.getTimeline({limit:r,cursor:e}),n=()=>{const n=Ye(e?[...ke.current,...t.data.feed]:t.data.feed);q(e?{type:"APPEND_ITEMS",items:t.data.feed,cursor:t.data.cursor}:{type:"SET_ITEMS",items:n,cursor:t.data.cursor})};e?j.startTransition(n):n()}else if(t.uri){const n=await s.app.bsky.feed.getFeed({feed:t.uri,limit:r,cursor:e}),o=()=>{const t=Ye(e?[...ke.current,...n.data.feed]:n.data.feed);q(e?{type:"APPEND_ITEMS",items:n.data.feed,cursor:n.data.cursor}:{type:"SET_ITEMS",items:t,cursor:n.data.cursor})};e?j.startTransition(o):o()}}else if("timeline"===D.kind){const t=await s.getTimeline({limit:r,cursor:e}),n=()=>{const n=Ye(e?[...ke.current,...t.data.feed]:t.data.feed);q(e?{type:"APPEND_ITEMS",items:t.data.feed,cursor:t.data.cursor}:{type:"SET_ITEMS",items:n,cursor:t.data.cursor})};e?j.startTransition(n):n()}else if(D.uri){const t=await s.app.bsky.feed.getFeed({feed:D.uri,limit:r,cursor:e}),n=()=>{const n=Ye(e?[...ke.current,...t.data.feed]:t.data.feed);q(e?{type:"APPEND_ITEMS",items:t.data.feed,cursor:t.data.cursor}:{type:"SET_ITEMS",items:n,cursor:t.data.cursor})};e?j.startTransition(n):n()}}else{const{feed:n,cursor:s}=await w(r,e);if(t?.aborted)return;const o=()=>{const t=Ye(e?[...ke.current,...n]:n);q(e?{type:"APPEND_ITEMS",items:n,cursor:s}:{type:"SET_ITEMS",items:t,cursor:s})};e?j.startTransition(o):o()}}catch(o){const e=o instanceof Error?o.message:"Failed to load feed";q({type:"SET_ERROR",error:e})}finally{q({type:"SET_LOADING",loading:!1}),q({type:"SET_LOADING_MORE",loadingMore:!1})}},[D,O,be,Me]);j.useEffect(()=>{const e=new AbortController;return Te(void 0,e.signal),()=>{e.abort()}},[Te]);W.current=$.loadingMore,j.useEffect(()=>{if(!$.cursor)return;const e=K.current;let t=0,n=0,s=0;const r=Math.min(3,Math.max(1,"1"===F?1:"2"===F?2:3)),o=()=>{clearTimeout(s);const t=Math.max(50,1800-(Date.now()-G.current)+50);s=window.setTimeout(()=>{W.current||(()=>{for(let t=0;t<r;t++){const n=e[t];if(n&&n.getBoundingClientRect().bottom<window.innerHeight)return!0}return!1})()&&(W.current=!0,G.current=Date.now(),Te($.cursor))},t)},i=new IntersectionObserver(e=>{for(const s of e){if(!s.isIntersecting||W.current)continue;if(Date.now()-G.current<1800){o();continue}W.current=!0;const e=$.cursor;t=requestAnimationFrame(()=>{t=0,n=window.setTimeout(()=>{n=0,G.current=Date.now(),Te(e)},120)});break}},{rootMargin:"600px",threshold:0});for(let a=0;a<r;a++){const t=e[a];t&&i.observe(t)}return r>1&&o(),()=>{i.disconnect(),t&&cancelAnimationFrame(t),n&&clearTimeout(n),clearTimeout(s)}},[$.cursor,Te,F]);const{mediaMode:Ie}=v(),{nsfwPreference:Ae,unblurredUris:Re,setUnblurred:Ce}=b(),{hideRepostsFromDids:Oe}=E()??{hideRepostsFromDids:[]},Fe=j.useMemo(()=>$.items.filter(e=>"media"!==Ie||a(e.post)).filter(e=>!$.seenUrisAtReset.has(e.post.uri)).filter(e=>"sfw"!==Ae||!c(e.post)).filter(e=>{if(!Ge(e))return!0;const t=e.reason?.by?.did;return!t||!Oe.includes(t)}),[$.items,Ie,$.seenUrisAtReset,Ae,Oe]),Pe=j.useMemo(()=>Je(Fe),[Fe]),Le=j.useMemo(()=>$.items.filter(e=>"media"!==Ie||a(e.post)).filter(e=>"sfw"!==Ae||!c(e.post)),[$.items,Ie,Ae]),Ue=0===Pe.length&&Le.length>0&&!$.cursor,De=0===Pe.length&&null!=$.cursor,Ve=U(F,150),Ze=j.useRef([]),et=j.useRef(0),tt=j.useRef(0);j.useEffect(()=>{Ze.current=[],et.current=0,tt.current=0},[D,Ie,Ae]);const nt=j.useMemo(()=>{Ve!==tt.current&&(Ze.current=[],et.current=0);const e=function(e,t,n,s){const r=Math.min(3,Math.max(1,Math.floor(t)));if(r<1)return[];if(n&&n.length===r&&void 0!==s&&e.length>s){const t=new Map;n.forEach((e,n)=>{e.forEach(({entry:e})=>{const s="post"===e.type?e.item.post.uri:e.items[0]?.post.uri;s&&t.set(s,n)})});const o=Array.from({length:r},()=>[]),i=Array(r).fill(0);for(let n=0;n<s;n++){const s=e[n],a="post"===s.type?s.item.post.uri:s.items[0]?.post.uri;if(a){const e=t.get(a);if(void 0!==e&&e<r){o[e].push({entry:s,originalIndex:n}),i[e]+=Xe(s);continue}}const l=Xe(s);let c=0;for(let e=1;e<r;e++)i[e]<i[c]&&(c=e);o[c].push({entry:s,originalIndex:n}),i[c]+=l}for(let n=s;n<e.length;n++){const t=e[n],s=Xe(t);let a=0;for(let e=1;e<r;e++)i[e]<i[a]&&(a=e);o[a].push({entry:t,originalIndex:n}),i[a]+=s}return o}const o=Array.from({length:r},()=>[]),i=Array(r).fill(0);for(let a=0;a<e.length;a++){const t=e[a],n=Xe(t),s=o.map(e=>e.length),l=0===s.length?0:Math.min(...s);let c=-1;for(let e=0;e<r;e++)o[e].length>l+1||(-1===c||i[e]<i[c]||i[e]===i[c]&&o[e].length<o[c].length)&&(c=e);-1===c&&(c=0),o[c].push({entry:t,originalIndex:a}),i[c]+=n}return o}(Pe,Ve,Ze.current,et.current);return Ze.current=e,et.current=Pe.length,tt.current=Ve,e},[Pe,Ve]),st=j.useMemo(()=>{const e=[];return Pe.forEach((t,n)=>{if("post"===t.type){const s="text"===Ie?1:Math.max(1,l(t.item.post).length);for(let t=0;t<s;t++)e.push({cardIndex:n,mediaIndex:t})}else e.push({cardIndex:n,mediaIndex:0})}),e},[Pe,Ie]),rt=j.useMemo(()=>{const e=[];let t=0;return Pe.forEach((n,s)=>{e[s]=t;const r=Pe[s],o="post"===r.type?"text"===Ie?1:Math.max(1,l(r.item.post).length):1;t+=o}),e},[Pe,Ie]),ot=j.useMemo(()=>{const e=[];return Pe.forEach((t,n)=>{const s="post"===t.type?"text"===Ie?1:Math.max(1,l(t.item.post).length):1;e[n]=rt[n]+s-1}),e},[Pe,rt,Ie]);te.current=Fe,ne.current=$.keyboardFocusIndex,se.current=$.actionsMenuOpenForIndex;const it=j.useCallback(e=>t=>{Z.current[e]=t},[]),at=j.useCallback((e,t,n)=>{ee.current[e]||(ee.current[e]={}),ee.current[e][t]=n},[]),lt=j.useCallback((e,t)=>{q({type:"SET_ACTIONS_MENU_OPEN",index:t?e:null})},[]),ct=j.useCallback(e=>{o&&ie.current&&(ie.current=!1,le(!1),de(!0),q({type:"SET_KEYBOARD_FOCUS",index:rt[e]??0}))},[o,rt]),dt=j.useCallback(()=>{J(!1)},[]);j.useEffect(()=>{const e=$.keyboardFocusIndex;if(e<0)return;if(0===st.length)return void q({type:"SET_KEYBOARD_FOCUS",index:-1});const t=Math.min(e,st.length-1);t!==e&&q({type:"SET_KEYBOARD_FOCUS",index:t})},[st.length,$.keyboardFocusIndex]);const ut=j.useMemo(()=>L(e=>function(e){const t=[...e],n=t.length>2e3?t.slice(-2e3):t;h.set(ze,n)}(e),1e3),[]);j.useEffect(()=>{ut($.seenUris)},[$.seenUris,ut]),j.useEffect(()=>{const e=new Set;let t=0,n=0;const s=new WeakSet,r=()=>{if(t=0,0===e.size)return;const s=Date.now();if(s-n<400)return void(t=requestAnimationFrame(r));n=s;const o=Array.from(e);e.clear(),j.startTransition(()=>{q({type:"MARK_SEEN",uris:o}),ge.current=new Set([...ge.current,...o])})},o=new IntersectionObserver(n=>{for(const t of n)if(!t.isIntersecting&&t.boundingClientRect.top<0){const n=t.target.getAttribute("data-post-uri");n&&!ge.current.has(n)&&e.add(n)}e.size>0&&!t&&(t=requestAnimationFrame(r))},{threshold:0,rootMargin:"0px"}),i=e=>{e instanceof HTMLElement&&e.hasAttribute("data-post-uri")&&!s.has(e)&&(o.observe(e),s.add(e))},a=_e.current;if(a){a.querySelectorAll("[data-post-uri]").forEach(i);const e=new MutationObserver(e=>{for(const t of e)t.addedNodes.forEach(e=>{if(e instanceof HTMLElement){i(e);e.querySelectorAll("[data-post-uri]").forEach(i)}})});return e.observe(a,{childList:!0,subtree:!0}),()=>{o.disconnect(),e.disconnect(),t&&cancelAnimationFrame(t)}}return()=>{o.disconnect(),t&&cancelAnimationFrame(t)}},[Pe.length]),j.useEffect(()=>{const e=()=>{ie.current=!0};return window.addEventListener("mousemove",e),()=>window.removeEventListener("mousemove",e)},[]),j.useEffect(()=>{if(!oe.current)return;if(oe.current=!1,$.keyboardFocusIndex===re.current)return;re.current=$.keyboardFocusIndex;const e=st[$.keyboardFocusIndex],t=requestAnimationFrame(()=>{const t=e?.cardIndex??$.keyboardFocusIndex,n=e?.mediaIndex??0,s=ee.current[t]?.[n],r=s??Z.current[t];r&&r.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})});return()=>cancelAnimationFrame(t)},[$.keyboardFocusIndex,st]),j.useEffect(()=>{const e=e=>{const n=/[?&](post|profile|tag|forumPost|artboard)=/.test(t.search);if(Q||n)return;const r=e.target;if("INPUT"===r.tagName||"TEXTAREA"===r.tagName||"SELECT"===r.tagName||r.isContentEditable)return void("Escape"===e.key&&(e.preventDefault(),r.blur()));if(e.ctrlKey||e.metaKey)return;const o=ne.current;if(0===Pe.length||0===st.length)return;de(!1);const i=st[o],a=i?.cardIndex??0,l=Pe[a],c="post"===l?.type?l.item:"carousel"===l?.type?l.items[0]:null,d=e.key.toLowerCase(),u=document.activeElement?.closest?.('[role="menu"]'),f=$.actionsMenuOpenForIndex===a;if((u||f)&&("w"===d||"s"===d||"e"===d||"enter"===d||"q"===d||"escape"===d))return;if(e.repeat&&("a"===d||"d"===d||"ArrowLeft"===e.key||"ArrowRight"===e.key))return;if(ue)return"escape"===d?(e.preventDefault(),void fe(null)):void 0;if("w"!==d&&"s"!==d&&"a"!==d&&"d"!==d&&"e"!==d&&"enter"!==d&&"r"!==d&&"f"!==d&&"c"!==d&&"h"!==d&&"b"!==d&&"m"!==d&&"`"!==d&&"4"!==d&&"ArrowUp"!==e.key&&"ArrowDown"!==e.key&&"ArrowLeft"!==e.key&&"ArrowRight"!==e.key||e.preventDefault(),"b"===d)return void(c?.post?.author&&O?.did!==c.post.author.did&&(fe({did:c.post.author.did,handle:c.post.author.handle??c.post.author.did,avatar:c.post.author.avatar}),requestAnimationFrame(()=>pe.current?.focus())));const p=o<0,m=Ve>=2?nt:null,h=e=>Z.current[e]?.getBoundingClientRect();if("w"===d||"ArrowUp"===e.key){ie.current=!1,le(!0),oe.current=!0;const e=o===rt[a],t=p?ot[Pe.length-1]??st.length-1:e?(()=>{const e=Ve>=2&&m?function(e,t){for(let n=0;n<e.length;n++){const s=e[n].findIndex(e=>e.originalIndex===t);if(s>0)return e[n][s-1].originalIndex;if(0===s)return t}return t}(m,a):Math.max(0,a-1);return ot[e]??rt[e]??0})():Math.max(0,o-1);return void q({type:"SET_KEYBOARD_FOCUS",index:t})}if("s"===d||"ArrowDown"===e.key){ie.current=!1,le(!0),oe.current=!0;const e=o===ot[a],t=p?0:e?(()=>{const e=Ve>=2&&m?function(e,t){for(let n=0;n<e.length;n++){const s=e[n].findIndex(e=>e.originalIndex===t);if(s>=0&&s<e[n].length-1)return e[n][s+1].originalIndex;if(s>=0)return t}return t}(m,a):Math.min(Pe.length-1,a+1);return rt[e]??o})():Math.min(st.length-1,o+1);return void q({type:"SET_KEYBOARD_FOCUS",index:t})}if("a"===d||"ArrowLeft"===e.key){ie.current=!1,le(!0),oe.current=!0;const e=p?0:Ve>=2&&m?function(e,t,n){for(let s=0;s<e.length;s++){if(e[s].findIndex(e=>e.originalIndex===t)<0)continue;if(0===s)return t;const r=e[s-1],o=n(t);if(!o)return t;let i=t,a=-1;for(const{originalIndex:e}of r){const t=n(e);if(!t)continue;const s=Qe(o,t);s>0&&s>a&&(a=s,i=e)}return i}return t}(m,a,h):a,t=p?0:e!==a?ot[e]??o:o;return t!==o&&q({type:"SET_ACTIONS_MENU_OPEN",index:null}),void q({type:"SET_KEYBOARD_FOCUS",index:t})}if("d"===d||"ArrowRight"===e.key){ie.current=!1,le(!0),oe.current=!0;const e=p?0:Ve>=2&&m?function(e,t,n){for(let s=0;s<e.length;s++){if(e[s].findIndex(e=>e.originalIndex===t)<0)continue;if(s===e.length-1)return t;const r=e[s+1],o=n(t);if(!o)return t;let i=t,a=-1;for(const{originalIndex:e}of r){const t=n(e);if(!t)continue;const s=Qe(o,t);s>0&&s>a&&(a=s,i=e)}return i}return t}(m,a,h):a,t=p?0:e!==a?ot[e]??o:o;return t!==o&&q({type:"SET_ACTIONS_MENU_OPEN",index:null}),void q({type:"SET_KEYBOARD_FOCUS",index:t})}if(("m"===d||"`"===d)&&o>=0)q(f?{type:"SET_ACTIONS_MENU_OPEN",index:null}:{type:"SET_ACTIONS_MENU_OPEN",index:a});else if("e"!==d&&"enter"!==d)if("r"!==d){if("f"===d){const e=c;if(!e?.post?.uri||!e?.post?.cid)return;const t=e.post.uri,n=t in Y?Y[t]??void 0:e.post.viewer?.like;return void(n?s.deleteLike(n).then(()=>{z(t,null)}).catch(()=>{}):s.like(t,e.post.cid).then(e=>{z(t,e.uri)}).catch(()=>{}))}if("c"!==d){if("4"===d){const e=c?.post?.author,t=c?.post?.uri;if(e&&O?.did&&O.did!==e.did&&t){const n=e.viewer?.following;n?s.deleteFollow(n).then(()=>{q({type:"UPDATE_ITEMS",updater:e=>e.map(e=>{if(e.post.uri!==t)return e;const n=e.post,s=n.author;return{...e,post:{...n,author:{...s,viewer:{...s.viewer,following:void 0}}}}})})}).catch(()=>{}):s.follow(e.did).then(e=>{q({type:"UPDATE_ITEMS",updater:n=>n.map(n=>{if(n.post.uri!==t)return n;const s=n.post,r=s.author;return{...n,post:{...s,author:{...r,viewer:{...r.viewer,following:e.uri}}}}})})}).catch(()=>{})}}}else J(!0)}else c&&X(c.post.uri,!0);else c&&X(c.post.uri)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[t.search,Ve,Q,X,ue,O,Y,$.actionsMenuOpenForIndex,st,rt,ot]),j.useEffect(()=>{ue&&pe.current?.focus()},[ue]);const ft=j.useRef(null),pt=j.useContext(A),mt=C({scrollRef:{current:null},touchTargetRef:pt?.wrapperRef??ft,onRefresh:async()=>{await Te(),requestAnimationFrame(()=>{window.scrollTo(0,0)})},enabled:o,maxTouchStartY:130}),ht=!!je&&1===be.length&&je.feedSources.length>1,gt=j.useCallback(e=>{mt.onTouchStart(e),ht&&1===e.touches.length&&(Se.current={x:e.touches[0].clientX,y:e.touches[0].clientY},Ne.current="unknown")},[ht,mt]),yt=j.useCallback(e=>{if(ht&&Se.current&&1===e.touches.length){if("unknown"===Ne.current){const t=e.touches[0].clientX-Se.current.x,n=e.touches[0].clientY-Se.current.y;(Math.abs(t)>20||Math.abs(n)>20)&&(Ne.current=Math.abs(t)>2*Math.abs(n)?"swipe":"pull")}"pull"!==Ne.current&&"unknown"!==Ne.current||mt.onTouchMove(e)}else mt.onTouchMove(e)},[ht,mt]),xt=j.useCallback(e=>{if(ht&&je&&Se.current&&1===e.changedTouches.length){const t=e.changedTouches[0].clientX-Se.current.x,n=e.changedTouches[0].clientY-Se.current.y;if("swipe"===Ne.current&&Math.abs(t)>80&&Math.abs(t)>2*Math.abs(n)){const e=je.feedSources,n=be[0].source,s=e.findIndex(e=>{return s=n,((t=e).uri??t.label)===(s.uri??s.label);var t,s});if(s>=0){const n=t<0?(s+1)%e.length:(s-1+e.length)%e.length;je.setSingleFeed(e[n])}}Se.current=null,Ne.current="unknown"}mt.onTouchEnd(e)},[ht,je,be,mt]);j.useEffect(()=>{const e=pt?.setHandlers;if(e)return e({onTouchStart:gt,onTouchMove:yt,onTouchEnd:xt}),()=>{e(null)}},[pt?.setHandlers,gt,yt,xt]);const wt=!!pt?.wrapperRef;return i.jsx(R,{title:"Feed",showNav:!0,children:i.jsxs(i.Fragment,{children:[i.jsxs("div",{ref:ft,className:P.wrap,onTouchStart:wt?void 0:gt,onTouchMove:wt?void 0:yt,onTouchEnd:wt?void 0:xt,children:[i.jsx("div",{className:`${P.pullRefreshHeader} ${mt.pullDistance>0||mt.isRefreshing?P.pullRefreshHeaderActive:""}`,"aria-hidden":0===mt.pullDistance&&!mt.isRefreshing,"aria-live":"polite","aria-label":mt.isRefreshing?"Refreshing":void 0,children:(mt.pullDistance>0||mt.isRefreshing)&&i.jsx("div",{className:P.pullRefreshSpinner})}),i.jsxs("div",{className:P.pullRefreshContent,style:{transform:`translateY(${mt.pullDistance}px)`},children:[O&&i.jsxs("div",{className:P.suggestedFollowsSection,children:[i.jsx("div",{className:P.suggestedFollowsSectionInner,children:i.jsx("button",{type:"button",className:P.suggestedFollowsToggle,onClick:()=>we(e=>!e),"aria-expanded":xe,"aria-label":xe?"Hide suggestions":"Discover accounts to follow",children:xe?"Hide suggestions":"Discover accounts"})}),xe&&i.jsx(Ee,{})]}),i.jsxs("div",{className:P.feedContentTransition,children:[$.error&&i.jsx("p",{className:P.error,children:$.error}),$.loading?i.jsx("div",{className:P.loading,children:"Loading…"}):0===Pe.length?i.jsx("div",{className:P.empty,children:De?i.jsxs(i.Fragment,{children:[i.jsx("p",{className:P.emptyLoadMoreText,children:Le.length>0?"You've seen everything visible from this batch. There may be more from your other feeds.":"No posts in this batch."}),i.jsx("button",{type:"button",className:P.loadMoreBtn,onClick:()=>$.cursor&&!$.loadingMore&&Te($.cursor),disabled:$.loadingMore,children:$.loadingMore?"Loading…":"Load more"})]}):Ue?i.jsxs(i.Fragment,{children:["You've read all the posts in this feed.",i.jsx("br",{}),"New posts will appear as they're posted."]}):"media"===Ie?"No posts with images or videos in this feed.":"No posts in this feed."}):i.jsxs(i.Fragment,{children:[i.jsx("div",{ref:_e,className:`${P.gridColumns} ${P[`gridView${F}`]}`,"data-feed-cards":!0,"data-view-mode":F,"data-keyboard-nav":ae||void 0,onMouseLeave:o&&!Q?()=>q({type:"SET_KEYBOARD_FOCUS",index:-1}):void 0,children:nt.map((e,t)=>i.jsx(He,{column:e,colIndex:t,loadMoreSentinelRef:$.cursor?e=>{K.current[t]=e}:void 0,hasCursor:!!$.cursor,keyboardFocusIndex:$.keyboardFocusIndex,focusTargets:st,firstFocusIndexForCard:rt,focusSetByMouse:ce,keyboardAddOpen:V,actionsMenuOpenForIndex:$.actionsMenuOpenForIndex,nsfwPreference:Ae,unblurredUris:Re,setUnblurred:Ce,likeOverrides:Y,setLikeOverrides:z,seenUris:$.seenUris,openPostModal:X,cardRef:it,onMediaRef:at,onActionsMenuOpenChange:lt,onMouseEnter:ct,onAddClose:dt},t))}),O&&i.jsxs("div",{className:P.loadMoreRow,children:[$.loadingMore&&i.jsx("p",{className:P.loadingMore,role:"status",children:"Loading more…"}),i.jsx("button",{type:"button",className:P.loadMoreBtn,onClick:()=>$.cursor&&!$.loadingMore&&Te($.cursor),disabled:$.loadingMore||!$.cursor,children:$.cursor?"Load more":"No more posts"})]})]})]},1===be.length?be[0].source.uri??be[0].source.label:"mixed"),!O&&i.jsxs("div",{className:P.feedLoginHint,children:[i.jsx("div",{className:P.feedLoginHintBtnRow,children:i.jsx("button",{type:"button",className:P.feedLoginHintBtn,onClick:()=>S(),children:"Log in"})}),i.jsxs("p",{className:P.feedLoginHintText,children:["Or"," ",i.jsx("button",{type:"button",className:P.feedLoginHintLink,onClick:()=>S("create"),children:"create an account"})," to see your own feeds."]})]})]})]}),ue&&i.jsx("div",{className:P.blockOverlay,role:"dialog","aria-modal":"true","aria-labelledby":"block-dialog-title",onKeyDown:e=>"Escape"===e.key&&fe(null),onClick:()=>fe(null),children:i.jsxs("div",{className:P.blockDialog,onClick:e=>e.stopPropagation(),children:[i.jsx("h2",{id:"block-dialog-title",className:P.blockTitle,children:"Block user?"}),i.jsxs("div",{className:P.blockUser,children:[ue.avatar?i.jsx("img",{src:ue.avatar,alt:"",className:P.blockAvatar,loading:"lazy"}):i.jsx("div",{className:P.blockAvatarPlaceholder}),i.jsxs("span",{className:P.blockHandle,children:["@",ue.handle]})]}),i.jsxs("div",{className:P.blockActions,children:[i.jsx("button",{ref:pe,type:"button",className:P.blockCancelBtn,onClick:()=>fe(null),children:"Cancel"}),i.jsx("button",{ref:me,type:"button",className:P.blockConfirmBtn,onClick:async()=>{if(ue)try{await M(ue.did),fe(null)}catch(e){}},children:"Block"})]})]})})]})})}export{Je as buildDisplayEntries,Ze as default};
