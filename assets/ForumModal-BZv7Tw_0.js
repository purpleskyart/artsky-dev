import{g as e,k as s,u as t,z as a,j as l}from"./index-B6Oq1pSb.js";import{b as o,L as r}from"./react-vendor-DGaPsC2e.js";import{A as i,s as n}from"./AppModal-B5Npsep4.js";import{l as d,a as c,c as m,s as p}from"./forum-CkX3B0r6.js";import{a as h,b as u}from"./PostActionsMenu-rac-Aigp.js";import{u as f}from"./useListKeyboardNav-3q-0e0hq.js";import"./Layout-DN75vOWm.js";import{a as y}from"./PostText-CvbwNCN2.js";import{CollabContent as j}from"./CollabPage-CYkzqUlh.js";import{R as x}from"./PostDetailPage-CA6aIAJU.js";import{s as g}from"./ForumPage.module-DLn4V-d3.js";import{p as b}from"./PostDetailPage.module-PsmxZ1-O.js";import"./atproto-3-1TCh3S.js";import"./ModalTopBarSlotContext-XWKZv5-E.js";import"./ModalScrollContext-B7n00fEw.js";import"./usePullToRefresh-DVlCPYCP.js";import"./Icons-Cxp2k-Gy.js";import"./postCache-CTqU0alO.js";import"./artboards-DNvSVVrd.js";function v(e){if(!e?.trim())return"";const s=e.replace(/\s+/g," ").trim();return s.length<=140?s:s.slice(0,140).trim()+"…"}function N({inModal:i=!1,onRegisterRefresh:n}){const[N,w]=o.useState("discover"),[k,C]=o.useState("all"),[A,L]=o.useState([]),[P,S]=o.useState([]),[B,F]=o.useState(!0),[T,R]=o.useState(null),[M,D]=o.useState(""),[E,W]=o.useState(0),[z,I]=o.useState(!1),[$,H]=o.useState({title:"",body:"",tags:""}),U=e(),{sessionsList:K,switchAccount:G}=s(),{isModalOpen:q,openForumPostModal:O}=t(),[V,Y]=o.useState({handle:""}),J=o.useRef(null);o.useEffect(()=>{if(!U?.did)return void Y({handle:""});let e=!1;return a.getProfile({actor:U.did}).then(s=>{if(e)return;const t=s.data;Y({handle:t.handle??U.did,avatar:t.avatar})}).catch(()=>{e||Y({handle:U.handle??U.did})}),()=>{e=!0}},[U?.did]);const Q=o.useCallback(async()=>{try{F(!0),R(null);const e=await d();L(e)}catch(e){R(e instanceof Error?e.message:"Failed to load forum")}finally{F(!1)}},[]),X=o.useCallback(async()=>{if(U?.did)try{F(!0);const e=await c(U.did,{limit:50});S(e.posts)}catch{S([])}finally{F(!1)}else S([])},[U?.did]);o.useEffect(()=>{"discover"===N?(L([]),Q()):"artsky"===N&&X()},[N,Q,X,k]),o.useEffect(()=>{n?.(()=>{"discover"===N?Q():"artsky"===N&&X()})},[n,N,Q,X]);const Z=o.useMemo(()=>"all"===k?A:"followed"===k&&U?.did?A.filter(e=>e.did!==U.did):"mine"===k&&U?.did?A.filter(e=>e.did===U.did):[],[A,k,U?.did]),_=o.useMemo(()=>Z.filter(e=>function(e,s){if(!s.trim())return!0;const t=s.toLowerCase().trim(),a=(e.title??"").toLowerCase(),l=(e.body??"").toLowerCase(),o=(e.authorHandle??"").toLowerCase(),r=(e.tags??[]).join(" ").toLowerCase();return a.includes(t)||l.includes(t)||o.includes(t)||r.includes(t)}(e,M)),[Z,M]);o.useEffect(()=>{W(e=>_.length?Math.min(e,_.length-1):0)},[_.length]),o.useEffect(()=>{if(!J.current||E<0)return;const e=J.current.querySelector(`[data-forum-index="${E}"]`);e&&e.scrollIntoView({block:"nearest",behavior:"smooth"})},[E]);const ee=P.filter(e=>!M.trim()||(e.title??"").toLowerCase().includes(M.toLowerCase())||(e.body??"").toLowerCase().includes(M.toLowerCase())),se=Math.min(E,Math.max(0,ee.length-1));f({enabled:"discover"===N&&_.length>0&&(i||!q),itemCount:"discover"===N?_.length:"artsky"===N?ee.length:0,focusedIndex:"discover"===N?E:se,setFocusedIndex:W,onActivate:e=>{if("discover"===N){const s=_[e];s&&O(s.uri)}else if("artsky"===N){const s=ee[e];s&&O(s.uri)}},useCapture:!0});const te=("followed"===k||"mine"===k)&&!U;async function ae(){if($.title.trim())try{await m({title:$.title,body:$.body,tags:$.tags.split(",").map(e=>e.trim()).filter(Boolean)}),H({title:"",body:"",tags:""}),I(!1),X()}catch(e){alert(e instanceof Error?e.message:"Failed to create post")}}return l.jsxs("div",{className:g.wrap,children:[l.jsxs("header",{className:g.header,children:[l.jsxs("div",{className:g.titleRow,children:[l.jsx("h2",{className:g.title,children:"Forums"}),U?.did&&l.jsx("button",{type:"button",className:g.newThreadBtn,onClick:function(){"artsky"!==N&&w("artsky"),I(!0)},"aria-label":"Create a new forum thread",children:"New Thread"})]}),l.jsxs("div",{className:g.tabs,style:{marginTop:"0.5rem"},children:[l.jsx("button",{type:"button",className:"discover"===N?g.tabActive:g.tab,onClick:()=>w("discover"),"aria-pressed":"discover"===N,children:"Discover"}),l.jsx("button",{type:"button",className:"artsky"===N?g.tabActive:g.tab,onClick:()=>w("artsky"),"aria-pressed":"artsky"===N,children:"ArtSky"}),l.jsx("button",{type:"button",className:"collab"===N?g.tabActive:g.tab,onClick:()=>w("collab"),"aria-pressed":"collab"===N,children:"Collab"})]}),"discover"===N&&l.jsxs(l.Fragment,{children:[l.jsx("p",{className:g.subtitle,style:{marginTop:"0.5rem"},children:"Forum posts from people you follow (AT Protocol forum lexicon)."}),l.jsxs("div",{className:g.tabs,children:[l.jsx("button",{type:"button",className:"all"===k?g.tabActive:g.tab,onClick:()=>C("all"),"aria-pressed":"all"===k,children:"All Posts"}),l.jsx("button",{type:"button",className:"followed"===k?g.tabActive:g.tab,onClick:()=>C("followed"),"aria-pressed":"followed"===k,children:"Followed"}),l.jsx("button",{type:"button",className:"mine"===k?g.tabActive:g.tab,onClick:()=>C("mine"),"aria-pressed":"mine"===k,children:"My Posts"})]})]}),("discover"===N||"artsky"===N)&&l.jsx("div",{className:g.searchRow,children:l.jsx("input",{type:"search",className:g.searchInput,placeholder:"Search posts…",value:M,onChange:e=>D(e.target.value),"aria-label":"Search posts"})})]}),"collab"===N&&l.jsx(j,{}),"discover"===N&&l.jsxs(l.Fragment,{children:[T&&l.jsx("p",{className:g.error,children:T}),te?l.jsxs("div",{className:g.empty,children:["Log in to see ","followed"===k?"posts from people you follow":"your posts","."]}):B?l.jsx("div",{className:g.loading,children:"all"===k?"Loading forum posts…":"followed"===k?"Loading followed posts…":"Loading your posts…"}):0===_.length?l.jsx("div",{className:g.empty,children:M.trim()?"No posts match your search.":0===Z.length?"all"===k?"No forum posts yet from you or people you follow.":"followed"===k?"No posts yet from people you follow.":"You haven't posted in the forums yet.":"No posts match your search."}):l.jsx("ul",{ref:J,className:g.list,children:_.map((e,s)=>{const t=e.authorHandle??e.did,a=s===E;return l.jsx("li",{"data-forum-index":s,children:l.jsx(r,{to:"#",className:a?`${g.postLink} ${g.postLinkFocused}`:g.postLink,onClick:s=>{s.preventDefault(),O(e.uri)},children:l.jsx("article",{className:b.postBlock,children:l.jsxs("div",{className:b.postBlockContent,children:[l.jsxs("div",{className:b.postHead,children:[e.authorAvatar?l.jsx("img",{src:e.authorAvatar,alt:"",className:b.avatar,loading:"lazy"}):l.jsx("span",{className:g.avatarPlaceholder,"aria-hidden":!0,children:(t||e.did).slice(0,1).toUpperCase()}),l.jsxs("div",{className:b.authorRow,children:[l.jsxs(y,{handle:t,className:b.handleLink,onClick:e=>e.stopPropagation(),children:["@",t]}),e.createdAt&&l.jsx("span",{className:b.postTimestamp,title:u(e.createdAt),children:h(e.createdAt)})]})]}),l.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.25rem"},children:[e.isPinned&&l.jsx("span",{className:g.commentBadge,children:"Pinned"}),e.isWiki&&l.jsx("span",{className:g.commentBadge,children:"Wiki"}),l.jsx("h3",{style:{fontSize:"1rem",fontWeight:600,margin:0},children:e.title||"Untitled"})]}),v(e.body)&&l.jsx("p",{className:g.bodyPreview,children:v(e.body)}),e.tags?.length?l.jsx("div",{style:{display:"flex",gap:"0.35rem",marginTop:"0.25rem",flexWrap:"wrap"},children:e.tags.map(e=>l.jsxs("span",{className:g.commentBadge,style:{fontSize:"0.7rem"},children:["#",e]},e))}):null]})})})},e.uri)})})]}),"artsky"===N&&l.jsxs(l.Fragment,{children:[U?.did&&l.jsx("button",{type:"button",className:g.tab,style:{marginBottom:"0.75rem"},onClick:()=>I(!z),children:"+ New Post"}),z&&U?.did&&l.jsx("div",{className:`${b.inlineReplyFormWrap} ${g.newThreadFormWrap}`,children:l.jsx("div",{children:l.jsxs("form",{className:b.inlineReplyForm,onSubmit:e=>{e.preventDefault(),ae()},children:[V.handle&&l.jsx("div",{className:b.inlineReplyFormHeader,children:K?.length&&U.did?l.jsx(x,{replyAs:V,sessionsList:K,switchAccount:G,currentDid:U.did,label:"Posting as"}):l.jsxs("p",{className:b.replyAs,children:[l.jsx("span",{className:b.replyAsLabel,children:"Posting as"}),l.jsxs("span",{className:b.replyAsUserChip,children:[V.avatar?l.jsx("img",{src:V.avatar,alt:"",className:b.replyAsAvatar,loading:"lazy"}):l.jsx("span",{className:b.replyAsAvatarPlaceholder,"aria-hidden":!0,children:V.handle.slice(0,1).toUpperCase()}),l.jsxs("span",{className:b.replyAsHandle,children:["@",V.handle]})]})]})}),l.jsx("label",{className:b.inlineReplyFormLabel,htmlFor:"forum-new-thread-title",children:"Title"}),l.jsx("input",{id:"forum-new-thread-title",type:"text",placeholder:"Post title",value:$.title,onChange:e=>H(s=>({...s,title:e.target.value})),className:g.newThreadInput}),l.jsx("label",{className:b.inlineReplyFormLabel,htmlFor:"forum-new-thread-body",children:"Body"}),l.jsx("textarea",{id:"forum-new-thread-body",placeholder:"Write your post… Use @username for mentions",value:$.body,onChange:e=>H(s=>({...s,body:e.target.value})),onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),$.title.trim()&&ae())},className:b.textarea,rows:4}),l.jsx("label",{className:b.inlineReplyFormLabel,htmlFor:"forum-new-thread-tags",children:"Tags (comma-separated)"}),l.jsx("input",{id:"forum-new-thread-tags",type:"text",placeholder:"e.g. help, feature",value:$.tags,onChange:e=>H(s=>({...s,tags:e.target.value})),className:g.newThreadInput}),l.jsx("p",{className:b.hint,children:"⌘ Enter to post"}),l.jsxs("div",{className:g.newThreadActions,children:[l.jsx("button",{type:"submit",className:b.submit,disabled:!$.title.trim(),children:"Post"}),l.jsx("button",{type:"button",className:g.tab,onClick:function(){p({title:$.title,body:$.body,tags:$.tags.split(",").map(e=>e.trim()).filter(Boolean)}),I(!1)},children:"Save Draft"}),l.jsx("button",{type:"button",className:g.tab,onClick:()=>I(!1),children:"Cancel"})]})]})})}),U?B?l.jsx("div",{className:g.loading,children:"Loading posts…"}):0===ee.length?l.jsx("div",{className:g.empty,children:"No forum posts yet. Be the first to start a discussion!"}):l.jsx("ul",{ref:J,className:g.list,children:ee.map((e,s)=>{const t=s===se;return l.jsx("li",{"data-forum-index":s,children:l.jsx(r,{to:"#",className:t?`${g.postLink} ${g.postLinkFocused}`:g.postLink,onClick:s=>{s.preventDefault(),O(e.uri)},children:l.jsx("article",{className:b.postBlock,children:l.jsxs("div",{className:b.postBlockContent,children:[l.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.25rem"},children:[e.isPinned&&l.jsx("span",{className:g.commentBadge,children:"Pinned"}),e.isWiki&&l.jsx("span",{className:g.commentBadge,children:"Wiki"}),l.jsx("h3",{style:{fontSize:"1rem",fontWeight:600,margin:0},children:e.title||"Untitled"})]}),e.body&&l.jsxs("p",{className:g.bodyPreview,children:[e.body.slice(0,120),e.body.length>120?"…":""]}),l.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginTop:"0.25rem",fontSize:"0.85rem",color:"var(--muted)"},children:[e.authorHandle&&l.jsxs("span",{children:["@",e.authorHandle]}),e.createdAt&&l.jsx("span",{children:new Date(e.createdAt).toLocaleDateString()}),e.tags?.map(e=>l.jsxs("span",{className:g.commentBadge,style:{fontSize:"0.7rem"},children:["#",e]},e))]})]})})})},`${e.uri}-${s}`)})}):l.jsx("div",{className:g.empty,children:"Log in to create and view ArtSky forum posts."})]})]})}function w({onClose:e,onBack:s,canGoBack:t}){const[a,r]=o.useState(null),d=o.useCallback(e=>{r(()=>e)},[]);return l.jsxs(i,{ariaLabel:"Forums",onClose:e,onBack:s,canGoBack:t,onPullToRefresh:a?()=>a():void 0,children:[l.jsx("div",{className:n.modalBetaAlert,role:"status",children:"BETA"}),l.jsx(N,{inModal:!0,onRegisterRefresh:d})]})}export{w as default};
