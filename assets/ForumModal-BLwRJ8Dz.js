import{g as e,k as s,u as t,E as a,j as l}from"./index-BXBIaIN_.js";import{b as o,L as r}from"./react-vendor-DGaPsC2e.js";import{A as i,s as n}from"./AppModal-3LvZLydf.js";import{l as c,a as d,c as m,s as u}from"./forum-DDlmpoqo.js";import{a as p,b as h}from"./PostActionsMenu-BMUSZoZl.js";import{u as f}from"./useListKeyboardNav-3q-0e0hq.js";import"./Layout-DUDhZOFY.js";import{a as y}from"./PostText-CYuGKBer.js";import{CollabContent as j}from"./CollabPage-BjtAkciV.js";import{ConsensusContent as x}from"./ConsensusPage-DDpGEGSo.js";import{R as b}from"./PostDetailPage-DAnWYYCK.js";import{s as g}from"./ForumPage.module-DLn4V-d3.js";import{p as v}from"./PostDetailPage.module-TDaRGCAY.js";import"./atproto-3-1TCh3S.js";import"./ModalTopBarSlotContext-XWKZv5-E.js";import"./ModalScrollContext-CNWnUaKs.js";import"./usePullToRefresh-DVlCPYCP.js";import"./Icons-psAHoCnZ.js";import"./postCache-CTqU0alO.js";import"./artboards-DNvSVVrd.js";function N(e){if(!e?.trim())return"";const s=e.replace(/\s+/g," ").trim();return s.length<=140?s:s.slice(0,140).trim()+"…"}function w({inModal:i=!1,onRegisterRefresh:n}){const[w,k]=o.useState("discover"),[C,A]=o.useState("all"),[L,P]=o.useState([]),[S,B]=o.useState([]),[F,T]=o.useState(!0),[R,M]=o.useState(null),[D,E]=o.useState(""),[W,I]=o.useState(0),[$,z]=o.useState(!1),[H,U]=o.useState({title:"",body:"",tags:""}),K=e(),{sessionsList:G,switchAccount:q}=s(),{isModalOpen:O,openForumPostModal:V}=t(),[Y,J]=o.useState({handle:""}),Q=o.useRef(null);o.useEffect(()=>{if(!K?.did)return void J({handle:""});let e=!1;return a.getProfile({actor:K.did}).then(s=>{if(e)return;const t=s.data;J({handle:t.handle??K.did,avatar:t.avatar})}).catch(()=>{e||J({handle:K.handle??K.did})}),()=>{e=!0}},[K?.did]);const X=o.useCallback(async()=>{try{T(!0),M(null);const e=await c();P(e)}catch(e){M(e instanceof Error?e.message:"Failed to load forum")}finally{T(!1)}},[]),Z=o.useCallback(async()=>{if(K?.did)try{T(!0);const e=await d(K.did,{limit:50});B(e.posts)}catch{B([])}finally{T(!1)}else B([])},[K?.did]);o.useEffect(()=>{"discover"===w?(P([]),X()):"artsky"===w&&Z()},[w,X,Z,C]),o.useEffect(()=>{n?.(()=>{"discover"===w?X():"artsky"===w&&Z()})},[n,w,X,Z]);const _=o.useMemo(()=>"all"===C?L:"followed"===C&&K?.did?L.filter(e=>e.did!==K.did):"mine"===C&&K?.did?L.filter(e=>e.did===K.did):[],[L,C,K?.did]),ee=o.useMemo(()=>_.filter(e=>function(e,s){if(!s.trim())return!0;const t=s.toLowerCase().trim(),a=(e.title??"").toLowerCase(),l=(e.body??"").toLowerCase(),o=(e.authorHandle??"").toLowerCase(),r=(e.tags??[]).join(" ").toLowerCase();return a.includes(t)||l.includes(t)||o.includes(t)||r.includes(t)}(e,D)),[_,D]);o.useEffect(()=>{I(e=>ee.length?Math.min(e,ee.length-1):0)},[ee.length]),o.useEffect(()=>{if(!Q.current||W<0)return;const e=Q.current.querySelector(`[data-forum-index="${W}"]`);e&&e.scrollIntoView({block:"nearest",behavior:"smooth"})},[W]);const se=S.filter(e=>!D.trim()||(e.title??"").toLowerCase().includes(D.toLowerCase())||(e.body??"").toLowerCase().includes(D.toLowerCase())),te=Math.min(W,Math.max(0,se.length-1));f({enabled:"discover"===w&&ee.length>0&&(i||!O),itemCount:"discover"===w?ee.length:"artsky"===w?se.length:0,focusedIndex:"discover"===w?W:te,setFocusedIndex:I,onActivate:e=>{if("discover"===w){const s=ee[e];s&&V(s.uri)}else if("artsky"===w){const s=se[e];s&&V(s.uri)}},useCapture:!0});const ae=("followed"===C||"mine"===C)&&!K;async function le(){if(H.title.trim())try{await m({title:H.title,body:H.body,tags:H.tags.split(",").map(e=>e.trim()).filter(Boolean)}),U({title:"",body:"",tags:""}),z(!1),Z()}catch(e){alert(e instanceof Error?e.message:"Failed to create post")}}return l.jsxs("div",{className:g.wrap,children:[l.jsxs("header",{className:g.header,children:[l.jsxs("div",{className:g.titleRow,children:[l.jsx("h2",{className:g.title,children:"Forums"}),K?.did&&l.jsx("button",{type:"button",className:g.newThreadBtn,onClick:function(){"artsky"!==w&&k("artsky"),z(!0)},"aria-label":"Create a new forum thread",children:"New Thread"})]}),l.jsxs("div",{className:g.tabs,style:{marginTop:"0.5rem"},children:[l.jsx("button",{type:"button",className:"discover"===w?g.tabActive:g.tab,onClick:()=>k("discover"),"aria-pressed":"discover"===w,children:"Discover"}),l.jsx("button",{type:"button",className:"artsky"===w?g.tabActive:g.tab,onClick:()=>k("artsky"),"aria-pressed":"artsky"===w,children:"ArtSky"}),l.jsx("button",{type:"button",className:"collab"===w?g.tabActive:g.tab,onClick:()=>k("collab"),"aria-pressed":"collab"===w,children:"Collab"}),l.jsx("button",{type:"button",className:"consensus"===w?g.tabActive:g.tab,onClick:()=>k("consensus"),"aria-pressed":"consensus"===w,children:"Consensus"})]}),"discover"===w&&l.jsxs(l.Fragment,{children:[l.jsx("p",{className:g.subtitle,style:{marginTop:"0.5rem"},children:"Forum posts from people you follow (AT Protocol forum lexicon)."}),l.jsxs("div",{className:g.tabs,children:[l.jsx("button",{type:"button",className:"all"===C?g.tabActive:g.tab,onClick:()=>A("all"),"aria-pressed":"all"===C,children:"All Posts"}),l.jsx("button",{type:"button",className:"followed"===C?g.tabActive:g.tab,onClick:()=>A("followed"),"aria-pressed":"followed"===C,children:"Followed"}),l.jsx("button",{type:"button",className:"mine"===C?g.tabActive:g.tab,onClick:()=>A("mine"),"aria-pressed":"mine"===C,children:"My Posts"})]})]}),("discover"===w||"artsky"===w)&&l.jsx("div",{className:g.searchRow,children:l.jsx("input",{type:"search",className:g.searchInput,placeholder:"Search posts…",value:D,onChange:e=>E(e.target.value),"aria-label":"Search posts"})})]}),"collab"===w&&l.jsx(j,{}),"consensus"===w&&l.jsx(x,{}),"discover"===w&&l.jsxs(l.Fragment,{children:[R&&l.jsx("p",{className:g.error,children:R}),ae?l.jsxs("div",{className:g.empty,children:["Log in to see ","followed"===C?"posts from people you follow":"your posts","."]}):F?l.jsx("div",{className:g.loading,children:"all"===C?"Loading forum posts…":"followed"===C?"Loading followed posts…":"Loading your posts…"}):0===ee.length?l.jsx("div",{className:g.empty,children:D.trim()?"No posts match your search.":0===_.length?"all"===C?"No forum posts yet from you or people you follow.":"followed"===C?"No posts yet from people you follow.":"You haven't posted in the forums yet.":"No posts match your search."}):l.jsx("ul",{ref:Q,className:g.list,children:ee.map((e,s)=>{const t=e.authorHandle??e.did,a=s===W;return l.jsx("li",{"data-forum-index":s,children:l.jsx(r,{to:"#",className:a?`${g.postLink} ${g.postLinkFocused}`:g.postLink,onClick:s=>{s.preventDefault(),V(e.uri)},children:l.jsx("article",{className:v.postBlock,children:l.jsxs("div",{className:v.postBlockContent,children:[l.jsxs("div",{className:v.postHead,children:[e.authorAvatar?l.jsx("img",{src:e.authorAvatar,alt:"",className:v.avatar,loading:"lazy"}):l.jsx("span",{className:g.avatarPlaceholder,"aria-hidden":!0,children:(t||e.did).slice(0,1).toUpperCase()}),l.jsxs("div",{className:v.authorRow,children:[l.jsxs(y,{handle:t,className:v.handleLink,onClick:e=>e.stopPropagation(),children:["@",t]}),e.createdAt&&l.jsx("span",{className:v.postTimestamp,title:h(e.createdAt),children:p(e.createdAt)})]})]}),l.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.25rem"},children:[e.isPinned&&l.jsx("span",{className:g.commentBadge,children:"Pinned"}),e.isWiki&&l.jsx("span",{className:g.commentBadge,children:"Wiki"}),l.jsx("h3",{style:{fontSize:"1rem",fontWeight:600,margin:0},children:e.title||"Untitled"})]}),N(e.body)&&l.jsx("p",{className:g.bodyPreview,children:N(e.body)}),e.tags?.length?l.jsx("div",{style:{display:"flex",gap:"0.35rem",marginTop:"0.25rem",flexWrap:"wrap"},children:e.tags.map(e=>l.jsxs("span",{className:g.commentBadge,style:{fontSize:"0.7rem"},children:["#",e]},e))}):null]})})})},e.uri)})})]}),"artsky"===w&&l.jsxs(l.Fragment,{children:[K?.did&&l.jsx("button",{type:"button",className:g.tab,style:{marginBottom:"0.75rem"},onClick:()=>z(!$),children:"+ New Post"}),$&&K?.did&&l.jsx("div",{className:`${v.inlineReplyFormWrap} ${g.newThreadFormWrap}`,children:l.jsx("div",{children:l.jsxs("form",{className:v.inlineReplyForm,onSubmit:e=>{e.preventDefault(),le()},children:[Y.handle&&l.jsx("div",{className:v.inlineReplyFormHeader,children:G?.length&&K.did?l.jsx(b,{replyAs:Y,sessionsList:G,switchAccount:q,currentDid:K.did,label:"Posting as"}):l.jsxs("p",{className:v.replyAs,children:[l.jsx("span",{className:v.replyAsLabel,children:"Posting as"}),l.jsxs("span",{className:v.replyAsUserChip,children:[Y.avatar?l.jsx("img",{src:Y.avatar,alt:"",className:v.replyAsAvatar,loading:"lazy"}):l.jsx("span",{className:v.replyAsAvatarPlaceholder,"aria-hidden":!0,children:Y.handle.slice(0,1).toUpperCase()}),l.jsxs("span",{className:v.replyAsHandle,children:["@",Y.handle]})]})]})}),l.jsx("label",{className:v.inlineReplyFormLabel,htmlFor:"forum-new-thread-title",children:"Title"}),l.jsx("input",{id:"forum-new-thread-title",type:"text",placeholder:"Post title",value:H.title,onChange:e=>U(s=>({...s,title:e.target.value})),className:g.newThreadInput}),l.jsx("label",{className:v.inlineReplyFormLabel,htmlFor:"forum-new-thread-body",children:"Body"}),l.jsx("textarea",{id:"forum-new-thread-body",placeholder:"Write your post… Use @username for mentions",value:H.body,onChange:e=>U(s=>({...s,body:e.target.value})),onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),H.title.trim()&&le())},className:v.textarea,rows:4}),l.jsx("label",{className:v.inlineReplyFormLabel,htmlFor:"forum-new-thread-tags",children:"Tags (comma-separated)"}),l.jsx("input",{id:"forum-new-thread-tags",type:"text",placeholder:"e.g. help, feature",value:H.tags,onChange:e=>U(s=>({...s,tags:e.target.value})),className:g.newThreadInput}),l.jsx("p",{className:v.hint,children:"⌘ Enter to post"}),l.jsxs("div",{className:g.newThreadActions,children:[l.jsx("button",{type:"submit",className:v.submit,disabled:!H.title.trim(),children:"Post"}),l.jsx("button",{type:"button",className:g.tab,onClick:function(){u({title:H.title,body:H.body,tags:H.tags.split(",").map(e=>e.trim()).filter(Boolean)}),z(!1)},children:"Save Draft"}),l.jsx("button",{type:"button",className:g.tab,onClick:()=>z(!1),children:"Cancel"})]})]})})}),K?F?l.jsx("div",{className:g.loading,children:"Loading posts…"}):0===se.length?l.jsx("div",{className:g.empty,children:"No forum posts yet. Be the first to start a discussion!"}):l.jsx("ul",{ref:Q,className:g.list,children:se.map((e,s)=>{const t=s===te;return l.jsx("li",{"data-forum-index":s,children:l.jsx(r,{to:"#",className:t?`${g.postLink} ${g.postLinkFocused}`:g.postLink,onClick:s=>{s.preventDefault(),V(e.uri)},children:l.jsx("article",{className:v.postBlock,children:l.jsxs("div",{className:v.postBlockContent,children:[l.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.25rem"},children:[e.isPinned&&l.jsx("span",{className:g.commentBadge,children:"Pinned"}),e.isWiki&&l.jsx("span",{className:g.commentBadge,children:"Wiki"}),l.jsx("h3",{style:{fontSize:"1rem",fontWeight:600,margin:0},children:e.title||"Untitled"})]}),e.body&&l.jsxs("p",{className:g.bodyPreview,children:[e.body.slice(0,120),e.body.length>120?"…":""]}),l.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginTop:"0.25rem",fontSize:"0.85rem",color:"var(--muted)"},children:[e.authorHandle&&l.jsxs("span",{children:["@",e.authorHandle]}),e.createdAt&&l.jsx("span",{children:new Date(e.createdAt).toLocaleDateString()}),e.tags?.map(e=>l.jsxs("span",{className:g.commentBadge,style:{fontSize:"0.7rem"},children:["#",e]},e))]})]})})})},`${e.uri}-${s}`)})}):l.jsx("div",{className:g.empty,children:"Log in to create and view ArtSky forum posts."})]})]})}function k({onClose:e,onBack:s,canGoBack:t}){const[a,r]=o.useState(null),c=o.useCallback(e=>{r(()=>e)},[]);return l.jsxs(i,{ariaLabel:"Forums",onClose:e,onBack:s,canGoBack:t,onPullToRefresh:a?()=>a():void 0,children:[l.jsx("div",{className:n.modalBetaAlert,role:"status",children:"BETA"}),l.jsx(w,{inModal:!0,onRegisterRefresh:c})]})}export{k as default};
