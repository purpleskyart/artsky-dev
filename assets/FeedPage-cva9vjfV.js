import{u as e,g as t,a as n,b as s,c as r,d as o,j as a,e as i,i as l,f as c,h as d,k as u,l as m,m as f,n as p,o as h,p as g,q as x,r as y,s as _,t as w,v,w as b,x as E,y as S}from"./index-DO5u49Z-.js";import{r as j,a as N,u as M,e as T,i as k}from"./react-vendor-rw3WIpbI.js";import{u as I,F as R,L as A}from"./Layout-i5XBa1yz.js";import{u as C}from"./usePullToRefresh-QiYvLiof.js";import{u as O}from"./virtual-SmD9oKU4.js";import{P as F}from"./PostCard-MzAp_gv-.js";import{setInitialPostForUri as P}from"./postCache-CTqU0alO.js";import{s as L}from"./FeedPage.module-BXQsl3XB.js";import"./atproto-JNpM3I1p.js";import"./Icons-_AhCYSE3.js";import"./PostText-XS6fYKXV.js";import"./PostActionsMenu-DDncNYIT.js";import"./date-Ct-NsrQr.js";import"./artboards-DNvSVVrd.js";import"./artboardsPds-DWUixJ9h.js";function D(e,t){let n;return function(...s){void 0!==n&&clearTimeout(n),n=setTimeout(()=>{n=void 0,e(...s)},t)}}function U(e,t=150){const n=function(e=150){const[t,n]=j.useState(()=>"undefined"!=typeof window?window.innerWidth:0);return j.useEffect(()=>{const t=D(()=>{n(window.innerWidth)},e);return n(window.innerWidth),window.addEventListener("resize",t,{passive:!0}),()=>{window.removeEventListener("resize",t)}},[e]),t}(t);return j.useMemo(()=>{const t="1"===e?1:"2"===e?2:3;return Math.min(3,Math.max(1,t))},[e,n])}const H="artsky-recommendations-shown";function B(){try{const e=localStorage.getItem(H);if(!e)return{};const t=JSON.parse(e);return"object"==typeof t&&null!==t?t:{}}catch{return{}}}const Y="_wrap_ljlgs_1",$="_subtext_ljlgs_10",z="_sortRow_ljlgs_18",K="_sortLabel_ljlgs_26",q="_sortSelect_ljlgs_31",W="_loading_ljlgs_46",G="_empty_ljlgs_47",V="_list_ljlgs_54",J="_item_ljlgs_65",X="_profileBtn_ljlgs_72",Q="_avatar_ljlgs_97",Z="_avatarPlaceholder_ljlgs_106",ee="_info_ljlgs_121",te="_handle_ljlgs_127",ne="_reason_ljlgs_135",se="_actions_ljlgs_140",re="_infoBtn_ljlgs_150",oe="_infoIcon_ljlgs_174",ae="_followBtn_ljlgs_179",ie="_dismissBtn_ljlgs_199",le="_detailBackdrop_ljlgs_226",ce="_detailPanel_ljlgs_237",de="_detailHeader_ljlgs_250",ue="_detailTitle_ljlgs_258",me="_detailClose_ljlgs_265",fe="_detailBody_ljlgs_284",pe="_detailSummary_ljlgs_289",he="_detailList_ljlgs_295",ge="_detailListItem_ljlgs_304",xe="_detailProfileBtn_ljlgs_308",ye="_detailAvatar_ljlgs_332",_e="_detailAvatarPlaceholder_ljlgs_340",we="_detailProfileInfo_ljlgs_354",ve="_detailDisplayName_ljlgs_360",be="_detailHandle_ljlgs_368",Ee="_detailLoading_ljlgs_376";function Se(){const{openProfileModal:i}=e(),[l,c]=j.useState([]),[d,u]=j.useState(!1),[m,f]=j.useState(null),[p,h]=j.useState(()=>new Set),[g,x]=j.useState("count"),[y,_]=j.useState(null),[w,v]=j.useState(null),[b,E]=j.useState(!1),S=j.useMemo(()=>l,[l]),M=j.useCallback(async()=>{const e=t(),o=e?.did;if(o){u(!0);try{const e="mutuals"===g?await n(s,o,{maxSuggestions:20}):await r(s,o,{maxSuggestions:20}),t=B(),a=Date.now()-6048e5,i=e.filter(e=>!p.has(e.did)&&(!t[e.did]||t[e.did]<a)).slice(0,8);c(i)}catch{c([])}finally{u(!1)}}},[p,g]);j.useEffect(()=>{M()},[M]);const T=j.useCallback(async e=>{_(e.did),v(null),E(!0);try{const n=t(),r=n?.did;if(!r)return;const a=await o(s,r,e.did,{source:"mutuals"===g?"mutuals":"peopleYouFollow"});v(a)}catch{v({count:0,followedBy:[]})}finally{E(!1)}},[g]),k=j.useCallback(async(e,t)=>{f(e);try{await s.follow(e),c(t=>t.filter(t=>t.did!==e))}catch{}finally{f(null)}},[]),I=j.useCallback(e=>{!function(e){if(0===e.length)return;const t=Date.now(),n={...B()};for(const o of e)n[o]=t;const s=Object.entries(n),r=s.length<=500?s:s.sort((e,t)=>(t[1]??0)-(e[1]??0)).slice(0,500);try{localStorage.setItem(H,JSON.stringify(Object.fromEntries(r)))}catch{}}([e]),h(t=>new Set(t).add(e)),c(t=>t.filter(t=>t.did!==e))},[]),R=y?l.find(e=>e.did===y):null;return a.jsxs("div",{className:Y,"aria-label":"Suggested accounts to follow",children:[a.jsx("p",{className:$,children:"Accounts followed by people you follow. New suggestions each time you open."}),l.length>0&&a.jsxs("div",{className:z,children:[a.jsx("span",{className:K,children:"Sort by:"}),a.jsxs("select",{className:q,value:g,onChange:e=>x(e.target.value),"aria-label":"Sort suggestions",children:[a.jsx("option",{value:"count",children:"Most followed by people you follow"}),a.jsx("option",{value:"mutuals",children:"Most followed by mutuals"})]})]}),d&&0===l.length?a.jsx("p",{className:W,children:"Loading…"}):0===l.length?a.jsx("p",{className:G,children:"No suggestions right now. Follow more accounts to see recommendations."}):a.jsx("ul",{className:V,children:S.map(e=>a.jsxs("li",{className:J,children:[a.jsxs("button",{type:"button",className:X,onClick:()=>i(e.handle),"aria-label":`View @${e.handle} profile`,children:[e.avatar?a.jsx("img",{src:e.avatar,alt:"",className:Q,loading:"lazy"}):a.jsx("span",{className:Z,"aria-hidden":!0,children:(e.displayName??e.handle).slice(0,1).toUpperCase()}),a.jsxs("span",{className:ee,children:[a.jsxs("span",{className:te,children:["@",e.handle]}),a.jsx("span",{className:ne,children:"mutuals"===g?1===e.count?"Followed by 1 mutual":`Followed by ${e.count} mutuals`:1===e.count?"Followed by 1 person you follow":`Followed by ${e.count} people you follow`})]})]}),a.jsxs("div",{className:se,children:[a.jsx("button",{type:"button",className:re,onClick:t=>{t.stopPropagation(),T(e)},"aria-label":"Why we recommend this account",title:"Why we recommend this account",children:a.jsx(je,{})}),a.jsx("button",{type:"button",className:ae,onClick:()=>k(e.did,e.handle),disabled:m===e.did,children:m===e.did?"…":"Follow"}),a.jsx("button",{type:"button",className:ie,onClick:()=>I(e.did),"aria-label":"Not now",title:"Hide this suggestion for a week",children:"×"})]})]},e.did))}),y&&R&&N.createPortal(a.jsx("div",{className:le,role:"dialog","aria-modal":"true","aria-labelledby":"suggestion-detail-title",onClick:()=>_(null),children:a.jsxs("div",{className:ce,onClick:e=>e.stopPropagation(),children:[a.jsxs("div",{className:de,children:[a.jsxs("h3",{id:"suggestion-detail-title",className:ue,children:["Why we recommend @",R.handle]}),a.jsx("button",{type:"button",className:me,onClick:()=>_(null),"aria-label":"Close",children:"×"})]}),b?a.jsx("p",{className:Ee,children:"Loading…"}):w?a.jsxs("div",{className:fe,children:[a.jsx("p",{className:pe,children:w.fromMutuals?1===w.count?"Followed by 1 mutual:":`Followed by ${w.count} mutuals:`:1===w.count?"Followed by 1 person you follow:":`Followed by ${w.count} people you follow:`}),a.jsx("ul",{className:he,children:w.followedBy.map(e=>a.jsx("li",{className:ge,children:a.jsxs("button",{type:"button",className:xe,onClick:()=>{i(e.handle),_(null)},children:[e.avatar?a.jsx("img",{src:e.avatar,alt:"",className:ye,loading:"lazy"}):a.jsx("span",{className:_e,"aria-hidden":!0,children:(e.displayName??e.handle).slice(0,1).toUpperCase()}),a.jsxs("span",{className:we,children:[e.displayName&&a.jsx("span",{className:ve,children:e.displayName}),a.jsxs("span",{className:be,children:["@",e.handle]})]})]})},e.did))})]}):null]})}),document.body)]})}function je(){return a.jsx("svg",{className:oe,viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":!0,children:a.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})}const Ne=j.memo(function(e){const t=j.useRef(null);return function(e,t){const[n,s]=j.useState(!0),r=j.useRef(null);j.useEffect(()=>{const n=e.current;if(n)return r.current=new IntersectionObserver(e=>{for(const t of e)s(t.isIntersecting)},{rootMargin:t?.rootMargin??"400px 0px 400px 0px",threshold:t?.threshold??0,...t}),r.current.observe(n),()=>{r.current&&(r.current.disconnect(),r.current=null)}},[e,t])}(t,{rootMargin:"1200px 0px 1200px 0px",threshold:0}),a.jsx(F,{...e,cardRef:n=>{t.current=n,e.cardRef(n)},onAspectRatio:void 0})}),Me="_wrap_a6pg0_1",Te="_seen_a6pg0_11",ke="_header_a6pg0_15",Ie="_repostIcon_a6pg0_25",Re="_title_a6pg0_32",Ae="_scrollWrap_a6pg0_38",Ce="_track_a6pg0_54",Oe="_tile_a6pg0_60",Fe="_tileImg_a6pg0_86",Pe="_tilePlaceholder_a6pg0_94",Le="_tileHandle_a6pg0_107";function De(){return a.jsx("svg",{className:Ie,viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":!0,children:a.jsx("path",{d:"M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"})})}function Ue({items:e,onPostClick:t,cardRef:n,seen:s,"data-post-uri":r}){if(0===e.length)return null;const o=e=>e.reason?.by;return a.jsxs("div",{ref:n,className:`${Me} ${s?Te:""}`,"data-post-uri":r??e[0]?.post?.uri,role:"article","aria-label":`${e.length} reposts`,children:[a.jsxs("div",{className:ke,children:[a.jsx(De,{}),a.jsxs("span",{className:Re,children:[e.length," reposts"]})]}),a.jsx("div",{className:Ae,children:a.jsx("div",{className:Ce,children:e.map(e=>{const n=e.post.uri,s=(e=>o(e)?.handle??o(e)?.did??e.post.author?.handle??e.post.author?.did??"")(e),r=i(e.post),l=e.post.author?.avatar,c=r?.url??l;return a.jsxs("button",{type:"button",className:Oe,onClick:()=>t(n,{initialItem:e}),"aria-label":s?`Repost by @${s}, open post`:"Open post",children:[c?a.jsx("img",{src:c,alt:"",className:Fe,loading:"lazy"}):a.jsx("span",{className:Pe,children:(e.post.author?.displayName??s??e.post.author?.did??"?").slice(0,1).toUpperCase()}),s?a.jsxs("span",{className:Le,children:["@",s]}):null]},n)})})})]})}const He=100;function Be({column:e,scrollMargin:t,loadMoreSentinelRef:n,hasCursor:s,keyboardFocusIndex:r,focusTargets:o,focusSetByMouse:i,keyboardAddOpen:d,actionsMenuOpenForIndex:u,nsfwPreference:m,unblurredUris:f,setUnblurred:p,likeOverrides:h,setLikeOverrides:g,seenUris:x,openPostModal:y,cardRef:_,onMediaRef:w,onActionsMenuOpenChange:v,onMouseEnter:b,onAddClose:E}){const S=O({count:e.length,estimateSize:t=>function(e){if("carousel"===e.type)return 200;const t=c(e.item.post);if(0===t.length){const t=e.item.post.record?.text||"",n=Math.ceil(t.length/50),s=Math.min(20*n,200);return He+s}if(t.length>1){const e=1/t.reduce((e,t)=>e+1/(t.aspectRatio||1),0),n=Math.ceil(280/e);return He+n+4*(t.length-1)}const n=t[0];if(null!=n.aspectRatio&&n.aspectRatio>0){const e=Math.ceil(280/n.aspectRatio);return He+Math.min(Math.max(e,150),600)}return 320}(e[t].entry),overscan:5,scrollMargin:t,gap:6}),j=S.getVirtualItems(),N=S.getTotalSize();return 0===e.length?a.jsx("div",{className:L.gridColumn,children:s&&null!=n&&a.jsx("div",{ref:n,className:L.loadMoreSentinel,"aria-hidden":!0})}):a.jsxs("div",{className:L.gridColumn,children:[a.jsx("div",{style:{height:`${N}px`,width:"100%",position:"relative"},children:j.map(t=>{const{entry:n,originalIndex:s}=e[t.index],j="post"===n.type?n.item.post.uri:`carousel-${n.items[0].post.uri}`;return a.jsx("div",{"data-index":t.index,ref:S.measureElement,className:L.gridItem,"data-selected":o[r]?.cardIndex===s||void 0,"data-post-uri":"post"===n.type?n.item.post.uri:n.items[0].post.uri,style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${t.start-S.options.scrollMargin}px)`},onMouseEnter:()=>b(s),children:"post"===n.type?a.jsx(Ne,{item:n.item,isSelected:o[r]?.cardIndex===s,focusedMediaIndex:o[r]?.cardIndex!==s||i&&c(n.item.post).length>1?void 0:o[r]?.mediaIndex,onMediaRef:(e,t)=>w(s,e,t),cardRef:_(s),openAddDropdown:o[r]?.cardIndex===s&&d,onAddClose:E,onActionsMenuOpenChange:e=>v(s,e),cardIndex:s,actionsMenuOpenForIndex:u,onPostClick:(e,t)=>{t?.initialItem&&P(e,t.initialItem),y(e,t?.openReply)},fillCell:!1,nsfwBlurred:"blurred"===m&&l(n.item.post)&&!f.has(n.item.post.uri),onNsfwUnblur:()=>p(n.item.post.uri,!0),likedUriOverride:h[n.item.post.uri],onLikedChange:(e,t)=>g(e,t??null),seen:x.has(n.item.post.uri)}):a.jsx(Ue,{items:n.items,onPostClick:(e,t)=>{t?.initialItem&&P(e,t.initialItem),y(e)},cardRef:_(s),seen:x.has(n.items[0].post.uri),"data-post-uri":n.items[0].post.uri})},j)})}),s&&null!=n&&a.jsx("div",{ref:n,className:L.loadMoreSentinel,"aria-hidden":!0})]})}function Ye(e,t){switch(t.type){case"SET_ITEMS":return{...e,items:t.items,cursor:t.cursor,loading:!1,error:null};case"APPEND_ITEMS":return{...e,items:[...e.items,...t.items],cursor:t.cursor,loadingMore:!1,error:null};case"UPDATE_ITEMS":return{...e,items:t.updater(e.items)};case"SET_LOADING":return{...e,loading:t.loading};case"SET_LOADING_MORE":return{...e,loadingMore:t.loadingMore};case"SET_ERROR":return{...e,error:t.error,loading:!1,loadingMore:!1};case"SET_KEYBOARD_FOCUS":return{...e,keyboardFocusIndex:t.index};case"SET_ACTIONS_MENU_OPEN":return{...e,actionsMenuOpenForIndex:t.index};case"MARK_SEEN":{const n=new Set(e.seenUris);return t.uris.forEach(e=>n.add(e)),{...e,seenUris:n}}case"RESET_SEEN_SNAPSHOT":return{...e,seenUrisAtReset:new Set(e.seenUris)};case"CLEAR_SEEN":return{...e,seenUris:new Set,seenUrisAtReset:new Set};default:return e}}function $e(e){const t=new Set;return e.filter(e=>{const n=e?.post?.uri;return!(!n||t.has(n))&&(t.add(n),!0)})}const ze="artsky-seen-posts";function Ke(){const e=h.get(ze);return e&&Array.isArray(e)?new Set(e):new Set}const qe=[{kind:"timeline",label:"Following"},{kind:"custom",label:"What's Hot",uri:"at://did:plc:z72i7hdynmk6r22z27h6tvur/app.bsky.feed.generator/whats-hot"}];function We(e){if("undefined"==typeof window)return()=>{};const t=window.matchMedia("(min-width: 768px)");return t.addEventListener("change",e),()=>t.removeEventListener("change",e)}function Ge(){return"undefined"!=typeof window&&window.innerWidth>=768}function Ve(e){return"app.bsky.feed.defs#reasonRepost"===e.reason?.$type}function Je(e){const t=e.post.record?.createdAt,n=e.post.indexedAt,s=t??n??"";return s?new Date(s).getTime():0}function Xe(e){const t=[];let n=0,s=[],r=0,o=0;function a(){if(s.length>=4)t.push({type:"carousel",items:[...s],entryIndex:n++});else for(const e of s)t.push({type:"post",item:e,entryIndex:n++});s=[]}for(const i of e){if(!Ve(i)){a(),t.push({type:"post",item:i,entryIndex:n++});continue}const e=Je(i);if(0===s.length){s.push(i),r=e,o=e;continue}const l=Math.min(r,e),c=Math.max(o,e);c-l<=36e5?(s.push(i),r=l,o=c):(a(),s=[i],r=e,o=e)}return a(),t}function Qe(e){if("carousel"===e.type)return 200;const t=i(e.item.post);return t?null!=t.aspectRatio&&t.aspectRatio>0?100+280/t.aspectRatio:320:180}function Ze(e,t){const n=Math.max(e.top,t.top),s=Math.min(e.bottom,t.bottom);return Math.max(0,s-n)}function et(){const t=M(),n=T(),r=k(),o=j.useSyncExternalStore(We,Ge,()=>!1),{openLoginModal:N}=d(),{session:O}=u(),{viewMode:F}=m(),[P,H]=j.useState(qe[0]),[,B]=j.useState([]),{likeOverrides:Y,setLikeOverride:$}=f(),[z,K]=j.useReducer(Ye,{items:[],cursor:void 0,loading:!0,loadingMore:!1,error:null,keyboardFocusIndex:-1,actionsMenuOpenForIndex:null,seenUris:Ke(),seenUrisAtReset:new Set(Ke())}),q=j.useRef([]),W=j.useRef(!1),G=j.useRef(0),[V,J]=j.useState(!1),{openPostModal:X,isModalOpen:Q}=e(),Z=j.useRef([]),ee=j.useRef({}),te=j.useRef([]),ne=j.useRef(-1),se=j.useRef(null),re=j.useRef(-1),oe=j.useRef(!1),ae=j.useRef(!1),[ie,le]=j.useState(!1),[ce,de]=j.useState(!1),[ue,me]=j.useState(null),fe=j.useRef(null),pe=j.useRef(null),he=j.useRef(t.pathname),ge=j.useRef(z.seenUris);ge.current=z.seenUris;const xe=p(),[ye,_e]=j.useState(!1),we=j.useRef(null),[ve,be]=j.useState(0);j.useEffect(()=>{if(xe)return xe.setClearSeenHandler(()=>{requestAnimationFrame(()=>{h.remove(ze),ge.current=new Set,K({type:"CLEAR_SEEN"})})}),()=>{xe.setClearSeenHandler(null)}},[xe]),j.useEffect(()=>{if(xe)return xe.setHomeClickHandler(()=>{requestAnimationFrame(()=>{K({type:"RESET_SEEN_SNAPSHOT"}),window.scrollTo(0,0)})}),()=>{xe.setHomeClickHandler(null)}},[xe]),j.useEffect(()=>{if(xe)return xe.setHideSeenOnlyHandler(e=>{requestAnimationFrame(()=>{const t=ge.current.size;K({type:"RESET_SEEN_SNAPSHOT"}),e(0===t?"No seen posts in feed":`${t} seen posts hidden`)})}),()=>{xe.setHideSeenOnlyHandler(null)}},[xe]);const Ee=j.useCallback(async()=>{if(O)try{const e=(await g()).filter(e=>"feed"===e.type&&e.pinned),t=await Promise.all(e.map(async e=>({kind:"custom",label:await x(e.value).catch(()=>e.value),uri:e.value})));B(t)}catch{B([])}else B([])},[O]);j.useEffect(()=>{Ee()},[Ee]),j.useEffect(()=>{let e;let t="undefined"!=typeof window?window.scrollY:0,n=t;const s=D(()=>{const s=window.scrollY,r=document.body.classList.contains("feed-scrolling"),o=s<n;if(n=s,o)return r&&(document.body.classList.remove("feed-scrolling"),e&&(clearTimeout(e),e=void 0)),void(t=s);r?(e&&clearTimeout(e),e=setTimeout(()=>{document.body.classList.remove("feed-scrolling"),t=window.scrollY,e=void 0},200)):s-t>=48&&(document.body.classList.add("feed-scrolling"),e&&clearTimeout(e),e=setTimeout(()=>{document.body.classList.remove("feed-scrolling"),t=window.scrollY,e=void 0},200))},16);return window.addEventListener("scroll",s,{passive:!0}),()=>{window.removeEventListener("scroll",s),e&&clearTimeout(e),document.body.classList.remove("feed-scrolling")}},[]),j.useEffect(()=>{const e=he.current!==t.pathname;("/"===t.pathname||t.pathname.startsWith("/feed"))&&e&&K({type:"RESET_SEEN_SNAPSHOT"}),he.current=t.pathname,"POP"!==r&&e&&window.scrollTo(0,0)},[t.pathname,r]),j.useEffect(()=>{const e=t.state?.feedSource;e&&(H(e),n(t.pathname,{replace:!0}))},[t.state,t.pathname,n]);const{entries:je,totalPercent:Ne}=y(),Me=I(),Te=j.useRef(null),ke=j.useRef("unknown");const Ie=j.useCallback(async(e,t)=>{const n=Math.min(3,Math.max(1,"1"===F?1:"2"===F?2:3)),r=n>=2?10*n:30;try{if(t?.aborted)return;if(K(e?{type:"SET_LOADING_MORE",loadingMore:!0}:{type:"SET_LOADING",loading:!0}),K({type:"SET_ERROR",error:null}),O){if(je.length>=2&&Ne>=99){const n=!!e;let s;if(n&&e)try{s=JSON.parse(e)}catch{s=void 0}const{feed:o,cursors:a}=await w(je.map(e=>({source:e.source,percent:e.percent})),r,s,t);if(t?.aborted)return;const i=()=>{const e=$e(n?[...z.items,...o]:o),t=Object.keys(a).length>0?JSON.stringify(a):void 0;K(n?{type:"APPEND_ITEMS",items:o,cursor:t}:{type:"SET_ITEMS",items:e,cursor:t})};n?j.startTransition(i):i()}else if(1===je.length){const t=je[0].source;if("timeline"===t.kind){const t=await s.getTimeline({limit:r,cursor:e}),n=()=>{const n=$e(e?[...z.items,...t.data.feed]:t.data.feed);K(e?{type:"APPEND_ITEMS",items:t.data.feed,cursor:t.data.cursor}:{type:"SET_ITEMS",items:n,cursor:t.data.cursor})};e?j.startTransition(n):n()}else if(t.uri){const n=await s.app.bsky.feed.getFeed({feed:t.uri,limit:r,cursor:e}),o=()=>{const t=$e(e?[...z.items,...n.data.feed]:n.data.feed);K(e?{type:"APPEND_ITEMS",items:n.data.feed,cursor:n.data.cursor}:{type:"SET_ITEMS",items:t,cursor:n.data.cursor})};e?j.startTransition(o):o()}}else if("timeline"===P.kind){const t=await s.getTimeline({limit:r,cursor:e}),n=()=>{const n=$e(e?[...z.items,...t.data.feed]:t.data.feed);K(e?{type:"APPEND_ITEMS",items:t.data.feed,cursor:t.data.cursor}:{type:"SET_ITEMS",items:n,cursor:t.data.cursor})};e?j.startTransition(n):n()}else if(P.uri){const t=await s.app.bsky.feed.getFeed({feed:P.uri,limit:r,cursor:e}),n=()=>{const n=$e(e?[...z.items,...t.data.feed]:t.data.feed);K(e?{type:"APPEND_ITEMS",items:t.data.feed,cursor:t.data.cursor}:{type:"SET_ITEMS",items:n,cursor:t.data.cursor})};e?j.startTransition(n):n()}}else{const{feed:n,cursor:s}=await _(r,e);if(t?.aborted)return;const o=()=>{const t=$e(e?[...z.items,...n]:n);K(e?{type:"APPEND_ITEMS",items:n,cursor:s}:{type:"SET_ITEMS",items:t,cursor:s})};e?j.startTransition(o):o()}}catch(o){const e=o instanceof Error?o.message:"Failed to load feed";K({type:"SET_ERROR",error:e})}finally{K({type:"SET_LOADING",loading:!1}),K({type:"SET_LOADING_MORE",loadingMore:!1})}},[P,O,je,Ne,z.items]);j.useEffect(()=>{const e=new AbortController;return Ie(void 0,e.signal),()=>{e.abort()}},[Ie]);W.current=z.loadingMore,j.useEffect(()=>{if(!z.cursor)return;const e=q.current;let t=0,n=0,s=0;const r=Math.min(3,Math.max(1,"1"===F?1:"2"===F?2:3)),o=()=>{clearTimeout(s);const t=Math.max(50,1800-(Date.now()-G.current)+50);s=window.setTimeout(()=>{W.current||(()=>{for(let t=0;t<r;t++){const n=e[t];if(n&&n.getBoundingClientRect().bottom<window.innerHeight)return!0}return!1})()&&(W.current=!0,G.current=Date.now(),Ie(z.cursor))},t)},a=new IntersectionObserver(e=>{for(const s of e){if(!s.isIntersecting||W.current)continue;if(Date.now()-G.current<1800){o();continue}W.current=!0;const e=z.cursor;t=requestAnimationFrame(()=>{t=0,n=window.setTimeout(()=>{n=0,G.current=Date.now(),Ie(e)},120)});break}},{rootMargin:"600px",threshold:0});for(let i=0;i<r;i++){const t=e[i];t&&a.observe(t)}return r>1&&o(),()=>{a.disconnect(),t&&cancelAnimationFrame(t),n&&clearTimeout(n),clearTimeout(s)}},[z.cursor,Ie,F]);const{mediaMode:Re}=v(),{nsfwPreference:Ae,unblurredUris:Ce,setUnblurred:Oe}=b(),{hideRepostsFromDids:Fe}=E()??{hideRepostsFromDids:[]},Pe=j.useMemo(()=>z.items.filter(e=>"media"!==Re||i(e.post)).filter(e=>!z.seenUrisAtReset.has(e.post.uri)).filter(e=>"sfw"!==Ae||!l(e.post)).filter(e=>{if(!Ve(e))return!0;const t=e.reason?.by?.did;return!t||!Fe.includes(t)}),[z.items,Re,z.seenUrisAtReset,Ae,Fe]),Le=j.useMemo(()=>Xe(Pe),[Pe]),De=j.useMemo(()=>z.items.filter(e=>"media"!==Re||i(e.post)).filter(e=>"sfw"!==Ae||!l(e.post)),[z.items,Re,Ae]),Ue=0===Le.length&&De.length>0&&!z.cursor,He=0===Le.length&&null!=z.cursor,Je=U(F,150),et=j.useMemo(()=>function(e,t){const n=Math.min(3,Math.max(1,Math.floor(t)));if(n<1)return[];const s=Array.from({length:n},()=>[]),r=Array(n).fill(0);for(let o=0;o<e.length;o++){const t=e[o],a=Qe(t),i=s.map(e=>e.length),l=0===i.length?0:Math.min(...i);let c=-1;for(let e=0;e<n;e++)s[e].length>l+1||(-1===c||r[e]<r[c]||r[e]===r[c]&&s[e].length<s[c].length)&&(c=e);-1===c&&(c=0),s[c].push({entry:t,originalIndex:o}),r[c]+=a}return s}(Le,Je),[Le,Je]),tt=j.useMemo(()=>{const e=[];return Le.forEach((t,n)=>{if("post"===t.type){const s="text"===Re?1:Math.max(1,c(t.item.post).length);for(let t=0;t<s;t++)e.push({cardIndex:n,mediaIndex:t})}else e.push({cardIndex:n,mediaIndex:0})}),e},[Le,Re]),nt=j.useMemo(()=>{const e=[];let t=0;return Le.forEach((n,s)=>{e[s]=t;const r=Le[s],o="post"===r.type?"text"===Re?1:Math.max(1,c(r.item.post).length):1;t+=o}),e},[Le,Re]),st=j.useMemo(()=>{const e=[];return Le.forEach((t,n)=>{const s="post"===t.type?"text"===Re?1:Math.max(1,c(t.item.post).length):1;e[n]=nt[n]+s-1}),e},[Le,nt,Re]);te.current=Pe,ne.current=z.keyboardFocusIndex,se.current=z.actionsMenuOpenForIndex,j.useLayoutEffect(()=>{const e=we.current;if(!e)return;const t=()=>{const t=e.getBoundingClientRect().top+window.scrollY;be(t)};t();const n=D(t,150),s=new ResizeObserver(n);return s.observe(e),()=>s.disconnect()},[Le.length,ye]),j.useEffect(()=>{const e=z.keyboardFocusIndex;if(e<0)return;if(0===tt.length)return void K({type:"SET_KEYBOARD_FOCUS",index:-1});const t=Math.min(e,tt.length-1);t!==e&&K({type:"SET_KEYBOARD_FOCUS",index:t})},[tt.length,z.keyboardFocusIndex]);const rt=j.useMemo(()=>D(e=>function(e){const t=[...e],n=t.length>2e3?t.slice(-2e3):t;h.set(ze,n)}(e),1e3),[]);j.useEffect(()=>{rt(z.seenUris)},[z.seenUris,rt]),j.useEffect(()=>{const e=new Set;let t=0,n=0;const s=()=>{if(t=0,0===e.size)return;const r=Date.now();if(r-n<400)return void(t=requestAnimationFrame(s));n=r;const o=Array.from(e);e.clear(),j.startTransition(()=>{K({type:"MARK_SEEN",uris:o}),ge.current=new Set([...ge.current,...o])})},r=new IntersectionObserver(n=>{for(const t of n)if(!t.isIntersecting&&t.boundingClientRect.top<0){const n=t.target.getAttribute("data-post-uri");n&&!ge.current.has(n)&&e.add(n)}e.size>0&&!t&&(t=requestAnimationFrame(s))},{threshold:0,rootMargin:"0px"}),o=Math.min(Le.length,80);for(let a=0;a<o;a++){const e=Z.current[a];e&&r.observe(e)}return()=>{r.disconnect(),t&&cancelAnimationFrame(t)}},[Le.length]),j.useEffect(()=>{const e=()=>{ae.current=!0};return window.addEventListener("mousemove",e),()=>window.removeEventListener("mousemove",e)},[]),j.useEffect(()=>{if(!oe.current)return;if(oe.current=!1,z.keyboardFocusIndex===re.current)return;re.current=z.keyboardFocusIndex;const e=tt[z.keyboardFocusIndex],t=requestAnimationFrame(()=>{const t=e?.cardIndex??z.keyboardFocusIndex,n=e?.mediaIndex??0,s=ee.current[t]?.[n],r=s??Z.current[t];r&&r.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})});return()=>cancelAnimationFrame(t)},[z.keyboardFocusIndex,tt]),j.useEffect(()=>{const e=e=>{const n=/[?&](post|profile|tag|forumPost|artboard)=/.test(t.search);if(Q||n)return;const r=e.target;if("INPUT"===r.tagName||"TEXTAREA"===r.tagName||"SELECT"===r.tagName||r.isContentEditable)return void("Escape"===e.key&&(e.preventDefault(),r.blur()));if(e.ctrlKey||e.metaKey)return;const o=ne.current;if(0===Le.length||0===tt.length)return;de(!1);const a=tt[o],i=a?.cardIndex??0,l=Le[i],c="post"===l?.type?l.item:"carousel"===l?.type?l.items[0]:null,d=e.key.toLowerCase(),u=document.activeElement?.closest?.('[role="menu"]'),m=z.actionsMenuOpenForIndex===i;if((u||m)&&("w"===d||"s"===d||"e"===d||"enter"===d||"q"===d||"escape"===d))return;if(e.repeat&&("a"===d||"d"===d||"ArrowLeft"===e.key||"ArrowRight"===e.key))return;if(ue)return"escape"===d?(e.preventDefault(),void me(null)):void 0;if("w"!==d&&"s"!==d&&"a"!==d&&"d"!==d&&"e"!==d&&"enter"!==d&&"r"!==d&&"f"!==d&&"c"!==d&&"h"!==d&&"b"!==d&&"m"!==d&&"`"!==d&&"4"!==d&&"ArrowUp"!==e.key&&"ArrowDown"!==e.key&&"ArrowLeft"!==e.key&&"ArrowRight"!==e.key||e.preventDefault(),"b"===d)return void(c?.post?.author&&O?.did!==c.post.author.did&&(me({did:c.post.author.did,handle:c.post.author.handle??c.post.author.did,avatar:c.post.author.avatar}),requestAnimationFrame(()=>fe.current?.focus())));const f=o<0,p=Je>=2?et:null,h=e=>Z.current[e]?.getBoundingClientRect();if("w"===d||"ArrowUp"===e.key){ae.current=!1,le(!0),oe.current=!0;const e=o===nt[i],t=f?st[Le.length-1]??tt.length-1:e?(()=>{const e=Je>=2&&p?function(e,t){for(let n=0;n<e.length;n++){const s=e[n].findIndex(e=>e.originalIndex===t);if(s>0)return e[n][s-1].originalIndex;if(0===s)return t}return t}(p,i):Math.max(0,i-1);return st[e]??nt[e]??0})():Math.max(0,o-1);return void K({type:"SET_KEYBOARD_FOCUS",index:t})}if("s"===d||"ArrowDown"===e.key){ae.current=!1,le(!0),oe.current=!0;const e=o===st[i],t=f?0:e?(()=>{const e=Je>=2&&p?function(e,t){for(let n=0;n<e.length;n++){const s=e[n].findIndex(e=>e.originalIndex===t);if(s>=0&&s<e[n].length-1)return e[n][s+1].originalIndex;if(s>=0)return t}return t}(p,i):Math.min(Le.length-1,i+1);return nt[e]??o})():Math.min(tt.length-1,o+1);return void K({type:"SET_KEYBOARD_FOCUS",index:t})}if("a"===d||"ArrowLeft"===e.key){ae.current=!1,le(!0),oe.current=!0;const e=f?0:Je>=2&&p?function(e,t,n){for(let s=0;s<e.length;s++){if(e[s].findIndex(e=>e.originalIndex===t)<0)continue;if(0===s)return t;const r=e[s-1],o=n(t);if(!o)return t;let a=t,i=-1;for(const{originalIndex:e}of r){const t=n(e);if(!t)continue;const s=Ze(o,t);s>0&&s>i&&(i=s,a=e)}return a}return t}(p,i,h):i,t=f?0:e!==i?st[e]??o:o;return t!==o&&K({type:"SET_ACTIONS_MENU_OPEN",index:null}),void K({type:"SET_KEYBOARD_FOCUS",index:t})}if("d"===d||"ArrowRight"===e.key){ae.current=!1,le(!0),oe.current=!0;const e=f?0:Je>=2&&p?function(e,t,n){for(let s=0;s<e.length;s++){if(e[s].findIndex(e=>e.originalIndex===t)<0)continue;if(s===e.length-1)return t;const r=e[s+1],o=n(t);if(!o)return t;let a=t,i=-1;for(const{originalIndex:e}of r){const t=n(e);if(!t)continue;const s=Ze(o,t);s>0&&s>i&&(i=s,a=e)}return a}return t}(p,i,h):i,t=f?0:e!==i?st[e]??o:o;return t!==o&&K({type:"SET_ACTIONS_MENU_OPEN",index:null}),void K({type:"SET_KEYBOARD_FOCUS",index:t})}if(("m"===d||"`"===d)&&o>=0)K(m?{type:"SET_ACTIONS_MENU_OPEN",index:null}:{type:"SET_ACTIONS_MENU_OPEN",index:i});else if("e"!==d&&"enter"!==d)if("r"!==d){if("f"===d){const e=c;if(!e?.post?.uri||!e?.post?.cid)return;const t=e.post.uri,n=t in Y?Y[t]??void 0:e.post.viewer?.like;return void(n?s.deleteLike(n).then(()=>{$(t,null)}).catch(()=>{}):s.like(t,e.post.cid).then(e=>{$(t,e.uri)}).catch(()=>{}))}if("c"!==d){if("4"===d){const e=c?.post?.author,t=c?.post?.uri;if(e&&O?.did&&O.did!==e.did&&t){const n=e.viewer?.following;n?s.deleteFollow(n).then(()=>{K({type:"UPDATE_ITEMS",updater:e=>e.map(e=>{if(e.post.uri!==t)return e;const n=e.post,s=n.author;return{...e,post:{...n,author:{...s,viewer:{...s.viewer,following:void 0}}}}})})}).catch(()=>{}):s.follow(e.did).then(e=>{K({type:"UPDATE_ITEMS",updater:n=>n.map(n=>{if(n.post.uri!==t)return n;const s=n.post,r=s.author;return{...n,post:{...s,author:{...r,viewer:{...r.viewer,following:e.uri}}}}})})}).catch(()=>{})}}}else J(!0)}else c&&X(c.post.uri,!0);else c&&X(c.post.uri)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[t.search,Je,Q,X,ue,O,Y,z.actionsMenuOpenForIndex,tt,nt,st]),j.useEffect(()=>{ue&&fe.current?.focus()},[ue]);const ot=j.useRef(null),at=j.useContext(R),it=C({scrollRef:{current:null},touchTargetRef:at?.wrapperRef??ot,onRefresh:async()=>{await Ie(),requestAnimationFrame(()=>{K({type:"RESET_SEEN_SNAPSHOT"}),window.scrollTo(0,0)})},enabled:o,maxTouchStartY:130}),lt=!!Me&&1===je.length&&Me.feedSources.length>1,ct=j.useCallback(e=>{it.onTouchStart(e),lt&&1===e.touches.length&&(Te.current={x:e.touches[0].clientX,y:e.touches[0].clientY},ke.current="unknown")},[lt,it]),dt=j.useCallback(e=>{if(lt&&Te.current&&1===e.touches.length){if("unknown"===ke.current){const t=e.touches[0].clientX-Te.current.x,n=e.touches[0].clientY-Te.current.y;(Math.abs(t)>20||Math.abs(n)>20)&&(ke.current=Math.abs(t)>2*Math.abs(n)?"swipe":"pull")}"pull"!==ke.current&&"unknown"!==ke.current||it.onTouchMove(e)}else it.onTouchMove(e)},[lt,it]),ut=j.useCallback(e=>{if(lt&&Me&&Te.current&&1===e.changedTouches.length){const t=e.changedTouches[0].clientX-Te.current.x,n=e.changedTouches[0].clientY-Te.current.y;if("swipe"===ke.current&&Math.abs(t)>80&&Math.abs(t)>2*Math.abs(n)){const e=Me.feedSources,n=je[0].source,s=e.findIndex(e=>{return s=n,((t=e).uri??t.label)===(s.uri??s.label);var t,s});if(s>=0){const n=t<0?(s+1)%e.length:(s-1+e.length)%e.length;Me.setSingleFeed(e[n])}}Te.current=null,ke.current="unknown"}it.onTouchEnd(e)},[lt,Me,je,it]);j.useEffect(()=>{const e=at?.setHandlers;if(e)return e({onTouchStart:ct,onTouchMove:dt,onTouchEnd:ut}),()=>{e(null)}},[at?.setHandlers,ct,dt,ut]);const mt=!!at?.wrapperRef;return a.jsx(A,{title:"Feed",showNav:!0,children:a.jsxs(a.Fragment,{children:[a.jsxs("div",{ref:ot,className:L.wrap,onTouchStart:mt?void 0:ct,onTouchMove:mt?void 0:dt,onTouchEnd:mt?void 0:ut,children:[a.jsx("div",{className:`${L.pullRefreshHeader} ${it.pullDistance>0||it.isRefreshing?L.pullRefreshHeaderActive:""}`,"aria-hidden":0===it.pullDistance&&!it.isRefreshing,"aria-live":"polite","aria-label":it.isRefreshing?"Refreshing":void 0,children:(it.pullDistance>0||it.isRefreshing)&&a.jsx("div",{className:L.pullRefreshSpinner})}),a.jsxs("div",{className:L.pullRefreshContent,style:{transform:`translateY(${it.pullDistance}px)`},children:[O&&a.jsxs("div",{className:L.suggestedFollowsSection,children:[a.jsx("div",{className:L.suggestedFollowsSectionInner,children:a.jsx("button",{type:"button",className:L.suggestedFollowsToggle,onClick:()=>_e(e=>!e),"aria-expanded":ye,"aria-label":ye?"Hide suggestions":"Discover accounts to follow",children:ye?"Hide suggestions":"Discover accounts"})}),ye&&a.jsx(Se,{})]}),a.jsxs("div",{className:L.feedContentTransition,children:[z.error&&a.jsx("p",{className:L.error,children:z.error}),z.loading?a.jsx("div",{className:L.loading,children:"Loading…"}):0===Le.length?a.jsx("div",{className:L.empty,children:He?a.jsxs(a.Fragment,{children:[a.jsx("p",{className:L.emptyLoadMoreText,children:De.length>0?"You've seen everything visible from this batch. There may be more from your other feeds.":"No posts in this batch."}),a.jsx("button",{type:"button",className:L.loadMoreBtn,onClick:()=>z.cursor&&!z.loadingMore&&Ie(z.cursor),disabled:z.loadingMore,children:z.loadingMore?"Loading…":"Load more"})]}):Ue?a.jsxs(a.Fragment,{children:["You've seen all the posts in this feed.",a.jsx("br",{}),"New posts will appear as they're posted."]}):"media"===Re?"No posts with images or videos in this feed.":"No posts in this feed."}):a.jsxs(a.Fragment,{children:[a.jsx("div",{ref:we,className:`${L.gridColumns} ${L[`gridView${F}`]}`,"data-feed-cards":!0,"data-view-mode":F,"data-keyboard-nav":ie||void 0,onMouseLeave:o&&!Q?()=>K({type:"SET_KEYBOARD_FOCUS",index:-1}):void 0,children:et.map((e,t)=>a.jsx(Be,{column:e,colIndex:t,scrollMargin:ve,loadMoreSentinelRef:z.cursor?e=>{q.current[t]=e}:void 0,hasCursor:!!z.cursor,keyboardFocusIndex:z.keyboardFocusIndex,focusTargets:tt,firstFocusIndexForCard:nt,focusSetByMouse:ce,keyboardAddOpen:V,actionsMenuOpenForIndex:z.actionsMenuOpenForIndex,nsfwPreference:Ae,unblurredUris:Ce,setUnblurred:Oe,likeOverrides:Y,setLikeOverrides:$,seenUris:z.seenUris,openPostModal:X,cardRef:e=>t=>{Z.current[e]=t},onMediaRef:(e,t,n)=>{ee.current[e]||(ee.current[e]={}),ee.current[e][t]=n},onActionsMenuOpenChange:(e,t)=>K({type:"SET_ACTIONS_MENU_OPEN",index:t?e:null}),onMouseEnter:e=>{o&&ae.current&&(ae.current=!1,le(!1),de(!0),K({type:"SET_KEYBOARD_FOCUS",index:nt[e]??0}))},onAddClose:()=>J(!1)},`${t}-${e.length}`))}),O&&a.jsxs("div",{className:L.loadMoreRow,children:[z.loadingMore&&a.jsx("p",{className:L.loadingMore,role:"status",children:"Loading more…"}),a.jsx("button",{type:"button",className:L.loadMoreBtn,onClick:()=>z.cursor&&!z.loadingMore&&Ie(z.cursor),disabled:z.loadingMore||!z.cursor,children:z.cursor?"Load more":"No more posts"})]})]})]},1===je.length?je[0].source.uri??je[0].source.label:"mixed"),!O&&a.jsxs("div",{className:L.feedLoginHint,children:[a.jsx("div",{className:L.feedLoginHintBtnRow,children:a.jsx("button",{type:"button",className:L.feedLoginHintBtn,onClick:()=>N(),children:"Log in"})}),a.jsxs("p",{className:L.feedLoginHintText,children:["Or"," ",a.jsx("button",{type:"button",className:L.feedLoginHintLink,onClick:()=>N("create"),children:"create an account"})," to see your own feeds."]})]})]})]}),ue&&a.jsx("div",{className:L.blockOverlay,role:"dialog","aria-modal":"true","aria-labelledby":"block-dialog-title",onKeyDown:e=>"Escape"===e.key&&me(null),onClick:()=>me(null),children:a.jsxs("div",{className:L.blockDialog,onClick:e=>e.stopPropagation(),children:[a.jsx("h2",{id:"block-dialog-title",className:L.blockTitle,children:"Block user?"}),a.jsxs("div",{className:L.blockUser,children:[ue.avatar?a.jsx("img",{src:ue.avatar,alt:"",className:L.blockAvatar,loading:"lazy"}):a.jsx("div",{className:L.blockAvatarPlaceholder}),a.jsxs("span",{className:L.blockHandle,children:["@",ue.handle]})]}),a.jsxs("div",{className:L.blockActions,children:[a.jsx("button",{ref:fe,type:"button",className:L.blockCancelBtn,onClick:()=>me(null),children:"Cancel"}),a.jsx("button",{ref:pe,type:"button",className:L.blockConfirmBtn,onClick:async()=>{if(ue)try{await S(ue.did),me(null)}catch(e){}},children:"Block"})]})]})})]})})}export{Xe as buildDisplayEntries,et as default};
