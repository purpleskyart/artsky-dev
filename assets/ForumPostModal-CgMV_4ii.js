import{k as e,D as t,Y as a,Z as s,j as l,_ as n,$ as r,a0 as i,a1 as c,b as o,a2 as d,a3 as u,a4 as m}from"./index-DlaOPLEe.js";import{b as h,L as p}from"./react-vendor-DGaPsC2e.js";import{A as f}from"./AppModal-BsExDXTS.js";import{u as x}from"./useListKeyboardNav-3q-0e0hq.js";import{a as y,b as j}from"./date-Ct-NsrQr.js";import{a as b,P as g}from"./PostText-081Ccbc7.js";import{C as _}from"./Layout-DmzsuBjM.js";import{R as v,g as N}from"./PostDetailPage-CR55Eq6b.js";import{p as k}from"./PostDetailPage.module-43ukAFnx.js";import{g as w,a as C,p as S,d as R,e as A,b as E}from"./forum-96nWbOYU.js";import"./atproto-3-1TCh3S.js";import"./ModalTopBarSlotContext-XWKZv5-E.js";import"./ModalScrollContext-CSfVhxQU.js";import"./usePullToRefresh-DVlCPYCP.js";import"./Icons-COneBEcI.js";import"./postCache-CTqU0alO.js";import"./artboards-DNvSVVrd.js";import"./PostActionsMenu-BMm0Jr67.js";const P="_wrap_lbd08_1",L="_loading_lbd08_6",D="_error_lbd08_12",F="_avatarPlaceholder_lbd08_18",T="_docTitle_lbd08_32",U="_docBody_lbd08_39",B="_docMedia_lbd08_46",I="_docMediaImg_lbd08_53",M="_docLink_lbd08_62",$="_externalLink_lbd08_67",H="_actions_lbd08_76",W="_actionBtn_lbd08_84",z="_actionBtnPrimary_lbd08_85",K="_actionBtnDanger_lbd08_86",q="_deleteConfirmText_lbd08_123",O="_editForm_lbd08_129",V="_editLabel_lbd08_133",Y="_editInput_lbd08_140",G="_editTextarea_lbd08_153",Z="_mediaDropZone_lbd08_174",J="_mediaInputHidden_lbd08_192",Q="_addMediaBtn_lbd08_200",X="_mediaDropHint_lbd08_215",ee="_mediaPreviews_lbd08_220",te="_mediaPreviewWrap_lbd08_228",ae="_mediaPreviewImg_lbd08_233",se="_mediaPreviewRemove_lbd08_243",le="_editActions_lbd08_267",ne="_replySection_lbd08_273",re="_replyFormWrap_lbd08_279",ie="_replySectionTitle_lbd08_289",ce="_replyToBtn_lbd08_328",oe="_commentBadge_lbd08_343",de="_replyForm_lbd08_279",ue="_replyTextarea_lbd08_356",me="_replySubmit_lbd08_375",he="_repliesSection_lbd08_396",pe="_replyList_lbd08_402",fe="_replyItem_lbd08_411",xe="_replyItemNested_lbd08_431",ye="_replyText_lbd08_356",je="_replyItemActions_lbd08_442",be="_viewPostLink_lbd08_449",ge="_likeBtn_lbd08_459",_e="_likeBtnLiked_lbd08_460",ve="_muted_lbd08_478";function Ne({documentUri:d,onClose:u,onRegisterRefresh:m}){const f=d,[N,w]=h.useState(null),[C,S]=h.useState(!0),[R,A]=h.useState(null),[E,Ne]=h.useState([]),[ke,we]=h.useState(!1),[Ce,Se]=h.useState(""),[Re,Ae]=h.useState(!1),[Ee,Pe]=h.useState(!1),[Le,De]=h.useState(""),[Fe,Te]=h.useState(""),[Ue,Be]=h.useState([]),[Ie,Me]=h.useState([]),[$e,He]=h.useState(!1),We=h.useRef(null),ze=h.useRef(null),Ke=h.useRef(null),qe=h.useRef(null),Oe=h.useRef(null),[Ve,Ye]=h.useState(0),[Ge,Ze]=h.useState(!1),[Je,Qe]=h.useState(!1),[Xe,et]=h.useState(null),[tt,at]=h.useState({}),[st,lt]=h.useState({}),[nt,rt]=h.useState({handle:""}),{session:it,sessionsList:ct,switchAccount:ot}=e(),dt=it?.did??"",ut=h.useRef(null),mt=h.useRef(!1),ht=it?.did&&N?.did===it.did,pt=N?function(e){if(!e.baseUrl)return null;const t=e.baseUrl.replace(/\/$/,""),a=(e.path??"").replace(/^\//,"");return a?`${t}/${a}`:t}(N):null,ft=N?.baseUrl?function(e){try{return new URL(e).hostname}catch{return""}}(N.baseUrl):"",xt=h.useMemo(()=>Ie.map(e=>URL.createObjectURL(e)),[Ie]);h.useEffect(()=>()=>xt.forEach(e=>URL.revokeObjectURL(e)),[xt]),h.useEffect(()=>{if(!it?.did)return void rt({handle:""});let e=!1;return t.getProfile({actor:it.did}).then(t=>{if(e)return;const a=t.data;rt({handle:a.handle??it.did,avatar:a.avatar})}).catch(()=>{e||rt({handle:it.handle??it.did})}),()=>{e=!0}},[it?.did]),h.useEffect(()=>{if(!Xe)return;const e=requestAnimationFrame(()=>{ut.current?.focus()});return()=>cancelAnimationFrame(e)},[Xe]);const yt=h.useCallback(async()=>{if(!f)return;S(!0),A(null);let e=!1;try{const t=await a(f);if(t)mt.current=!1,w(t),De(t.title??""),Te(t.body??""),Be(t.mediaRefs??[]),Me([]);else{if(!mt.current&&f.startsWith("at://"))return mt.current=!0,e=!0,void setTimeout(()=>yt(),600);A("Post not found or not a standard.site document.")}}catch(t){A(t instanceof Error?t.message:"Failed to load post")}finally{e||S(!1)}},[f]),jt=h.useCallback(async()=>{if(f&&ft){we(!0);try{const e=await s(f,ft,pt);Ne(e)}catch{Ne([])}finally{we(!1)}}},[f,ft,pt]),bt=h.useMemo(()=>N?function(e){const t=[];return function e(a,s){for(const l of a)t.push({reply:l.reply,depth:s}),e(l.children,s+1)}(e,0),t}(function(e,t){const a=new Map;for(const l of e){const e=l.replyTo??t;a.has(e)||a.set(e,[]),a.get(e).push(l)}const s=(e,t)=>new Date(e.record?.createdAt??0).getTime()-new Date(t.record?.createdAt??0).getTime();return function e(t){return(a.get(t)??[]).slice().sort(s).map(t=>({reply:t,children:e(t.uri)}))}(t)}(E,N.uri)):[],[E,N?.uri]);h.useEffect(()=>{mt.current=!1,w(null),yt()},[yt]),h.useEffect(()=>{if(!f)return;const e=()=>{"visible"===document.visibilityState&&yt()};return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)},[f,yt]),h.useEffect(()=>{N&&jt()},[N,jt]),h.useEffect(()=>{m?.(()=>yt())},[m,yt]);const gt=1+bt.length+(it?1:0),_t=h.useCallback(e=>{if(0===e)requestAnimationFrame(()=>{Ke.current?.focus(),Ke.current?.scrollIntoView({behavior:"smooth",block:"nearest"})});else if(e<=bt.length){const t=e-1,a=Oe.current?.querySelectorAll("[data-forum-reply-index]")?.[t];a&&requestAnimationFrame(()=>{a.focus(),a.scrollIntoView({behavior:"smooth",block:"nearest"})})}else requestAnimationFrame(()=>{qe.current?.focus(),qe.current?.scrollIntoView({behavior:"smooth",block:"nearest"})})},[bt.length]);async function vt(e){if(e.preventDefault(),it&&N&&Ce.trim()&&!Re){Ae(!0);try{await c(N.uri,Ce.trim(),Xe?.uri),Se(""),et(null),await jt()}catch(t){alert(t instanceof Error?t.message:"Failed to post")}finally{Ae(!1)}}}async function Nt(){if(N&&f&&!$e){He(!0);try{let e=[...Ue];if(Ie.length>0){const t=await Promise.all(Ie.map(e=>r(e)));e=[...e,...t]}const t=await i(f,{title:Le,body:Fe.trim(),media:e});w(t),Be(t.mediaRefs??[]),Me([]),Pe(!1)}catch(e){alert(e instanceof Error?e.message:"Failed to save")}finally{He(!1)}}}return h.useEffect(()=>{N&&Ye(0)},[f]),h.useEffect(()=>{gt<=0||Ye(e=>Math.min(Math.max(0,e),gt-1))},[gt]),h.useEffect(()=>{gt<=0||_t(Ve)},[Ve,gt,_t]),x({enabled:!!N&&gt>0,itemCount:gt,focusedIndex:Ve,setFocusedIndex:Ye,onActivate:_t,useCapture:!1}),f?l.jsxs("div",{className:P,children:[C&&l.jsx("div",{className:L,children:"Loading…"}),R&&l.jsx("p",{className:D,children:R}),N&&!C&&l.jsxs(l.Fragment,{children:[l.jsx("article",{ref:Ke,tabIndex:-1,className:`${k.postBlock} ${k.rootPostBlock}`,onFocus:()=>Ye(0),onMouseEnter:()=>Ye(0),children:l.jsxs("div",{className:k.postBlockContent,children:[l.jsxs("div",{className:k.postHead,children:[N.authorAvatar?l.jsx("img",{src:N.authorAvatar,alt:"",className:k.avatar,loading:"lazy"}):l.jsx("span",{className:F,"aria-hidden":!0,children:(N.authorHandle??N.did).slice(0,1).toUpperCase()}),l.jsxs("div",{className:k.authorRow,children:[l.jsxs(b,{handle:N.authorHandle??N.did,className:k.handleLink,children:["@",N.authorHandle??N.did]}),N.createdAt&&l.jsx("span",{className:k.postTimestamp,title:j(N.createdAt),children:y(N.createdAt)})]})]}),Ee?l.jsxs("div",{className:O,onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),$e||Nt())},children:[l.jsxs("label",{className:V,children:["Title",l.jsx("input",{type:"text",className:Y,value:Le,onChange:e=>De(e.target.value),placeholder:"Title"})]}),l.jsxs("label",{className:V,children:["Body",l.jsx("textarea",{className:G,value:Fe,onChange:e=>Te(e.target.value),placeholder:"Write your post…",rows:8})]}),l.jsxs("div",{className:V,children:["Media",l.jsxs("div",{className:Z,onDrop:function(e){e.preventDefault();const t=e.dataTransfer.files;if(!t?.length)return;const a=["image/jpeg","image/png","image/gif","image/webp"],s=Array.from(t).filter(e=>a.includes(e.type)).slice(0,4-Ue.length-Ie.length);Me(e=>[...e,...s].slice(0,4-Ue.length))},onDragOver:function(e){e.preventDefault(),e.dataTransfer.dropEffect="copy"},children:[l.jsx("input",{ref:We,id:"forum-edit-media-input",type:"file",accept:"image/jpeg,image/png,image/gif,image/webp",multiple:!0,className:J,onChange:function(e){const t=e.target.files;if(!t?.length)return;const a=["image/jpeg","image/png","image/gif","image/webp"],s=Array.from(t).filter(e=>a.includes(e.type)).slice(0,4-Ue.length-Ie.length);Me(e=>[...e,...s].slice(0,4-Ue.length)),e.target.value=""}}),l.jsx("button",{type:"button",className:Q,onClick:function(){We.current?.click()},children:"Add image"}),l.jsx("span",{className:X,children:"or drag and drop images here"}),Ue.length+Ie.length>0&&l.jsxs("div",{className:ee,children:[N.media?.slice(0,Ue.length).map((e,t)=>l.jsxs("div",{className:te,children:[l.jsx("img",{src:e.url,alt:"",className:ae,loading:"lazy"}),l.jsx("button",{type:"button",className:se,onClick:()=>{return e=t,void Be(t=>t.filter((t,a)=>a!==e));var e},"aria-label":"Remove",children:"×"})]},`existing-${t}`)),Ie.map((e,t)=>l.jsxs("div",{className:te,children:[l.jsx("img",{src:xt[t],alt:"",className:ae,loading:"lazy"}),l.jsx("button",{type:"button",className:se,onClick:()=>{return e=t,void Me(t=>t.filter((t,a)=>a!==e));var e},"aria-label":"Remove",children:"×"})]},`new-${t}`))]})]})]}),l.jsxs("div",{className:le,children:[l.jsx("button",{type:"button",className:W,onClick:()=>Pe(!1),disabled:$e,children:"Cancel"}),l.jsx("button",{type:"button",className:z,onClick:Nt,disabled:$e,children:$e?"Saving…":"Save"})]})]}):l.jsxs(l.Fragment,{children:[l.jsx("h1",{className:T,children:N.title||"Untitled"}),N.body&&l.jsx("div",{className:U,children:l.jsx(g,{text:N.body})}),N.media&&N.media.length>0&&l.jsx("div",{className:B,children:N.media.map((e,t)=>l.jsx("img",{src:e.url,alt:"",className:I,loading:"lazy"},t))}),pt&&l.jsx("p",{className:M,children:l.jsx("a",{href:pt,target:"_blank",rel:"noopener noreferrer",className:$,children:"Open full post →"})}),ht&&l.jsxs("div",{className:H,children:[l.jsx("button",{type:"button",className:W,onClick:()=>Pe(!0),children:"Edit"}),Ge?l.jsxs(l.Fragment,{children:[l.jsx("span",{className:q,children:"Delete this post?"}),l.jsx("button",{type:"button",className:W,onClick:()=>Ze(!1),disabled:Je,children:"Cancel"}),l.jsx("button",{type:"button",className:K,onClick:async function(){if(f&&Ge&&!Je){Qe(!0);try{await n(f),u()}catch(e){alert(e instanceof Error?e.message:"Failed to delete")}finally{Qe(!1)}}},disabled:Je,children:Je?"Deleting…":"Yes, delete"})]}):l.jsx("button",{type:"button",className:K,onClick:()=>Ze(!0),children:"Delete"})]})]})]})}),it&&!Xe&&l.jsx("section",{className:ne,children:l.jsxs("div",{ref:qe,className:re,tabIndex:-1,onFocus:()=>Ye(gt-1),onMouseEnter:()=>Ye(gt-1),children:[l.jsx("h2",{className:ie,children:"Reply"}),l.jsxs("form",{ref:ze,onSubmit:vt,className:de,children:[l.jsx("textarea",{className:ue,value:Ce,onChange:e=>Se(e.target.value),onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),Ce.trim()&&!Re&&ze.current?.requestSubmit())},placeholder:"Write a reply…",rows:3,disabled:Re}),l.jsx("button",{type:"submit",className:me,disabled:Re||!Ce.trim(),children:Re?"Posting…":"Post reply"})]})]})}),l.jsxs("section",{className:he,children:[l.jsx("h2",{className:ie,children:"Replies & discussion"}),ke?l.jsx("p",{className:ve,children:"Loading…"}):0===bt.length?l.jsx("p",{className:ve,children:"No replies yet. Post a reply above or share this post."}):l.jsx("ul",{ref:Oe,className:pe,children:bt.map(({reply:e,depth:t},a)=>{const s=!!(st[e.uri]??e.viewer?.like),n=tt[e.uri],r=e.author.handle??e.author.did,i=!0===e.isComment;return l.jsxs("li",{className:t>0?`${fe} ${xe}`:fe,"data-forum-reply-index":a,tabIndex:-1,onFocus:()=>Ye(1+a),onMouseEnter:()=>Ye(1+a),style:{marginLeft:20*t},children:[l.jsxs("div",{className:k.postHead,children:[e.author.avatar?l.jsx("img",{src:e.author.avatar,alt:"",className:k.avatar,loading:"lazy"}):l.jsx("span",{className:F,"aria-hidden":!0,children:r.slice(0,1).toUpperCase()}),l.jsxs("div",{className:k.authorRow,children:[l.jsxs(b,{handle:r,className:k.handleLink,children:["@",r]}),i&&l.jsx("span",{className:oe,children:"standard.site comment"}),e.record?.createdAt&&l.jsx("span",{className:k.postTimestamp,title:j(e.record.createdAt),children:y(e.record.createdAt)})]})]}),e.record?.text&&l.jsx("div",{className:ye,children:l.jsx(g,{text:e.record.text,facets:e.isComment?void 0:e.record.facets})}),l.jsxs("div",{className:je,children:[it&&l.jsx("button",{type:"button",className:ce,onClick:()=>{et(e)},children:"Reply"}),!i&&l.jsx(p,{to:`/post/${encodeURIComponent(e.uri)}`,className:be,children:"View post"}),it&&!i&&l.jsxs("button",{type:"button",className:s?_e:ge,onClick:()=>async function(e){if(e.isComment)return;const t=st[e.uri]??e.viewer?.like,a=!!t;at(t=>({...t,[e.uri]:!0}));try{if(a)await o.deleteLike(t),lt(t=>{const a={...t};return delete a[e.uri],a});else{const t=await o.like(e.uri,e.cid);lt(a=>({...a,[e.uri]:t.uri}))}await jt()}catch{}finally{at(t=>({...t,[e.uri]:!1}))}}(e),disabled:n,title:s?"Remove like":"Like",children:["♥ ",e.likeCount??0]})]}),it&&Xe?.uri===e.uri&&l.jsx("div",{className:k.inlineReplyFormWrap,children:l.jsxs("form",{onSubmit:vt,className:k.inlineReplyForm,children:[l.jsxs("div",{className:k.inlineReplyFormHeader,children:[l.jsx("button",{type:"button",className:k.cancelReply,onClick:()=>et(null),"aria-label":"Cancel reply",children:"×"}),nt.handle&&ct?.length&&dt?l.jsx(v,{replyAs:nt,sessionsList:ct,switchAccount:ot,currentDid:dt}):l.jsxs("p",{className:k.replyAs,children:[l.jsx("span",{className:k.replyAsLabel,children:"Replying as"}),l.jsxs("span",{className:k.replyAsUserChip,children:[nt.avatar?l.jsx("img",{src:nt.avatar,alt:"",className:k.replyAsAvatar,loading:"lazy"}):l.jsx("span",{className:k.replyAsAvatarPlaceholder,"aria-hidden":!0,children:nt.handle.slice(0,1).toUpperCase()}),l.jsxs("span",{className:k.replyAsHandle,children:["@",nt.handle]})]})]})]}),l.jsx(_,{inputRef:ut,placeholder:`Reply to @${r}…`,value:Ce,onChange:Se,onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),Ce.trim()&&!Re&&e.target.form?.requestSubmit())},className:k.textarea,rows:2,maxLength:300}),l.jsx("p",{className:k.hint,children:"⌘ Enter or ⌘ E to post"}),l.jsx("button",{type:"submit",className:k.submit,disabled:Re||!Ce.trim(),children:Re?"Posting…":"Post reply"})]})})]},e.uri)})})]})]})]}):(u(),null)}function ke({documentUri:t,onClose:a,onRegisterRefresh:s}){const[n,r]=h.useState(null),[i,c]=h.useState([]),[o,p]=h.useState(!0),[f,x]=h.useState(null),[_,v]=h.useState(""),[B,I]=h.useState(!1),[M,$]=h.useState(!1),[Z,J]=h.useState(""),[Q,X]=h.useState("");h.useEffect(()=>{n&&(J(n.title??""),X(n.body??""))},[n]);const[ee,te]=h.useState(!1),[ae,se]=h.useState(!1),[re,ce]=h.useState(!1),[je,be]=h.useState({}),[Ne,ke]=h.useState({}),{session:we}=e(),Ce=h.useCallback(async()=>{if(t){p(!0),x(null);try{const[e,a]=await Promise.all([w(t),C(t,we?.did?[we.did]:[])]);if(r(e),c(a),we?.did){const e=await d();be(e)}const s=e?.uri?[e.uri]:[];if(a.forEach(e=>s.push(e.uri)),s.length>0){const e=await N(s);ke(e)}}catch(e){x(e instanceof Error?e.message:"Failed to load post")}finally{p(!1)}}},[t,we?.did]);async function Se(e,t){if(we)try{const a=await m(e,t);be(t=>({...t,[e]:a})),ke(t=>({...t,[e]:(t[e]??0)+1}))}catch{}}async function Re(e){if(we)try{await u(e);const t=Object.entries(je).find(([,t])=>t===e)?.[0];t&&(be(e=>{const a={...e};return delete a[t],a}),ke(e=>({...e,[t]:Math.max(0,(e[t]??0)-1)})))}catch{}}if(h.useEffect(()=>{Ce()},[Ce]),h.useEffect(()=>{s?.(()=>Ce())},[s,Ce]),!t||!t.includes("app.artsky.forum.post"))return null;if(o)return l.jsx("div",{className:L,children:"Loading…"});if(f||!n)return l.jsx("p",{className:D,children:f??"Post not found"});const Ae=we?.did===n.did,Ee=Ne[n.uri]??0,Pe=!!je[n.uri],Le=function(e){const t=[];return function e(a,s){for(const l of a)t.push({reply:l.reply,depth:s}),e(l.children,s+1)}(e,0),t}(function(e,t){const a=new Map;for(const l of e){const e=l.replyTo??t;a.has(e)||a.set(e,[]),a.get(e).push(l)}const s=(e,t)=>new Date(e.record?.createdAt??0).getTime()-new Date(t.record?.createdAt??0).getTime();return function e(t){return(a.get(t)??[]).slice().sort(s).map(t=>({reply:t,children:e(t.uri)}))}(t)}(i,t));return l.jsxs("div",{className:P,children:[l.jsx("article",{className:`${k.postBlock} ${k.rootPostBlock}`,children:l.jsxs("div",{className:k.postBlockContent,children:[l.jsxs("div",{style:{display:"flex",gap:"var(--space-sm)",marginBottom:"var(--space-sm)"},children:[n.isPinned&&l.jsx("span",{className:oe,children:"Pinned"}),n.isWiki&&l.jsx("span",{className:oe,children:"Wiki"})]}),l.jsxs("div",{className:k.postHead,children:[n.authorAvatar?l.jsx("img",{src:n.authorAvatar,alt:"",className:k.avatar,loading:"lazy"}):l.jsx("span",{className:F,"aria-hidden":!0,children:(n.authorHandle??n.did).slice(0,1).toUpperCase()}),l.jsxs("div",{className:k.authorRow,children:[l.jsxs(b,{handle:n.authorHandle??n.did,className:k.handleLink,children:["@",n.authorHandle??n.did]}),n.createdAt&&l.jsx("span",{className:k.postTimestamp,title:j(n.createdAt),children:y(n.createdAt)})]})]}),M?l.jsxs("div",{className:O,children:[l.jsxs("label",{className:V,children:["Title",l.jsx("input",{type:"text",className:Y,value:Z,onChange:e=>J(e.target.value),placeholder:"Title"})]}),l.jsxs("label",{className:V,children:["Body",l.jsx("textarea",{className:G,value:Q,onChange:e=>X(e.target.value),placeholder:"Write your post…",rows:8})]}),l.jsxs("div",{className:le,children:[l.jsx("button",{type:"button",className:W,onClick:()=>$(!1),disabled:ee,children:"Cancel"}),l.jsx("button",{type:"button",className:z,onClick:async function(){if(n&&!ee){te(!0);try{await A(t,{title:Z,body:Q});const e=await w(t);r(e),$(!1)}catch(e){alert(e instanceof Error?e.message:"Failed to save")}finally{te(!1)}}},disabled:ee,children:ee?"Saving…":"Save"})]})]}):l.jsxs(l.Fragment,{children:[l.jsx("h1",{className:T,children:n.title||"Untitled"}),n.body&&l.jsx("div",{className:U,children:l.jsx(g,{text:n.body})}),n.tags&&n.tags.length>0&&l.jsx("div",{style:{display:"flex",gap:"var(--space-xs)",marginTop:"var(--space-md)",flexWrap:"wrap"},children:n.tags.map(e=>l.jsxs("span",{className:oe,children:["#",e]},e))}),l.jsxs("div",{style:{display:"flex",gap:"var(--space-sm)",marginTop:"var(--space-md)",alignItems:"center"},children:[l.jsxs("button",{type:"button",className:Pe?_e:ge,onClick:()=>Pe?Re(je[n.uri]):Se(n.uri,n.cid),disabled:!we,title:Pe?"Remove downvote":"Downvote",children:["↓ ",Ee]}),l.jsxs("span",{style:{fontSize:"var(--font-sm)",color:"var(--muted)"},children:[i.length," repl",1===i.length?"y":"ies"]})]}),Ae&&l.jsxs("div",{className:H,style:{marginTop:"var(--space-md)"},children:[l.jsx("button",{type:"button",className:W,onClick:()=>$(!0),children:"Edit"}),!n.isWiki&&l.jsx("button",{type:"button",className:W,onClick:async function(){if(n)try{await S(t);const e=await w(t);r(e)}catch(e){alert(e instanceof Error?e.message:"Failed to promote")}},children:"Promote to Wiki"}),ae?l.jsxs(l.Fragment,{children:[l.jsx("span",{className:q,children:"Delete this post?"}),l.jsx("button",{type:"button",className:W,onClick:()=>se(!1),disabled:re,children:"Cancel"}),l.jsx("button",{type:"button",className:K,onClick:async function(){if(ae&&!re){ce(!0);try{await R(t),a()}catch(e){alert(e instanceof Error?e.message:"Failed to delete")}finally{ce(!1)}}},disabled:re,children:re?"Deleting…":"Yes, delete"})]}):l.jsx("button",{type:"button",className:K,onClick:()=>se(!0),children:"Delete"})]})]})]})}),we&&l.jsxs("section",{className:ne,children:[l.jsx("h2",{className:ie,children:"Reply"}),l.jsxs("form",{onSubmit:async function(e){if(e.preventDefault(),we&&n&&_.trim()&&!B){I(!0);try{await E({postUri:t,text:_.trim()}),v("");const e=await C(t,[we.did]);c(e)}catch(a){alert(a instanceof Error?a.message:"Failed to post")}finally{I(!1)}}},className:de,children:[l.jsx("textarea",{className:ue,value:_,onChange:e=>v(e.target.value),placeholder:"Write a reply… Use @username for mentions",rows:3,disabled:B}),l.jsx("button",{type:"submit",className:me,disabled:B||!_.trim(),children:B?"Posting…":"Post reply"})]})]}),l.jsxs("section",{className:he,children:[l.jsxs("h2",{className:ie,children:["Replies (",i.length,")"]}),0===Le.length?l.jsx("p",{className:ve,children:"No replies yet."}):l.jsx("ul",{className:pe,children:Le.map(({reply:e,depth:t})=>{const a=Ne[e.uri]??0,s=!!je[e.uri],n=e.author.handle??e.author.did;return l.jsxs("li",{className:t>0?`${fe} ${xe}`:fe,style:{marginLeft:20*t},children:[l.jsxs("div",{className:k.postHead,children:[e.author.avatar?l.jsx("img",{src:e.author.avatar,alt:"",className:k.avatar,loading:"lazy"}):l.jsx("span",{className:F,"aria-hidden":!0,children:n.slice(0,1).toUpperCase()}),l.jsxs("div",{className:k.authorRow,children:[l.jsxs(b,{handle:n,className:k.handleLink,children:["@",n]}),e.record?.createdAt&&l.jsx("span",{className:k.postTimestamp,title:j(e.record.createdAt),children:y(e.record.createdAt)})]})]}),e.record?.text&&l.jsx("div",{className:ye,children:l.jsx(g,{text:e.record.text})}),we&&l.jsxs("button",{type:"button",className:s?_e:ge,onClick:()=>s?Re(je[e.uri]):Se(e.uri,e.cid),title:s?"Remove downvote":"Downvote",children:["↓ ",a]})]},e.uri)})})]})]})}function we({documentUri:e,onClose:t,onBack:a,canGoBack:s}){const[n,r]=h.useState(null),i=e.includes("app.artsky.forum.post");return l.jsx(f,{ariaLabel:"Forum post",onClose:t,onBack:a,canGoBack:s,onPullToRefresh:n?()=>n():void 0,children:i?l.jsx(ke,{documentUri:e,onClose:t,onRegisterRefresh:e=>r(()=>e)}):l.jsx(Ne,{documentUri:e,onClose:t,onRegisterRefresh:e=>r(()=>e)})})}export{we as default};
