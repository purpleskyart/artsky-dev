import{j as e,u as t,g as s,k as o,b as a,z as n,a5 as r,a0 as i,a6 as l,a7 as c,a8 as d,a9 as u,aa as m,a1 as p,a2 as h,ab as x,h as f,ac as v}from"./index-C92fSBT1.js";import{b as y,d as j,f as g,u as N}from"./react-vendor-DGaPsC2e.js";import{takeInitialPostForUri as b,getCachedThread as C}from"./postCache-CTqU0alO.js";import{g as w,i as A,c as k,a as P}from"./artboards-DNvSVVrd.js";import{l as q,a as R,b as L,P as S}from"./PostActionsMenu-B3ZLjaQs.js";import{C as E,a as D,L as M}from"./Layout-CULUiZuc.js";import{a as I,P as U}from"./PostText-4SKFSD3X.js";import{p as F}from"./PostDetailPage.module-TDaRGCAY.js";async function T(e){const t=new URLSearchParams({target:e,collection:"app.artsky.feed.downvote",path:".subject.uri"});try{const e=await fetch(`https://constellation.microcosm.blue/links/count/distinct-dids?${t}`,{headers:{Accept:"application/json"}});if(!e.ok)return 0;const s=await e.json();return"number"==typeof s.total?s.total:0}catch{return 0}}async function $(e){const t=[...new Set(e)],s=await Promise.all(t.map(async e=>({uri:e,count:await T(e)}))),o={};for(const{uri:a,count:n}of s)o[a]=n;return o}function B({playlistUrl:t,poster:s,className:o,controls:a=!0,playsInline:n=!0,preload:r="metadata",autoPlay:i=!1,controlsHiddenUntilTap:l=!1}){const c=y.useRef(null),[d,u]=y.useState(!l),m=l?d:a;return y.useEffect(()=>{if(!t||!c.current)return;const e=c.current;let s;var o;return/\.m3u8(\?|$)/i.test(o=t)||o.includes("m3u8")?q().then(o=>{if(c.current)if(o.isSupported()){const a=new o;a.loadSource(t),a.attachMedia(e),a.on(o.Events.ERROR,()=>{}),s=()=>{a.destroy()}}else e.canPlayType("application/vnd.apple.mpegurl")&&(e.src=t,s=()=>{e.removeAttribute("src")})}).catch(()=>{e.canPlayType("application/vnd.apple.mpegurl")&&(e.src=t)}):(e.src=t,s=()=>{e.removeAttribute("src")}),()=>{s?.()}},[t]),y.useEffect(()=>{if(!i||!c.current)return;const e=c.current;function t(){e.play().catch(()=>{})}return e.readyState>=2?t():e.addEventListener("loadeddata",t,{once:!0}),()=>e.removeEventListener("loadeddata",t)},[i,t]),e.jsx("video",{ref:c,className:o,poster:s,controls:m,playsInline:n,preload:r,autoPlay:i,muted:i,onClick:l&&!d?()=>u(!0):void 0})}const V=18;function H(){return e.jsx("svg",{width:V,height:V,viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":!0,children:e.jsx("path",{d:"M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"})})}function z(){return e.jsx("svg",{width:V,height:V,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:e.jsx("path",{d:"M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"})})}function W(){return e.jsxs("svg",{width:V,height:V,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:[e.jsx("path",{d:"M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H3c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2z"}),e.jsx("path",{d:"M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-5c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2z"})]})}function O({replyAs:t,sessionsList:s,switchAccount:o,currentDid:a,label:r="Replying as"}){const[i,l]=y.useState(!1),[c,d]=y.useState({}),u=y.useRef(null);y.useEffect(()=>{if(!i)return;const e=e=>{u.current?.contains(e.target)||l(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[i]);const m=y.useMemo(()=>s.map(e=>e.did).sort().join(","),[s]);y.useEffect(()=>{if(0===s.length)return void d({});let e=!1;return s.forEach(t=>{n.getProfile({actor:t.did}).then(s=>{if(e)return;const o=s.data;d(e=>({...e,[t.did]:{avatar:o.avatar,handle:o.handle}}))}).catch(()=>{})}),()=>{e=!0}},[m,s]);const{openLoginModal:p}=f();return e.jsxs("p",{className:F.replyAs,children:[e.jsx("span",{className:F.replyAsLabel,children:r}),e.jsxs("span",{className:F.replyAsUserChip,children:[t.avatar?e.jsx("img",{src:t.avatar,alt:"",className:F.replyAsAvatar,loading:"lazy"}):e.jsx("span",{className:F.replyAsAvatarPlaceholder,"aria-hidden":!0,children:t.handle.slice(0,1).toUpperCase()}),e.jsxs("div",{className:F.replyAsHandleWrap,ref:u,children:[e.jsxs("button",{type:"button",className:F.replyAsHandleBtn,onClick:()=>l(e=>!e),"aria-expanded":i,"aria-haspopup":"true",children:["@",t.handle]}),i&&e.jsxs("div",{className:F.replyAsDropdown,role:"menu",children:[s.map(t=>{const s=c[t.did],n=s?.handle??t.handle??t.did,r=t.did===a;return e.jsxs("button",{type:"button",role:"menuitem",className:r?F.replyAsDropdownItemActive:F.replyAsDropdownItem,onClick:async()=>{await o(t.did)&&l(!1)},children:[s?.avatar?e.jsx("img",{src:s.avatar,alt:"",className:F.replyAsDropdownAvatar,loading:"lazy"}):e.jsx("span",{className:F.replyAsDropdownAvatarPlaceholder,"aria-hidden":!0,children:(n||t.did).slice(0,1).toUpperCase()}),e.jsxs("span",{className:F.replyAsDropdownHandle,children:["@",n]}),r&&e.jsx("span",{className:F.replyAsDropdownCheck,"aria-hidden":!0,children:"✓"})]},t.did)}),e.jsx("button",{type:"button",role:"menuitem",className:F.replyAsDropdownAddAccount,onClick:()=>{l(!1),p()},children:"+ Add account"})]})]})]})]})}function Q(e){return e&&"object"==typeof e&&"post"in e&&!!e.post}function K(e,t){return e.flatMap(e=>{const s=e.post.uri,o=e.post.author?.handle??e.post.author?.did??"";if(t.has(s))return[{uri:s,handle:o}];return[{uri:s,handle:o},...K("replies"in e&&Array.isArray(e.replies)?e.replies.filter(e=>Q(e)):[],t)]})}function _(e,t){for(const s of e){if(s.post.uri===t)return s;const e=_("replies"in s&&Array.isArray(s.replies)?s.replies.filter(e=>Q(e)):[],t);if(e)return e}return null}function G(e){if(!Q(e))return[];const t=[e.post.uri],s="replies"in e&&Array.isArray(e.replies)?e.replies.filter(e=>Q(e)):[];for(const o of s)t.push(...G(o));return t}function X(e){if("undefined"==typeof window)return()=>{};const t=window.matchMedia("(min-width: 768px)");return t.addEventListener("change",e),()=>t.removeEventListener("change",e)}function J(){return"undefined"!=typeof window&&window.innerWidth>=768}function Y({items:t,autoPlayFirstVideo:s=!1,hideVideoControlsUntilTap:o=!1,onFocusItem:a,onDoubleTapLike:n}){const r=y.useRef(0),i=y.useRef(0);if(0===t.length)return null;const l=s?t.findIndex(e=>"video"===e.type&&e.videoPlaylist):-1;return e.jsx("div",{className:F.galleryWrap,onTouchEnd:e=>{if(!n||1!==e.changedTouches.length)return;const t=Date.now();t-r.current<400?(r.current=0,e.preventDefault(),n()):r.current=t},onClick:e=>{if(!n)return;const t=Date.now();t-i.current<400?(i.current=0,e.stopPropagation(),e.preventDefault(),n()):i.current=t},children:e.jsx("div",{className:F.gallery,children:t.map((t,s)=>{if("video"===t.type&&t.videoPlaylist){const n=t.aspectRatio??16/9;return e.jsx("div",{className:F.galleryVideoWrap,style:{aspectRatio:n},"data-media-item":s,tabIndex:0,onFocus:()=>a?.(s),children:e.jsx(B,{playlistUrl:t.videoPlaylist,poster:t.url||void 0,className:F.galleryVideo,autoPlay:s===l,preload:s===l?"metadata":"none",controlsHiddenUntilTap:o})},s)}const n="image"===t.type&&null!=t.aspectRatio?t.aspectRatio:1;return e.jsx("div",{className:F.galleryImageBtn,style:{aspectRatio:n,"--media-aspect":n},"data-media-item":s,tabIndex:0,onFocus:()=>a?.(s),children:e.jsx("img",{src:t.url,alt:"",className:F.galleryMedia,loading:"lazy"})},s)})})})}function Z({node:t,depth:s=0,collapsedThreads:o,onToggleCollapse:n,onReply:r,rootPostUri:i,rootPostCid:l,replyingTo:d,replyComment:u,setReplyComment:m,onReplySubmit:p,replyPosting:h,clearReplyingTo:x,commentFormRef:f,replyAs:j,sessionsList:g,switchAccount:N,currentDid:b,focusedCommentUri:C,onCommentMediaFocus:w,onLike:A,onDownvote:k,likeOverrides:P,myDownvotes:q,downvoteCounts:M,downvoteCountOptimisticDelta:T,likeLoadingUri:$,downvoteLoadingUri:B,openActionsMenuCommentUri:V,onActionsMenuOpenChange:H,onViewQuotes:z}){const[W,K]=y.useState(null),_=y.useRef(null),[G,X]=y.useState(!1),[J,ee]=y.useState(""),[te,se]=y.useState([]),[oe,ae]=y.useState([]),[ne,re]=y.useState(null),[ie,le]=y.useState(!1),ce=y.useRef(null),de=y.useRef(null),ue=["image/jpeg","image/png","image/gif","image/webp"];function me(){X(!1),re(null)}function pe(e){const t=Array.from(e).filter(e=>ue.includes(e.type));se(e=>[...e,...t].slice(0,4)),ae(e=>[...e,...new Array(t.length).fill("")])}async function he(e){if(e.preventDefault(),!Q(t)||ie||!b)return;if(J.trim()||te.length>0){re(null),le(!0);try{await v(t.post.uri,t.post.cid,J,te.length>0?te:void 0,oe.length>0?oe:void 0),me()}catch(s){re(s instanceof Error?s.message:"Failed to post quote")}finally{le(!1)}}}y.useEffect(()=>{if(!W)return;const e=e=>{_.current?.contains(e.target)||K(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[W]),y.useEffect(()=>{if(G)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e);function e(e){const t=e.target;de.current?.contains(t)||X(!1)}},[G]);const xe=y.useMemo(()=>te.map(e=>URL.createObjectURL(e)),[te]);if(y.useEffect(()=>()=>xe.forEach(e=>URL.revokeObjectURL(e)),[xe]),!Q(t))return null;const{post:fe}=t,ve=fe,ye=void 0!==P?.[fe.uri]?P[fe.uri]:ve.viewer?.like,je=q?.[fe.uri],ge=ve.likeCount??0,Ne=!!ve.viewer?.like,be=(!!ye?1:0)-(Ne?1:0),Ce=Math.max(0,ge+be),we=M?.[fe.uri]??ve.downvoteCount??0,Ae=T?.[fe.uri]??0,ke=Math.max(0,we+Ae),Pe=c(fe),qe=fe.record?.text??"",Re=fe.author.handle??fe.author.did,Le=fe.author.avatar??void 0,Se=fe.record?.createdAt,Ee="replies"in t&&Array.isArray(t.replies)?t.replies:[],De=Ee.length>0,Me=De&&o?.has(fe.uri),Ie=!!n,Ue=d?.uri===fe.uri,Fe=C===fe.uri,Te=$===fe.uri,$e=B===fe.uri;return e.jsxs("article",{className:`${F.postBlock} ${Fe?F.commentFocused:""}`,style:{marginLeft:2*s},"data-comment-uri":fe.uri,tabIndex:-1,children:[Ie&&e.jsxs("div",{className:F.collapseColumn,children:[e.jsx("button",{type:"button",className:F.collapseBtn,onClick:()=>n?.(fe.uri),"aria-label":Me?"Expand this comment":"Collapse this comment",title:Me?"Expand this comment":"Collapse this comment",children:e.jsx("span",{className:F.collapseIcon,"aria-hidden":!0,children:"−"})}),e.jsx("button",{type:"button",className:F.collapseStrip,onClick:()=>n?.(fe.uri),"aria-label":Me?"Expand this comment":"Collapse this comment",title:Me?"Expand this comment":"Collapse this comment"})]}),e.jsxs("div",{className:F.postBlockContent,children:[e.jsxs("div",{className:F.commentContentWrap,"data-comment-content":fe.uri,tabIndex:-1,children:[e.jsxs("div",{className:F.postHead,children:[Le&&e.jsx("img",{src:Le,alt:"",className:F.avatar,loading:"lazy"}),e.jsxs("div",{className:F.authorRow,children:[e.jsxs(I,{handle:Re,className:F.handleLink,children:["@",Re]}),Se&&e.jsx("span",{className:F.postTimestamp,title:L(Se),children:R(Se)})]})]}),Pe.length>0&&e.jsx(Y,{items:Pe,onFocusItem:e=>w?.(fe.uri,e),onDoubleTapLike:A?()=>A(fe.uri,fe.cid,ye??null):void 0}),qe&&e.jsx("p",{className:F.postText,children:e.jsx(U,{text:qe,facets:fe.record?.facets,interactive:!0})}),(r||A||k)&&e.jsxs("div",{className:F.replyBtnRow,children:[r&&e.jsxs("button",{type:"button",className:F.replyBtn,onClick:()=>r(fe.uri,fe.cid,Re),children:[e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:e.jsx("path",{d:"M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"})}),e.jsx("span",{children:"Reply"})]}),A&&e.jsxs("button",{type:"button",className:ye?F.commentLikeBtnLiked:F.commentLikeBtn,onClick:()=>A(fe.uri,fe.cid,ye??null),disabled:Te,title:ye?"Remove like":"Like","aria-label":ye?"Remove like":"Like",children:["↑",` ${Ce}`]}),A&&k&&e.jsx("span",{className:F.commentVoteTotal,"aria-label":`Score: ${Ce-ke} (upvotes minus downvotes)`,children:Ce-ke}),k&&e.jsxs("button",{type:"button",className:je?F.commentDownvoteBtnActive:F.commentDownvoteBtn,onClick:()=>k(fe.uri,fe.cid,je??null),disabled:$e,title:je?"Remove downvote":"Downvote (syncs across AT Protocol)","aria-label":je?"Remove downvote":"Downvote",children:["↓",` ${ke}`]}),b&&e.jsxs("div",{className:F.commentRepostWrap,ref:_,children:[e.jsxs("button",{type:"button",className:F.commentRepostBtn,onClick:()=>K(W===fe.uri?null:fe.uri),"aria-expanded":W===fe.uri,"aria-haspopup":"true",title:"Repost or quote",children:[e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":!0,children:e.jsx("path",{d:"M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"})}),e.jsx("span",{children:"Repost"})]}),W===fe.uri&&e.jsxs("div",{className:F.commentRepostDropdown,role:"menu",children:[e.jsx("button",{type:"button",className:F.commentRepostDropdownItem,role:"menuitem",onClick:async()=>{K(null);try{const e=fe;e.viewer?.repost?await a.deleteRepost(e.viewer.repost):await a.repost(fe.uri,fe.cid)}catch(e){}},children:fe.viewer?.repost?"Remove repost":"Repost"}),e.jsx("button",{type:"button",className:F.commentRepostDropdownItem,role:"menuitem",onClick:function(){K(null),X(!0),ee(""),se([]),ae([]),re(null)},disabled:!b,children:"Quote post"})]})]}),e.jsxs("div",{className:F.commentActionsWrap,children:[e.jsx(S,{postUri:fe.uri,postCid:fe.cid,authorDid:fe.author.did,rootUri:i??fe.uri,isOwnPost:b===fe.author.did,compact:!0,verticalIcon:!0,className:F.commentActionsMenu,open:H?V===fe.uri:void 0,onOpenChange:H?e=>H(fe.uri,e):void 0,postedAt:fe.record?.createdAt,onViewQuotes:z}),e.jsxs("button",{type:"button",className:F.commentViewQuotesBtn,onClick:()=>z?.(fe.uri),title:"View posts that quote this","aria-label":"View quotes",children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:[e.jsx("path",{d:"M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H3c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2z"}),e.jsx("path",{d:"M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-5c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2z"})]}),e.jsx("span",{children:"View Quotes"})]})]})]}),Ue&&d&&m&&p&&x&&f&&e.jsx("div",{className:F.inlineReplyFormWrap,children:e.jsxs("form",{ref:f,onSubmit:p,className:F.inlineReplyForm,children:[e.jsxs("div",{className:F.inlineReplyFormHeader,children:[e.jsx("button",{type:"button",className:F.cancelReply,onClick:x,"aria-label":"Cancel reply",children:"×"}),j&&(g&&N&&b?e.jsx(O,{replyAs:j,sessionsList:g,switchAccount:N,currentDid:b}):e.jsxs("p",{className:F.replyAs,children:[e.jsx("span",{className:F.replyAsLabel,children:"Replying as"}),e.jsxs("span",{className:F.replyAsUserChip,children:[j.avatar?e.jsx("img",{src:j.avatar,alt:"",className:F.replyAsAvatar,loading:"lazy"}):e.jsx("span",{className:F.replyAsAvatarPlaceholder,"aria-hidden":!0,children:j.handle.slice(0,1).toUpperCase()}),e.jsxs("span",{className:F.replyAsHandle,children:["@",j.handle]})]})]}))]}),e.jsx(E,{placeholder:`Reply to @${d.handle}…`,value:u??"",onChange:e=>m?.(e),onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),(u??"").trim()&&!h&&f.current?.requestSubmit())},className:F.textarea,rows:2,maxLength:300,autoFocus:!0}),e.jsxs("div",{className:F.commentFormFooter,children:[e.jsx(D,{used:(u??"").length,max:300}),e.jsx("p",{className:F.hint,children:"⌘ Enter or ⌘ E to post"})]}),e.jsx("button",{type:"submit",className:F.submit,disabled:h||!(u??"").trim(),children:h?"Posting…":"Post reply"})]})})]}),De&&e.jsx("div",{className:F.repliesContainer,children:Me?e.jsxs("button",{type:"button",className:F.repliesCollapsed,onClick:()=>n?.(fe.uri),children:[Ee.length," reply",1!==Ee.length?"s":""]}):e.jsx("div",{className:F.replies,children:Ee.map((t,a)=>{if(!Q(t))return null;const c=s+1;if(o?.has(t.post.uri)){const s="replies"in t&&Array.isArray(t.replies)?t.replies.length:0,o=0===s?"Comment":`${s} reply${1!==s?"s":""}`,r=t.post.author?.handle??t.post.author?.did??"";return e.jsx("div",{className:F.collapsedCommentWrap,style:{marginLeft:12*c},"data-comment-uri":t.post.uri,tabIndex:-1,children:e.jsxs("button",{type:"button",className:F.collapsedCommentBtn,onClick:()=>n?.(t.post.uri),children:[e.jsx("span",{className:F.collapsedCommentExpandIcon,"aria-hidden":!0,children:"+"}),t.post.author?.avatar?e.jsx("img",{src:t.post.author.avatar,alt:"",className:F.collapsedCommentAvatar,loading:"lazy"}):e.jsx("span",{className:F.collapsedCommentAvatarPlaceholder,"aria-hidden":!0,children:r.slice(0,1).toUpperCase()}),e.jsxs("span",{className:F.collapsedCommentHandle,children:["@",r]}),e.jsx("span",{className:F.collapsedCommentLabel,children:o})]})},`${t.post.uri}-${a}`)}return e.jsx(Z,{node:t,depth:c,collapsedThreads:o,onToggleCollapse:n,onReply:r,rootPostUri:i,rootPostCid:l,replyingTo:d,replyComment:u,setReplyComment:m,onReplySubmit:p,replyPosting:h,clearReplyingTo:x,commentFormRef:f,replyAs:j,sessionsList:g,switchAccount:N,currentDid:b,focusedCommentUri:C,onCommentMediaFocus:w,onLike:A,onDownvote:k,likeOverrides:P,myDownvotes:q,downvoteCounts:M,downvoteCountOptimisticDelta:T,likeLoadingUri:$,downvoteLoadingUri:B,openActionsMenuCommentUri:V,onActionsMenuOpenChange:H,onViewQuotes:z},`${t.post.uri}-${a}`)})})})]}),G&&Q(t)&&(()=>{const s=t.post,o=s.author?.handle??s.author?.did??"",a=s.record?.text??"",n=c(s)[0];return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:F.quoteComposerBackdrop,onClick:me,"aria-hidden":!0}),e.jsx("div",{className:F.quoteComposerOverlay,role:"dialog","aria-label":"Quote post",onClick:me,onDragOver:e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"},onDrop:e=>{e.preventDefault(),e.dataTransfer?.files?.length&&pe(e.dataTransfer.files)},children:e.jsxs("div",{className:F.quoteComposerCard,onClick:e=>e.stopPropagation(),children:[e.jsx("h2",{className:F.quoteComposerTitle,children:"Quote post"}),b?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:F.quoteComposerQuotedWrap,children:[e.jsx("p",{className:F.quotedPostLabel,children:"Quoting"}),e.jsxs("div",{className:F.quoteComposerQuotedCard,children:[e.jsxs("div",{className:F.quotedPostHead,children:[s.author?.avatar?e.jsx("img",{src:s.author.avatar,alt:"",className:F.quotedPostAvatar,loading:"lazy"}):e.jsx("span",{className:F.quotedPostAvatarPlaceholder,"aria-hidden":!0,children:o.slice(0,1).toUpperCase()}),e.jsxs("span",{className:F.quotedPostHandle,children:["@",o]}),s.record?.createdAt&&e.jsx("span",{className:F.quotedPostTime,title:L(s.record.createdAt),children:R(s.record.createdAt)})]}),n&&e.jsx("div",{className:F.quotedPostMedia,children:"image"===n.type?e.jsx("img",{src:n.url,alt:"",loading:"lazy",className:F.quotedPostThumb}):n.videoPlaylist?e.jsx("div",{className:F.quotedPostVideoThumb,style:{backgroundImage:n.url?`url(${n.url})`:void 0}}):null}),a?e.jsx("p",{className:F.quotedPostText,children:e.jsx(U,{text:a,facets:s.record?.facets,maxLength:300,stopPropagation:!0})}):null]})]}),e.jsxs("form",{onSubmit:he,onKeyDown:e=>{(e.metaKey||e.ctrlKey)&&"Enter"===e.key&&(e.preventDefault(),he(e))},children:[e.jsx(E,{className:F.quoteComposerTextarea,value:J,onChange:ee,placeholder:"Add your thoughts...",rows:4,maxLength:300,disabled:ie,autoFocus:!0}),te.length>0&&e.jsxs("div",{className:F.quoteComposerMediaSection,children:[e.jsx("div",{className:F.quoteComposerPreviews,children:te.map((t,s)=>e.jsxs("div",{className:F.quoteComposerPreviewWrap,children:[e.jsx("img",{src:xe[s],alt:"",className:F.quoteComposerPreviewImg}),e.jsx("button",{type:"button",className:F.quoteComposerPreviewRemove,onClick:()=>{return e=s,se(t=>t.filter((t,s)=>s!==e)),void ae(t=>t.filter((t,s)=>s!==e));var e},"aria-label":"Remove image",disabled:ie,children:"×"})]},s))}),e.jsx("p",{className:F.quoteComposerAltPrompt,children:"Describe each image for accessibility (alt text)."}),e.jsx("div",{className:F.quoteComposerAltFields,children:te.map((t,s)=>e.jsxs("div",{className:F.quoteComposerAltRow,children:[e.jsxs("label",{htmlFor:`quote-alt-${s}`,className:F.quoteComposerAltLabel,children:["Image ",s+1]}),e.jsx("input",{id:`quote-alt-${s}`,type:"text",className:F.quoteComposerAltInput,placeholder:"Describe this image",value:oe[s]??"",onChange:e=>{const t=e.target.value.slice(0,1e3);ae(e=>{const o=[...e];for(;o.length<te.length;)o.push("");return o[s]=t,o})},maxLength:1e3,disabled:ie})]},s))})]}),e.jsxs("div",{className:F.quoteComposerFooter,children:[e.jsxs("div",{className:F.quoteComposerFooterLeft,children:[e.jsx("input",{ref:ce,type:"file",accept:"image/jpeg,image/png,image/gif,image/webp",multiple:!0,className:F.quoteComposerFileInput,onChange:e=>{e.target.files?.length&&pe(e.target.files),e.target.value=""}}),e.jsx("button",{type:"button",className:F.quoteComposerAddMedia,onClick:()=>ce.current?.click(),disabled:ie||te.length>=4,title:"Add photo","aria-label":"Add photo",children:"Add media"}),e.jsx(D,{used:J.length,max:300})]}),e.jsxs("div",{className:F.quoteComposerActions,children:[e.jsx("button",{type:"button",className:F.quoteComposerCancel,onClick:me,disabled:ie,children:"Cancel"}),e.jsx("button",{type:"submit",className:F.quoteComposerSubmit,disabled:ie||!J.trim()&&0===te.length,children:ie?"Posting…":"Quote post"})]})]}),ne&&e.jsx("p",{className:F.quoteComposerError,children:ne})]})]}):e.jsx("p",{className:F.quoteComposerSignIn,children:"Log in to quote posts."})]})})]})})()]})}function ee({uri:f,initialOpenReply:g,initialFocusedCommentUri:N,onClose:q,onAuthorHandle:T,onRegisterRefresh:B}){const V=j(),{openProfileModal:ee,openPostModal:te,openQuotesModal:se}=t(),oe=y.useSyncExternalStore(X,J,()=>!1),ae=f,[ne,re]=y.useState(null),[ie,le]=y.useState(!0),[ce,de]=y.useState(null),[ue,me]=y.useState(""),[pe,he]=y.useState(!1),[xe,fe]=y.useState(new Set),[ve,ye]=y.useState(null),[je,ge]=y.useState(()=>new Set),[Ne,be]=y.useState(!1),[Ce,we]=y.useState(!1),[Ae,ke]=y.useState(null),[Pe,qe]=y.useState(!1),[Re,Le]=y.useState(!1),[Se,Ee]=y.useState(null),[De,Me]=y.useState(null),[Ie,Ue]=y.useState(null),[Fe,Te]=y.useState({}),[$e,Be]=y.useState({}),[Ve,He]=y.useState({}),[ze,We]=y.useState({}),[Oe,Qe]=y.useState(null),[Ke,_e]=y.useState(null),[Ge,Xe]=y.useState(null),[Je,Ye]=y.useState(""),[Ze,et]=y.useState(!1),[tt,st]=y.useState(!1),[ot,at]=y.useState(!1),[nt,rt]=y.useState(""),[it,lt]=y.useState([]),[ct,dt]=y.useState([]),[ut,mt]=y.useState(!1),[pt,ht]=y.useState(null),xt=y.useRef(null),ft=y.useRef(null),[vt,yt]=y.useState(0),jt=y.useRef(null),gt=y.useRef(null),Nt=y.useRef(null),bt=y.useRef(null),Ct=y.useRef(null),[wt,At]=y.useState(0),[kt,Pt]=y.useState(!1),qt=y.useRef(null),[Rt,Lt]=y.useState("score"),[St,Et]=y.useState(0),Dt=y.useRef(0),Mt=y.useRef(!1),It=y.useRef(null),Ut=y.useRef(0),Ft=w(),Tt=s(),{session:$t,sessionsList:Bt,switchAccount:Vt}=o(),[Ht,zt]=y.useState(null);y.useEffect(()=>{const e=$t??Tt;if(!e?.did)return void zt(null);const t=e.handle??e.did;a.getProfile({actor:e.did}).then(e=>zt({handle:e.data.handle??t,avatar:e.data.avatar})).catch(()=>zt({handle:t}))},[$t?.did,Tt?.did]);const Wt=Ht??(Tt?{handle:Tt.handle??Tt.did}:null),Ot=ne&&Q(ne)&&Tt?.did===ne.post.author.did,Qt=ne&&Q(ne)?ne.post.author.viewer:void 0,Kt=Qt?.following??Ae,_t=!!Kt||Ce,Gt=ne&&Q(ne)?ne.post.viewer:void 0,Xt=Gt?.like??Se,Jt=Gt?.repost??De,Yt=!!Xt,Zt=!!Jt;function es(e){ge(t=>{const s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})}async function ts(){if(!ne||!Q(ne)||Pe)return;const{uri:e,cid:t}=ne.post;qe(!0);try{if(Yt)await a.deleteLike(Xt),Ee(null);else{const s=await a.like(e,t);Ee(s.uri)}}catch{}finally{qe(!1)}}const ss=["image/jpeg","image/png","image/gif","image/webp"];function os(e){const t=Array.from(e).filter(e=>ss.includes(e.type)),s=Math.min(t.length,4-it.length);s<=0||(lt(e=>[...e,...t.slice(0,s)]),dt(e=>[...e,...t.slice(0,s).map(()=>"")]))}function as(){at(!1),ht(null)}async function ns(e){if(e.preventDefault(),!ne||!Q(ne)||ut||!Tt?.did)return;if(nt.trim()||it.length>0){ht(null),mt(!0);try{await v(ne.post.uri,ne.post.cid,nt,it.length>0?it:void 0,ct.length>0?ct:void 0),as(),V("/feed")}catch(t){ht(t instanceof Error?t.message:"Failed to post quote")}finally{mt(!1)}}}const rs=y.useCallback(async()=>{if(!ae)return;de(null);const e=s()?a:n;let t=!1;const o=b(ae),c=C(ae);if(o){const e=o.post??o;if(e&&"object"==typeof e&&e.uri===ae){re({$type:"app.bsky.feed.defs#threadViewPost",post:e,replies:[]});const s=e.record?.reply;le(!!s),t=!0}}else c&&Q(c)&&(re(c),le(!1),t=!0);t||le(!0);try{const t=(await r(ae,e)).data.thread;re(t),le(!1),We({});const o=Q(t)?G(t):[];o.length>0?$(o).then(He).catch(()=>{}):He({}),s()?i().then(Be).catch(()=>{}):Be({})}catch(d){de(l(d,"load post"))}finally{le(!1)}},[ae,$t?.did]);async function is(e){if(e.preventDefault(),!ne||!Q(ne)||!ue.trim())return;const t=ne.post,s=Ie??{uri:t.uri,cid:t.cid};he(!0);try{await x(t.uri,t.cid,s.uri,s.cid,ue.trim()),me(""),Ue(null),await rs()}catch(o){alert(o instanceof Error?o.message:"Failed to post comment")}finally{he(!1)}}function ls(e,t,s){Ue({uri:e,cid:t,handle:s});const o=document.querySelector(`.${F.commentForm} textarea`);o?.focus()}async function cs(e,t,s){Qe(e);try{if(s)await a.deleteLike(s),Te(t=>({...t,[e]:null}));else{const s=await a.like(e,t);Te(t=>({...t,[e]:s.uri}))}}catch{}finally{Qe(null)}}async function ds(e,t,s){_e(e);try{if(s)await p(s),Be(t=>{const s={...t};return delete s[e],s}),We(t=>({...t,[e]:(t[e]??0)-1}));else{const s=await h(e,t);Be(t=>({...t,[e]:s})),We(t=>({...t,[e]:(t[e]??0)+1}))}}catch{}finally{_e(null)}}function us(){if(!ne||!Q(ne))return;if(!(xe.size>0||Je.trim().length>0))return;const e=ne.post,t=m(e),s=c(e),o=s.length>0?s.map(e=>e.url):void 0,a={uri:e.uri,cid:e.cid,authorHandle:e.author.handle,text:e.record?.text?.slice(0,200),thumb:t?.url??o?.[0],thumbs:o},n=[];if(Je.trim()){const e=k(Je.trim());P(e.id,a),n.push(e.id),Ye("")}xe.forEach(e=>{P(e,a),n.push(e)}),ye(n[0]??null),fe(new Set),et(!1)}y.useEffect(()=>{rs()},[rs]),y.useEffect(()=>{B?.(()=>rs())},[B,rs]),y.useEffect(()=>{if(!ne||!Q(ne)||!g)return;const e=ne.post.author?.handle??ne.post.author?.did??"";Ue({uri:ne.post.uri,cid:ne.post.cid,handle:e}),requestAnimationFrame(()=>{const e=document.querySelector(`.${F.commentForm} textarea`);e?.focus()})},[ne,g]),y.useEffect(()=>{if(!Ie)return;const e=e=>{if("Escape"===e.key){e.preventDefault(),Ue(null);const t=document.activeElement;t instanceof HTMLElement&&t.blur()}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[Ie]);const ms=y.useMemo(()=>it.map(e=>URL.createObjectURL(e)),[it]);y.useEffect(()=>()=>ms.forEach(e=>URL.revokeObjectURL(e)),[ms]),y.useEffect(()=>{if(tt)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e);function e(e){const t=e.target;ft.current?.contains(t)||st(!1)}},[tt]);const ps=ne&&Q(ne)?c(ne.post):[],hs=ps.length>0,xs=ne&&Q(ne)&&"replies"in ne&&Array.isArray(ne.replies)&&ne.replies.length>0,fs=1+(hs?1:0)+(xs?1:0),vs=ne&&Q(ne)&&"replies"in ne&&Array.isArray(ne.replies)?ne.replies.filter(e=>Q(e)):[],ys=y.useCallback(e=>{const t=e.post,s=t.likeCount??0,o=!!t.viewer?.like,a=(!!(void 0!==Fe[e.post.uri]?Fe[e.post.uri]:t.viewer?.like)?1:0)-(o?1:0);return Math.max(0,s+a)},[Fe]),js=y.useCallback(e=>(Ve[e.post.uri]??0)+(ze[e.post.uri]??0),[Ve,ze]),gs=y.useCallback((e,t)=>{const s=e+t;if(0===s)return 0;const o=1.96,a=e/s,n=1+o*o/s,r=a+o*o/(2*s),i=o*Math.sqrt((a*(1-a)+o*o/(4*s))/s);return Math.max(0,(r-i)/n)},[]),Ns=y.useMemo(()=>{const e=e=>e.post.record?.createdAt??"",t=(t,s)=>e(s).localeCompare(e(t));return"newest"===Rt?[...vs].sort((t,s)=>e(s).localeCompare(e(t))):"oldest"===Rt?[...vs].sort((t,s)=>e(t).localeCompare(e(s))):[...vs].sort((e,s)=>{const o=ys(e),a=ys(s),n=js(e),r=js(s);if("likes"===Rt)return a!==o?a-o:t(e,s);if("score"===Rt){const i=o-n,l=a-r;return l!==i?l-i:t(e,s)}if("controversial"===Rt){const i=o+n,l=a+r,c=i>0?o*n/i:0,d=l>0?a*r/l:0;return d!==c?d-c:t(e,s)}const i=gs(o,n),l=gs(a,r);return l!==i?l-i:t(e,s)})},[vs,Rt,ys,js,gs]),bs=y.useMemo(()=>K(Ns,je),[Ns,je]),Cs=y.useRef(bs);Cs.current=bs,Dt.current=St;const ws=y.useMemo(()=>{const e=[];for(let t=0;t<ps.length;t++)e.push({type:"rootMedia",index:t});e.push({type:"description"});for(const t of bs){const s=_(Ns,t.uri),o=s?c(s.post):[];for(let a=0;a<o.length;a++)e.push({type:"commentMedia",commentUri:t.uri,mediaIndex:a});e.push({type:"comment",commentUri:t.uri})}return e.push({type:"replyForm"}),e},[ps.length,bs,Ns]),As=ws.length,ks=y.useCallback((e,t)=>{const s=ws.findIndex(s=>"commentMedia"===s.type&&s.commentUri===e&&s.mediaIndex===t);if(s>=0){Et(s);const t=bs.findIndex(t=>t.uri===e);t>=0&&At(t)}},[ws,bs]),Ps=ne&&Q(ne)?ne.post.uri:null;if(y.useEffect(()=>{if(ne&&Q(ne)&&T){const e=ne.post.author?.handle??ne.post.author?.did??"";e&&T(e)}},[ne,T]),y.useEffect(()=>{Ps&&Et(0)},[Ps]),y.useEffect(()=>{As<=0||Et(e=>Math.min(Math.max(0,e),As-1))},[As]),y.useEffect(()=>{const e=e=>{const t=e.target;if("INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName||t.isContentEditable)return void("Escape"===e.key&&(e.preventDefault(),t.blur()));if(e.ctrlKey||e.metaKey)return;const s=e.key.toLowerCase();if("f"===s)return void(ne&&Q(ne)&&(e.preventDefault(),ts()));if("r"===s){const t=ne;if(!t||!Q(t))return;e.preventDefault();if(xs&&vt===fs-1&&bs.length>0&&wt>=0&&wt<bs.length){const e=bs[wt],t=_(vs,e.uri);t&&ls(t.post.uri,t.post.cid,e.handle)}else if(vt===(hs?1:0)){const e=t.post.author?.handle??t.post.author?.did??"";ls(t.post.uri,t.post.cid,e)}return}const o=xs&&(vt===fs-1||(Ct.current?.contains(t)??!1)),a=bt.current?.contains(t)??!1,n=Nt.current?.contains(t)??!1,r=gt.current?.contains(t)??!1;if("e"===s||"enter"===s){if(e.preventDefault(),(kt||r)&&jt.current){const e=jt.current.querySelector("textarea");return void(e&&(e.focus(),Pt(!0)))}if(o&&bs.length>0&&wt>=0&&wt<bs.length){const e=bs[wt];return void(e?.handle&&ee(e.handle))}if((a||n)&&ne&&Q(ne)){const e=ne.post.author?.handle??ne.post.author?.did??"";return void(e&&ee(e))}return}if("m"===s||"`"===s){const t=document.activeElement?.closest?.('[role="menu"]');if(t&&null!=Ge)return e.preventDefault(),void Xe(null);if(ne&&Q(ne)&&ws.length>0){const t=Dt.current,s=ws[t];if(s){let t=null;"description"===s.type||"rootMedia"===s.type?t=ne.post.uri:"comment"!==s.type&&"commentMedia"!==s.type||(t=s.commentUri),null!=t&&(e.preventDefault(),Xe(Ge===t?null:t))}}return}const i="w"===s||"ArrowUp"===e.key,l="s"===s||"d"===s||"a"===s||"ArrowDown"===e.key||"ArrowRight"===e.key||"ArrowLeft"===e.key;if(!i&&!l)return;if(!ne||!Q(ne))return;const c=ws.length;if(c<=0)return;const d=(e,t)=>{const s=ws[e];if(s)if(Pt("replyForm"===s.type),"rootMedia"===s.type){yt(0),At(0);const e=Nt.current?.querySelectorAll("[data-media-item]"),t=e?.[s.index];t&&requestAnimationFrame(()=>{t.focus(),t.scrollIntoView({behavior:"smooth",block:"center"})})}else if("description"===s.type)yt(hs?1:0),At(0),requestAnimationFrame(()=>{bt.current?.focus(),bt.current?.scrollIntoView({behavior:"smooth",block:"center"})});else if("commentMedia"===s.type){yt(fs-1);const e=bs.findIndex(e=>e.uri===s.commentUri);At(e>=0?e:0),requestAnimationFrame(()=>{const e=Ct.current;if(!e)return;const t=Array.from(e.querySelectorAll("[data-comment-uri]")).find(e=>e.getAttribute("data-comment-uri")===s.commentUri),o=t?.querySelectorAll("[data-media-item]")?.[s.mediaIndex];o&&(o.focus({preventScroll:!0}),o.scrollIntoView({behavior:"smooth",block:"center"}))})}else if("comment"===s.type){const o=ws.filter(e=>"commentMedia"===e.type&&e.commentUri===s.commentUri).length,a=void 0!==t?ws[t]:void 0;if("commentMedia"===a?.type&&a.commentUri===s.commentUri&&o>0&&a.mediaIndex===o-1&&e+1<ws.length)return Et(e+1),void d(e+1,e);yt(fs-1);const n=bs.findIndex(e=>e.uri===s.commentUri);At(n>=0?n:0);const r=o>0&&void 0!==t?e<t?o-1:0:-1;if(r>=0){const e=ws.findIndex(e=>"commentMedia"===e.type&&e.commentUri===s.commentUri&&e.mediaIndex===r);e>=0&&Et(e)}requestAnimationFrame(()=>{const e=Ct.current;if(!e)return;const t=Array.from(e.querySelectorAll("[data-comment-uri]")).find(e=>e.getAttribute("data-comment-uri")===s.commentUri);if(!t)return;const o=t.querySelector("[data-comment-content]")||t;if(r>=0){const e=o.querySelectorAll("[data-media-item]")?.[r];e&&(e.focus({preventScroll:!0}),e.scrollIntoView({behavior:"smooth",block:"center"}))}else o.focus({preventScroll:!0}),o.scrollIntoView({behavior:"smooth",block:"center"})})}else yt(fs-1),At(bs.length-1),requestAnimationFrame(()=>{gt.current?.focus(),gt.current?.scrollIntoView({behavior:"smooth",block:"center"})})},u=Dt.current,m=i?Math.max(0,u-1):Math.min(c-1,u+1);m!==u&&(e.preventDefault(),e.stopPropagation(),Mt.current=!0,Et(m),d(m,u))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[fs,vt,xs,bs,wt,kt,ne,hs,ls,ps.length,ee,ws,ts,Ge]),y.useEffect(()=>{if(fs<=1)return;if(0===vt||hs&&1===vt)return;let e=null;xs&&vt===fs-1&&(e=Ct.current),e&&e.scrollIntoView({behavior:"smooth",block:"start"})},[vt,hs,xs,fs]),y.useEffect(()=>{vt===fs-1&&xs&&Ut.current!==fs-1&&At(0),Ut.current=vt},[vt,fs,xs]),y.useEffect(()=>{bs.length>0&&At(e=>Math.min(e,bs.length-1))},[bs.length]),y.useEffect(()=>{if(!N||!ne||!Q(ne)||0===bs.length)return;if(It.current===N)return;It.current=N;const e=bs.findIndex(e=>e.uri===N);if(e<0)return;At(e);const t=ws.findIndex(e=>("comment"===e.type||"commentMedia"===e.type)&&e.commentUri===N);t>=0&&Et(t),requestAnimationFrame(()=>{const e=Ct.current;if(!e)return;const t=Array.from(e.querySelectorAll("[data-comment-uri]")).find(e=>e.getAttribute("data-comment-uri")===N);if(t){(t.querySelector("[data-comment-content]")||t).scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}})},[N,ne,bs,ws]),y.useEffect(()=>{if(!Mt.current)return;if(!(xs&&vt===fs-1)||fs<=1)return;const e=Cs.current;wt<0||wt>=e.length||(Mt.current=!1)},[wt,xs,vt,fs]),y.useEffect(()=>{if(!Mt.current)return;const e=ws[St];!e||"comment"!==e.type&&"commentMedia"!==e.type||(Mt.current=!1)},[St,ws]),!ae)return q&&q(),null;const qs=ne&&Q(ne)?c(ne.post):[],Rs=e.jsxs("div",{className:`${F.wrap}${q?` ${F.wrapInModal}`:""}${ie?` ${F.wrapLoading}`:""}`,children:[ie&&!ne&&e.jsx("div",{className:F.loading,"aria-live":"polite",children:"Loading…"}),ce&&e.jsx("p",{className:F.error,children:ce}),ne&&Q(ne)&&e.jsxs(e.Fragment,{children:[(()=>{const t=ne.post.record?.reply,s="parent"in ne&&ne.parent&&Q(ne.parent);return ie&&t&&!s?e.jsxs("div",{className:F.parentPostWrap,children:[e.jsx("p",{className:F.quotedPostLabel,children:"Replying to"}),e.jsx("div",{className:`${F.quotedPostCard} ${F.parentSkeleton}`,children:e.jsxs("div",{className:F.quotedPostHead,children:[e.jsx("span",{className:F.quotedPostAvatarPlaceholder,"aria-hidden":!0,children:"•"}),e.jsx("span",{className:F.quotedPostHandle,children:"Loading…"})]})})]}):s?(()=>{const t=ne.parent,s=t&&"post"in t?t.post:void 0;if(!s)return null;const o=s.author?.handle??s.author?.did??"",a=s.record?.text??"",n=c(s);return e.jsxs("div",{className:F.parentPostWrap,children:[e.jsx("p",{className:F.quotedPostLabel,children:"Replying to"}),e.jsxs("button",{type:"button",className:F.quotedPostCard,onClick:()=>{q?te(s.uri):V(`/post/${encodeURIComponent(s.uri)}`)},children:[e.jsxs("div",{className:F.quotedPostHead,children:[s.author?.avatar?e.jsx("img",{src:s.author.avatar,alt:"",className:F.quotedPostAvatar,loading:"lazy"}):e.jsx("span",{className:F.quotedPostAvatarPlaceholder,"aria-hidden":!0,children:o.slice(0,1).toUpperCase()}),e.jsxs(I,{handle:o,className:F.quotedPostHandle,onClick:e=>e.stopPropagation(),children:["@",o]}),s.record?.createdAt&&e.jsx("span",{className:F.quotedPostTime,title:L(s.record.createdAt),children:R(s.record.createdAt)})]}),n.length>0&&e.jsx("div",{className:F.quotedPostMediaGrid,children:n.map((t,s)=>e.jsx("div",{className:F.quotedPostMedia,children:"image"===t.type?e.jsx("img",{src:t.url,alt:"",loading:"lazy",className:F.quotedPostThumb}):t.videoPlaylist?e.jsx("div",{className:F.quotedPostVideoThumb,style:{backgroundImage:t.url?`url(${t.url})`:void 0}}):null},s))}),a?e.jsx("p",{className:F.quotedPostText,children:e.jsx(U,{text:a,facets:s.record?.facets,maxLength:200,stopPropagation:!0})}):null]})]})})():null})(),e.jsxs("article",{className:`${F.postBlock} ${F.rootPostBlock}`,children:[qs.length>0&&e.jsx("div",{ref:Nt,onMouseEnter:()=>!q&&ps.length>0&&Et(0),children:e.jsx(Y,{items:qs,autoPlayFirstVideo:!0,hideVideoControlsUntilTap:!oe,onFocusItem:e=>!q&&Et(e),onDoubleTapLike:q?void 0:ts})}),e.jsxs("div",{ref:bt,className:F.rootPostDescription,tabIndex:-1,onFocus:()=>!q&&Et(ps.length),onMouseEnter:()=>!q&&Et(ps.length),children:[e.jsxs("div",{className:F.postHead,children:[ne.post.author.avatar&&e.jsx("img",{src:ne.post.author.avatar,alt:"",className:F.avatar,loading:"lazy"}),e.jsxs("div",{className:F.authorRow,children:[e.jsxs(I,{handle:ne.post.author.handle??ne.post.author.did,className:F.handleLink,children:["@",ne.post.author.handle??ne.post.author.did]}),!Ot&&(_t?e.jsxs("button",{type:"button",className:`${F.followBtn} ${F.followBtnFollowing}`,onClick:async function(){if(Kt&&!Ne){be(!0);try{await a.deleteFollow(Kt),ke(null),we(!1)}catch{}finally{be(!1)}}},disabled:Ne,title:"Unfollow",children:[e.jsx("span",{className:F.followLabelDefault,children:"Following"}),e.jsx("span",{className:F.followLabelHover,children:"Unfollow"})]}):e.jsx("button",{type:"button",className:F.followBtn,onClick:async function(){if(ne&&Q(ne)&&!Ne&&!_t){be(!0);try{const e=await a.follow(ne.post.author.did);ke(e.uri),we(!0)}catch{}finally{be(!1)}}},disabled:Ne,children:Ne?"Following…":"Follow"})),ne.post.record?.createdAt&&e.jsx("span",{className:F.postTimestamp,title:L(ne.post.record.createdAt),children:R(ne.post.record.createdAt)})]})]}),ne.post.record?.text&&e.jsx("p",{className:F.postText,children:e.jsx(U,{text:ne.post.record.text,facets:ne.post.record?.facets,interactive:!0})}),(()=>{const t=d(ne.post);return t?e.jsxs("div",{className:F.quotedPostWrap,children:[e.jsx("p",{className:F.quotedPostLabel,children:"Link"}),e.jsxs("a",{href:t.uri,target:"_blank",rel:"noopener noreferrer",className:F.quotedPostCard,children:[t.thumb?e.jsx("div",{className:F.quotedPostMedia,children:e.jsx("img",{src:t.thumb,alt:"",loading:"lazy",className:F.quotedPostThumb})}):null,e.jsx("p",{className:F.quotedPostText,children:t.title}),t.description?e.jsx("p",{className:F.quotedPostText,children:e.jsx(U,{text:t.description,maxLength:200,stopPropagation:!0})}):null]})]}):null})(),(()=>{const t=u(ne.post);if(!t)return null;const s=t.author?.handle??t.author?.did??"",o=t.record?.text??"",a=c(t);return e.jsxs("div",{className:F.quotedPostWrap,children:[e.jsx("p",{className:F.quotedPostLabel,children:"Quoting"}),e.jsxs("button",{type:"button",className:F.quotedPostCard,onClick:()=>{q?te(t.uri):V(`/post/${encodeURIComponent(t.uri)}`)},children:[e.jsxs("div",{className:F.quotedPostHead,children:[t.author?.avatar?e.jsx("img",{src:t.author.avatar,alt:"",className:F.quotedPostAvatar,loading:"lazy"}):e.jsx("span",{className:F.quotedPostAvatarPlaceholder,"aria-hidden":!0,children:s.slice(0,1).toUpperCase()}),e.jsxs(I,{handle:s,className:F.quotedPostHandle,onClick:e=>e.stopPropagation(),children:["@",s]}),t.record?.createdAt&&e.jsx("span",{className:F.quotedPostTime,title:L(t.record.createdAt),children:R(t.record.createdAt)})]}),a.length>0&&e.jsx("div",{className:F.quotedPostMediaGrid,children:a.map((t,s)=>e.jsx("div",{className:F.quotedPostMedia,children:"image"===t.type?e.jsx("img",{src:t.url,alt:"",loading:"lazy",className:F.quotedPostThumb}):t.videoPlaylist?e.jsx("div",{className:F.quotedPostVideoThumb,style:{backgroundImage:t.url?`url(${t.url})`:void 0}}):null},s))}),o?e.jsx("p",{className:F.quotedPostText,children:e.jsx(U,{text:o,facets:t.record?.facets,maxLength:200,stopPropagation:!0})}):null]})]})})()]}),e.jsxs("section",{className:F.actions,"aria-label":"Post actions",children:[e.jsxs("div",{className:F.actionRow,children:[e.jsxs("div",{className:F.addToBoardWrap,children:[e.jsxs("button",{type:"button",className:F.addToBoardTrigger,onClick:()=>et(e=>!e),"aria-expanded":Ze,"aria-haspopup":"true",children:[e.jsx("span",{className:F.likeRepostBtnIcon,"aria-hidden":!0,children:e.jsx(z,{})}),"Collect ",Ze?"▾":"▸"]}),Ze&&e.jsxs("div",{className:F.boardDropdown,children:[0===Ft.length?null:e.jsx(e.Fragment,{children:Ft.map(t=>{const s=A(t.id,ne.post.uri),o=xe.has(t.id);return e.jsxs("label",{className:F.boardCheckLabel,children:[e.jsx("input",{type:"checkbox",checked:o,onChange:()=>{return!s&&(e=t.id,void fe(t=>{const s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s}));var e},disabled:s,className:F.boardCheckbox}),e.jsx("span",{className:F.boardCheckText,children:s?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:F.boardCheckIcon,"aria-hidden":!0,children:"✓"})," ",t.name]}):t.name})]},t.id)})}),e.jsx("div",{className:F.boardDropdownNew,children:e.jsx("input",{type:"text",placeholder:"New collection name",value:Je,onChange:e=>Ye(e.target.value),className:F.newBoardInput,onKeyDown:e=>"Enter"===e.key&&(e.preventDefault(),us())})}),e.jsx("div",{className:F.boardDropdownActions,children:e.jsx("button",{type:"button",className:F.addBtn,onClick:us,disabled:0===xe.size&&!Je.trim(),children:"Add to selected"})})]})]}),e.jsxs("button",{type:"button",className:`${F.likeRepostBtn} ${Yt?F.likeRepostBtnActive:""}`,onClick:ts,disabled:Pe,title:Yt?"Remove like":"Like",children:[Pe?"…":Yt?"♥":"♡"," Like"]}),ne&&Q(ne)&&Tt&&e.jsxs("button",{type:"button",className:`${F.likeRepostBtn} ${$e[ne.post.uri]?F.likeRepostBtnDownvoteActive:""}`,onClick:()=>ds(ne.post.uri,ne.post.cid,$e[ne.post.uri]??null),disabled:Ke===ne.post.uri,title:$e[ne.post.uri]?"Remove downvote":"Downvote (syncs across AT Protocol)","aria-label":$e[ne.post.uri]?"Remove downvote":"Downvote",children:[Ke===ne.post.uri?"…":"↓"," Downvote",(()=>{const e=Ve[ne.post.uri]??ne.post.downvoteCount??0,t=ze[ne.post.uri]??0,s=Math.max(0,e+t);return s>0?` ${s}`:""})()]}),e.jsxs("div",{className:F.repostWrap,ref:ft,children:[e.jsxs("button",{type:"button",className:`${F.likeRepostBtn} ${Zt?F.likeRepostBtnActive:""} ${tt?F.repostTriggerOpen:""}`,onClick:()=>st(e=>!e),disabled:Re,title:Zt?"Remove repost":"Repost or quote","aria-expanded":tt,"aria-haspopup":"true",children:[e.jsx("span",{className:F.likeRepostBtnIcon,"aria-hidden":!0,children:e.jsx(H,{})}),Re?"…":"Repost ▾"]}),tt&&e.jsxs("div",{className:F.repostDropdown,role:"menu",children:[e.jsx("button",{type:"button",className:F.repostDropdownItem,role:"menuitem",onClick:()=>{st(!1),async function(){if(!ne||!Q(ne)||Re)return;const{uri:e,cid:t}=ne.post;Le(!0);try{if(Zt)await a.deleteRepost(Jt),Me(null);else{const s=await a.repost(e,t);Me(s.uri)}}catch{}finally{Le(!1)}}()},disabled:Re,children:Zt?"Remove repost":"Repost"}),e.jsx("button",{type:"button",className:F.repostDropdownItem,role:"menuitem",onClick:function(){st(!1),at(!0),rt(""),lt([]),dt([]),ht(null)},disabled:!Tt?.did,children:"Quote post"})]})]}),ne&&Q(ne)&&e.jsxs("button",{type:"button",className:F.likeRepostBtn,onClick:()=>se(ne.post.uri),title:"View posts that quote this","aria-label":"View quotes",children:[e.jsx("span",{className:F.likeRepostBtnIcon,"aria-hidden":!0,children:e.jsx(W,{})}),"View Quotes"]}),ne&&Q(ne)&&e.jsx(S,{postUri:ne.post.uri,postCid:ne.post.cid,authorDid:ne.post.author.did,rootUri:ne.post.uri,isOwnPost:Tt?.did===ne.post.author.did,compact:!0,verticalIcon:!0,open:Ge===ne.post.uri,onOpenChange:e=>Xe(e?ne.post.uri:null),onHidden:()=>V("/feed"),postedAt:ne.post.record?.createdAt,onViewQuotes:se})]}),ve&&e.jsxs("p",{className:F.added,children:["Added to ",Ft.find(e=>e.id===ve)?.name]})]})]}),ne&&Q(ne)&&e.jsx("div",{className:F.inlineReplyFormWrap,children:e.jsx("div",{children:e.jsxs("form",{ref:qt,onSubmit:async function(e){if(e.preventDefault(),!ne||!Q(ne)||!ue.trim())return;const t=ne.post;he(!0);try{await x(t.uri,t.cid,t.uri,t.cid,ue.trim()),me(""),await rs()}catch(s){alert(s instanceof Error?s.message:"Failed to post comment")}finally{he(!1)}},className:F.commentForm,children:[Wt&&e.jsx("div",{className:F.inlineReplyFormHeader,children:Bt&&$t?.did?e.jsx(O,{replyAs:Wt,sessionsList:Bt,switchAccount:Vt,currentDid:$t.did}):e.jsxs("p",{className:F.replyAs,children:[e.jsx("span",{className:F.replyAsLabel,children:"Replying as"}),e.jsxs("span",{className:F.replyAsUserChip,children:[Wt.avatar?e.jsx("img",{src:Wt.avatar,alt:"",className:F.replyAsAvatar,loading:"lazy"}):e.jsx("span",{className:F.replyAsAvatarPlaceholder,"aria-hidden":!0,children:Wt.handle.slice(0,1).toUpperCase()}),e.jsxs("span",{className:F.replyAsHandle,children:["@",Wt.handle]})]})]})}),e.jsx(E,{placeholder:"Write a comment…",value:ue,onChange:me,onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),ue.trim()&&!pe&&qt.current?.requestSubmit())},className:F.textarea,rows:3,maxLength:300}),e.jsx("p",{className:F.hint,children:"⌘ Enter or ⌘ E to post"}),e.jsx("button",{type:"submit",className:F.submit,disabled:pe||!ue.trim(),children:pe?"Posting…":"Post comment"})]})})}),"replies"in ne&&Array.isArray(ne.replies)&&ne.replies.length>0&&e.jsxs("div",{ref:Ct,className:`${F.replies} ${F.repliesTopLevel}`,children:[e.jsxs("div",{className:F.commentSortRow,children:[e.jsx("label",{htmlFor:"comment-sort",className:F.commentSortLabel,children:"Sort:"}),e.jsxs("select",{id:"comment-sort",className:F.commentSortSelect,value:Rt,onChange:e=>Lt(e.target.value),"aria-label":"Comment sort order",children:[e.jsx("option",{value:"newest",children:"Newest"}),e.jsx("option",{value:"oldest",children:"Oldest"}),e.jsx("option",{value:"likes",children:"Most liked"}),e.jsx("option",{value:"score",children:"Score (↑ − ↓)"}),e.jsx("option",{value:"controversial",children:"Controversial"}),e.jsx("option",{value:"best",children:"Best"})]})]}),e.jsx("div",{onFocusCapture:e=>{if(q)return;const t=e.target,s=t.closest?.("[data-comment-uri]");if(!s)return;const o=s.getAttribute("data-comment-uri");if(!o)return;const a=t.closest?.("[data-media-item]");if(a){const e=a.getAttribute("data-media-item");if(null!=e){const t=ws.findIndex(t=>"commentMedia"===t.type&&t.commentUri===o&&t.mediaIndex===parseInt(e,10));t>=0&&Et(t)}return}const n=ws.findIndex(e=>"comment"===e.type&&e.commentUri===o);if(n>=0){Et(n);const e=bs.findIndex(e=>e.uri===o);e>=0&&At(e)}},children:Ns.map((t,s)=>{const o=ws[St],a="comment"===o?.type||"commentMedia"===o?.type?o.commentUri:void 0,n=ws.findIndex(e=>"comment"===e.type&&e.commentUri===t.post.uri),r=xs&&"comment"===o?.type&&o.commentUri===t.post.uri;if(je.has(t.post.uri)){const o="replies"in t&&Array.isArray(t.replies)?t.replies.length:0,a=0===o?"Comment":`${o} reply${1!==o?"s":""}`,i=t.post.author?.handle??t.post.author?.did??"";return e.jsx("div",{className:F.topLevelCommentWrap,"data-comment-uri":t.post.uri,tabIndex:-1,onMouseEnter:()=>{!q&&n>=0&&(Et(n),At(bs.findIndex(e=>e.uri===t.post.uri)))},children:e.jsx("div",{className:`${F.collapsedCommentWrap} ${r?F.commentFocused:""}`,style:{marginLeft:0},onFocus:()=>!q&&n>=0&&Et(n),children:e.jsxs("button",{type:"button",className:F.collapsedCommentBtn,onClick:()=>es(t.post.uri),children:[e.jsx("span",{className:F.collapsedCommentExpandIcon,"aria-hidden":!0,children:"+"}),t.post.author?.avatar?e.jsx("img",{src:t.post.author.avatar,alt:"",className:F.collapsedCommentAvatar,loading:"lazy"}):e.jsx("span",{className:F.collapsedCommentAvatarPlaceholder,"aria-hidden":!0,children:i.slice(0,1).toUpperCase()}),e.jsxs("span",{className:F.collapsedCommentHandle,children:["@",i]}),e.jsx("span",{className:F.collapsedCommentLabel,children:a})]})})},`${t.post.uri}-${s}`)}return e.jsx("div",{className:F.topLevelCommentWrap,onMouseEnter:()=>{!q&&n>=0&&(Et(n),At(bs.findIndex(e=>e.uri===t.post.uri)))},children:e.jsx(Z,{node:t,depth:0,collapsedThreads:je,onToggleCollapse:es,onReply:ls,rootPostUri:ne.post.uri,rootPostCid:ne.post.cid,replyingTo:Ie,replyComment:ue,setReplyComment:me,onReplySubmit:is,replyPosting:pe,clearReplyingTo:()=>Ue(null),commentFormRef:jt,replyAs:Wt,sessionsList:Bt,switchAccount:Vt,currentDid:$t?.did??void 0,focusedCommentUri:a,onCommentMediaFocus:ks,onLike:$t?cs:void 0,onDownvote:$t?ds:void 0,likeOverrides:Fe,myDownvotes:$e,downvoteCounts:Ve,downvoteCountOptimisticDelta:ze,likeLoadingUri:Oe,downvoteLoadingUri:Ke,openActionsMenuCommentUri:Ge,onActionsMenuOpenChange:(e,t)=>Xe(t?e:null),onViewQuotes:se})},`${t.post.uri}-${s}`)})})]}),ne&&Q(ne)&&"replies"in ne&&Array.isArray(ne.replies)&&ne.replies.length>=6&&(!Ie||Ie.uri===ne.post.uri)&&e.jsx("div",{className:F.inlineReplyFormWrap,children:e.jsx("div",{ref:gt,tabIndex:-1,className:kt?F.commentFormWrapFocused:void 0,onFocus:()=>!q&&Et(ws.length-1),onMouseEnter:()=>!q&&Et(ws.length-1),onBlur:()=>{requestAnimationFrame(()=>{jt.current?.contains(document.activeElement)||Pt(!1)})},children:e.jsxs("form",{ref:jt,onSubmit:is,className:F.commentForm,children:[Wt&&e.jsxs("div",{className:F.inlineReplyFormHeader,children:[Ie&&e.jsx("button",{type:"button",className:F.cancelReply,onClick:()=>Ue(null),"aria-label":"Cancel reply",children:"×"}),Bt&&$t?.did?e.jsx(O,{replyAs:Wt,sessionsList:Bt,switchAccount:Vt,currentDid:$t.did}):e.jsxs("p",{className:F.replyAs,children:[e.jsx("span",{className:F.replyAsLabel,children:"Replying as"}),e.jsxs("span",{className:F.replyAsUserChip,children:[Wt.avatar?e.jsx("img",{src:Wt.avatar,alt:"",className:F.replyAsAvatar,loading:"lazy"}):e.jsx("span",{className:F.replyAsAvatarPlaceholder,"aria-hidden":!0,children:Wt.handle.slice(0,1).toUpperCase()}),e.jsxs("span",{className:F.replyAsHandle,children:["@",Wt.handle]})]})]})]}),e.jsx(E,{placeholder:Ie?`Reply to @${Ie.handle}…`:"Write a comment…",value:ue,onChange:me,onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),ue.trim()&&!pe&&jt.current?.requestSubmit())},className:F.textarea,rows:3,maxLength:300}),e.jsx("p",{className:F.hint,children:"⌘ Enter or ⌘ E to post"}),e.jsx("button",{type:"submit",className:F.submit,disabled:pe||!ue.trim(),children:pe?"Posting…":"Post comment"})]})})})]}),ot&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:F.quoteComposerBackdrop,onClick:as,"aria-hidden":!0}),e.jsx("div",{className:F.quoteComposerOverlay,role:"dialog","aria-label":"Quote post",onClick:as,onDragOver:e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"},onDrop:e=>{e.preventDefault(),e.dataTransfer?.files?.length&&os(e.dataTransfer.files)},children:e.jsxs("div",{className:F.quoteComposerCard,onClick:e=>e.stopPropagation(),children:[e.jsx("h2",{className:F.quoteComposerTitle,children:"Quote post"}),Tt?.did?e.jsxs(e.Fragment,{children:[ne&&Q(ne)&&(()=>{const t=ne.post,s=t.author?.handle??t.author?.did??"",o=t.record?.text??"",a=c(t)[0];return e.jsxs("div",{className:F.quoteComposerQuotedWrap,children:[e.jsx("p",{className:F.quotedPostLabel,children:"Quoting"}),e.jsxs("div",{className:F.quoteComposerQuotedCard,children:[e.jsxs("div",{className:F.quotedPostHead,children:[t.author?.avatar?e.jsx("img",{src:t.author.avatar,alt:"",className:F.quotedPostAvatar,loading:"lazy"}):e.jsx("span",{className:F.quotedPostAvatarPlaceholder,"aria-hidden":!0,children:s.slice(0,1).toUpperCase()}),e.jsxs("span",{className:F.quotedPostHandle,children:["@",s]}),t.record?.createdAt&&e.jsx("span",{className:F.quotedPostTime,title:L(t.record.createdAt),children:R(t.record.createdAt)})]}),a&&e.jsx("div",{className:F.quotedPostMedia,children:"image"===a.type?e.jsx("img",{src:a.url,alt:"",loading:"lazy",className:F.quotedPostThumb}):a.videoPlaylist?e.jsx("div",{className:F.quotedPostVideoThumb,style:{backgroundImage:a.url?`url(${a.url})`:void 0}}):null}),o?e.jsx("p",{className:F.quotedPostText,children:e.jsx(U,{text:o,facets:t.record?.facets,maxLength:300,stopPropagation:!0})}):null]})]})})(),e.jsxs("form",{onSubmit:ns,onKeyDown:e=>{(e.metaKey||e.ctrlKey)&&"Enter"===e.key&&(e.preventDefault(),ns(e))},children:[e.jsx(E,{className:F.quoteComposerTextarea,value:nt,onChange:rt,placeholder:"Add your thoughts...",rows:4,maxLength:300,disabled:ut,autoFocus:!0}),it.length>0&&e.jsxs("div",{className:F.quoteComposerMediaSection,children:[e.jsx("div",{className:F.quoteComposerPreviews,children:it.map((t,s)=>e.jsxs("div",{className:F.quoteComposerPreviewWrap,children:[e.jsx("img",{src:ms[s],alt:"",className:F.quoteComposerPreviewImg}),e.jsx("button",{type:"button",className:F.quoteComposerPreviewRemove,onClick:()=>{return e=s,lt(t=>t.filter((t,s)=>s!==e)),void dt(t=>t.filter((t,s)=>s!==e));var e},"aria-label":"Remove image",disabled:ut,children:"×"})]},s))}),e.jsx("p",{className:F.quoteComposerAltPrompt,children:"Describe each image for accessibility (alt text)."}),e.jsx("div",{className:F.quoteComposerAltFields,children:it.map((t,s)=>e.jsxs("div",{className:F.quoteComposerAltRow,children:[e.jsxs("label",{htmlFor:`quote-alt-${s}`,className:F.quoteComposerAltLabel,children:["Image ",s+1]}),e.jsx("input",{id:`quote-alt-${s}`,type:"text",className:F.quoteComposerAltInput,placeholder:"Describe this image",value:ct[s]??"",onChange:e=>{const t=e.target.value.slice(0,1e3);dt(e=>{const o=[...e];for(;o.length<it.length;)o.push("");return o[s]=t,o})},maxLength:1e3,disabled:ut})]},s))})]}),e.jsxs("div",{className:F.quoteComposerFooter,children:[e.jsxs("div",{className:F.quoteComposerFooterLeft,children:[e.jsx("input",{ref:xt,type:"file",accept:"image/jpeg,image/png,image/gif,image/webp",multiple:!0,className:F.quoteComposerFileInput,onChange:e=>{e.target.files?.length&&os(e.target.files),e.target.value=""}}),e.jsx("button",{type:"button",className:F.quoteComposerAddMedia,onClick:()=>xt.current?.click(),disabled:ut||it.length>=4,title:"Add photo","aria-label":"Add photo",children:"Add media"}),e.jsx(D,{used:nt.length,max:300})]}),e.jsxs("div",{className:F.quoteComposerActions,children:[e.jsx("button",{type:"button",className:F.quoteComposerCancel,onClick:as,disabled:ut,children:"Cancel"}),e.jsx("button",{type:"submit",className:F.quoteComposerSubmit,disabled:ut||!nt.trim()&&0===it.length,children:ut?"Posting…":"Quote post"})]})]}),pt&&e.jsx("p",{className:F.quoteComposerError,children:pt})]})]}):e.jsx("p",{className:F.quoteComposerSignIn,children:"Log in to quote posts."})]})})]})]});return q?Rs:e.jsx(M,{title:"Post",showNav:!0,children:Rs})}const te=Object.freeze(Object.defineProperty({__proto__:null,PostDetailContent:ee,ReplyAsRow:O,default:function(){const{uri:t}=g(),s=j(),o=N(),a=t?decodeURIComponent(t):"";return a?e.jsx(M,{title:"Post",showNav:!0,children:e.jsx(ee,{uri:a,initialOpenReply:o.state?.openReply})}):(s("/feed",{replace:!0}),null)}},Symbol.toStringTag,{value:"Module"}));export{ee as P,O as R,te as a,$ as g};
