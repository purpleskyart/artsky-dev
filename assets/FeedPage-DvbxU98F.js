import{u as e,g as t,a as n,b as s,c as r,d as o,j as a,e as i,i as l,f as c,h as d,k as u,l as f,m,n as p,o as h,p as g,q as y,r as x,s as _,t as w,v,w as b,x as E,y as j}from"./index-BPDhhyE4.js";import{b as N,h as S,u as M,d as T,i as k}from"./react-vendor-DGaPsC2e.js";import{u as I,F as R,L as A}from"./Layout-yUc6JO35.js";import{u as C}from"./usePullToRefresh-DVlCPYCP.js";import{P as O}from"./PostCard-Baic0qcw.js";import{setInitialPostForUri as F}from"./postCache-CTqU0alO.js";import{s as L}from"./FeedPage.module-BzgruK7v.js";import"./atproto-3-1TCh3S.js";import"./Icons-BgaOPc_J.js";import"./PostText-BqfJW8ik.js";import"./PostActionsMenu-Dh-vr2d3.js";import"./date-Ct-NsrQr.js";import"./artboards-DNvSVVrd.js";import"./artboardsPds-DWUixJ9h.js";function P(e,t){let n;return function(...s){void 0!==n&&clearTimeout(n),n=setTimeout(()=>{n=void 0,e(...s)},t)}}function D(e,t=150){const n=function(e=150){const[t,n]=N.useState(()=>"undefined"!=typeof window?window.innerWidth:0);return N.useEffect(()=>{const t=P(()=>{n(window.innerWidth)},e);return n(window.innerWidth),window.addEventListener("resize",t,{passive:!0}),()=>{window.removeEventListener("resize",t)}},[e]),t}(t);return N.useMemo(()=>{const t="1"===e?1:"2"===e?2:3;return Math.min(3,Math.max(1,t))},[e,n])}const U="artsky-recommendations-shown";function H(){try{const e=localStorage.getItem(U);if(!e)return{};const t=JSON.parse(e);return"object"==typeof t&&null!==t?t:{}}catch{return{}}}const B="_wrap_ljlgs_1",Y="_subtext_ljlgs_10",$="_sortRow_ljlgs_18",z="_sortLabel_ljlgs_26",q="_sortSelect_ljlgs_31",K="_loading_ljlgs_46",W="_empty_ljlgs_47",G="_list_ljlgs_54",V="_item_ljlgs_65",J="_profileBtn_ljlgs_72",X="_avatar_ljlgs_97",Q="_avatarPlaceholder_ljlgs_106",Z="_info_ljlgs_121",ee="_handle_ljlgs_127",te="_reason_ljlgs_135",ne="_actions_ljlgs_140",se="_infoBtn_ljlgs_150",re="_infoIcon_ljlgs_174",oe="_followBtn_ljlgs_179",ae="_dismissBtn_ljlgs_199",ie="_detailBackdrop_ljlgs_226",le="_detailPanel_ljlgs_237",ce="_detailHeader_ljlgs_250",de="_detailTitle_ljlgs_258",ue="_detailClose_ljlgs_265",fe="_detailBody_ljlgs_284",me="_detailSummary_ljlgs_289",pe="_detailList_ljlgs_295",he="_detailListItem_ljlgs_304",ge="_detailProfileBtn_ljlgs_308",ye="_detailAvatar_ljlgs_332",xe="_detailAvatarPlaceholder_ljlgs_340",_e="_detailProfileInfo_ljlgs_354",we="_detailDisplayName_ljlgs_360",ve="_detailHandle_ljlgs_368",be="_detailLoading_ljlgs_376";function Ee(){const{openProfileModal:i}=e(),[l,c]=N.useState([]),[d,u]=N.useState(!1),[f,m]=N.useState(null),[p,h]=N.useState(()=>new Set),[g,y]=N.useState("count"),[x,_]=N.useState(null),[w,v]=N.useState(null),[b,E]=N.useState(!1),j=N.useMemo(()=>l,[l]),M=N.useCallback(async()=>{const e=t(),o=e?.did;if(o){u(!0);try{const e="mutuals"===g?await n(s,o,{maxSuggestions:20}):await r(s,o,{maxSuggestions:20}),t=H(),a=Date.now()-6048e5,i=e.filter(e=>!p.has(e.did)&&(!t[e.did]||t[e.did]<a)).slice(0,8);c(i)}catch{c([])}finally{u(!1)}}},[p,g]);N.useEffect(()=>{M()},[M]);const T=N.useCallback(async e=>{_(e.did),v(null),E(!0);try{const n=t(),r=n?.did;if(!r)return;const a=await o(s,r,e.did,{source:"mutuals"===g?"mutuals":"peopleYouFollow"});v(a)}catch{v({count:0,followedBy:[]})}finally{E(!1)}},[g]),k=N.useCallback(async(e,t)=>{m(e);try{await s.follow(e),c(t=>t.filter(t=>t.did!==e))}catch{}finally{m(null)}},[]),I=N.useCallback(e=>{!function(e){if(0===e.length)return;const t=Date.now(),n={...H()};for(const o of e)n[o]=t;const s=Object.entries(n),r=s.length<=500?s:s.sort((e,t)=>(t[1]??0)-(e[1]??0)).slice(0,500);try{localStorage.setItem(U,JSON.stringify(Object.fromEntries(r)))}catch{}}([e]),h(t=>new Set(t).add(e)),c(t=>t.filter(t=>t.did!==e))},[]),R=x?l.find(e=>e.did===x):null;return a.jsxs("div",{className:B,"aria-label":"Suggested accounts to follow",children:[a.jsx("p",{className:Y,children:"Accounts followed by people you follow. New suggestions each time you open."}),l.length>0&&a.jsxs("div",{className:$,children:[a.jsx("span",{className:z,children:"Sort by:"}),a.jsxs("select",{className:q,value:g,onChange:e=>y(e.target.value),"aria-label":"Sort suggestions",children:[a.jsx("option",{value:"count",children:"Most followed by people you follow"}),a.jsx("option",{value:"mutuals",children:"Most followed by mutuals"})]})]}),d&&0===l.length?a.jsx("p",{className:K,children:"Loading…"}):0===l.length?a.jsx("p",{className:W,children:"No suggestions right now. Follow more accounts to see recommendations."}):a.jsx("ul",{className:G,children:j.map(e=>a.jsxs("li",{className:V,children:[a.jsxs("button",{type:"button",className:J,onClick:()=>i(e.handle),"aria-label":`View @${e.handle} profile`,children:[e.avatar?a.jsx("img",{src:e.avatar,alt:"",className:X,loading:"lazy"}):a.jsx("span",{className:Q,"aria-hidden":!0,children:(e.displayName??e.handle).slice(0,1).toUpperCase()}),a.jsxs("span",{className:Z,children:[a.jsxs("span",{className:ee,children:["@",e.handle]}),a.jsx("span",{className:te,children:"mutuals"===g?1===e.count?"Followed by 1 mutual":`Followed by ${e.count} mutuals`:1===e.count?"Followed by 1 person you follow":`Followed by ${e.count} people you follow`})]})]}),a.jsxs("div",{className:ne,children:[a.jsx("button",{type:"button",className:se,onClick:t=>{t.stopPropagation(),T(e)},"aria-label":"Why we recommend this account",title:"Why we recommend this account",children:a.jsx(je,{})}),a.jsx("button",{type:"button",className:oe,onClick:()=>k(e.did,e.handle),disabled:f===e.did,children:f===e.did?"…":"Follow"}),a.jsx("button",{type:"button",className:ae,onClick:()=>I(e.did),"aria-label":"Not now",title:"Hide this suggestion for a week",children:"×"})]})]},e.did))}),x&&R&&S.createPortal(a.jsx("div",{className:ie,role:"dialog","aria-modal":"true","aria-labelledby":"suggestion-detail-title",onClick:()=>_(null),children:a.jsxs("div",{className:le,onClick:e=>e.stopPropagation(),children:[a.jsxs("div",{className:ce,children:[a.jsxs("h3",{id:"suggestion-detail-title",className:de,children:["Why we recommend @",R.handle]}),a.jsx("button",{type:"button",className:ue,onClick:()=>_(null),"aria-label":"Close",children:"×"})]}),b?a.jsx("p",{className:be,children:"Loading…"}):w?a.jsxs("div",{className:fe,children:[a.jsx("p",{className:me,children:w.fromMutuals?1===w.count?"Followed by 1 mutual:":`Followed by ${w.count} mutuals:`:1===w.count?"Followed by 1 person you follow:":`Followed by ${w.count} people you follow:`}),a.jsx("ul",{className:pe,children:w.followedBy.map(e=>a.jsx("li",{className:he,children:a.jsxs("button",{type:"button",className:ge,onClick:()=>{i(e.handle),_(null)},children:[e.avatar?a.jsx("img",{src:e.avatar,alt:"",className:ye,loading:"lazy"}):a.jsx("span",{className:xe,"aria-hidden":!0,children:(e.displayName??e.handle).slice(0,1).toUpperCase()}),a.jsxs("span",{className:_e,children:[e.displayName&&a.jsx("span",{className:we,children:e.displayName}),a.jsxs("span",{className:ve,children:["@",e.handle]})]})]})},e.did))})]}):null]})}),document.body)]})}function je(){return a.jsx("svg",{className:re,viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":!0,children:a.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})}const Ne=N.memo(function(e){const t=N.useRef(null);return function(e,t){const[n,s]=N.useState(!0),r=N.useRef(null);N.useEffect(()=>{const n=e.current;if(n)return r.current=new IntersectionObserver(e=>{for(const t of e)s(t.isIntersecting)},{rootMargin:t?.rootMargin??"400px 0px 400px 0px",threshold:t?.threshold??0,...t}),r.current.observe(n),()=>{r.current&&(r.current.disconnect(),r.current=null)}},[e,t])}(t,{rootMargin:"1200px 0px 1200px 0px",threshold:0}),a.jsx(O,{...e,cardRef:n=>{t.current=n,e.cardRef(n)},onAspectRatio:void 0})}),Se="_wrap_a6pg0_1",Me="_seen_a6pg0_11",Te="_header_a6pg0_15",ke="_repostIcon_a6pg0_25",Ie="_title_a6pg0_32",Re="_scrollWrap_a6pg0_38",Ae="_track_a6pg0_54",Ce="_tile_a6pg0_60",Oe="_tileImg_a6pg0_86",Fe="_tilePlaceholder_a6pg0_94",Le="_tileHandle_a6pg0_107";function Pe(){return a.jsx("svg",{className:ke,viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":!0,children:a.jsx("path",{d:"M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"})})}function De({items:e,onPostClick:t,cardRef:n,seen:s,"data-post-uri":r}){if(0===e.length)return null;const o=e=>e.reason?.by;return a.jsxs("div",{ref:n,className:`${Se} ${s?Me:""}`,"data-post-uri":r??e[0]?.post?.uri,role:"article","aria-label":`${e.length} reposts`,children:[a.jsxs("div",{className:Te,children:[a.jsx(Pe,{}),a.jsxs("span",{className:Ie,children:[e.length," reposts"]})]}),a.jsx("div",{className:Re,children:a.jsx("div",{className:Ae,children:e.map(e=>{const n=e.post.uri,s=(e=>o(e)?.handle??o(e)?.did??e.post.author?.handle??e.post.author?.did??"")(e),r=i(e.post),l=e.post.author?.avatar,c=r?.url??l;return a.jsxs("button",{type:"button",className:Ce,onClick:()=>t(n,{initialItem:e}),"aria-label":s?`Repost by @${s}, open post`:"Open post",children:[c?a.jsx("img",{src:c,alt:"",className:Oe,loading:"lazy"}):a.jsx("span",{className:Fe,children:(e.post.author?.displayName??s??e.post.author?.did??"?").slice(0,1).toUpperCase()}),s?a.jsxs("span",{className:Le,children:["@",s]}):null]},n)})})})]})}function Ue({column:e,loadMoreSentinelRef:t,hasCursor:n,keyboardFocusIndex:s,focusTargets:r,focusSetByMouse:o,keyboardAddOpen:i,actionsMenuOpenForIndex:d,nsfwPreference:u,unblurredUris:f,setUnblurred:m,likeOverrides:p,setLikeOverrides:h,seenUris:g,openPostModal:y,cardRef:x,onMediaRef:_,onActionsMenuOpenChange:w,onMouseEnter:v,onAddClose:b}){return 0===e.length?a.jsx("div",{className:L.gridColumn,children:n&&null!=t&&a.jsx("div",{ref:t,className:L.loadMoreSentinel,"aria-hidden":!0})}):a.jsxs("div",{className:L.gridColumn,children:[e.map(({entry:e,originalIndex:t})=>{const n="post"===e.type?e.item.post.uri:e.items[0].post.uri;return a.jsx("div",{ref:x(t),className:L.gridItem,"data-selected":r[s]?.cardIndex===t||void 0,"data-post-uri":"post"===e.type?e.item.post.uri:e.items[0].post.uri,onMouseEnter:()=>v(t),children:"post"===e.type?a.jsx(Ne,{item:e.item,isSelected:r[s]?.cardIndex===t,focusedMediaIndex:r[s]?.cardIndex!==t||o&&c(e.item.post).length>1?void 0:r[s]?.mediaIndex,onMediaRef:(e,n)=>_(t,e,n),cardRef:()=>{},openAddDropdown:r[s]?.cardIndex===t&&i,onAddClose:b,onActionsMenuOpenChange:e=>w(t,e),cardIndex:t,actionsMenuOpenForIndex:d,onPostClick:(e,t)=>{t?.initialItem&&F(e,t.initialItem),y(e,t?.openReply)},fillCell:!1,nsfwBlurred:"blurred"===u&&l(e.item.post)&&!f.has(e.item.post.uri),onNsfwUnblur:()=>m(e.item.post.uri,!0),likedUriOverride:p[e.item.post.uri],onLikedChange:(e,t)=>h(e,t??null),seen:g.has(e.item.post.uri)}):a.jsx(De,{items:e.items,onPostClick:(e,t)=>{t?.initialItem&&F(e,t.initialItem),y(e)},cardRef:()=>{},seen:g.has(e.items[0].post.uri),"data-post-uri":e.items[0].post.uri})},n)}),n&&null!=t&&a.jsx("div",{ref:t,className:L.loadMoreSentinel,"aria-hidden":!0})]})}function He(e,t){switch(t.type){case"SET_ITEMS":return{...e,items:t.items,cursor:t.cursor,loading:!1,error:null};case"APPEND_ITEMS":return{...e,items:[...e.items,...t.items],cursor:t.cursor,loadingMore:!1,error:null};case"UPDATE_ITEMS":return{...e,items:t.updater(e.items)};case"SET_LOADING":return{...e,loading:t.loading};case"SET_LOADING_MORE":return{...e,loadingMore:t.loadingMore};case"SET_ERROR":return{...e,error:t.error,loading:!1,loadingMore:!1};case"SET_KEYBOARD_FOCUS":return{...e,keyboardFocusIndex:t.index};case"SET_ACTIONS_MENU_OPEN":return{...e,actionsMenuOpenForIndex:t.index};case"MARK_SEEN":{const n=new Set(e.seenUris);if(t.uris.forEach(e=>n.add(e)),n.size>2500){const t=Array.from(n),s=new Set(t.slice(-2e3));return{...e,seenUris:s}}return{...e,seenUris:n}}case"RESET_SEEN_SNAPSHOT":return{...e,seenUrisAtReset:new Set(e.seenUris)};case"CLEAR_SEEN":return{...e,seenUris:new Set,seenUrisAtReset:new Set};default:return e}}function Be(e){const t=new Set;return e.filter(e=>{const n=e?.post?.uri;return!(!n||t.has(n))&&(t.add(n),!0)})}const Ye="artsky-seen-posts";function $e(){const e=h.get(Ye);return e&&Array.isArray(e)?new Set(e):new Set}const ze=[{kind:"timeline",label:"Following"},{kind:"custom",label:"What's Hot",uri:"at://did:plc:z72i7hdynmk6r22z27h6tvur/app.bsky.feed.generator/whats-hot"}];function qe(e){if("undefined"==typeof window)return()=>{};const t=window.matchMedia("(min-width: 768px)");return t.addEventListener("change",e),()=>t.removeEventListener("change",e)}function Ke(){return"undefined"!=typeof window&&window.innerWidth>=768}function We(e){return"app.bsky.feed.defs#reasonRepost"===e.reason?.$type}function Ge(e){const t=e.post.record?.createdAt,n=e.post.indexedAt,s=t??n??"";return s?new Date(s).getTime():0}function Ve(e){const t=[];let n=0,s=[],r=0,o=0;function a(){if(s.length>=4)t.push({type:"carousel",items:[...s],entryIndex:n++});else for(const e of s)t.push({type:"post",item:e,entryIndex:n++});s=[]}for(const i of e){if(!We(i)){a(),t.push({type:"post",item:i,entryIndex:n++});continue}const e=Ge(i);if(0===s.length){s.push(i),r=e,o=e;continue}const l=Math.min(r,e),c=Math.max(o,e);c-l<=36e5?(s.push(i),r=l,o=c):(a(),s=[i],r=e,o=e)}return a(),t}function Je(e){if("carousel"===e.type)return 200;const t=i(e.item.post);return t?null!=t.aspectRatio&&t.aspectRatio>0?100+280/t.aspectRatio:320:180}function Xe(e,t){const n=Math.max(e.top,t.top),s=Math.min(e.bottom,t.bottom);return Math.max(0,s-n)}function Qe(){const t=M(),n=T(),r=k(),o=N.useSyncExternalStore(qe,Ke,()=>!1),{openLoginModal:S}=d(),{session:O}=u(),{viewMode:F}=f(),[U,H]=N.useState(ze[0]),[,B]=N.useState([]),{likeOverrides:Y,setLikeOverride:$}=m(),[z,q]=N.useReducer(He,{items:[],cursor:void 0,loading:!0,loadingMore:!1,error:null,keyboardFocusIndex:-1,actionsMenuOpenForIndex:null,seenUris:$e(),seenUrisAtReset:new Set}),K=N.useRef([]),W=N.useRef(!1),G=N.useRef(0),[V,J]=N.useState(!1),{openPostModal:X,isModalOpen:Q}=e(),Z=N.useRef([]),ee=N.useRef({}),te=N.useRef([]),ne=N.useRef(-1),se=N.useRef(null),re=N.useRef(-1),oe=N.useRef(!1),ae=N.useRef(!1),[ie,le]=N.useState(!1),[ce,de]=N.useState(!1),[ue,fe]=N.useState(null),me=N.useRef(null),pe=N.useRef(null),he=N.useRef(t.pathname),ge=N.useRef(z.seenUris);ge.current=z.seenUris;const ye=p(),[xe,_e]=N.useState(!1),we=N.useRef(null);N.useEffect(()=>{if(ye)return ye.setClearSeenHandler(()=>{requestAnimationFrame(()=>{h.remove(Ye),ge.current=new Set,q({type:"CLEAR_SEEN"})})}),()=>{ye.setClearSeenHandler(null)}},[ye]),N.useEffect(()=>{if(ye)return ye.setHomeClickHandler(()=>{requestAnimationFrame(()=>{window.scrollTo(0,0)})}),()=>{ye.setHomeClickHandler(null)}},[ye]),N.useEffect(()=>{if(ye)return ye.setHideSeenOnlyHandler(e=>{requestAnimationFrame(()=>{const t=ge.current.size;q({type:"RESET_SEEN_SNAPSHOT"}),e(0===t?"No read posts in feed":`${t} read posts hidden`)})}),()=>{ye.setHideSeenOnlyHandler(null)}},[ye]);const ve=N.useCallback(async()=>{if(O)try{const e=(await g()).filter(e=>"feed"===e.type&&e.pinned),t=await Promise.all(e.map(async e=>({kind:"custom",label:await y(e.value).catch(()=>e.value),uri:e.value})));B(t)}catch{B([])}else B([])},[O]);N.useEffect(()=>{ve()},[ve]),N.useEffect(()=>{let e;let t="undefined"!=typeof window?window.scrollY:0,n=t;const s=P(()=>{const s=window.scrollY,r=document.body.classList.contains("feed-scrolling"),o=s<n;if(n=s,o)return r&&(document.body.classList.remove("feed-scrolling"),e&&(clearTimeout(e),e=void 0)),void(t=s);r?(e&&clearTimeout(e),e=setTimeout(()=>{document.body.classList.remove("feed-scrolling"),t=window.scrollY,e=void 0},200)):s-t>=48&&(document.body.classList.add("feed-scrolling"),e&&clearTimeout(e),e=setTimeout(()=>{document.body.classList.remove("feed-scrolling"),t=window.scrollY,e=void 0},200))},16);return window.addEventListener("scroll",s,{passive:!0}),()=>{window.removeEventListener("scroll",s),e&&clearTimeout(e),document.body.classList.remove("feed-scrolling")}},[]),N.useEffect(()=>{const e=he.current!==t.pathname;he.current=t.pathname,"POP"!==r&&e&&window.scrollTo(0,0)},[t.pathname,r]),N.useEffect(()=>{const e=t.state?.feedSource;e&&(H(e),n(t.pathname,{replace:!0}))},[t.state,t.pathname,n]);const{entries:be,totalPercent:je}=x(),Ne=I(),Se=N.useRef(null),Me=N.useRef("unknown"),Te=N.useRef([]);Te.current=z.items;const ke=N.useCallback(async(e,t)=>{const n=Math.min(3,Math.max(1,"1"===F?1:"2"===F?2:3)),r=n>=2?10*n:30;if(!e&&window.scrollY>100)q({type:"SET_LOADING",loading:!1});else try{if(t?.aborted)return;if(q(e?{type:"SET_LOADING_MORE",loadingMore:!0}:{type:"SET_LOADING",loading:!0}),q({type:"SET_ERROR",error:null}),O){if(be.length>=2&&je>=99){const n=!!e;let s;if(n&&e)try{s=JSON.parse(e)}catch{s=void 0}const{feed:o,cursors:a}=await w(be.map(e=>({source:e.source,percent:e.percent})),r,s,t);if(t?.aborted)return;const i=()=>{const e=Be(n?[...Te.current,...o]:o),t=Object.keys(a).length>0?JSON.stringify(a):void 0;q(n?{type:"APPEND_ITEMS",items:o,cursor:t}:{type:"SET_ITEMS",items:e,cursor:t})};n?N.startTransition(i):i()}else if(1===be.length){const t=be[0].source;if("timeline"===t.kind){const t=await s.getTimeline({limit:r,cursor:e}),n=()=>{const n=Be(e?[...Te.current,...t.data.feed]:t.data.feed);q(e?{type:"APPEND_ITEMS",items:t.data.feed,cursor:t.data.cursor}:{type:"SET_ITEMS",items:n,cursor:t.data.cursor})};e?N.startTransition(n):n()}else if(t.uri){const n=await s.app.bsky.feed.getFeed({feed:t.uri,limit:r,cursor:e}),o=()=>{const t=Be(e?[...Te.current,...n.data.feed]:n.data.feed);q(e?{type:"APPEND_ITEMS",items:n.data.feed,cursor:n.data.cursor}:{type:"SET_ITEMS",items:t,cursor:n.data.cursor})};e?N.startTransition(o):o()}}else if("timeline"===U.kind){const t=await s.getTimeline({limit:r,cursor:e}),n=()=>{const n=Be(e?[...Te.current,...t.data.feed]:t.data.feed);q(e?{type:"APPEND_ITEMS",items:t.data.feed,cursor:t.data.cursor}:{type:"SET_ITEMS",items:n,cursor:t.data.cursor})};e?N.startTransition(n):n()}else if(U.uri){const t=await s.app.bsky.feed.getFeed({feed:U.uri,limit:r,cursor:e}),n=()=>{const n=Be(e?[...Te.current,...t.data.feed]:t.data.feed);q(e?{type:"APPEND_ITEMS",items:t.data.feed,cursor:t.data.cursor}:{type:"SET_ITEMS",items:n,cursor:t.data.cursor})};e?N.startTransition(n):n()}}else{const{feed:n,cursor:s}=await _(r,e);if(t?.aborted)return;const o=()=>{const t=Be(e?[...Te.current,...n]:n);q(e?{type:"APPEND_ITEMS",items:n,cursor:s}:{type:"SET_ITEMS",items:t,cursor:s})};e?N.startTransition(o):o()}}catch(o){const e=o instanceof Error?o.message:"Failed to load feed";q({type:"SET_ERROR",error:e})}finally{q({type:"SET_LOADING",loading:!1}),q({type:"SET_LOADING_MORE",loadingMore:!1})}},[U,O,be,je]);N.useEffect(()=>{const e=new AbortController;return ke(void 0,e.signal),()=>{e.abort()}},[ke]);W.current=z.loadingMore,N.useEffect(()=>{if(!z.cursor)return;const e=K.current;let t=0,n=0,s=0;const r=Math.min(3,Math.max(1,"1"===F?1:"2"===F?2:3)),o=()=>{clearTimeout(s);const t=Math.max(50,1800-(Date.now()-G.current)+50);s=window.setTimeout(()=>{W.current||(()=>{for(let t=0;t<r;t++){const n=e[t];if(n&&n.getBoundingClientRect().bottom<window.innerHeight)return!0}return!1})()&&(W.current=!0,G.current=Date.now(),ke(z.cursor))},t)},a=new IntersectionObserver(e=>{for(const s of e){if(!s.isIntersecting||W.current)continue;if(Date.now()-G.current<1800){o();continue}W.current=!0;const e=z.cursor;t=requestAnimationFrame(()=>{t=0,n=window.setTimeout(()=>{n=0,G.current=Date.now(),ke(e)},120)});break}},{rootMargin:"600px",threshold:0});for(let i=0;i<r;i++){const t=e[i];t&&a.observe(t)}return r>1&&o(),()=>{a.disconnect(),t&&cancelAnimationFrame(t),n&&clearTimeout(n),clearTimeout(s)}},[z.cursor,ke,F]);const{mediaMode:Ie}=v(),{nsfwPreference:Re,unblurredUris:Ae,setUnblurred:Ce}=b(),{hideRepostsFromDids:Oe}=E()??{hideRepostsFromDids:[]},Fe=N.useMemo(()=>z.items.filter(e=>"media"!==Ie||i(e.post)).filter(e=>!z.seenUrisAtReset.has(e.post.uri)).filter(e=>"sfw"!==Re||!l(e.post)).filter(e=>{if(!We(e))return!0;const t=e.reason?.by?.did;return!t||!Oe.includes(t)}),[z.items,Ie,z.seenUrisAtReset,Re,Oe]),Le=N.useMemo(()=>Ve(Fe),[Fe]),Pe=N.useMemo(()=>z.items.filter(e=>"media"!==Ie||i(e.post)).filter(e=>"sfw"!==Re||!l(e.post)),[z.items,Ie,Re]),De=0===Le.length&&Pe.length>0&&!z.cursor,Ge=0===Le.length&&null!=z.cursor,Qe=D(F,150),Ze=N.useRef([]),et=N.useRef(0),tt=N.useRef(0);N.useEffect(()=>{Ze.current=[],et.current=0,tt.current=0},[U,Ie,Re]);const nt=N.useMemo(()=>{Qe!==tt.current&&(Ze.current=[],et.current=0);const e=function(e,t,n,s){const r=Math.min(3,Math.max(1,Math.floor(t)));if(r<1)return[];if(n&&n.length===r&&void 0!==s&&e.length>s){const t=new Map;n.forEach((e,n)=>{e.forEach(({entry:e})=>{const s="post"===e.type?e.item.post.uri:e.items[0]?.post.uri;s&&t.set(s,n)})});const o=Array.from({length:r},()=>[]),a=Array(r).fill(0);for(let n=0;n<s;n++){const s=e[n],i="post"===s.type?s.item.post.uri:s.items[0]?.post.uri;if(i){const e=t.get(i);if(void 0!==e&&e<r){o[e].push({entry:s,originalIndex:n}),a[e]+=Je(s);continue}}const l=Je(s);let c=0;for(let e=1;e<r;e++)a[e]<a[c]&&(c=e);o[c].push({entry:s,originalIndex:n}),a[c]+=l}for(let n=s;n<e.length;n++){const t=e[n],s=Je(t);let i=0;for(let e=1;e<r;e++)a[e]<a[i]&&(i=e);o[i].push({entry:t,originalIndex:n}),a[i]+=s}return o}const o=Array.from({length:r},()=>[]),a=Array(r).fill(0);for(let i=0;i<e.length;i++){const t=e[i],n=Je(t),s=o.map(e=>e.length),l=0===s.length?0:Math.min(...s);let c=-1;for(let e=0;e<r;e++)o[e].length>l+1||(-1===c||a[e]<a[c]||a[e]===a[c]&&o[e].length<o[c].length)&&(c=e);-1===c&&(c=0),o[c].push({entry:t,originalIndex:i}),a[c]+=n}return o}(Le,Qe,Ze.current,et.current);return Ze.current=e,et.current=Le.length,tt.current=Qe,e},[Le,Qe]),st=N.useMemo(()=>{const e=[];return Le.forEach((t,n)=>{if("post"===t.type){const s="text"===Ie?1:Math.max(1,c(t.item.post).length);for(let t=0;t<s;t++)e.push({cardIndex:n,mediaIndex:t})}else e.push({cardIndex:n,mediaIndex:0})}),e},[Le,Ie]),rt=N.useMemo(()=>{const e=[];let t=0;return Le.forEach((n,s)=>{e[s]=t;const r=Le[s],o="post"===r.type?"text"===Ie?1:Math.max(1,c(r.item.post).length):1;t+=o}),e},[Le,Ie]),ot=N.useMemo(()=>{const e=[];return Le.forEach((t,n)=>{const s="post"===t.type?"text"===Ie?1:Math.max(1,c(t.item.post).length):1;e[n]=rt[n]+s-1}),e},[Le,rt,Ie]);te.current=Fe,ne.current=z.keyboardFocusIndex,se.current=z.actionsMenuOpenForIndex,N.useEffect(()=>{const e=z.keyboardFocusIndex;if(e<0)return;if(0===st.length)return void q({type:"SET_KEYBOARD_FOCUS",index:-1});const t=Math.min(e,st.length-1);t!==e&&q({type:"SET_KEYBOARD_FOCUS",index:t})},[st.length,z.keyboardFocusIndex]);const at=N.useMemo(()=>P(e=>function(e){const t=[...e],n=t.length>2e3?t.slice(-2e3):t;h.set(Ye,n)}(e),1e3),[]);N.useEffect(()=>{at(z.seenUris)},[z.seenUris,at]),N.useEffect(()=>{const e=new Set;let t=0,n=0;const s=new WeakSet,r=()=>{if(t=0,0===e.size)return;const s=Date.now();if(s-n<400)return void(t=requestAnimationFrame(r));n=s;const o=Array.from(e);e.clear(),N.startTransition(()=>{q({type:"MARK_SEEN",uris:o}),ge.current=new Set([...ge.current,...o])})},o=new IntersectionObserver(n=>{for(const t of n)if(!t.isIntersecting&&t.boundingClientRect.top<0){const n=t.target.getAttribute("data-post-uri");n&&!ge.current.has(n)&&e.add(n)}e.size>0&&!t&&(t=requestAnimationFrame(r))},{threshold:0,rootMargin:"0px"}),a=e=>{e instanceof HTMLElement&&e.hasAttribute("data-post-uri")&&!s.has(e)&&(o.observe(e),s.add(e))},i=we.current;if(i){i.querySelectorAll("[data-post-uri]").forEach(a);const e=new MutationObserver(e=>{for(const t of e)t.addedNodes.forEach(e=>{if(e instanceof HTMLElement){a(e);e.querySelectorAll("[data-post-uri]").forEach(a)}})});return e.observe(i,{childList:!0,subtree:!0}),()=>{o.disconnect(),e.disconnect(),t&&cancelAnimationFrame(t)}}return()=>{o.disconnect(),t&&cancelAnimationFrame(t)}},[Le.length]),N.useEffect(()=>{const e=()=>{ae.current=!0};return window.addEventListener("mousemove",e),()=>window.removeEventListener("mousemove",e)},[]),N.useEffect(()=>{if(!oe.current)return;if(oe.current=!1,z.keyboardFocusIndex===re.current)return;re.current=z.keyboardFocusIndex;const e=st[z.keyboardFocusIndex],t=requestAnimationFrame(()=>{const t=e?.cardIndex??z.keyboardFocusIndex,n=e?.mediaIndex??0,s=ee.current[t]?.[n],r=s??Z.current[t];r&&r.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})});return()=>cancelAnimationFrame(t)},[z.keyboardFocusIndex,st]),N.useEffect(()=>{const e=e=>{const n=/[?&](post|profile|tag|forumPost|artboard)=/.test(t.search);if(Q||n)return;const r=e.target;if("INPUT"===r.tagName||"TEXTAREA"===r.tagName||"SELECT"===r.tagName||r.isContentEditable)return void("Escape"===e.key&&(e.preventDefault(),r.blur()));if(e.ctrlKey||e.metaKey)return;const o=ne.current;if(0===Le.length||0===st.length)return;de(!1);const a=st[o],i=a?.cardIndex??0,l=Le[i],c="post"===l?.type?l.item:"carousel"===l?.type?l.items[0]:null,d=e.key.toLowerCase(),u=document.activeElement?.closest?.('[role="menu"]'),f=z.actionsMenuOpenForIndex===i;if((u||f)&&("w"===d||"s"===d||"e"===d||"enter"===d||"q"===d||"escape"===d))return;if(e.repeat&&("a"===d||"d"===d||"ArrowLeft"===e.key||"ArrowRight"===e.key))return;if(ue)return"escape"===d?(e.preventDefault(),void fe(null)):void 0;if("w"!==d&&"s"!==d&&"a"!==d&&"d"!==d&&"e"!==d&&"enter"!==d&&"r"!==d&&"f"!==d&&"c"!==d&&"h"!==d&&"b"!==d&&"m"!==d&&"`"!==d&&"4"!==d&&"ArrowUp"!==e.key&&"ArrowDown"!==e.key&&"ArrowLeft"!==e.key&&"ArrowRight"!==e.key||e.preventDefault(),"b"===d)return void(c?.post?.author&&O?.did!==c.post.author.did&&(fe({did:c.post.author.did,handle:c.post.author.handle??c.post.author.did,avatar:c.post.author.avatar}),requestAnimationFrame(()=>me.current?.focus())));const m=o<0,p=Qe>=2?nt:null,h=e=>Z.current[e]?.getBoundingClientRect();if("w"===d||"ArrowUp"===e.key){ae.current=!1,le(!0),oe.current=!0;const e=o===rt[i],t=m?ot[Le.length-1]??st.length-1:e?(()=>{const e=Qe>=2&&p?function(e,t){for(let n=0;n<e.length;n++){const s=e[n].findIndex(e=>e.originalIndex===t);if(s>0)return e[n][s-1].originalIndex;if(0===s)return t}return t}(p,i):Math.max(0,i-1);return ot[e]??rt[e]??0})():Math.max(0,o-1);return void q({type:"SET_KEYBOARD_FOCUS",index:t})}if("s"===d||"ArrowDown"===e.key){ae.current=!1,le(!0),oe.current=!0;const e=o===ot[i],t=m?0:e?(()=>{const e=Qe>=2&&p?function(e,t){for(let n=0;n<e.length;n++){const s=e[n].findIndex(e=>e.originalIndex===t);if(s>=0&&s<e[n].length-1)return e[n][s+1].originalIndex;if(s>=0)return t}return t}(p,i):Math.min(Le.length-1,i+1);return rt[e]??o})():Math.min(st.length-1,o+1);return void q({type:"SET_KEYBOARD_FOCUS",index:t})}if("a"===d||"ArrowLeft"===e.key){ae.current=!1,le(!0),oe.current=!0;const e=m?0:Qe>=2&&p?function(e,t,n){for(let s=0;s<e.length;s++){if(e[s].findIndex(e=>e.originalIndex===t)<0)continue;if(0===s)return t;const r=e[s-1],o=n(t);if(!o)return t;let a=t,i=-1;for(const{originalIndex:e}of r){const t=n(e);if(!t)continue;const s=Xe(o,t);s>0&&s>i&&(i=s,a=e)}return a}return t}(p,i,h):i,t=m?0:e!==i?ot[e]??o:o;return t!==o&&q({type:"SET_ACTIONS_MENU_OPEN",index:null}),void q({type:"SET_KEYBOARD_FOCUS",index:t})}if("d"===d||"ArrowRight"===e.key){ae.current=!1,le(!0),oe.current=!0;const e=m?0:Qe>=2&&p?function(e,t,n){for(let s=0;s<e.length;s++){if(e[s].findIndex(e=>e.originalIndex===t)<0)continue;if(s===e.length-1)return t;const r=e[s+1],o=n(t);if(!o)return t;let a=t,i=-1;for(const{originalIndex:e}of r){const t=n(e);if(!t)continue;const s=Xe(o,t);s>0&&s>i&&(i=s,a=e)}return a}return t}(p,i,h):i,t=m?0:e!==i?ot[e]??o:o;return t!==o&&q({type:"SET_ACTIONS_MENU_OPEN",index:null}),void q({type:"SET_KEYBOARD_FOCUS",index:t})}if(("m"===d||"`"===d)&&o>=0)q(f?{type:"SET_ACTIONS_MENU_OPEN",index:null}:{type:"SET_ACTIONS_MENU_OPEN",index:i});else if("e"!==d&&"enter"!==d)if("r"!==d){if("f"===d){const e=c;if(!e?.post?.uri||!e?.post?.cid)return;const t=e.post.uri,n=t in Y?Y[t]??void 0:e.post.viewer?.like;return void(n?s.deleteLike(n).then(()=>{$(t,null)}).catch(()=>{}):s.like(t,e.post.cid).then(e=>{$(t,e.uri)}).catch(()=>{}))}if("c"!==d){if("4"===d){const e=c?.post?.author,t=c?.post?.uri;if(e&&O?.did&&O.did!==e.did&&t){const n=e.viewer?.following;n?s.deleteFollow(n).then(()=>{q({type:"UPDATE_ITEMS",updater:e=>e.map(e=>{if(e.post.uri!==t)return e;const n=e.post,s=n.author;return{...e,post:{...n,author:{...s,viewer:{...s.viewer,following:void 0}}}}})})}).catch(()=>{}):s.follow(e.did).then(e=>{q({type:"UPDATE_ITEMS",updater:n=>n.map(n=>{if(n.post.uri!==t)return n;const s=n.post,r=s.author;return{...n,post:{...s,author:{...r,viewer:{...r.viewer,following:e.uri}}}}})})}).catch(()=>{})}}}else J(!0)}else c&&X(c.post.uri,!0);else c&&X(c.post.uri)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[t.search,Qe,Q,X,ue,O,Y,z.actionsMenuOpenForIndex,st,rt,ot]),N.useEffect(()=>{ue&&me.current?.focus()},[ue]);const it=N.useRef(null),lt=N.useContext(R),ct=C({scrollRef:{current:null},touchTargetRef:lt?.wrapperRef??it,onRefresh:async()=>{await ke(),requestAnimationFrame(()=>{window.scrollTo(0,0)})},enabled:o,maxTouchStartY:130}),dt=!!Ne&&1===be.length&&Ne.feedSources.length>1,ut=N.useCallback(e=>{ct.onTouchStart(e),dt&&1===e.touches.length&&(Se.current={x:e.touches[0].clientX,y:e.touches[0].clientY},Me.current="unknown")},[dt,ct]),ft=N.useCallback(e=>{if(dt&&Se.current&&1===e.touches.length){if("unknown"===Me.current){const t=e.touches[0].clientX-Se.current.x,n=e.touches[0].clientY-Se.current.y;(Math.abs(t)>20||Math.abs(n)>20)&&(Me.current=Math.abs(t)>2*Math.abs(n)?"swipe":"pull")}"pull"!==Me.current&&"unknown"!==Me.current||ct.onTouchMove(e)}else ct.onTouchMove(e)},[dt,ct]),mt=N.useCallback(e=>{if(dt&&Ne&&Se.current&&1===e.changedTouches.length){const t=e.changedTouches[0].clientX-Se.current.x,n=e.changedTouches[0].clientY-Se.current.y;if("swipe"===Me.current&&Math.abs(t)>80&&Math.abs(t)>2*Math.abs(n)){const e=Ne.feedSources,n=be[0].source,s=e.findIndex(e=>{return s=n,((t=e).uri??t.label)===(s.uri??s.label);var t,s});if(s>=0){const n=t<0?(s+1)%e.length:(s-1+e.length)%e.length;Ne.setSingleFeed(e[n])}}Se.current=null,Me.current="unknown"}ct.onTouchEnd(e)},[dt,Ne,be,ct]);N.useEffect(()=>{const e=lt?.setHandlers;if(e)return e({onTouchStart:ut,onTouchMove:ft,onTouchEnd:mt}),()=>{e(null)}},[lt?.setHandlers,ut,ft,mt]);const pt=!!lt?.wrapperRef;return a.jsx(A,{title:"Feed",showNav:!0,children:a.jsxs(a.Fragment,{children:[a.jsxs("div",{ref:it,className:L.wrap,onTouchStart:pt?void 0:ut,onTouchMove:pt?void 0:ft,onTouchEnd:pt?void 0:mt,children:[a.jsx("div",{className:`${L.pullRefreshHeader} ${ct.pullDistance>0||ct.isRefreshing?L.pullRefreshHeaderActive:""}`,"aria-hidden":0===ct.pullDistance&&!ct.isRefreshing,"aria-live":"polite","aria-label":ct.isRefreshing?"Refreshing":void 0,children:(ct.pullDistance>0||ct.isRefreshing)&&a.jsx("div",{className:L.pullRefreshSpinner})}),a.jsxs("div",{className:L.pullRefreshContent,style:{transform:`translateY(${ct.pullDistance}px)`},children:[O&&a.jsxs("div",{className:L.suggestedFollowsSection,children:[a.jsx("div",{className:L.suggestedFollowsSectionInner,children:a.jsx("button",{type:"button",className:L.suggestedFollowsToggle,onClick:()=>_e(e=>!e),"aria-expanded":xe,"aria-label":xe?"Hide suggestions":"Discover accounts to follow",children:xe?"Hide suggestions":"Discover accounts"})}),xe&&a.jsx(Ee,{})]}),a.jsxs("div",{className:L.feedContentTransition,children:[z.error&&a.jsx("p",{className:L.error,children:z.error}),z.loading?a.jsx("div",{className:L.loading,children:"Loading…"}):0===Le.length?a.jsx("div",{className:L.empty,children:Ge?a.jsxs(a.Fragment,{children:[a.jsx("p",{className:L.emptyLoadMoreText,children:Pe.length>0?"You've seen everything visible from this batch. There may be more from your other feeds.":"No posts in this batch."}),a.jsx("button",{type:"button",className:L.loadMoreBtn,onClick:()=>z.cursor&&!z.loadingMore&&ke(z.cursor),disabled:z.loadingMore,children:z.loadingMore?"Loading…":"Load more"})]}):De?a.jsxs(a.Fragment,{children:["You've read all the posts in this feed.",a.jsx("br",{}),"New posts will appear as they're posted."]}):"media"===Ie?"No posts with images or videos in this feed.":"No posts in this feed."}):a.jsxs(a.Fragment,{children:[a.jsx("div",{ref:we,className:`${L.gridColumns} ${L[`gridView${F}`]}`,"data-feed-cards":!0,"data-view-mode":F,"data-keyboard-nav":ie||void 0,onMouseLeave:o&&!Q?()=>q({type:"SET_KEYBOARD_FOCUS",index:-1}):void 0,children:nt.map((e,t)=>a.jsx(Ue,{column:e,colIndex:t,loadMoreSentinelRef:z.cursor?e=>{K.current[t]=e}:void 0,hasCursor:!!z.cursor,keyboardFocusIndex:z.keyboardFocusIndex,focusTargets:st,firstFocusIndexForCard:rt,focusSetByMouse:ce,keyboardAddOpen:V,actionsMenuOpenForIndex:z.actionsMenuOpenForIndex,nsfwPreference:Re,unblurredUris:Ae,setUnblurred:Ce,likeOverrides:Y,setLikeOverrides:$,seenUris:z.seenUris,openPostModal:X,cardRef:e=>t=>{Z.current[e]=t},onMediaRef:(e,t,n)=>{ee.current[e]||(ee.current[e]={}),ee.current[e][t]=n},onActionsMenuOpenChange:(e,t)=>q({type:"SET_ACTIONS_MENU_OPEN",index:t?e:null}),onMouseEnter:e=>{o&&ae.current&&(ae.current=!1,le(!1),de(!0),q({type:"SET_KEYBOARD_FOCUS",index:rt[e]??0}))},onAddClose:()=>J(!1)},`${t}-${e.length}`))}),O&&a.jsxs("div",{className:L.loadMoreRow,children:[z.loadingMore&&a.jsx("p",{className:L.loadingMore,role:"status",children:"Loading more…"}),a.jsx("button",{type:"button",className:L.loadMoreBtn,onClick:()=>z.cursor&&!z.loadingMore&&ke(z.cursor),disabled:z.loadingMore||!z.cursor,children:z.cursor?"Load more":"No more posts"})]})]})]},1===be.length?be[0].source.uri??be[0].source.label:"mixed"),!O&&a.jsxs("div",{className:L.feedLoginHint,children:[a.jsx("div",{className:L.feedLoginHintBtnRow,children:a.jsx("button",{type:"button",className:L.feedLoginHintBtn,onClick:()=>S(),children:"Log in"})}),a.jsxs("p",{className:L.feedLoginHintText,children:["Or"," ",a.jsx("button",{type:"button",className:L.feedLoginHintLink,onClick:()=>S("create"),children:"create an account"})," to see your own feeds."]})]})]})]}),ue&&a.jsx("div",{className:L.blockOverlay,role:"dialog","aria-modal":"true","aria-labelledby":"block-dialog-title",onKeyDown:e=>"Escape"===e.key&&fe(null),onClick:()=>fe(null),children:a.jsxs("div",{className:L.blockDialog,onClick:e=>e.stopPropagation(),children:[a.jsx("h2",{id:"block-dialog-title",className:L.blockTitle,children:"Block user?"}),a.jsxs("div",{className:L.blockUser,children:[ue.avatar?a.jsx("img",{src:ue.avatar,alt:"",className:L.blockAvatar,loading:"lazy"}):a.jsx("div",{className:L.blockAvatarPlaceholder}),a.jsxs("span",{className:L.blockHandle,children:["@",ue.handle]})]}),a.jsxs("div",{className:L.blockActions,children:[a.jsx("button",{ref:me,type:"button",className:L.blockCancelBtn,onClick:()=>fe(null),children:"Cancel"}),a.jsx("button",{ref:pe,type:"button",className:L.blockConfirmBtn,onClick:async()=>{if(ue)try{await j(ue.did),fe(null)}catch(e){}},children:"Block"})]})]})})]})})}export{Ve as buildDisplayEntries,Qe as default};
