import{l as e,ad as t,x as r,j as n,ae as s,k as i,u as o,av as a,ag as l,e as c,i as u,b as d}from"./index-BXBIaIN_.js";import{h,b as f}from"./react-vendor-DGaPsC2e.js";import{P as m}from"./ProfileColumn-v6J4Wnog.js";import{A as g}from"./AppModal-3LvZLydf.js";import{u as x}from"./ModalTopBarSlotContext-XWKZv5-E.js";import{s as p,b as j,a as w,E as y,C as b,c as k,d as v}from"./Icons-psAHoCnZ.js";import{u as C}from"./ModalScrollContext-CNWnUaKs.js";import{s as M}from"./TagPage.module-BpGvzkuE.js";import{s as S}from"./FeedPage.module-DHdPJV-V.js";import"./atproto-3-1TCh3S.js";import"./PostCard-DFZPqraO.js";import"./PostActionsMenu-BMUSZoZl.js";import"./artboards-DNvSVVrd.js";import"./artboardsPds-DWUixJ9h.js";import"./PostText-CYuGKBer.js";import"./postCache-CTqU0alO.js";import"./usePullToRefresh-DVlCPYCP.js";function B({mode:e}){return"open"===e?n.jsx(j,{size:24}):"half"===e?n.jsx(w,{size:24}):n.jsx(y,{size:24})}function _({mode:e}){return"default"===e?n.jsx(b,{size:20}):"minimalist"===e?n.jsx(k,{size:20}):n.jsx(v,{size:20})}function A(){return n.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:n.jsx("rect",{x:"7",y:"3",width:"10",height:"18",rx:"1"})})}function N(){return n.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:[n.jsx("rect",{x:"3",y:"3",width:"8",height:"18",rx:"1"}),n.jsx("rect",{x:"13",y:"3",width:"8",height:"18",rx:"1"})]})}function R(){return n.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:[n.jsx("rect",{x:"2",y:"3",width:"5",height:"18",rx:"1"}),n.jsx("rect",{x:"9.5",y:"3",width:"5",height:"18",rx:"1"}),n.jsx("rect",{x:"17",y:"3",width:"5",height:"18",rx:"1"})]})}function I({centerContent:i}){const o=x(),{viewMode:a,cycleViewMode:l}=e(),{cardViewMode:c,cycleCardView:u}=t(),{nsfwPreference:d,cycleNsfwPreference:f}=r(),m=o?.centerSlot??null,g=o?.rightSlot??null;return n.jsxs(n.Fragment,{children:[m&&null!=i?h.createPortal(i,m):null,g?h.createPortal(n.jsxs(n.Fragment,{children:[n.jsx("button",{type:"button",className:`${p.headerBtn} ${"sfw"!==d?p.headerBtnActive:""}`,onClick:e=>f(e.currentTarget),title:`${d}. Click to cycle: SFW → Blurred → NSFW`,"aria-label":`NSFW filter: ${d}`,children:n.jsx(B,{mode:"sfw"===d?"closed":"blurred"===d?"half":"open"})}),n.jsxs("button",{type:"button",className:p.headerBtn,onClick:e=>l(e.currentTarget),title:`${s[a]}. Click to cycle.`,"aria-label":`${s[a]}. Click to cycle.`,children:["1"===a&&n.jsx(A,{}),"2"===a&&n.jsx(N,{}),"3"===a&&n.jsx(R,{})]}),n.jsx("button",{type:"button",className:`${p.headerBtn} ${"default"!==c?p.headerBtnActive:""}`,onClick:e=>u(e.currentTarget),"aria-label":"default"===c?"Show all":"minimalist"===c?"Minimalist":"Art only",title:"default"===c?"Show all":"minimalist"===c?"Minimalist":"Art only",children:n.jsx(_,{mode:"default"===c?"default":"minimalist"===c?"minimalist":"artOnly"})})]}),g):null]})}const P="_searchQueryCenter_1i1b0_2",E="_searchBlogsSection_1i1b0_14",L="_searchBlogsTitle_1i1b0_18",T="_searchBlogsLoading_1i1b0_26",F="_searchBlogsScroll_1i1b0_32",$="_searchBlogCard_1i1b0_40",U="_searchBlogCardTitle_1i1b0_60",z="_searchBlogCardMeta_1i1b0_70",O="_searchBlogCardPreview_1i1b0_76";function W(e){return{post:e}}function q(e){const t=c(e.post);return t?null!=t.aspectRatio&&t.aspectRatio>0?100+280/t.aspectRatio:320:180}function V(e,t){const r=Math.min(3,Math.max(1,Math.floor(t)));if(r<1)return[];const n=Array.from({length:r},()=>[]),s=Array(r).fill(0);for(let i=0;i<e.length;i++){const t=e[i],o=q(t),a=n.map(e=>e.length),l=0===a.length?0:Math.min(...a);let c=-1;for(let e=0;e<r;e++)n[e].length>l+1||(-1===c||s[e]<s[c]||s[e]===s[c]&&n[e].length<n[c].length)&&(c=e);-1===c&&(c=0),n[c].push({item:t,originalIndex:i}),s[c]+=o}return n}function D({query:t,onRegisterRefresh:s}){const{session:h}=i(),{viewMode:g}=e(),{openPostModal:x,openForumPostModal:p}=o(),[j,w]=f.useState([]),[y,b]=f.useState(),[k,v]=f.useState(!0),[B,_]=f.useState(!1),[A,N]=f.useState([]),[R,I]=f.useState(!1),[P,q]=f.useState(null),[D,H]=f.useState(0),[G,K]=f.useState(!1),[Q,X]=f.useState({}),J=f.useRef([]),Y=f.useRef([]),Z=f.useRef(!1),ee=f.useRef(0),te=f.useRef([]),re=f.useRef(!1),ne=f.useRef(-1),se=C(),ie=f.useCallback(async e=>{if(t.trim())try{e?_(!0):v(!0),q(null);const{posts:r,cursor:n}=await a(t.trim(),e),s=r.map(W);w(t=>e?[...t,...s]:s),b(n)}catch(r){const e=r instanceof Error?r.message:"Search failed";q("Failed to fetch"===e?"Search couldn’t be completed. Check your connection or try again.":e)}finally{v(!1),_(!1)}},[t]),oe=f.useCallback(async()=>{if(t.trim()&&h?.did){I(!0);try{const e=await l(t.trim(),12);N(e)}catch{N([])}finally{I(!1)}}},[t,h?.did]);f.useEffect(()=>{t.trim()?(w([]),b(void 0),ie(),h?.did?oe():N([])):N([])},[t,ie,oe,h?.did]),f.useEffect(()=>{s?.(async()=>{await ie(),await oe()})},[s,ie,oe]),Z.current=B,f.useEffect(()=>{if(!y)return;const e=Y.current,t="1"===g?1:"2"===g?2:3,r=e[0]?.closest("[data-modal-scroll]")??void 0;let n=0;const s=new IntersectionObserver(e=>{for(const t of e)if(t.isIntersecting&&!Z.current){Z.current=!0,ie(y);break}},{root:r,rootMargin:"600px",threshold:0});for(let i=0;i<t;i++){const t=e[i];t&&s.observe(t)}return t>1&&(n=window.setTimeout(()=>{if(Z.current)return;const n=r?r.getBoundingClientRect().bottom:window.innerHeight;for(let r=0;r<t;r++){const t=e[r];if(t&&t.getBoundingClientRect().bottom<n)return Z.current=!0,void ie(y)}},200)),()=>{s.disconnect(),clearTimeout(n)}},[y,ie,g]);const{nsfwPreference:ae,unblurredUris:le,setUnblurred:ce}=r(),ue=j.filter(e=>c(e.post)).filter(e=>"sfw"!==ae||!u(e.post)),de="1"===g?1:"2"===g?2:3;if(te.current=ue,ee.current=D,f.useEffect(()=>{H(e=>ue.length?Math.min(e,ue.length-1):0)},[ue.length]),f.useEffect(()=>{if(!re.current)return;if(re.current=!1,D===ne.current)return;ne.current=D;const e=D,t=requestAnimationFrame(()=>{const t=J.current[e];t&&t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})});return()=>cancelAnimationFrame(t)},[D]),f.useEffect(()=>{const e=e=>{const t=e.target;if("INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName||t.isContentEditable)return void("Escape"===e.key&&(e.preventDefault(),t.blur()));if(e.ctrlKey||e.metaKey)return;if(0===ue.length)return;const r=te.current,n=ee.current,s=V(r,de),i=e.key.toLowerCase();if("w"!==i&&"s"!==i&&"a"!==i&&"d"!==i&&"e"!==i&&"enter"!==i&&"f"!==i&&"c"!==i&&"ArrowUp"!==e.key&&"ArrowDown"!==e.key&&"ArrowLeft"!==e.key&&"ArrowRight"!==e.key||e.preventDefault(),"w"===i||"ArrowUp"===e.key)return re.current=!0,void H(e=>de>=2?function(e,t){for(let r=0;r<e.length;r++){const n=e[r].findIndex(e=>e.originalIndex===t);if(n>0)return e[r][n-1].originalIndex;if(0===n)return t}return t}(s,e):Math.max(0,e-1));if("s"===i||"ArrowDown"===e.key)return re.current=!0,void H(e=>de>=2?function(e,t){for(let r=0;r<e.length;r++){const n=e[r].findIndex(e=>e.originalIndex===t);if(n>=0&&n<e[r].length-1)return e[r][n+1].originalIndex;if(n===e[r].length-1)return t}return t}(s,e):Math.min(r.length-1,e+1));if("a"===i||"ArrowLeft"===e.key)return re.current=!0,void H(e=>de>=2?function(e,t){for(let r=0;r<e.length;r++){const n=e[r].findIndex(e=>e.originalIndex===t);if(n>=0&&r>0)return e[r-1][Math.min(n,e[r-1].length-1)].originalIndex}return t}(s,e):Math.max(0,e-1));if("d"===i||"ArrowRight"===e.key)return re.current=!0,void H(e=>de>=2?function(e,t){for(let r=0;r<e.length;r++){const n=e[r].findIndex(e=>e.originalIndex===t);if(n>=0&&r<e.length-1)return e[r+1][Math.min(n,e[r+1].length-1)].originalIndex}return t}(s,e):Math.min(r.length-1,e+1));if("e"===i||"enter"===i){const e=r[n];return void(e&&x(e.post.uri))}if("f"===i&&h){const e=r[n];if(!e?.post?.uri||!e?.post?.cid)return;const t=e.post.uri,s=t in Q?Q[t]??void 0:e.post.viewer?.like;return void(s?d.deleteLike(s).then(()=>{X(e=>({...e,[t]:null}))}).catch(()=>{}):d.like(t,e.post.cid).then(e=>{X(r=>({...r,[t]:e.uri}))}).catch(()=>{}))}"c"===i&&K(!0)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[ue.length,de,x,Q,h]),!t.trim())return null;const he=h&&(R||A.length>0);return n.jsxs("div",{className:M.wrap,children:[P&&n.jsx("p",{className:M.error,children:P}),he&&n.jsxs("section",{className:E,"aria-label":"Blogs (standard.site)",children:[n.jsx("h3",{className:L,children:"Blogs"}),R?n.jsx("p",{className:T,children:"Searching blogs…"}):0===A.length?null:n.jsx("div",{className:F,children:A.map(e=>{const t=e.authorHandle??e.did,r=e.title||e.path||"Untitled",s=(e.body??"").replace(/\s+/g," ").trim().slice(0,72);return n.jsxs("button",{type:"button",className:$,onClick:()=>p(e.uri),children:[n.jsx("span",{className:U,children:r}),n.jsxs("span",{className:z,children:["@",t]}),s&&n.jsxs("span",{className:O,children:[s,s.length>=72?"…":""]})]},e.uri)})})]}),k?n.jsx("div",{className:M.loading,children:"Loading…"}):0===ue.length?n.jsx("div",{className:M.empty,children:"No posts found for this search."}):n.jsx("div",{className:`${S.gridColumns} ${S[`gridView${g}`]}`,"data-view-mode":g,children:V(ue,de).map((e,t)=>n.jsx(m,{column:e,colIndex:t,scrollRef:se,loadMoreSentinelRef:y?e=>{Y.current[t]=e}:void 0,hasCursor:!!y,keyboardFocusIndex:D,keyboardAddOpen:G,actionsMenuOpenForIndex:null,nsfwPreference:ae,unblurredUris:le,setUnblurred:ce,likeOverrides:Q,setLikeOverrides:X,openPostModal:e=>x(e),cardRef:e=>t=>{J.current[e]=t},onActionsMenuOpenChange:()=>{},onMouseEnter:e=>H(e),onAddClose:()=>K(!1),constrainMediaHeight:1===de,isSelected:e=>e===D},t))})]})}function H({query:e,onClose:t,onBack:r,canGoBack:s}){const[i,o]=f.useState(null);return n.jsxs(g,{ariaLabel:`Search: ${e}`,onClose:t,onBack:r,canGoBack:s,onPullToRefresh:i?()=>i():void 0,children:[n.jsx(I,{centerContent:n.jsxs("span",{className:P,title:e.trim(),children:['"',e.trim(),'"']})}),n.jsx(D,{query:e,onRegisterRefresh:e=>o(()=>e)})]})}export{H as default};
