import{l as e,ad as t,w as r,j as n,ae as o,k as i,u as s,av as a,e as l,i as c,b as u}from"./index-Cixw3jdx.js";import{a as d,r as f}from"./react-vendor-rw3WIpbI.js";import{V as h}from"./VirtualizedProfileColumn-TmDuIFYA.js";import{A as m}from"./AppModal-sATWv0fJ.js";import{u as g}from"./ModalTopBarSlotContext-BCMHq62N.js";import{s as x,b as p,a as j,E as w,C as y,c as k,d as v}from"./Icons-D4yuh_Fp.js";import{u as C}from"./ModalScrollContext-CW_VbNex.js";import{s as b}from"./TagPage.module-BpGvzkuE.js";import{s as M}from"./FeedPage.module-BXQsl3XB.js";import"./atproto-JNpM3I1p.js";import"./virtual-SmD9oKU4.js";import"./PostCard-CbGLg3rD.js";import"./PostActionsMenu-4D4JLWpJ.js";import"./date-Ct-NsrQr.js";import"./artboards-DNvSVVrd.js";import"./artboardsPds-DWUixJ9h.js";import"./PostText-0G7hlYgr.js";import"./postCache-CTqU0alO.js";import"./usePullToRefresh-QiYvLiof.js";function A({mode:e}){return"open"===e?n.jsx(p,{size:24}):"half"===e?n.jsx(j,{size:24}):n.jsx(w,{size:24})}function R({mode:e}){return"default"===e?n.jsx(y,{size:20}):"minimalist"===e?n.jsx(k,{size:20}):n.jsx(v,{size:20})}function S(){return n.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:n.jsx("rect",{x:"7",y:"3",width:"10",height:"18",rx:"1"})})}function I(){return n.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:[n.jsx("rect",{x:"3",y:"3",width:"8",height:"18",rx:"1"}),n.jsx("rect",{x:"13",y:"3",width:"8",height:"18",rx:"1"})]})}function E(){return n.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:[n.jsx("rect",{x:"2",y:"3",width:"5",height:"18",rx:"1"}),n.jsx("rect",{x:"9.5",y:"3",width:"5",height:"18",rx:"1"}),n.jsx("rect",{x:"17",y:"3",width:"5",height:"18",rx:"1"})]})}function P({centerContent:i}){const s=g(),{viewMode:a,cycleViewMode:l}=e(),{cardViewMode:c,cycleCardView:u}=t(),{nsfwPreference:f,cycleNsfwPreference:h}=r(),m=s?.centerSlot??null,p=s?.rightSlot??null;return n.jsxs(n.Fragment,{children:[m&&null!=i?d.createPortal(i,m):null,p?d.createPortal(n.jsxs(n.Fragment,{children:[n.jsx("button",{type:"button",className:`${x.headerBtn} ${"sfw"!==f?x.headerBtnActive:""}`,onClick:e=>h(e.currentTarget),title:`${f}. Click to cycle: SFW → Blurred → NSFW`,"aria-label":`NSFW filter: ${f}`,children:n.jsx(A,{mode:"sfw"===f?"closed":"blurred"===f?"half":"open"})}),n.jsxs("button",{type:"button",className:x.headerBtn,onClick:e=>l(e.currentTarget),title:`${o[a]}. Click to cycle.`,"aria-label":`${o[a]}. Click to cycle.`,children:["1"===a&&n.jsx(S,{}),"2"===a&&n.jsx(I,{}),"3"===a&&n.jsx(E,{})]}),n.jsx("button",{type:"button",className:`${x.headerBtn} ${"default"!==c?x.headerBtnActive:""}`,onClick:e=>u(e.currentTarget),"aria-label":"default"===c?"Show all":"minimalist"===c?"Minimalist":"Art only",title:"default"===c?"Show all":"minimalist"===c?"Minimalist":"Art only",children:n.jsx(R,{mode:"default"===c?"default":"minimalist"===c?"minimalist":"artOnly"})})]}),p):null]})}const B="_searchQueryCenter_1r4a6_2";function N(e){return{post:e}}function L(e){const t=l(e.post);return t?null!=t.aspectRatio&&t.aspectRatio>0?100+280/t.aspectRatio:320:180}function T(e,t){const r=Math.min(3,Math.max(1,Math.floor(t)));if(r<1)return[];const n=Array.from({length:r},()=>[]),o=Array(r).fill(0);for(let i=0;i<e.length;i++){const t=e[i],s=L(t),a=n.map(e=>e.length),l=0===a.length?0:Math.min(...a);let c=-1;for(let e=0;e<r;e++)n[e].length>l+1||(-1===c||o[e]<o[c]||o[e]===o[c]&&n[e].length<n[c].length)&&(c=e);-1===c&&(c=0),n[c].push({item:t,originalIndex:i}),o[c]+=s}return n}function $({query:t,onRegisterRefresh:o}){const{session:d}=i(),{viewMode:m}=e(),{openPostModal:g}=s(),[x,p]=f.useState([]),[j,w]=f.useState(),[y,k]=f.useState(!0),[v,A]=f.useState(!1),[R,S]=f.useState(null),[I,E]=f.useState(0),[P,B]=f.useState(!1),[L,$]=f.useState({}),F=f.useRef([]),z=f.useRef([]),O=f.useRef(!1),U=f.useRef(0),V=f.useRef([]),W=f.useRef(!1),q=f.useRef(-1),D=C(),_=f.useCallback(async e=>{if(t.trim())try{e?A(!0):k(!0),S(null);const{posts:r,cursor:n}=await a(t.trim(),e),o=r.map(N);p(t=>e?[...t,...o]:o),w(n)}catch(r){const e=r instanceof Error?r.message:"Search failed";S("Failed to fetch"===e?"Search couldn’t be completed. Check your connection or try again.":e)}finally{k(!1),A(!1)}},[t]);f.useEffect(()=>{t.trim()&&(p([]),w(void 0),_())},[t,_]),f.useEffect(()=>{o?.(()=>_())},[o,_]),O.current=v,f.useEffect(()=>{if(!j)return;const e=z.current,t="1"===m?1:"2"===m?2:3,r=e[0]?.closest("[data-modal-scroll]")??void 0;let n=0;const o=new IntersectionObserver(e=>{for(const t of e)if(t.isIntersecting&&!O.current){O.current=!0,_(j);break}},{root:r,rootMargin:"600px",threshold:0});for(let i=0;i<t;i++){const t=e[i];t&&o.observe(t)}return t>1&&(n=window.setTimeout(()=>{if(O.current)return;const n=r?r.getBoundingClientRect().bottom:window.innerHeight;for(let r=0;r<t;r++){const t=e[r];if(t&&t.getBoundingClientRect().bottom<n)return O.current=!0,void _(j)}},200)),()=>{o.disconnect(),clearTimeout(n)}},[j,_,m]);const{nsfwPreference:G,unblurredUris:H,setUnblurred:K}=r(),Q=x.filter(e=>l(e.post)).filter(e=>"sfw"!==G||!c(e.post)),X="1"===m?1:"2"===m?2:3;return V.current=Q,U.current=I,f.useEffect(()=>{E(e=>Q.length?Math.min(e,Q.length-1):0)},[Q.length]),f.useEffect(()=>{if(!W.current)return;if(W.current=!1,I===q.current)return;q.current=I;const e=I,t=requestAnimationFrame(()=>{const t=F.current[e];t&&t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})});return()=>cancelAnimationFrame(t)},[I]),f.useEffect(()=>{const e=e=>{const t=e.target;if("INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName||t.isContentEditable)return void("Escape"===e.key&&(e.preventDefault(),t.blur()));if(e.ctrlKey||e.metaKey)return;if(0===Q.length)return;const r=V.current,n=U.current,o=T(r,X),i=e.key.toLowerCase();if("w"!==i&&"s"!==i&&"a"!==i&&"d"!==i&&"e"!==i&&"enter"!==i&&"f"!==i&&"c"!==i&&"ArrowUp"!==e.key&&"ArrowDown"!==e.key&&"ArrowLeft"!==e.key&&"ArrowRight"!==e.key||e.preventDefault(),"w"===i||"ArrowUp"===e.key)return W.current=!0,void E(e=>X>=2?function(e,t){for(let r=0;r<e.length;r++){const n=e[r].findIndex(e=>e.originalIndex===t);if(n>0)return e[r][n-1].originalIndex;if(0===n)return t}return t}(o,e):Math.max(0,e-1));if("s"===i||"ArrowDown"===e.key)return W.current=!0,void E(e=>X>=2?function(e,t){for(let r=0;r<e.length;r++){const n=e[r].findIndex(e=>e.originalIndex===t);if(n>=0&&n<e[r].length-1)return e[r][n+1].originalIndex;if(n===e[r].length-1)return t}return t}(o,e):Math.min(r.length-1,e+1));if("a"===i||"ArrowLeft"===e.key)return W.current=!0,void E(e=>X>=2?function(e,t){for(let r=0;r<e.length;r++){const n=e[r].findIndex(e=>e.originalIndex===t);if(n>=0&&r>0)return e[r-1][Math.min(n,e[r-1].length-1)].originalIndex}return t}(o,e):Math.max(0,e-1));if("d"===i||"ArrowRight"===e.key)return W.current=!0,void E(e=>X>=2?function(e,t){for(let r=0;r<e.length;r++){const n=e[r].findIndex(e=>e.originalIndex===t);if(n>=0&&r<e.length-1)return e[r+1][Math.min(n,e[r+1].length-1)].originalIndex}return t}(o,e):Math.min(r.length-1,e+1));if("e"===i||"enter"===i){const e=r[n];return void(e&&g(e.post.uri))}if("f"===i&&d){const e=r[n];if(!e?.post?.uri||!e?.post?.cid)return;const t=e.post.uri,o=t in L?L[t]??void 0:e.post.viewer?.like;return void(o?u.deleteLike(o).then(()=>{$(e=>({...e,[t]:null}))}).catch(()=>{}):u.like(t,e.post.cid).then(e=>{$(r=>({...r,[t]:e.uri}))}).catch(()=>{}))}"c"===i&&B(!0)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[Q.length,X,g,L,d]),t.trim()?n.jsxs("div",{className:b.wrap,children:[R&&n.jsx("p",{className:b.error,children:R}),y?n.jsx("div",{className:b.loading,children:"Loading…"}):0===Q.length?n.jsx("div",{className:b.empty,children:"No posts found for this search."}):n.jsx("div",{className:`${M.gridColumns} ${M[`gridView${m}`]}`,"data-view-mode":m,children:T(Q,X).map((e,t)=>n.jsx(h,{column:e,colIndex:t,scrollMargin:0,scrollRef:D,loadMoreSentinelRef:j?e=>{z.current[t]=e}:void 0,hasCursor:!!j,keyboardFocusIndex:I,keyboardAddOpen:P,actionsMenuOpenForIndex:null,nsfwPreference:G,unblurredUris:H,setUnblurred:K,likeOverrides:L,setLikeOverrides:$,openPostModal:e=>g(e),cardRef:e=>t=>{F.current[e]=t},onActionsMenuOpenChange:()=>{},onMouseEnter:e=>E(e),onAddClose:()=>B(!1),constrainMediaHeight:1===X,isSelected:e=>e===I},t))})]}):null}function F({query:e,onClose:t,onBack:r,canGoBack:o}){const[i,s]=f.useState(null);return n.jsxs(m,{ariaLabel:`Search: ${e}`,onClose:t,onBack:r,canGoBack:o,onPullToRefresh:i?()=>i():void 0,children:[n.jsx(P,{centerContent:n.jsxs("span",{className:B,title:e.trim(),children:['"',e.trim(),'"']})}),n.jsx($,{query:e,onRegisterRefresh:e=>s(()=>e)})]})}export{F as default};
