import{j as e,u as t,g as s,k as o,b as a,E as n,a6 as r,a1 as i,a7 as l,a8 as c,a9 as d,aa as u,a2 as m,a3 as p,ab as h,h as x,ac as f}from"./index-CxrS-4Im.js";import{b as v,d as y,f as j,u as g}from"./react-vendor-DGaPsC2e.js";import{takeInitialPostForUri as N,getCachedThread as b}from"./postCache-CTqU0alO.js";import{g as C,i as w,c as A,a as k}from"./artboards-DNvSVVrd.js";import{l as P,a as q,b as R,P as L}from"./PostActionsMenu-yyFn4Qo4.js";import{C as S,a as E,L as D}from"./Layout-D_5WMlYL.js";import{a as M,P as I}from"./PostText-DYSApYWK.js";import{p as U}from"./PostDetailPage.module-TDaRGCAY.js";async function F(e){const t=new URLSearchParams({target:e,collection:"app.artsky.feed.downvote",path:".subject.uri"});try{const e=await fetch(`https://constellation.microcosm.blue/links/count/distinct-dids?${t}`,{headers:{Accept:"application/json"}});if(!e.ok)return 0;const s=await e.json();return"number"==typeof s.total?s.total:0}catch{return 0}}async function T(e){const t=[...new Set(e)],s=await Promise.all(t.map(async e=>({uri:e,count:await F(e)}))),o={};for(const{uri:a,count:n}of s)o[a]=n;return o}function $({playlistUrl:t,poster:s,className:o,controls:a=!0,playsInline:n=!0,preload:r="metadata",autoPlay:i=!1,controlsHiddenUntilTap:l=!1}){const c=v.useRef(null),[d,u]=v.useState(!l),m=l?d:a;return v.useEffect(()=>{if(!t||!c.current)return;const e=c.current;let s;var o;return/\.m3u8(\?|$)/i.test(o=t)||o.includes("m3u8")?P().then(o=>{if(c.current)if(o.isSupported()){const a=new o;a.loadSource(t),a.attachMedia(e),a.on(o.Events.ERROR,()=>{}),s=()=>{a.destroy()}}else e.canPlayType("application/vnd.apple.mpegurl")&&(e.src=t,s=()=>{e.removeAttribute("src")})}).catch(()=>{e.canPlayType("application/vnd.apple.mpegurl")&&(e.src=t)}):(e.src=t,s=()=>{e.removeAttribute("src")}),()=>{s?.()}},[t]),v.useEffect(()=>{if(!i||!c.current)return;const e=c.current;function t(){e.play().catch(()=>{})}return e.readyState>=2?t():e.addEventListener("loadeddata",t,{once:!0}),()=>e.removeEventListener("loadeddata",t)},[i,t]),e.jsx("video",{ref:c,className:o,poster:s,controls:m,playsInline:n,preload:r,autoPlay:i,muted:i,onClick:l&&!d?()=>u(!0):void 0})}const B=18;function V(){return e.jsx("svg",{width:B,height:B,viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":!0,children:e.jsx("path",{d:"M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"})})}function H(){return e.jsx("svg",{width:B,height:B,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:e.jsx("path",{d:"M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"})})}function z(){return e.jsxs("svg",{width:B,height:B,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:[e.jsx("path",{d:"M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H3c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2z"}),e.jsx("path",{d:"M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-5c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2z"})]})}function W({replyAs:t,sessionsList:s,switchAccount:o,currentDid:a,label:r="Replying as"}){const[i,l]=v.useState(!1),[c,d]=v.useState({}),u=v.useRef(null);v.useEffect(()=>{if(!i)return;const e=e=>{u.current?.contains(e.target)||l(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[i]);const m=v.useMemo(()=>s.map(e=>e.did).sort().join(","),[s]);v.useEffect(()=>{if(0===s.length)return void d({});let e=!1;return s.forEach(t=>{n.getProfile({actor:t.did}).then(s=>{if(e)return;const o=s.data;d(e=>({...e,[t.did]:{avatar:o.avatar,handle:o.handle}}))}).catch(()=>{})}),()=>{e=!0}},[m,s]);const{openLoginModal:p}=x();return e.jsxs("p",{className:U.replyAs,children:[e.jsx("span",{className:U.replyAsLabel,children:r}),e.jsxs("span",{className:U.replyAsUserChip,children:[t.avatar?e.jsx("img",{src:t.avatar,alt:"",className:U.replyAsAvatar,loading:"lazy"}):e.jsx("span",{className:U.replyAsAvatarPlaceholder,"aria-hidden":!0,children:t.handle.slice(0,1).toUpperCase()}),e.jsxs("div",{className:U.replyAsHandleWrap,ref:u,children:[e.jsxs("button",{type:"button",className:U.replyAsHandleBtn,onClick:()=>l(e=>!e),"aria-expanded":i,"aria-haspopup":"true",children:["@",t.handle]}),i&&e.jsxs("div",{className:U.replyAsDropdown,role:"menu",children:[s.map(t=>{const s=c[t.did],n=s?.handle??t.handle??t.did,r=t.did===a;return e.jsxs("button",{type:"button",role:"menuitem",className:r?U.replyAsDropdownItemActive:U.replyAsDropdownItem,onClick:async()=>{await o(t.did)&&l(!1)},children:[s?.avatar?e.jsx("img",{src:s.avatar,alt:"",className:U.replyAsDropdownAvatar,loading:"lazy"}):e.jsx("span",{className:U.replyAsDropdownAvatarPlaceholder,"aria-hidden":!0,children:(n||t.did).slice(0,1).toUpperCase()}),e.jsxs("span",{className:U.replyAsDropdownHandle,children:["@",n]}),r&&e.jsx("span",{className:U.replyAsDropdownCheck,"aria-hidden":!0,children:"✓"})]},t.did)}),e.jsx("button",{type:"button",role:"menuitem",className:U.replyAsDropdownAddAccount,onClick:()=>{l(!1),p()},children:"+ Add account"})]})]})]})]})}function O(e){return e&&"object"==typeof e&&"post"in e&&!!e.post}function Q(e,t){return e.flatMap(e=>{const s=e.post.uri,o=e.post.author?.handle??e.post.author?.did??"";if(t.has(s))return[{uri:s,handle:o}];return[{uri:s,handle:o},...Q("replies"in e&&Array.isArray(e.replies)?e.replies.filter(e=>O(e)):[],t)]})}function K(e,t){for(const s of e){if(s.post.uri===t)return s;const e=K("replies"in s&&Array.isArray(s.replies)?s.replies.filter(e=>O(e)):[],t);if(e)return e}return null}function _(e){if(!O(e))return[];const t=[e.post.uri],s="replies"in e&&Array.isArray(e.replies)?e.replies.filter(e=>O(e)):[];for(const o of s)t.push(..._(o));return t}function G(e){if("undefined"==typeof window)return()=>{};const t=window.matchMedia("(min-width: 768px)");return t.addEventListener("change",e),()=>t.removeEventListener("change",e)}function X(){return"undefined"!=typeof window&&window.innerWidth>=768}function J({items:t,autoPlayFirstVideo:s=!1,hideVideoControlsUntilTap:o=!1,onFocusItem:a,onDoubleTapLike:n}){const r=v.useRef(0),i=v.useRef(0);if(0===t.length)return null;const l=s?t.findIndex(e=>"video"===e.type&&e.videoPlaylist):-1;return e.jsx("div",{className:U.galleryWrap,onTouchEnd:e=>{if(!n||1!==e.changedTouches.length)return;const t=Date.now();t-r.current<400?(r.current=0,e.preventDefault(),n()):r.current=t},onClick:e=>{if(!n)return;const t=Date.now();t-i.current<400?(i.current=0,e.stopPropagation(),e.preventDefault(),n()):i.current=t},children:e.jsx("div",{className:U.gallery,children:t.map((t,s)=>{if("video"===t.type&&t.videoPlaylist){const n=t.aspectRatio??16/9;return e.jsx("div",{className:U.galleryVideoWrap,style:{aspectRatio:n},"data-media-item":s,tabIndex:0,onFocus:()=>a?.(s),children:e.jsx($,{playlistUrl:t.videoPlaylist,poster:t.url||void 0,className:U.galleryVideo,autoPlay:s===l,preload:s===l?"metadata":"none",controlsHiddenUntilTap:o})},s)}const n="image"===t.type&&null!=t.aspectRatio?t.aspectRatio:1;return e.jsx("div",{className:U.galleryImageBtn,style:{aspectRatio:n,"--media-aspect":n},"data-media-item":s,tabIndex:0,onFocus:()=>a?.(s),children:e.jsx("img",{src:t.url,alt:"",className:U.galleryMedia,loading:"lazy"})},s)})})})}function Y({node:t,depth:s=0,collapsedThreads:o,onToggleCollapse:n,onReply:r,rootPostUri:i,rootPostCid:c,replyingTo:d,replyComment:u,setReplyComment:m,onReplySubmit:p,replyPosting:h,clearReplyingTo:x,commentFormRef:y,replyAs:j,sessionsList:g,switchAccount:N,currentDid:b,focusedCommentUri:C,onCommentMediaFocus:w,onLike:A,onDownvote:k,likeOverrides:P,myDownvotes:D,downvoteCounts:F,downvoteCountOptimisticDelta:T,likeLoadingUri:$,downvoteLoadingUri:B,openActionsMenuCommentUri:V,onActionsMenuOpenChange:H,onViewQuotes:z}){const[Q,K]=v.useState(null),_=v.useRef(null),[G,X]=v.useState(!1),[Z,ee]=v.useState(""),[te,se]=v.useState([]),[oe,ae]=v.useState([]),[ne,re]=v.useState(null),[ie,le]=v.useState(!1),ce=v.useRef(null),de=v.useRef(null),ue=["image/jpeg","image/png","image/gif","image/webp"];function me(){X(!1),re(null)}function pe(e){const t=Array.from(e).filter(e=>ue.includes(e.type));se(e=>[...e,...t].slice(0,4)),ae(e=>[...e,...new Array(t.length).fill("")])}async function he(e){if(e.preventDefault(),!O(t)||ie||!b)return;if(Z.trim()||te.length>0){re(null),le(!0);try{await f(t.post.uri,t.post.cid,Z,te.length>0?te:void 0,oe.length>0?oe:void 0),me()}catch(s){re(s instanceof Error?s.message:"Failed to post quote")}finally{le(!1)}}}v.useEffect(()=>{if(!Q)return;const e=e=>{_.current?.contains(e.target)||K(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[Q]),v.useEffect(()=>{if(G)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e);function e(e){const t=e.target;de.current?.contains(t)||X(!1)}},[G]);const xe=v.useMemo(()=>te.map(e=>URL.createObjectURL(e)),[te]);if(v.useEffect(()=>()=>xe.forEach(e=>URL.revokeObjectURL(e)),[xe]),!O(t))return null;const{post:fe}=t,ve=fe,ye=void 0!==P?.[fe.uri]?P[fe.uri]:ve.viewer?.like,je=D?.[fe.uri],ge=ve.likeCount??0,Ne=!!ve.viewer?.like,be=(!!ye?1:0)-(Ne?1:0),Ce=Math.max(0,ge+be),we=F?.[fe.uri]??ve.downvoteCount??0,Ae=T?.[fe.uri]??0,ke=Math.max(0,we+Ae),Pe=l(fe),qe=fe.record?.text??"",Re=fe.author.handle??fe.author.did,Le=fe.author.avatar??void 0,Se=fe.record?.createdAt,Ee="replies"in t&&Array.isArray(t.replies)?t.replies:[],De=Ee.length>0,Me=De&&o?.has(fe.uri),Ie=!!n,Ue=d?.uri===fe.uri,Fe=C===fe.uri,Te=$===fe.uri,$e=B===fe.uri;return e.jsxs("article",{className:`${U.postBlock} ${Fe?U.commentFocused:""}`,style:{marginLeft:2*s},"data-comment-uri":fe.uri,tabIndex:-1,children:[Ie&&e.jsxs("div",{className:U.collapseColumn,children:[e.jsx("button",{type:"button",className:U.collapseBtn,onClick:()=>n?.(fe.uri),"aria-label":Me?"Expand this comment":"Collapse this comment",title:Me?"Expand this comment":"Collapse this comment",children:e.jsx("span",{className:U.collapseIcon,"aria-hidden":!0,children:"−"})}),e.jsx("button",{type:"button",className:U.collapseStrip,onClick:()=>n?.(fe.uri),"aria-label":Me?"Expand this comment":"Collapse this comment",title:Me?"Expand this comment":"Collapse this comment"})]}),e.jsxs("div",{className:U.postBlockContent,children:[e.jsxs("div",{className:U.commentContentWrap,"data-comment-content":fe.uri,tabIndex:-1,children:[e.jsxs("div",{className:U.postHead,children:[Le&&e.jsx("img",{src:Le,alt:"",className:U.avatar,loading:"lazy"}),e.jsxs("div",{className:U.authorRow,children:[e.jsxs(M,{handle:Re,className:U.handleLink,children:["@",Re]}),Se&&e.jsx("span",{className:U.postTimestamp,title:R(Se),children:q(Se)})]})]}),Pe.length>0&&e.jsx(J,{items:Pe,onFocusItem:e=>w?.(fe.uri,e),onDoubleTapLike:A?()=>A(fe.uri,fe.cid,ye??null):void 0}),qe&&e.jsx("p",{className:U.postText,children:e.jsx(I,{text:qe,facets:fe.record?.facets,interactive:!0})}),(r||A||k)&&e.jsxs("div",{className:U.replyBtnRow,children:[r&&e.jsxs("button",{type:"button",className:U.replyBtn,onClick:()=>r(fe.uri,fe.cid,Re),children:[e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:e.jsx("path",{d:"M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"})}),e.jsx("span",{children:"Reply"})]}),A&&e.jsxs("button",{type:"button",className:ye?U.commentLikeBtnLiked:U.commentLikeBtn,onClick:()=>A(fe.uri,fe.cid,ye??null),disabled:Te,title:ye?"Remove like":"Like","aria-label":ye?"Remove like":"Like",children:["↑",` ${Ce}`]}),A&&k&&e.jsx("span",{className:U.commentVoteTotal,"aria-label":`Score: ${Ce-ke} (upvotes minus downvotes)`,children:Ce-ke}),k&&e.jsxs("button",{type:"button",className:je?U.commentDownvoteBtnActive:U.commentDownvoteBtn,onClick:()=>k(fe.uri,fe.cid,je??null),disabled:$e,title:je?"Remove downvote":"Downvote (syncs across AT Protocol)","aria-label":je?"Remove downvote":"Downvote",children:["↓",` ${ke}`]}),b&&e.jsxs("div",{className:U.commentRepostWrap,ref:_,children:[e.jsxs("button",{type:"button",className:U.commentRepostBtn,onClick:()=>K(Q===fe.uri?null:fe.uri),"aria-expanded":Q===fe.uri,"aria-haspopup":"true",title:"Repost or quote",children:[e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":!0,children:e.jsx("path",{d:"M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"})}),e.jsx("span",{children:"Repost"})]}),Q===fe.uri&&e.jsxs("div",{className:U.commentRepostDropdown,role:"menu",children:[e.jsx("button",{type:"button",className:U.commentRepostDropdownItem,role:"menuitem",onClick:async()=>{K(null);try{const e=fe;e.viewer?.repost?await a.deleteRepost(e.viewer.repost):await a.repost(fe.uri,fe.cid)}catch(e){}},children:fe.viewer?.repost?"Remove repost":"Repost"}),e.jsx("button",{type:"button",className:U.commentRepostDropdownItem,role:"menuitem",onClick:function(){K(null),X(!0),ee(""),se([]),ae([]),re(null)},disabled:!b,children:"Quote post"})]})]}),e.jsxs("div",{className:U.commentActionsWrap,children:[e.jsx(L,{postUri:fe.uri,postCid:fe.cid,authorDid:fe.author.did,rootUri:i??fe.uri,isOwnPost:b===fe.author.did,compact:!0,verticalIcon:!0,className:U.commentActionsMenu,open:H?V===fe.uri:void 0,onOpenChange:H?e=>H(fe.uri,e):void 0,postedAt:fe.record?.createdAt,onViewQuotes:z}),e.jsxs("button",{type:"button",className:U.commentViewQuotesBtn,onClick:()=>z?.(fe.uri),title:"View posts that quote this","aria-label":"View quotes",children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:[e.jsx("path",{d:"M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H3c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2z"}),e.jsx("path",{d:"M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-5c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2z"})]}),e.jsx("span",{children:"View Quotes"})]})]})]}),Ue&&d&&m&&p&&x&&y&&e.jsx("div",{className:U.inlineReplyFormWrap,children:e.jsxs("form",{ref:y,onSubmit:p,className:U.inlineReplyForm,children:[e.jsxs("div",{className:U.inlineReplyFormHeader,children:[e.jsx("button",{type:"button",className:U.cancelReply,onClick:x,"aria-label":"Cancel reply",children:"×"}),j&&(g&&N&&b?e.jsx(W,{replyAs:j,sessionsList:g,switchAccount:N,currentDid:b}):e.jsxs("p",{className:U.replyAs,children:[e.jsx("span",{className:U.replyAsLabel,children:"Replying as"}),e.jsxs("span",{className:U.replyAsUserChip,children:[j.avatar?e.jsx("img",{src:j.avatar,alt:"",className:U.replyAsAvatar,loading:"lazy"}):e.jsx("span",{className:U.replyAsAvatarPlaceholder,"aria-hidden":!0,children:j.handle.slice(0,1).toUpperCase()}),e.jsxs("span",{className:U.replyAsHandle,children:["@",j.handle]})]})]}))]}),e.jsx(S,{placeholder:`Reply to @${d.handle}…`,value:u??"",onChange:e=>m?.(e),onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),(u??"").trim()&&!h&&y.current?.requestSubmit())},className:U.textarea,rows:2,maxLength:300,autoFocus:!0}),e.jsxs("div",{className:U.commentFormFooter,children:[e.jsx(E,{used:(u??"").length,max:300}),e.jsx("p",{className:U.hint,children:"⌘ Enter or ⌘ E to post"})]}),e.jsx("button",{type:"submit",className:U.submit,disabled:h||!(u??"").trim(),children:h?"Posting…":"Post reply"})]})})]}),De&&e.jsx("div",{className:U.repliesContainer,children:Me?e.jsxs("button",{type:"button",className:U.repliesCollapsed,onClick:()=>n?.(fe.uri),children:[Ee.length," reply",1!==Ee.length?"s":""]}):e.jsx("div",{className:U.replies,children:Ee.map((t,a)=>{if(!O(t))return null;const l=s+1;if(o?.has(t.post.uri)){const s="replies"in t&&Array.isArray(t.replies)?t.replies.length:0,o=0===s?"Comment":`${s} reply${1!==s?"s":""}`,r=t.post.author?.handle??t.post.author?.did??"";return e.jsx("div",{className:U.collapsedCommentWrap,style:{marginLeft:12*l},"data-comment-uri":t.post.uri,tabIndex:-1,children:e.jsxs("button",{type:"button",className:U.collapsedCommentBtn,onClick:()=>n?.(t.post.uri),children:[e.jsx("span",{className:U.collapsedCommentExpandIcon,"aria-hidden":!0,children:"+"}),t.post.author?.avatar?e.jsx("img",{src:t.post.author.avatar,alt:"",className:U.collapsedCommentAvatar,loading:"lazy"}):e.jsx("span",{className:U.collapsedCommentAvatarPlaceholder,"aria-hidden":!0,children:r.slice(0,1).toUpperCase()}),e.jsxs("span",{className:U.collapsedCommentHandle,children:["@",r]}),e.jsx("span",{className:U.collapsedCommentLabel,children:o})]})},`${t.post.uri}-${a}`)}return e.jsx(Y,{node:t,depth:l,collapsedThreads:o,onToggleCollapse:n,onReply:r,rootPostUri:i,rootPostCid:c,replyingTo:d,replyComment:u,setReplyComment:m,onReplySubmit:p,replyPosting:h,clearReplyingTo:x,commentFormRef:y,replyAs:j,sessionsList:g,switchAccount:N,currentDid:b,focusedCommentUri:C,onCommentMediaFocus:w,onLike:A,onDownvote:k,likeOverrides:P,myDownvotes:D,downvoteCounts:F,downvoteCountOptimisticDelta:T,likeLoadingUri:$,downvoteLoadingUri:B,openActionsMenuCommentUri:V,onActionsMenuOpenChange:H,onViewQuotes:z},`${t.post.uri}-${a}`)})})})]}),G&&O(t)&&(()=>{const s=t.post,o=s.author?.handle??s.author?.did??"",a=s.record?.text??"",n=l(s)[0];return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:U.quoteComposerBackdrop,onClick:me,"aria-hidden":!0}),e.jsx("div",{className:U.quoteComposerOverlay,role:"dialog","aria-label":"Quote post",onClick:me,onDragOver:e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"},onDrop:e=>{e.preventDefault(),e.dataTransfer?.files?.length&&pe(e.dataTransfer.files)},children:e.jsxs("div",{className:U.quoteComposerCard,onClick:e=>e.stopPropagation(),children:[e.jsx("h2",{className:U.quoteComposerTitle,children:"Quote post"}),b?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:U.quoteComposerQuotedWrap,children:[e.jsx("p",{className:U.quotedPostLabel,children:"Quoting"}),e.jsxs("div",{className:U.quoteComposerQuotedCard,children:[e.jsxs("div",{className:U.quotedPostHead,children:[s.author?.avatar?e.jsx("img",{src:s.author.avatar,alt:"",className:U.quotedPostAvatar,loading:"lazy"}):e.jsx("span",{className:U.quotedPostAvatarPlaceholder,"aria-hidden":!0,children:o.slice(0,1).toUpperCase()}),e.jsxs("span",{className:U.quotedPostHandle,children:["@",o]}),s.record?.createdAt&&e.jsx("span",{className:U.quotedPostTime,title:R(s.record.createdAt),children:q(s.record.createdAt)})]}),n&&e.jsx("div",{className:U.quotedPostMedia,children:"image"===n.type?e.jsx("img",{src:n.url,alt:"",loading:"lazy",className:U.quotedPostThumb}):n.videoPlaylist?e.jsx("div",{className:U.quotedPostVideoThumb,style:{backgroundImage:n.url?`url(${n.url})`:void 0}}):null}),a?e.jsx("p",{className:U.quotedPostText,children:e.jsx(I,{text:a,facets:s.record?.facets,maxLength:300,stopPropagation:!0})}):null]})]}),e.jsxs("form",{onSubmit:he,onKeyDown:e=>{(e.metaKey||e.ctrlKey)&&"Enter"===e.key&&(e.preventDefault(),he(e))},children:[e.jsx(S,{className:U.quoteComposerTextarea,value:Z,onChange:ee,placeholder:"Add your thoughts...",rows:4,maxLength:300,disabled:ie,autoFocus:!0}),te.length>0&&e.jsxs("div",{className:U.quoteComposerMediaSection,children:[e.jsx("div",{className:U.quoteComposerPreviews,children:te.map((t,s)=>e.jsxs("div",{className:U.quoteComposerPreviewWrap,children:[e.jsx("img",{src:xe[s],alt:"",className:U.quoteComposerPreviewImg}),e.jsx("button",{type:"button",className:U.quoteComposerPreviewRemove,onClick:()=>{return e=s,se(t=>t.filter((t,s)=>s!==e)),void ae(t=>t.filter((t,s)=>s!==e));var e},"aria-label":"Remove image",disabled:ie,children:"×"})]},s))}),e.jsx("p",{className:U.quoteComposerAltPrompt,children:"Describe each image for accessibility (alt text)."}),e.jsx("div",{className:U.quoteComposerAltFields,children:te.map((t,s)=>e.jsxs("div",{className:U.quoteComposerAltRow,children:[e.jsxs("label",{htmlFor:`quote-alt-${s}`,className:U.quoteComposerAltLabel,children:["Image ",s+1]}),e.jsx("input",{id:`quote-alt-${s}`,type:"text",className:U.quoteComposerAltInput,placeholder:"Describe this image",value:oe[s]??"",onChange:e=>{const t=e.target.value.slice(0,1e3);ae(e=>{const o=[...e];for(;o.length<te.length;)o.push("");return o[s]=t,o})},maxLength:1e3,disabled:ie})]},s))})]}),e.jsxs("div",{className:U.quoteComposerFooter,children:[e.jsxs("div",{className:U.quoteComposerFooterLeft,children:[e.jsx("input",{ref:ce,type:"file",accept:"image/jpeg,image/png,image/gif,image/webp",multiple:!0,className:U.quoteComposerFileInput,onChange:e=>{e.target.files?.length&&pe(e.target.files),e.target.value=""}}),e.jsx("button",{type:"button",className:U.quoteComposerAddMedia,onClick:()=>ce.current?.click(),disabled:ie||te.length>=4,title:"Add photo","aria-label":"Add photo",children:"Add media"}),e.jsx(E,{used:Z.length,max:300})]}),e.jsxs("div",{className:U.quoteComposerActions,children:[e.jsx("button",{type:"button",className:U.quoteComposerCancel,onClick:me,disabled:ie,children:"Cancel"}),e.jsx("button",{type:"submit",className:U.quoteComposerSubmit,disabled:ie||!Z.trim()&&0===te.length,children:ie?"Posting…":"Quote post"})]})]}),ne&&e.jsx("p",{className:U.quoteComposerError,children:ne})]})]}):e.jsx("p",{className:U.quoteComposerSignIn,children:"Log in to quote posts."})]})})]})})()]})}function Z({uri:x,initialOpenReply:j,initialFocusedCommentUri:g,onClose:P,onAuthorHandle:F,onRegisterRefresh:$}){const B=y(),{openProfileModal:Z,openPostModal:ee,openQuotesModal:te}=t(),se=v.useSyncExternalStore(G,X,()=>!1),oe=x,[ae,ne]=v.useState(null),[re,ie]=v.useState(!0),[le,ce]=v.useState(null),[de,ue]=v.useState(""),[me,pe]=v.useState(!1),[he,xe]=v.useState(new Set),[fe,ve]=v.useState(null),[ye,je]=v.useState(()=>new Set),[ge,Ne]=v.useState(!1),[be,Ce]=v.useState(!1),[we,Ae]=v.useState(null),[ke,Pe]=v.useState(!1),[qe,Re]=v.useState(!1),[Le,Se]=v.useState(null),[Ee,De]=v.useState(null),[Me,Ie]=v.useState(null),[Ue,Fe]=v.useState({}),[Te,$e]=v.useState({}),[Be,Ve]=v.useState({}),[He,ze]=v.useState({}),[We,Oe]=v.useState(null),[Qe,Ke]=v.useState(null),[_e,Ge]=v.useState(null),[Xe,Je]=v.useState(""),[Ye,Ze]=v.useState(!1),[et,tt]=v.useState(!1),[st,ot]=v.useState(!1),[at,nt]=v.useState(""),[rt,it]=v.useState([]),[lt,ct]=v.useState([]),[dt,ut]=v.useState(!1),[mt,pt]=v.useState(null),ht=v.useRef(null),xt=v.useRef(null),[ft,vt]=v.useState(0),yt=v.useRef(null),jt=v.useRef(null),gt=v.useRef(null),Nt=v.useRef(null),bt=v.useRef(null),[Ct,wt]=v.useState(0),[At,kt]=v.useState(!1),Pt=v.useRef(null),[qt,Rt]=v.useState("score"),[Lt,St]=v.useState(0),Et=v.useRef(0),Dt=v.useRef(!1),Mt=v.useRef(null),It=v.useRef(0),Ut=C(),Ft=s(),{session:Tt,sessionsList:$t,switchAccount:Bt}=o(),[Vt,Ht]=v.useState(null);v.useEffect(()=>{const e=Tt??Ft;if(!e?.did)return void Ht(null);const t=e.handle??e.did;a.getProfile({actor:e.did}).then(e=>Ht({handle:e.data.handle??t,avatar:e.data.avatar})).catch(()=>Ht({handle:t}))},[Tt?.did,Ft?.did]);const zt=Vt??(Ft?{handle:Ft.handle??Ft.did}:null),Wt=ae&&O(ae)&&Ft?.did===ae.post.author.did,Ot=ae&&O(ae)?ae.post.author.viewer:void 0,Qt=Ot?.following??we,Kt=!!Qt||be,_t=ae&&O(ae)?ae.post.viewer:void 0,Gt=_t?.like??Le,Xt=_t?.repost??Ee,Jt=!!Gt,Yt=!!Xt;function Zt(e){je(t=>{const s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})}async function es(){if(!ae||!O(ae)||ke)return;const{uri:e,cid:t}=ae.post;Pe(!0);try{if(Jt)await a.deleteLike(Gt),Se(null);else{const s=await a.like(e,t);Se(s.uri)}}catch{}finally{Pe(!1)}}const ts=["image/jpeg","image/png","image/gif","image/webp"];function ss(e){const t=Array.from(e).filter(e=>ts.includes(e.type)),s=Math.min(t.length,4-rt.length);s<=0||(it(e=>[...e,...t.slice(0,s)]),ct(e=>[...e,...t.slice(0,s).map(()=>"")]))}function os(){ot(!1),pt(null)}async function as(e){if(e.preventDefault(),!ae||!O(ae)||dt||!Ft?.did)return;if(at.trim()||rt.length>0){pt(null),ut(!0);try{await f(ae.post.uri,ae.post.cid,at,rt.length>0?rt:void 0,lt.length>0?lt:void 0),os(),B("/feed")}catch(t){pt(t instanceof Error?t.message:"Failed to post quote")}finally{ut(!1)}}}const ns=v.useCallback(async()=>{if(!oe)return;ce(null);const e=s()?a:n;let t=!1;const o=N(oe),l=b(oe);if(o){const e=o.post??o;if(e&&"object"==typeof e&&e.uri===oe){ne({$type:"app.bsky.feed.defs#threadViewPost",post:e,replies:[]});const s=e.record?.reply;ie(!!s),t=!0}}else l&&O(l)&&(ne(l),ie(!1),t=!0);t||ie(!0);try{const t=(await r(oe,e)).data.thread;ne(t),ie(!1),ze({});const o=O(t)?_(t):[];o.length>0?T(o).then(Ve).catch(()=>{}):Ve({}),s()?i().then($e).catch(()=>{}):$e({})}catch(c){ce(c instanceof Error?c.message:"Failed to load post")}finally{ie(!1)}},[oe,Tt?.did]);async function rs(e){if(e.preventDefault(),!ae||!O(ae)||!de.trim())return;const t=ae.post,s=Me??{uri:t.uri,cid:t.cid};pe(!0);try{await h(t.uri,t.cid,s.uri,s.cid,de.trim()),ue(""),Ie(null),await ns()}catch(o){alert(o instanceof Error?o.message:"Failed to post comment")}finally{pe(!1)}}function is(e,t,s){Ie({uri:e,cid:t,handle:s});const o=document.querySelector(`.${U.commentForm} textarea`);o?.focus()}async function ls(e,t,s){Oe(e);try{if(s)await a.deleteLike(s),Fe(t=>({...t,[e]:null}));else{const s=await a.like(e,t);Fe(t=>({...t,[e]:s.uri}))}}catch{}finally{Oe(null)}}async function cs(e,t,s){Ke(e);try{if(s)await m(s),$e(t=>{const s={...t};return delete s[e],s}),ze(t=>({...t,[e]:(t[e]??0)-1}));else{const s=await p(e,t);$e(t=>({...t,[e]:s})),ze(t=>({...t,[e]:(t[e]??0)+1}))}}catch{}finally{Ke(null)}}function ds(){if(!ae||!O(ae))return;if(!(he.size>0||Xe.trim().length>0))return;const e=ae.post,t=u(e),s=l(e),o=s.length>0?s.map(e=>e.url):void 0,a={uri:e.uri,cid:e.cid,authorHandle:e.author.handle,text:e.record?.text?.slice(0,200),thumb:t?.url??o?.[0],thumbs:o},n=[];if(Xe.trim()){const e=A(Xe.trim());k(e.id,a),n.push(e.id),Je("")}he.forEach(e=>{k(e,a),n.push(e)}),ve(n[0]??null),xe(new Set),Ze(!1)}v.useEffect(()=>{ns()},[ns]),v.useEffect(()=>{$?.(()=>ns())},[$,ns]),v.useEffect(()=>{if(!ae||!O(ae)||!j)return;const e=ae.post.author?.handle??ae.post.author?.did??"";Ie({uri:ae.post.uri,cid:ae.post.cid,handle:e}),requestAnimationFrame(()=>{const e=document.querySelector(`.${U.commentForm} textarea`);e?.focus()})},[ae,j]),v.useEffect(()=>{if(!Me)return;const e=e=>{if("Escape"===e.key){e.preventDefault(),Ie(null);const t=document.activeElement;t instanceof HTMLElement&&t.blur()}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[Me]);const us=v.useMemo(()=>rt.map(e=>URL.createObjectURL(e)),[rt]);v.useEffect(()=>()=>us.forEach(e=>URL.revokeObjectURL(e)),[us]),v.useEffect(()=>{if(et)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e);function e(e){const t=e.target;xt.current?.contains(t)||tt(!1)}},[et]);const ms=ae&&O(ae)?l(ae.post):[],ps=ms.length>0,hs=ae&&O(ae)&&"replies"in ae&&Array.isArray(ae.replies)&&ae.replies.length>0,xs=1+(ps?1:0)+(hs?1:0),fs=ae&&O(ae)&&"replies"in ae&&Array.isArray(ae.replies)?ae.replies.filter(e=>O(e)):[],vs=v.useCallback(e=>{const t=e.post,s=t.likeCount??0,o=!!t.viewer?.like,a=(!!(void 0!==Ue[e.post.uri]?Ue[e.post.uri]:t.viewer?.like)?1:0)-(o?1:0);return Math.max(0,s+a)},[Ue]),ys=v.useCallback(e=>(Be[e.post.uri]??0)+(He[e.post.uri]??0),[Be,He]),js=v.useCallback((e,t)=>{const s=e+t;if(0===s)return 0;const o=1.96,a=e/s,n=1+o*o/s,r=a+o*o/(2*s),i=o*Math.sqrt((a*(1-a)+o*o/(4*s))/s);return Math.max(0,(r-i)/n)},[]),gs=v.useMemo(()=>{const e=e=>e.post.record?.createdAt??"",t=(t,s)=>e(s).localeCompare(e(t));return"newest"===qt?[...fs].sort((t,s)=>e(s).localeCompare(e(t))):"oldest"===qt?[...fs].sort((t,s)=>e(t).localeCompare(e(s))):[...fs].sort((e,s)=>{const o=vs(e),a=vs(s),n=ys(e),r=ys(s);if("likes"===qt)return a!==o?a-o:t(e,s);if("score"===qt){const i=o-n,l=a-r;return l!==i?l-i:t(e,s)}if("controversial"===qt){const i=o+n,l=a+r,c=i>0?o*n/i:0,d=l>0?a*r/l:0;return d!==c?d-c:t(e,s)}const i=js(o,n),l=js(a,r);return l!==i?l-i:t(e,s)})},[fs,qt,vs,ys,js]),Ns=v.useMemo(()=>Q(gs,ye),[gs,ye]),bs=v.useRef(Ns);bs.current=Ns,Et.current=Lt;const Cs=v.useMemo(()=>{const e=[];for(let t=0;t<ms.length;t++)e.push({type:"rootMedia",index:t});e.push({type:"description"});for(const t of Ns){const s=K(gs,t.uri),o=s?l(s.post):[];for(let a=0;a<o.length;a++)e.push({type:"commentMedia",commentUri:t.uri,mediaIndex:a});e.push({type:"comment",commentUri:t.uri})}return e.push({type:"replyForm"}),e},[ms.length,Ns,gs]),ws=Cs.length,As=v.useCallback((e,t)=>{const s=Cs.findIndex(s=>"commentMedia"===s.type&&s.commentUri===e&&s.mediaIndex===t);if(s>=0){St(s);const t=Ns.findIndex(t=>t.uri===e);t>=0&&wt(t)}},[Cs,Ns]),ks=ae&&O(ae)?ae.post.uri:null;if(v.useEffect(()=>{if(ae&&O(ae)&&F){const e=ae.post.author?.handle??ae.post.author?.did??"";e&&F(e)}},[ae,F]),v.useEffect(()=>{ks&&St(0)},[ks]),v.useEffect(()=>{ws<=0||St(e=>Math.min(Math.max(0,e),ws-1))},[ws]),v.useEffect(()=>{const e=e=>{const t=e.target;if("INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName||t.isContentEditable)return void("Escape"===e.key&&(e.preventDefault(),t.blur()));if(e.ctrlKey||e.metaKey)return;const s=e.key.toLowerCase();if("f"===s)return void(ae&&O(ae)&&(e.preventDefault(),es()));if("r"===s){const t=ae;if(!t||!O(t))return;e.preventDefault();if(hs&&ft===xs-1&&Ns.length>0&&Ct>=0&&Ct<Ns.length){const e=Ns[Ct],t=K(fs,e.uri);t&&is(t.post.uri,t.post.cid,e.handle)}else if(ft===(ps?1:0)){const e=t.post.author?.handle??t.post.author?.did??"";is(t.post.uri,t.post.cid,e)}return}const o=hs&&(ft===xs-1||(bt.current?.contains(t)??!1)),a=Nt.current?.contains(t)??!1,n=gt.current?.contains(t)??!1,r=jt.current?.contains(t)??!1;if("e"===s||"enter"===s){if(e.preventDefault(),(At||r)&&yt.current){const e=yt.current.querySelector("textarea");return void(e&&(e.focus(),kt(!0)))}if(o&&Ns.length>0&&Ct>=0&&Ct<Ns.length){const e=Ns[Ct];return void(e?.handle&&Z(e.handle))}if((a||n)&&ae&&O(ae)){const e=ae.post.author?.handle??ae.post.author?.did??"";return void(e&&Z(e))}return}if("m"===s||"`"===s){const t=document.activeElement?.closest?.('[role="menu"]');if(t&&null!=_e)return e.preventDefault(),void Ge(null);if(ae&&O(ae)&&Cs.length>0){const t=Et.current,s=Cs[t];if(s){let t=null;"description"===s.type||"rootMedia"===s.type?t=ae.post.uri:"comment"!==s.type&&"commentMedia"!==s.type||(t=s.commentUri),null!=t&&(e.preventDefault(),Ge(_e===t?null:t))}}return}const i="w"===s||"ArrowUp"===e.key,l="s"===s||"d"===s||"a"===s||"ArrowDown"===e.key||"ArrowRight"===e.key||"ArrowLeft"===e.key;if(!i&&!l)return;if(!ae||!O(ae))return;const c=Cs.length;if(c<=0)return;const d=(e,t)=>{const s=Cs[e];if(s)if(kt("replyForm"===s.type),"rootMedia"===s.type){vt(0),wt(0);const e=gt.current?.querySelectorAll("[data-media-item]"),t=e?.[s.index];t&&requestAnimationFrame(()=>{t.focus(),t.scrollIntoView({behavior:"smooth",block:"center"})})}else if("description"===s.type)vt(ps?1:0),wt(0),requestAnimationFrame(()=>{Nt.current?.focus(),Nt.current?.scrollIntoView({behavior:"smooth",block:"center"})});else if("commentMedia"===s.type){vt(xs-1);const e=Ns.findIndex(e=>e.uri===s.commentUri);wt(e>=0?e:0),requestAnimationFrame(()=>{const e=bt.current;if(!e)return;const t=Array.from(e.querySelectorAll("[data-comment-uri]")).find(e=>e.getAttribute("data-comment-uri")===s.commentUri),o=t?.querySelectorAll("[data-media-item]")?.[s.mediaIndex];o&&(o.focus({preventScroll:!0}),o.scrollIntoView({behavior:"smooth",block:"center"}))})}else if("comment"===s.type){const o=Cs.filter(e=>"commentMedia"===e.type&&e.commentUri===s.commentUri).length,a=void 0!==t?Cs[t]:void 0;if("commentMedia"===a?.type&&a.commentUri===s.commentUri&&o>0&&a.mediaIndex===o-1&&e+1<Cs.length)return St(e+1),void d(e+1,e);vt(xs-1);const n=Ns.findIndex(e=>e.uri===s.commentUri);wt(n>=0?n:0);const r=o>0&&void 0!==t?e<t?o-1:0:-1;if(r>=0){const e=Cs.findIndex(e=>"commentMedia"===e.type&&e.commentUri===s.commentUri&&e.mediaIndex===r);e>=0&&St(e)}requestAnimationFrame(()=>{const e=bt.current;if(!e)return;const t=Array.from(e.querySelectorAll("[data-comment-uri]")).find(e=>e.getAttribute("data-comment-uri")===s.commentUri);if(!t)return;const o=t.querySelector("[data-comment-content]")||t;if(r>=0){const e=o.querySelectorAll("[data-media-item]")?.[r];e&&(e.focus({preventScroll:!0}),e.scrollIntoView({behavior:"smooth",block:"center"}))}else o.focus({preventScroll:!0}),o.scrollIntoView({behavior:"smooth",block:"center"})})}else vt(xs-1),wt(Ns.length-1),requestAnimationFrame(()=>{jt.current?.focus(),jt.current?.scrollIntoView({behavior:"smooth",block:"center"})})},u=Et.current,m=i?Math.max(0,u-1):Math.min(c-1,u+1);m!==u&&(e.preventDefault(),e.stopPropagation(),Dt.current=!0,St(m),d(m,u))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[xs,ft,hs,Ns,Ct,At,ae,ps,is,ms.length,Z,Cs,es,_e]),v.useEffect(()=>{if(xs<=1)return;if(0===ft||ps&&1===ft)return;let e=null;hs&&ft===xs-1&&(e=bt.current),e&&e.scrollIntoView({behavior:"smooth",block:"start"})},[ft,ps,hs,xs]),v.useEffect(()=>{ft===xs-1&&hs&&It.current!==xs-1&&wt(0),It.current=ft},[ft,xs,hs]),v.useEffect(()=>{Ns.length>0&&wt(e=>Math.min(e,Ns.length-1))},[Ns.length]),v.useEffect(()=>{if(!g||!ae||!O(ae)||0===Ns.length)return;if(Mt.current===g)return;Mt.current=g;const e=Ns.findIndex(e=>e.uri===g);if(e<0)return;wt(e);const t=Cs.findIndex(e=>("comment"===e.type||"commentMedia"===e.type)&&e.commentUri===g);t>=0&&St(t),requestAnimationFrame(()=>{const e=bt.current;if(!e)return;const t=Array.from(e.querySelectorAll("[data-comment-uri]")).find(e=>e.getAttribute("data-comment-uri")===g);if(t){(t.querySelector("[data-comment-content]")||t).scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}})},[g,ae,Ns,Cs]),v.useEffect(()=>{if(!Dt.current)return;if(!(hs&&ft===xs-1)||xs<=1)return;const e=bs.current;Ct<0||Ct>=e.length||(Dt.current=!1)},[Ct,hs,ft,xs]),v.useEffect(()=>{if(!Dt.current)return;const e=Cs[Lt];!e||"comment"!==e.type&&"commentMedia"!==e.type||(Dt.current=!1)},[Lt,Cs]),!oe)return P&&P(),null;const Ps=ae&&O(ae)?l(ae.post):[],qs=e.jsxs("div",{className:`${U.wrap}${P?` ${U.wrapInModal}`:""}${re?` ${U.wrapLoading}`:""}`,children:[re&&!ae&&e.jsx("div",{className:U.loading,"aria-live":"polite",children:"Loading…"}),le&&e.jsx("p",{className:U.error,children:le}),ae&&O(ae)&&e.jsxs(e.Fragment,{children:[(()=>{const t=ae.post.record?.reply,s="parent"in ae&&ae.parent&&O(ae.parent);return re&&t&&!s?e.jsxs("div",{className:U.parentPostWrap,children:[e.jsx("p",{className:U.quotedPostLabel,children:"Replying to"}),e.jsx("div",{className:`${U.quotedPostCard} ${U.parentSkeleton}`,children:e.jsxs("div",{className:U.quotedPostHead,children:[e.jsx("span",{className:U.quotedPostAvatarPlaceholder,"aria-hidden":!0,children:"•"}),e.jsx("span",{className:U.quotedPostHandle,children:"Loading…"})]})})]}):s?(()=>{const t=ae.parent,s=t&&"post"in t?t.post:void 0;if(!s)return null;const o=s.author?.handle??s.author?.did??"",a=s.record?.text??"",n=l(s);return e.jsxs("div",{className:U.parentPostWrap,children:[e.jsx("p",{className:U.quotedPostLabel,children:"Replying to"}),e.jsxs("button",{type:"button",className:U.quotedPostCard,onClick:()=>{P?ee(s.uri):B(`/post/${encodeURIComponent(s.uri)}`)},children:[e.jsxs("div",{className:U.quotedPostHead,children:[s.author?.avatar?e.jsx("img",{src:s.author.avatar,alt:"",className:U.quotedPostAvatar,loading:"lazy"}):e.jsx("span",{className:U.quotedPostAvatarPlaceholder,"aria-hidden":!0,children:o.slice(0,1).toUpperCase()}),e.jsxs(M,{handle:o,className:U.quotedPostHandle,onClick:e=>e.stopPropagation(),children:["@",o]}),s.record?.createdAt&&e.jsx("span",{className:U.quotedPostTime,title:R(s.record.createdAt),children:q(s.record.createdAt)})]}),n.length>0&&e.jsx("div",{className:U.quotedPostMediaGrid,children:n.map((t,s)=>e.jsx("div",{className:U.quotedPostMedia,children:"image"===t.type?e.jsx("img",{src:t.url,alt:"",loading:"lazy",className:U.quotedPostThumb}):t.videoPlaylist?e.jsx("div",{className:U.quotedPostVideoThumb,style:{backgroundImage:t.url?`url(${t.url})`:void 0}}):null},s))}),a?e.jsx("p",{className:U.quotedPostText,children:e.jsx(I,{text:a,facets:s.record?.facets,maxLength:200,stopPropagation:!0})}):null]})]})})():null})(),e.jsxs("article",{className:`${U.postBlock} ${U.rootPostBlock}`,children:[Ps.length>0&&e.jsx("div",{ref:gt,onMouseEnter:()=>!P&&ms.length>0&&St(0),children:e.jsx(J,{items:Ps,autoPlayFirstVideo:!0,hideVideoControlsUntilTap:!se,onFocusItem:e=>!P&&St(e),onDoubleTapLike:P?void 0:es})}),e.jsxs("div",{ref:Nt,className:U.rootPostDescription,tabIndex:-1,onFocus:()=>!P&&St(ms.length),onMouseEnter:()=>!P&&St(ms.length),children:[e.jsxs("div",{className:U.postHead,children:[ae.post.author.avatar&&e.jsx("img",{src:ae.post.author.avatar,alt:"",className:U.avatar,loading:"lazy"}),e.jsxs("div",{className:U.authorRow,children:[e.jsxs(M,{handle:ae.post.author.handle??ae.post.author.did,className:U.handleLink,children:["@",ae.post.author.handle??ae.post.author.did]}),!Wt&&(Kt?e.jsxs("button",{type:"button",className:`${U.followBtn} ${U.followBtnFollowing}`,onClick:async function(){if(Qt&&!ge){Ne(!0);try{await a.deleteFollow(Qt),Ae(null),Ce(!1)}catch{}finally{Ne(!1)}}},disabled:ge,title:"Unfollow",children:[e.jsx("span",{className:U.followLabelDefault,children:"Following"}),e.jsx("span",{className:U.followLabelHover,children:"Unfollow"})]}):e.jsx("button",{type:"button",className:U.followBtn,onClick:async function(){if(ae&&O(ae)&&!ge&&!Kt){Ne(!0);try{const e=await a.follow(ae.post.author.did);Ae(e.uri),Ce(!0)}catch{}finally{Ne(!1)}}},disabled:ge,children:ge?"Following…":"Follow"})),ae.post.record?.createdAt&&e.jsx("span",{className:U.postTimestamp,title:R(ae.post.record.createdAt),children:q(ae.post.record.createdAt)})]})]}),ae.post.record?.text&&e.jsx("p",{className:U.postText,children:e.jsx(I,{text:ae.post.record.text,facets:ae.post.record?.facets,interactive:!0})}),(()=>{const t=c(ae.post);return t?e.jsxs("div",{className:U.quotedPostWrap,children:[e.jsx("p",{className:U.quotedPostLabel,children:"Link"}),e.jsxs("a",{href:t.uri,target:"_blank",rel:"noopener noreferrer",className:U.quotedPostCard,children:[t.thumb?e.jsx("div",{className:U.quotedPostMedia,children:e.jsx("img",{src:t.thumb,alt:"",loading:"lazy",className:U.quotedPostThumb})}):null,e.jsx("p",{className:U.quotedPostText,children:t.title}),t.description?e.jsx("p",{className:U.quotedPostText,children:e.jsx(I,{text:t.description,maxLength:200,stopPropagation:!0})}):null]})]}):null})(),(()=>{const t=d(ae.post);if(!t)return null;const s=t.author?.handle??t.author?.did??"",o=t.record?.text??"",a=l(t);return e.jsxs("div",{className:U.quotedPostWrap,children:[e.jsx("p",{className:U.quotedPostLabel,children:"Quoting"}),e.jsxs("button",{type:"button",className:U.quotedPostCard,onClick:()=>{P?ee(t.uri):B(`/post/${encodeURIComponent(t.uri)}`)},children:[e.jsxs("div",{className:U.quotedPostHead,children:[t.author?.avatar?e.jsx("img",{src:t.author.avatar,alt:"",className:U.quotedPostAvatar,loading:"lazy"}):e.jsx("span",{className:U.quotedPostAvatarPlaceholder,"aria-hidden":!0,children:s.slice(0,1).toUpperCase()}),e.jsxs(M,{handle:s,className:U.quotedPostHandle,onClick:e=>e.stopPropagation(),children:["@",s]}),t.record?.createdAt&&e.jsx("span",{className:U.quotedPostTime,title:R(t.record.createdAt),children:q(t.record.createdAt)})]}),a.length>0&&e.jsx("div",{className:U.quotedPostMediaGrid,children:a.map((t,s)=>e.jsx("div",{className:U.quotedPostMedia,children:"image"===t.type?e.jsx("img",{src:t.url,alt:"",loading:"lazy",className:U.quotedPostThumb}):t.videoPlaylist?e.jsx("div",{className:U.quotedPostVideoThumb,style:{backgroundImage:t.url?`url(${t.url})`:void 0}}):null},s))}),o?e.jsx("p",{className:U.quotedPostText,children:e.jsx(I,{text:o,facets:t.record?.facets,maxLength:200,stopPropagation:!0})}):null]})]})})()]}),e.jsxs("section",{className:U.actions,"aria-label":"Post actions",children:[e.jsxs("div",{className:U.actionRow,children:[e.jsxs("div",{className:U.addToBoardWrap,children:[e.jsxs("button",{type:"button",className:U.addToBoardTrigger,onClick:()=>Ze(e=>!e),"aria-expanded":Ye,"aria-haspopup":"true",children:[e.jsx("span",{className:U.likeRepostBtnIcon,"aria-hidden":!0,children:e.jsx(H,{})}),"Collect ",Ye?"▾":"▸"]}),Ye&&e.jsxs("div",{className:U.boardDropdown,children:[0===Ut.length?null:e.jsx(e.Fragment,{children:Ut.map(t=>{const s=w(t.id,ae.post.uri),o=he.has(t.id);return e.jsxs("label",{className:U.boardCheckLabel,children:[e.jsx("input",{type:"checkbox",checked:o,onChange:()=>{return!s&&(e=t.id,void xe(t=>{const s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s}));var e},disabled:s,className:U.boardCheckbox}),e.jsx("span",{className:U.boardCheckText,children:s?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:U.boardCheckIcon,"aria-hidden":!0,children:"✓"})," ",t.name]}):t.name})]},t.id)})}),e.jsx("div",{className:U.boardDropdownNew,children:e.jsx("input",{type:"text",placeholder:"New collection name",value:Xe,onChange:e=>Je(e.target.value),className:U.newBoardInput,onKeyDown:e=>"Enter"===e.key&&(e.preventDefault(),ds())})}),e.jsx("div",{className:U.boardDropdownActions,children:e.jsx("button",{type:"button",className:U.addBtn,onClick:ds,disabled:0===he.size&&!Xe.trim(),children:"Add to selected"})})]})]}),e.jsxs("button",{type:"button",className:`${U.likeRepostBtn} ${Jt?U.likeRepostBtnActive:""}`,onClick:es,disabled:ke,title:Jt?"Remove like":"Like",children:[ke?"…":Jt?"♥":"♡"," Like"]}),ae&&O(ae)&&Ft&&e.jsxs("button",{type:"button",className:`${U.likeRepostBtn} ${Te[ae.post.uri]?U.likeRepostBtnDownvoteActive:""}`,onClick:()=>cs(ae.post.uri,ae.post.cid,Te[ae.post.uri]??null),disabled:Qe===ae.post.uri,title:Te[ae.post.uri]?"Remove downvote":"Downvote (syncs across AT Protocol)","aria-label":Te[ae.post.uri]?"Remove downvote":"Downvote",children:[Qe===ae.post.uri?"…":"↓"," Downvote",(()=>{const e=Be[ae.post.uri]??ae.post.downvoteCount??0,t=He[ae.post.uri]??0,s=Math.max(0,e+t);return s>0?` ${s}`:""})()]}),e.jsxs("div",{className:U.repostWrap,ref:xt,children:[e.jsxs("button",{type:"button",className:`${U.likeRepostBtn} ${Yt?U.likeRepostBtnActive:""} ${et?U.repostTriggerOpen:""}`,onClick:()=>tt(e=>!e),disabled:qe,title:Yt?"Remove repost":"Repost or quote","aria-expanded":et,"aria-haspopup":"true",children:[e.jsx("span",{className:U.likeRepostBtnIcon,"aria-hidden":!0,children:e.jsx(V,{})}),qe?"…":"Repost ▾"]}),et&&e.jsxs("div",{className:U.repostDropdown,role:"menu",children:[e.jsx("button",{type:"button",className:U.repostDropdownItem,role:"menuitem",onClick:()=>{tt(!1),async function(){if(!ae||!O(ae)||qe)return;const{uri:e,cid:t}=ae.post;Re(!0);try{if(Yt)await a.deleteRepost(Xt),De(null);else{const s=await a.repost(e,t);De(s.uri)}}catch{}finally{Re(!1)}}()},disabled:qe,children:Yt?"Remove repost":"Repost"}),e.jsx("button",{type:"button",className:U.repostDropdownItem,role:"menuitem",onClick:function(){tt(!1),ot(!0),nt(""),it([]),ct([]),pt(null)},disabled:!Ft?.did,children:"Quote post"})]})]}),ae&&O(ae)&&e.jsxs("button",{type:"button",className:U.likeRepostBtn,onClick:()=>te(ae.post.uri),title:"View posts that quote this","aria-label":"View quotes",children:[e.jsx("span",{className:U.likeRepostBtnIcon,"aria-hidden":!0,children:e.jsx(z,{})}),"View Quotes"]}),ae&&O(ae)&&e.jsx(L,{postUri:ae.post.uri,postCid:ae.post.cid,authorDid:ae.post.author.did,rootUri:ae.post.uri,isOwnPost:Ft?.did===ae.post.author.did,compact:!0,verticalIcon:!0,open:_e===ae.post.uri,onOpenChange:e=>Ge(e?ae.post.uri:null),onHidden:()=>B("/feed"),postedAt:ae.post.record?.createdAt,onViewQuotes:te})]}),fe&&e.jsxs("p",{className:U.added,children:["Added to ",Ut.find(e=>e.id===fe)?.name]})]})]}),ae&&O(ae)&&e.jsx("div",{className:U.inlineReplyFormWrap,children:e.jsx("div",{children:e.jsxs("form",{ref:Pt,onSubmit:async function(e){if(e.preventDefault(),!ae||!O(ae)||!de.trim())return;const t=ae.post;pe(!0);try{await h(t.uri,t.cid,t.uri,t.cid,de.trim()),ue(""),await ns()}catch(s){alert(s instanceof Error?s.message:"Failed to post comment")}finally{pe(!1)}},className:U.commentForm,children:[zt&&e.jsx("div",{className:U.inlineReplyFormHeader,children:$t&&Tt?.did?e.jsx(W,{replyAs:zt,sessionsList:$t,switchAccount:Bt,currentDid:Tt.did}):e.jsxs("p",{className:U.replyAs,children:[e.jsx("span",{className:U.replyAsLabel,children:"Replying as"}),e.jsxs("span",{className:U.replyAsUserChip,children:[zt.avatar?e.jsx("img",{src:zt.avatar,alt:"",className:U.replyAsAvatar,loading:"lazy"}):e.jsx("span",{className:U.replyAsAvatarPlaceholder,"aria-hidden":!0,children:zt.handle.slice(0,1).toUpperCase()}),e.jsxs("span",{className:U.replyAsHandle,children:["@",zt.handle]})]})]})}),e.jsx(S,{placeholder:"Write a comment…",value:de,onChange:ue,onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),de.trim()&&!me&&Pt.current?.requestSubmit())},className:U.textarea,rows:3,maxLength:300}),e.jsx("p",{className:U.hint,children:"⌘ Enter or ⌘ E to post"}),e.jsx("button",{type:"submit",className:U.submit,disabled:me||!de.trim(),children:me?"Posting…":"Post comment"})]})})}),"replies"in ae&&Array.isArray(ae.replies)&&ae.replies.length>0&&e.jsxs("div",{ref:bt,className:`${U.replies} ${U.repliesTopLevel}`,children:[e.jsxs("div",{className:U.commentSortRow,children:[e.jsx("label",{htmlFor:"comment-sort",className:U.commentSortLabel,children:"Sort:"}),e.jsxs("select",{id:"comment-sort",className:U.commentSortSelect,value:qt,onChange:e=>Rt(e.target.value),"aria-label":"Comment sort order",children:[e.jsx("option",{value:"newest",children:"Newest"}),e.jsx("option",{value:"oldest",children:"Oldest"}),e.jsx("option",{value:"likes",children:"Most liked"}),e.jsx("option",{value:"score",children:"Score (↑ − ↓)"}),e.jsx("option",{value:"controversial",children:"Controversial"}),e.jsx("option",{value:"best",children:"Best"})]})]}),e.jsx("div",{onFocusCapture:e=>{if(P)return;const t=e.target,s=t.closest?.("[data-comment-uri]");if(!s)return;const o=s.getAttribute("data-comment-uri");if(!o)return;const a=t.closest?.("[data-media-item]");if(a){const e=a.getAttribute("data-media-item");if(null!=e){const t=Cs.findIndex(t=>"commentMedia"===t.type&&t.commentUri===o&&t.mediaIndex===parseInt(e,10));t>=0&&St(t)}return}const n=Cs.findIndex(e=>"comment"===e.type&&e.commentUri===o);if(n>=0){St(n);const e=Ns.findIndex(e=>e.uri===o);e>=0&&wt(e)}},children:gs.map((t,s)=>{const o=Cs[Lt],a="comment"===o?.type||"commentMedia"===o?.type?o.commentUri:void 0,n=Cs.findIndex(e=>"comment"===e.type&&e.commentUri===t.post.uri),r=hs&&"comment"===o?.type&&o.commentUri===t.post.uri;if(ye.has(t.post.uri)){const o="replies"in t&&Array.isArray(t.replies)?t.replies.length:0,a=0===o?"Comment":`${o} reply${1!==o?"s":""}`,i=t.post.author?.handle??t.post.author?.did??"";return e.jsx("div",{className:U.topLevelCommentWrap,"data-comment-uri":t.post.uri,tabIndex:-1,onMouseEnter:()=>{!P&&n>=0&&(St(n),wt(Ns.findIndex(e=>e.uri===t.post.uri)))},children:e.jsx("div",{className:`${U.collapsedCommentWrap} ${r?U.commentFocused:""}`,style:{marginLeft:0},onFocus:()=>!P&&n>=0&&St(n),children:e.jsxs("button",{type:"button",className:U.collapsedCommentBtn,onClick:()=>Zt(t.post.uri),children:[e.jsx("span",{className:U.collapsedCommentExpandIcon,"aria-hidden":!0,children:"+"}),t.post.author?.avatar?e.jsx("img",{src:t.post.author.avatar,alt:"",className:U.collapsedCommentAvatar,loading:"lazy"}):e.jsx("span",{className:U.collapsedCommentAvatarPlaceholder,"aria-hidden":!0,children:i.slice(0,1).toUpperCase()}),e.jsxs("span",{className:U.collapsedCommentHandle,children:["@",i]}),e.jsx("span",{className:U.collapsedCommentLabel,children:a})]})})},`${t.post.uri}-${s}`)}return e.jsx("div",{className:U.topLevelCommentWrap,onMouseEnter:()=>{!P&&n>=0&&(St(n),wt(Ns.findIndex(e=>e.uri===t.post.uri)))},children:e.jsx(Y,{node:t,depth:0,collapsedThreads:ye,onToggleCollapse:Zt,onReply:is,rootPostUri:ae.post.uri,rootPostCid:ae.post.cid,replyingTo:Me,replyComment:de,setReplyComment:ue,onReplySubmit:rs,replyPosting:me,clearReplyingTo:()=>Ie(null),commentFormRef:yt,replyAs:zt,sessionsList:$t,switchAccount:Bt,currentDid:Tt?.did??void 0,focusedCommentUri:a,onCommentMediaFocus:As,onLike:Tt?ls:void 0,onDownvote:Tt?cs:void 0,likeOverrides:Ue,myDownvotes:Te,downvoteCounts:Be,downvoteCountOptimisticDelta:He,likeLoadingUri:We,downvoteLoadingUri:Qe,openActionsMenuCommentUri:_e,onActionsMenuOpenChange:(e,t)=>Ge(t?e:null),onViewQuotes:te})},`${t.post.uri}-${s}`)})})]}),ae&&O(ae)&&"replies"in ae&&Array.isArray(ae.replies)&&ae.replies.length>=6&&(!Me||Me.uri===ae.post.uri)&&e.jsx("div",{className:U.inlineReplyFormWrap,children:e.jsx("div",{ref:jt,tabIndex:-1,className:At?U.commentFormWrapFocused:void 0,onFocus:()=>!P&&St(Cs.length-1),onMouseEnter:()=>!P&&St(Cs.length-1),onBlur:()=>{requestAnimationFrame(()=>{yt.current?.contains(document.activeElement)||kt(!1)})},children:e.jsxs("form",{ref:yt,onSubmit:rs,className:U.commentForm,children:[zt&&e.jsxs("div",{className:U.inlineReplyFormHeader,children:[Me&&e.jsx("button",{type:"button",className:U.cancelReply,onClick:()=>Ie(null),"aria-label":"Cancel reply",children:"×"}),$t&&Tt?.did?e.jsx(W,{replyAs:zt,sessionsList:$t,switchAccount:Bt,currentDid:Tt.did}):e.jsxs("p",{className:U.replyAs,children:[e.jsx("span",{className:U.replyAsLabel,children:"Replying as"}),e.jsxs("span",{className:U.replyAsUserChip,children:[zt.avatar?e.jsx("img",{src:zt.avatar,alt:"",className:U.replyAsAvatar,loading:"lazy"}):e.jsx("span",{className:U.replyAsAvatarPlaceholder,"aria-hidden":!0,children:zt.handle.slice(0,1).toUpperCase()}),e.jsxs("span",{className:U.replyAsHandle,children:["@",zt.handle]})]})]})]}),e.jsx(S,{placeholder:Me?`Reply to @${Me.handle}…`:"Write a comment…",value:de,onChange:ue,onKeyDown:e=>{"Enter"!==e.key&&"E"!==e.key||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),de.trim()&&!me&&yt.current?.requestSubmit())},className:U.textarea,rows:3,maxLength:300}),e.jsx("p",{className:U.hint,children:"⌘ Enter or ⌘ E to post"}),e.jsx("button",{type:"submit",className:U.submit,disabled:me||!de.trim(),children:me?"Posting…":"Post comment"})]})})})]}),st&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:U.quoteComposerBackdrop,onClick:os,"aria-hidden":!0}),e.jsx("div",{className:U.quoteComposerOverlay,role:"dialog","aria-label":"Quote post",onClick:os,onDragOver:e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"},onDrop:e=>{e.preventDefault(),e.dataTransfer?.files?.length&&ss(e.dataTransfer.files)},children:e.jsxs("div",{className:U.quoteComposerCard,onClick:e=>e.stopPropagation(),children:[e.jsx("h2",{className:U.quoteComposerTitle,children:"Quote post"}),Ft?.did?e.jsxs(e.Fragment,{children:[ae&&O(ae)&&(()=>{const t=ae.post,s=t.author?.handle??t.author?.did??"",o=t.record?.text??"",a=l(t)[0];return e.jsxs("div",{className:U.quoteComposerQuotedWrap,children:[e.jsx("p",{className:U.quotedPostLabel,children:"Quoting"}),e.jsxs("div",{className:U.quoteComposerQuotedCard,children:[e.jsxs("div",{className:U.quotedPostHead,children:[t.author?.avatar?e.jsx("img",{src:t.author.avatar,alt:"",className:U.quotedPostAvatar,loading:"lazy"}):e.jsx("span",{className:U.quotedPostAvatarPlaceholder,"aria-hidden":!0,children:s.slice(0,1).toUpperCase()}),e.jsxs("span",{className:U.quotedPostHandle,children:["@",s]}),t.record?.createdAt&&e.jsx("span",{className:U.quotedPostTime,title:R(t.record.createdAt),children:q(t.record.createdAt)})]}),a&&e.jsx("div",{className:U.quotedPostMedia,children:"image"===a.type?e.jsx("img",{src:a.url,alt:"",loading:"lazy",className:U.quotedPostThumb}):a.videoPlaylist?e.jsx("div",{className:U.quotedPostVideoThumb,style:{backgroundImage:a.url?`url(${a.url})`:void 0}}):null}),o?e.jsx("p",{className:U.quotedPostText,children:e.jsx(I,{text:o,facets:t.record?.facets,maxLength:300,stopPropagation:!0})}):null]})]})})(),e.jsxs("form",{onSubmit:as,onKeyDown:e=>{(e.metaKey||e.ctrlKey)&&"Enter"===e.key&&(e.preventDefault(),as(e))},children:[e.jsx(S,{className:U.quoteComposerTextarea,value:at,onChange:nt,placeholder:"Add your thoughts...",rows:4,maxLength:300,disabled:dt,autoFocus:!0}),rt.length>0&&e.jsxs("div",{className:U.quoteComposerMediaSection,children:[e.jsx("div",{className:U.quoteComposerPreviews,children:rt.map((t,s)=>e.jsxs("div",{className:U.quoteComposerPreviewWrap,children:[e.jsx("img",{src:us[s],alt:"",className:U.quoteComposerPreviewImg}),e.jsx("button",{type:"button",className:U.quoteComposerPreviewRemove,onClick:()=>{return e=s,it(t=>t.filter((t,s)=>s!==e)),void ct(t=>t.filter((t,s)=>s!==e));var e},"aria-label":"Remove image",disabled:dt,children:"×"})]},s))}),e.jsx("p",{className:U.quoteComposerAltPrompt,children:"Describe each image for accessibility (alt text)."}),e.jsx("div",{className:U.quoteComposerAltFields,children:rt.map((t,s)=>e.jsxs("div",{className:U.quoteComposerAltRow,children:[e.jsxs("label",{htmlFor:`quote-alt-${s}`,className:U.quoteComposerAltLabel,children:["Image ",s+1]}),e.jsx("input",{id:`quote-alt-${s}`,type:"text",className:U.quoteComposerAltInput,placeholder:"Describe this image",value:lt[s]??"",onChange:e=>{const t=e.target.value.slice(0,1e3);ct(e=>{const o=[...e];for(;o.length<rt.length;)o.push("");return o[s]=t,o})},maxLength:1e3,disabled:dt})]},s))})]}),e.jsxs("div",{className:U.quoteComposerFooter,children:[e.jsxs("div",{className:U.quoteComposerFooterLeft,children:[e.jsx("input",{ref:ht,type:"file",accept:"image/jpeg,image/png,image/gif,image/webp",multiple:!0,className:U.quoteComposerFileInput,onChange:e=>{e.target.files?.length&&ss(e.target.files),e.target.value=""}}),e.jsx("button",{type:"button",className:U.quoteComposerAddMedia,onClick:()=>ht.current?.click(),disabled:dt||rt.length>=4,title:"Add photo","aria-label":"Add photo",children:"Add media"}),e.jsx(E,{used:at.length,max:300})]}),e.jsxs("div",{className:U.quoteComposerActions,children:[e.jsx("button",{type:"button",className:U.quoteComposerCancel,onClick:os,disabled:dt,children:"Cancel"}),e.jsx("button",{type:"submit",className:U.quoteComposerSubmit,disabled:dt||!at.trim()&&0===rt.length,children:dt?"Posting…":"Quote post"})]})]}),mt&&e.jsx("p",{className:U.quoteComposerError,children:mt})]})]}):e.jsx("p",{className:U.quoteComposerSignIn,children:"Log in to quote posts."})]})})]})]});return P?qs:e.jsx(D,{title:"Post",showNav:!0,children:qs})}const ee=Object.freeze(Object.defineProperty({__proto__:null,PostDetailContent:Z,ReplyAsRow:W,default:function(){const{uri:t}=j(),s=y(),o=g(),a=t?decodeURIComponent(t):"";return a?e.jsx(D,{title:"Post",showNav:!0,children:e.jsx(Z,{uri:a,initialOpenReply:o.state?.openReply})}):(s("/feed",{replace:!0}),null)}},Symbol.toStringTag,{value:"Module"}));export{Z as P,W as R,ee as a,T as g};
