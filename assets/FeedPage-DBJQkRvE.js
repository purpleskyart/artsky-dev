import{u as e,g as t,a as n,b as s,c as r,d as o,j as a,e as i,i as l,f as c,h as u,k as d,l as f,m,n as h,o as p,p as g,q as x,r as y,s as w,t as _,v,w as b,x as E,y as j}from"./index-8GKR_g2p.js";import{r as M,a as S,u as N,e as T,i as k}from"./react-vendor-rw3WIpbI.js";import{u as R,F as I,L as A}from"./Layout-moAaamW7.js";import{u as C}from"./usePullToRefresh-QiYvLiof.js";import{u as O}from"./virtual-SmD9oKU4.js";import{P as F}from"./PostCard-Dh7fyk6s.js";import{setInitialPostForUri as L}from"./postCache-CTqU0alO.js";import{s as P}from"./FeedPage.module-BXQsl3XB.js";import"./atproto-JNpM3I1p.js";import"./Icons-kH7Jsgwf.js";import"./PostText-Daqt1fz_.js";import"./PostActionsMenu-Bm4IHsgk.js";import"./date-Ct-NsrQr.js";import"./artboards-DNvSVVrd.js";import"./artboardsPds-DWUixJ9h.js";function D(e,t){let n;return function(...s){void 0!==n&&clearTimeout(n),n=setTimeout(()=>{n=void 0,e(...s)},t)}}function U(e,t=150){const n=function(e=150){const[t,n]=M.useState(()=>"undefined"!=typeof window?window.innerWidth:0);return M.useEffect(()=>{const t=D(()=>{n(window.innerWidth)},e);return n(window.innerWidth),window.addEventListener("resize",t,{passive:!0}),()=>{window.removeEventListener("resize",t)}},[e]),t}(t);return M.useMemo(()=>{const t="1"===e?1:"2"===e?2:3;return Math.min(3,Math.max(1,t))},[e,n])}const B="artsky-recommendations-shown";function H(){try{const e=localStorage.getItem(B);if(!e)return{};const t=JSON.parse(e);return"object"==typeof t&&null!==t?t:{}}catch{return{}}}const $="_wrap_ljlgs_1",Y="_subtext_ljlgs_10",z="_sortRow_ljlgs_18",q="_sortLabel_ljlgs_26",K="_sortSelect_ljlgs_31",W="_loading_ljlgs_46",G="_empty_ljlgs_47",V="_list_ljlgs_54",J="_item_ljlgs_65",X="_profileBtn_ljlgs_72",Q="_avatar_ljlgs_97",Z="_avatarPlaceholder_ljlgs_106",ee="_info_ljlgs_121",te="_handle_ljlgs_127",ne="_reason_ljlgs_135",se="_actions_ljlgs_140",re="_infoBtn_ljlgs_150",oe="_infoIcon_ljlgs_174",ae="_followBtn_ljlgs_179",ie="_dismissBtn_ljlgs_199",le="_detailBackdrop_ljlgs_226",ce="_detailPanel_ljlgs_237",ue="_detailHeader_ljlgs_250",de="_detailTitle_ljlgs_258",fe="_detailClose_ljlgs_265",me="_detailBody_ljlgs_284",he="_detailSummary_ljlgs_289",pe="_detailList_ljlgs_295",ge="_detailListItem_ljlgs_304",xe="_detailProfileBtn_ljlgs_308",ye="_detailAvatar_ljlgs_332",we="_detailAvatarPlaceholder_ljlgs_340",_e="_detailProfileInfo_ljlgs_354",ve="_detailDisplayName_ljlgs_360",be="_detailHandle_ljlgs_368",Ee="_detailLoading_ljlgs_376";function je(){const{openProfileModal:i}=e(),[l,c]=M.useState([]),[u,d]=M.useState(!1),[f,m]=M.useState(null),[h,p]=M.useState(()=>new Set),[g,x]=M.useState("count"),[y,w]=M.useState(null),[_,v]=M.useState(null),[b,E]=M.useState(!1),j=M.useMemo(()=>l,[l]),N=M.useCallback(async()=>{const e=t(),o=e?.did;if(o){d(!0);try{const e="mutuals"===g?await n(s,o,{maxSuggestions:20}):await r(s,o,{maxSuggestions:20}),t=H(),a=Date.now()-6048e5,i=e.filter(e=>!h.has(e.did)&&(!t[e.did]||t[e.did]<a)).slice(0,8);c(i)}catch{c([])}finally{d(!1)}}},[h,g]);M.useEffect(()=>{N()},[N]);const T=M.useCallback(async e=>{w(e.did),v(null),E(!0);try{const n=t(),r=n?.did;if(!r)return;const a=await o(s,r,e.did,{source:"mutuals"===g?"mutuals":"peopleYouFollow"});v(a)}catch{v({count:0,followedBy:[]})}finally{E(!1)}},[g]),k=M.useCallback(async(e,t)=>{m(e);try{await s.follow(e),c(t=>t.filter(t=>t.did!==e))}catch{}finally{m(null)}},[]),R=M.useCallback(e=>{!function(e){if(0===e.length)return;const t=Date.now(),n={...H()};for(const o of e)n[o]=t;const s=Object.entries(n),r=s.length<=500?s:s.sort((e,t)=>(t[1]??0)-(e[1]??0)).slice(0,500);try{localStorage.setItem(B,JSON.stringify(Object.fromEntries(r)))}catch{}}([e]),p(t=>new Set(t).add(e)),c(t=>t.filter(t=>t.did!==e))},[]),I=y?l.find(e=>e.did===y):null;return a.jsxs("div",{className:$,"aria-label":"Suggested accounts to follow",children:[a.jsx("p",{className:Y,children:"Accounts followed by people you follow. New suggestions each time you open."}),l.length>0&&a.jsxs("div",{className:z,children:[a.jsx("span",{className:q,children:"Sort by:"}),a.jsxs("select",{className:K,value:g,onChange:e=>x(e.target.value),"aria-label":"Sort suggestions",children:[a.jsx("option",{value:"count",children:"Most followed by people you follow"}),a.jsx("option",{value:"mutuals",children:"Most followed by mutuals"})]})]}),u&&0===l.length?a.jsx("p",{className:W,children:"Loading…"}):0===l.length?a.jsx("p",{className:G,children:"No suggestions right now. Follow more accounts to see recommendations."}):a.jsx("ul",{className:V,children:j.map(e=>a.jsxs("li",{className:J,children:[a.jsxs("button",{type:"button",className:X,onClick:()=>i(e.handle),"aria-label":`View @${e.handle} profile`,children:[e.avatar?a.jsx("img",{src:e.avatar,alt:"",className:Q,loading:"lazy"}):a.jsx("span",{className:Z,"aria-hidden":!0,children:(e.displayName??e.handle).slice(0,1).toUpperCase()}),a.jsxs("span",{className:ee,children:[a.jsxs("span",{className:te,children:["@",e.handle]}),a.jsx("span",{className:ne,children:"mutuals"===g?1===e.count?"Followed by 1 mutual":`Followed by ${e.count} mutuals`:1===e.count?"Followed by 1 person you follow":`Followed by ${e.count} people you follow`})]})]}),a.jsxs("div",{className:se,children:[a.jsx("button",{type:"button",className:re,onClick:t=>{t.stopPropagation(),T(e)},"aria-label":"Why we recommend this account",title:"Why we recommend this account",children:a.jsx(Me,{})}),a.jsx("button",{type:"button",className:ae,onClick:()=>k(e.did,e.handle),disabled:f===e.did,children:f===e.did?"…":"Follow"}),a.jsx("button",{type:"button",className:ie,onClick:()=>R(e.did),"aria-label":"Not now",title:"Hide this suggestion for a week",children:"×"})]})]},e.did))}),y&&I&&S.createPortal(a.jsx("div",{className:le,role:"dialog","aria-modal":"true","aria-labelledby":"suggestion-detail-title",onClick:()=>w(null),children:a.jsxs("div",{className:ce,onClick:e=>e.stopPropagation(),children:[a.jsxs("div",{className:ue,children:[a.jsxs("h3",{id:"suggestion-detail-title",className:de,children:["Why we recommend @",I.handle]}),a.jsx("button",{type:"button",className:fe,onClick:()=>w(null),"aria-label":"Close",children:"×"})]}),b?a.jsx("p",{className:Ee,children:"Loading…"}):_?a.jsxs("div",{className:me,children:[a.jsx("p",{className:he,children:_.fromMutuals?1===_.count?"Followed by 1 mutual:":`Followed by ${_.count} mutuals:`:1===_.count?"Followed by 1 person you follow:":`Followed by ${_.count} people you follow:`}),a.jsx("ul",{className:pe,children:_.followedBy.map(e=>a.jsx("li",{className:ge,children:a.jsxs("button",{type:"button",className:xe,onClick:()=>{i(e.handle),w(null)},children:[e.avatar?a.jsx("img",{src:e.avatar,alt:"",className:ye,loading:"lazy"}):a.jsx("span",{className:we,"aria-hidden":!0,children:(e.displayName??e.handle).slice(0,1).toUpperCase()}),a.jsxs("span",{className:_e,children:[e.displayName&&a.jsx("span",{className:ve,children:e.displayName}),a.jsxs("span",{className:be,children:["@",e.handle]})]})]})},e.did))})]}):null]})}),document.body)]})}function Me(){return a.jsx("svg",{className:oe,viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":!0,children:a.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})}const Se=M.memo(function(e){const t=M.useRef(null);return function(e,t){const[n,s]=M.useState(!0),r=M.useRef(null);M.useEffect(()=>{const n=e.current;if(n)return r.current=new IntersectionObserver(e=>{for(const t of e)s(t.isIntersecting)},{rootMargin:t?.rootMargin??"400px 0px 400px 0px",threshold:t?.threshold??0,...t}),r.current.observe(n),()=>{r.current&&(r.current.disconnect(),r.current=null)}},[e,t])}(t,{rootMargin:"1200px 0px 1200px 0px",threshold:0}),a.jsx(F,{...e,cardRef:n=>{t.current=n,e.cardRef(n)},onAspectRatio:void 0})}),Ne="_wrap_a6pg0_1",Te="_seen_a6pg0_11",ke="_header_a6pg0_15",Re="_repostIcon_a6pg0_25",Ie="_title_a6pg0_32",Ae="_scrollWrap_a6pg0_38",Ce="_track_a6pg0_54",Oe="_tile_a6pg0_60",Fe="_tileImg_a6pg0_86",Le="_tilePlaceholder_a6pg0_94",Pe="_tileHandle_a6pg0_107";function De(){return a.jsx("svg",{className:Re,viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":!0,children:a.jsx("path",{d:"M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"})})}function Ue({items:e,onPostClick:t,cardRef:n,seen:s,"data-post-uri":r}){if(0===e.length)return null;const o=e=>e.reason?.by;return a.jsxs("div",{ref:n,className:`${Ne} ${s?Te:""}`,"data-post-uri":r??e[0]?.post?.uri,role:"article","aria-label":`${e.length} reposts`,children:[a.jsxs("div",{className:ke,children:[a.jsx(De,{}),a.jsxs("span",{className:Ie,children:[e.length," reposts"]})]}),a.jsx("div",{className:Ae,children:a.jsx("div",{className:Ce,children:e.map(e=>{const n=e.post.uri,s=(e=>o(e)?.handle??o(e)?.did??e.post.author?.handle??e.post.author?.did??"")(e),r=i(e.post),l=e.post.author?.avatar,c=r?.url??l;return a.jsxs("button",{type:"button",className:Oe,onClick:()=>t(n,{initialItem:e}),"aria-label":s?`Repost by @${s}, open post`:"Open post",children:[c?a.jsx("img",{src:c,alt:"",className:Fe,loading:"lazy"}):a.jsx("span",{className:Le,children:(e.post.author?.displayName??s??e.post.author?.did??"?").slice(0,1).toUpperCase()}),s?a.jsxs("span",{className:Pe,children:["@",s]}):null]},n)})})})]})}const Be=100;function He({column:e,scrollMargin:t,loadMoreSentinelRef:n,hasCursor:s,keyboardFocusIndex:r,focusTargets:o,focusSetByMouse:i,keyboardAddOpen:u,actionsMenuOpenForIndex:d,nsfwPreference:f,unblurredUris:m,setUnblurred:h,likeOverrides:p,setLikeOverrides:g,seenUris:x,openPostModal:y,cardRef:w,onMediaRef:_,onActionsMenuOpenChange:v,onMouseEnter:b,onAddClose:E}){const j=O({count:e.length,estimateSize:t=>function(e){if("carousel"===e.type)return 200;const t=c(e.item.post);if(0===t.length){const t=e.item.post.record?.text||"",n=Math.ceil(t.length/50),s=Math.min(20*n,200);return Be+s}if(t.length>1){const e=1/t.reduce((e,t)=>e+1/(t.aspectRatio||1),0),n=Math.ceil(280/e);return Be+n+4*(t.length-1)}const n=t[0];if(null!=n.aspectRatio&&n.aspectRatio>0){const e=Math.ceil(280/n.aspectRatio);return Be+Math.min(Math.max(e,150),600)}return 320}(e[t].entry),overscan:15,scrollMargin:t,gap:6,lanes:1,scrollToFn:()=>{}}),S=j.getVirtualItems(),N=j.getTotalSize(),T=M.useRef(-1),k=M.useRef(new Set),R=M.useRef(e.length);if(R.current!==e.length){const t=new Set;for(let n=0;n<Math.min(R.current,e.length);n++)k.current.has(n)&&t.add(n);k.current=t,R.current=e.length}return 0===e.length?a.jsx("div",{className:P.gridColumn,children:s&&null!=n&&a.jsx("div",{ref:n,className:P.loadMoreSentinel,"aria-hidden":!0})}):a.jsxs("div",{className:P.gridColumn,children:[a.jsx("div",{style:{height:`${N}px`,width:"100%",position:"relative"},children:S.map(t=>{const{entry:n,originalIndex:s}=e[t.index],M="post"===n.type?`${n.item.post.uri}-${s}`:`carousel-${n.items[0].post.uri}-${s}`;return a.jsx("div",{"data-index":t.index,ref:e=>{if(!e)return;const n=e.getBoundingClientRect(),r=window.innerHeight;(n.top<r+2e3||!k.current.has(t.index)||n.bottom<0)&&(j.measureElement(e),k.current.add(t.index),T.current=Math.max(T.current,t.index)),w(s)(e)},className:P.gridItem,"data-selected":o[r]?.cardIndex===s||void 0,"data-post-uri":"post"===n.type?n.item.post.uri:n.items[0].post.uri,style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${t.start-j.options.scrollMargin}px)`},onMouseEnter:()=>b(s),children:"post"===n.type?a.jsx(Se,{item:n.item,isSelected:o[r]?.cardIndex===s,focusedMediaIndex:o[r]?.cardIndex!==s||i&&c(n.item.post).length>1?void 0:o[r]?.mediaIndex,onMediaRef:(e,t)=>_(s,e,t),cardRef:()=>{},openAddDropdown:o[r]?.cardIndex===s&&u,onAddClose:E,onActionsMenuOpenChange:e=>v(s,e),cardIndex:s,actionsMenuOpenForIndex:d,onPostClick:(e,t)=>{t?.initialItem&&L(e,t.initialItem),y(e,t?.openReply)},fillCell:!1,nsfwBlurred:"blurred"===f&&l(n.item.post)&&!m.has(n.item.post.uri),onNsfwUnblur:()=>h(n.item.post.uri,!0),likedUriOverride:p[n.item.post.uri],onLikedChange:(e,t)=>g(e,t??null),seen:x.has(n.item.post.uri)}):a.jsx(Ue,{items:n.items,onPostClick:(e,t)=>{t?.initialItem&&L(e,t.initialItem),y(e)},cardRef:()=>{},seen:x.has(n.items[0].post.uri),"data-post-uri":n.items[0].post.uri})},M)})}),s&&null!=n&&a.jsx("div",{ref:n,className:P.loadMoreSentinel,"aria-hidden":!0})]})}function $e(e,t){switch(t.type){case"SET_ITEMS":return{...e,items:t.items,cursor:t.cursor,loading:!1,error:null};case"APPEND_ITEMS":return{...e,items:[...e.items,...t.items],cursor:t.cursor,loadingMore:!1,error:null};case"UPDATE_ITEMS":return{...e,items:t.updater(e.items)};case"SET_LOADING":return{...e,loading:t.loading};case"SET_LOADING_MORE":return{...e,loadingMore:t.loadingMore};case"SET_ERROR":return{...e,error:t.error,loading:!1,loadingMore:!1};case"SET_KEYBOARD_FOCUS":return{...e,keyboardFocusIndex:t.index};case"SET_ACTIONS_MENU_OPEN":return{...e,actionsMenuOpenForIndex:t.index};case"MARK_SEEN":{const n=new Set(e.seenUris);if(t.uris.forEach(e=>n.add(e)),n.size>2500){const t=Array.from(n),s=new Set(t.slice(-2e3));return{...e,seenUris:s}}return{...e,seenUris:n}}case"RESET_SEEN_SNAPSHOT":return{...e,seenUrisAtReset:new Set(e.seenUris)};case"CLEAR_SEEN":return{...e,seenUris:new Set,seenUrisAtReset:new Set};default:return e}}function Ye(e){const t=new Set;return e.filter(e=>{const n=e?.post?.uri;return!(!n||t.has(n))&&(t.add(n),!0)})}const ze="artsky-seen-posts";function qe(){const e=p.get(ze);return e&&Array.isArray(e)?new Set(e):new Set}const Ke=[{kind:"timeline",label:"Following"},{kind:"custom",label:"What's Hot",uri:"at://did:plc:z72i7hdynmk6r22z27h6tvur/app.bsky.feed.generator/whats-hot"}];function We(e){if("undefined"==typeof window)return()=>{};const t=window.matchMedia("(min-width: 768px)");return t.addEventListener("change",e),()=>t.removeEventListener("change",e)}function Ge(){return"undefined"!=typeof window&&window.innerWidth>=768}function Ve(e){return"app.bsky.feed.defs#reasonRepost"===e.reason?.$type}function Je(e){const t=e.post.record?.createdAt,n=e.post.indexedAt,s=t??n??"";return s?new Date(s).getTime():0}function Xe(e){const t=[];let n=0,s=[],r=0,o=0;function a(){if(s.length>=4)t.push({type:"carousel",items:[...s],entryIndex:n++});else for(const e of s)t.push({type:"post",item:e,entryIndex:n++});s=[]}for(const i of e){if(!Ve(i)){a(),t.push({type:"post",item:i,entryIndex:n++});continue}const e=Je(i);if(0===s.length){s.push(i),r=e,o=e;continue}const l=Math.min(r,e),c=Math.max(o,e);c-l<=36e5?(s.push(i),r=l,o=c):(a(),s=[i],r=e,o=e)}return a(),t}function Qe(e){if("carousel"===e.type)return 200;const t=i(e.item.post);return t?null!=t.aspectRatio&&t.aspectRatio>0?100+280/t.aspectRatio:320:180}function Ze(e,t){const n=Math.max(e.top,t.top),s=Math.min(e.bottom,t.bottom);return Math.max(0,s-n)}function et(){const t=N(),n=T(),r=k(),o=M.useSyncExternalStore(We,Ge,()=>!1),{openLoginModal:S}=u(),{session:O}=d(),{viewMode:F}=f(),[L,B]=M.useState(Ke[0]),[,H]=M.useState([]),{likeOverrides:$,setLikeOverride:Y}=m(),[z,q]=M.useReducer($e,{items:[],cursor:void 0,loading:!0,loadingMore:!1,error:null,keyboardFocusIndex:-1,actionsMenuOpenForIndex:null,seenUris:qe(),seenUrisAtReset:new Set}),K=M.useRef([]),W=M.useRef(!1),G=M.useRef(0),[V,J]=M.useState(!1),{openPostModal:X,isModalOpen:Q}=e(),Z=M.useRef([]),ee=M.useRef({}),te=M.useRef([]),ne=M.useRef(-1),se=M.useRef(null),re=M.useRef(-1),oe=M.useRef(!1),ae=M.useRef(!1),[ie,le]=M.useState(!1),[ce,ue]=M.useState(!1),[de,fe]=M.useState(null),me=M.useRef(null),he=M.useRef(null),pe=M.useRef(t.pathname),ge=M.useRef(z.seenUris);ge.current=z.seenUris;const xe=h(),[ye,we]=M.useState(!1),_e=M.useRef(null),[ve,be]=M.useState(0);M.useEffect(()=>{if(xe)return xe.setClearSeenHandler(()=>{requestAnimationFrame(()=>{p.remove(ze),ge.current=new Set,q({type:"CLEAR_SEEN"})})}),()=>{xe.setClearSeenHandler(null)}},[xe]),M.useEffect(()=>{if(xe)return xe.setHomeClickHandler(()=>{requestAnimationFrame(()=>{window.scrollTo(0,0)})}),()=>{xe.setHomeClickHandler(null)}},[xe]),M.useEffect(()=>{if(xe)return xe.setHideSeenOnlyHandler(e=>{requestAnimationFrame(()=>{const t=ge.current.size;q({type:"RESET_SEEN_SNAPSHOT"}),e(0===t?"No read posts in feed":`${t} read posts hidden`)})}),()=>{xe.setHideSeenOnlyHandler(null)}},[xe]);const Ee=M.useCallback(async()=>{if(O)try{const e=(await g()).filter(e=>"feed"===e.type&&e.pinned),t=await Promise.all(e.map(async e=>({kind:"custom",label:await x(e.value).catch(()=>e.value),uri:e.value})));H(t)}catch{H([])}else H([])},[O]);M.useEffect(()=>{Ee()},[Ee]),M.useEffect(()=>{let e;let t="undefined"!=typeof window?window.scrollY:0,n=t;const s=D(()=>{const s=window.scrollY,r=document.body.classList.contains("feed-scrolling"),o=s<n;if(n=s,o)return r&&(document.body.classList.remove("feed-scrolling"),e&&(clearTimeout(e),e=void 0)),void(t=s);r?(e&&clearTimeout(e),e=setTimeout(()=>{document.body.classList.remove("feed-scrolling"),t=window.scrollY,e=void 0},200)):s-t>=48&&(document.body.classList.add("feed-scrolling"),e&&clearTimeout(e),e=setTimeout(()=>{document.body.classList.remove("feed-scrolling"),t=window.scrollY,e=void 0},200))},16);return window.addEventListener("scroll",s,{passive:!0}),()=>{window.removeEventListener("scroll",s),e&&clearTimeout(e),document.body.classList.remove("feed-scrolling")}},[]),M.useEffect(()=>{const e=pe.current!==t.pathname;pe.current=t.pathname,"POP"!==r&&e&&window.scrollTo(0,0)},[t.pathname,r]),M.useEffect(()=>{const e=t.state?.feedSource;e&&(B(e),n(t.pathname,{replace:!0}))},[t.state,t.pathname,n]);const{entries:Me,totalPercent:Se}=y(),Ne=R(),Te=M.useRef(null),ke=M.useRef("unknown"),Re=M.useRef([]);Re.current=z.items;const Ie=M.useCallback(async(e,t)=>{const n=Math.min(3,Math.max(1,"1"===F?1:"2"===F?2:3)),r=n>=2?10*n:30;if(!e&&window.scrollY>100)q({type:"SET_LOADING",loading:!1});else try{if(t?.aborted)return;if(q(e?{type:"SET_LOADING_MORE",loadingMore:!0}:{type:"SET_LOADING",loading:!0}),q({type:"SET_ERROR",error:null}),O){if(Me.length>=2&&Se>=99){const n=!!e;let s;if(n&&e)try{s=JSON.parse(e)}catch{s=void 0}const{feed:o,cursors:a}=await _(Me.map(e=>({source:e.source,percent:e.percent})),r,s,t);if(t?.aborted)return;const i=()=>{const e=Ye(n?[...Re.current,...o]:o),t=Object.keys(a).length>0?JSON.stringify(a):void 0;q(n?{type:"APPEND_ITEMS",items:o,cursor:t}:{type:"SET_ITEMS",items:e,cursor:t})};n?M.startTransition(i):i()}else if(1===Me.length){const t=Me[0].source;if("timeline"===t.kind){const t=await s.getTimeline({limit:r,cursor:e}),n=()=>{const n=Ye(e?[...Re.current,...t.data.feed]:t.data.feed);q(e?{type:"APPEND_ITEMS",items:t.data.feed,cursor:t.data.cursor}:{type:"SET_ITEMS",items:n,cursor:t.data.cursor})};e?M.startTransition(n):n()}else if(t.uri){const n=await s.app.bsky.feed.getFeed({feed:t.uri,limit:r,cursor:e}),o=()=>{const t=Ye(e?[...Re.current,...n.data.feed]:n.data.feed);q(e?{type:"APPEND_ITEMS",items:n.data.feed,cursor:n.data.cursor}:{type:"SET_ITEMS",items:t,cursor:n.data.cursor})};e?M.startTransition(o):o()}}else if("timeline"===L.kind){const t=await s.getTimeline({limit:r,cursor:e}),n=()=>{const n=Ye(e?[...Re.current,...t.data.feed]:t.data.feed);q(e?{type:"APPEND_ITEMS",items:t.data.feed,cursor:t.data.cursor}:{type:"SET_ITEMS",items:n,cursor:t.data.cursor})};e?M.startTransition(n):n()}else if(L.uri){const t=await s.app.bsky.feed.getFeed({feed:L.uri,limit:r,cursor:e}),n=()=>{const n=Ye(e?[...Re.current,...t.data.feed]:t.data.feed);q(e?{type:"APPEND_ITEMS",items:t.data.feed,cursor:t.data.cursor}:{type:"SET_ITEMS",items:n,cursor:t.data.cursor})};e?M.startTransition(n):n()}}else{const{feed:n,cursor:s}=await w(r,e);if(t?.aborted)return;const o=()=>{const t=Ye(e?[...Re.current,...n]:n);q(e?{type:"APPEND_ITEMS",items:n,cursor:s}:{type:"SET_ITEMS",items:t,cursor:s})};e?M.startTransition(o):o()}}catch(o){const e=o instanceof Error?o.message:"Failed to load feed";q({type:"SET_ERROR",error:e})}finally{q({type:"SET_LOADING",loading:!1}),q({type:"SET_LOADING_MORE",loadingMore:!1})}},[L,O,Me,Se]);M.useEffect(()=>{const e=new AbortController;return Ie(void 0,e.signal),()=>{e.abort()}},[Ie]);W.current=z.loadingMore,M.useEffect(()=>{if(!z.cursor)return;const e=K.current;let t=0,n=0,s=0;const r=Math.min(3,Math.max(1,"1"===F?1:"2"===F?2:3)),o=()=>{clearTimeout(s);const t=Math.max(50,1800-(Date.now()-G.current)+50);s=window.setTimeout(()=>{W.current||(()=>{for(let t=0;t<r;t++){const n=e[t];if(n&&n.getBoundingClientRect().bottom<window.innerHeight)return!0}return!1})()&&(W.current=!0,G.current=Date.now(),Ie(z.cursor))},t)},a=new IntersectionObserver(e=>{for(const s of e){if(!s.isIntersecting||W.current)continue;if(Date.now()-G.current<1800){o();continue}W.current=!0;const e=z.cursor;t=requestAnimationFrame(()=>{t=0,n=window.setTimeout(()=>{n=0,G.current=Date.now(),Ie(e)},120)});break}},{rootMargin:"600px",threshold:0});for(let i=0;i<r;i++){const t=e[i];t&&a.observe(t)}return r>1&&o(),()=>{a.disconnect(),t&&cancelAnimationFrame(t),n&&clearTimeout(n),clearTimeout(s)}},[z.cursor,Ie,F]);const{mediaMode:Ae}=v(),{nsfwPreference:Ce,unblurredUris:Oe,setUnblurred:Fe}=b(),{hideRepostsFromDids:Le}=E()??{hideRepostsFromDids:[]},Pe=M.useMemo(()=>z.items.filter(e=>"media"!==Ae||i(e.post)).filter(e=>!z.seenUrisAtReset.has(e.post.uri)).filter(e=>"sfw"!==Ce||!l(e.post)).filter(e=>{if(!Ve(e))return!0;const t=e.reason?.by?.did;return!t||!Le.includes(t)}),[z.items,Ae,z.seenUrisAtReset,Ce,Le]),De=M.useMemo(()=>Xe(Pe),[Pe]),Ue=M.useMemo(()=>z.items.filter(e=>"media"!==Ae||i(e.post)).filter(e=>"sfw"!==Ce||!l(e.post)),[z.items,Ae,Ce]),Be=0===De.length&&Ue.length>0&&!z.cursor,Je=0===De.length&&null!=z.cursor,et=U(F,150),tt=M.useRef([]),nt=M.useRef(0),st=M.useRef(0);M.useEffect(()=>{tt.current=[],nt.current=0,st.current=0},[L,Ae,Ce]);const rt=M.useMemo(()=>{et!==st.current&&(tt.current=[],nt.current=0);const e=function(e,t,n,s){const r=Math.min(3,Math.max(1,Math.floor(t)));if(r<1)return[];if(n&&n.length===r&&void 0!==s&&e.length>s){const t=new Map;n.forEach((e,n)=>{e.forEach(({entry:e})=>{const s="post"===e.type?e.item.post.uri:e.items[0]?.post.uri;s&&t.set(s,n)})});const o=Array.from({length:r},()=>[]),a=Array(r).fill(0);for(let n=0;n<s;n++){const s=e[n],i="post"===s.type?s.item.post.uri:s.items[0]?.post.uri;if(i){const e=t.get(i);if(void 0!==e&&e<r){o[e].push({entry:s,originalIndex:n}),a[e]+=Qe(s);continue}}const l=Qe(s);let c=0;for(let e=1;e<r;e++)a[e]<a[c]&&(c=e);o[c].push({entry:s,originalIndex:n}),a[c]+=l}for(let n=s;n<e.length;n++){const t=e[n],s=Qe(t);let i=0;for(let e=1;e<r;e++)a[e]<a[i]&&(i=e);o[i].push({entry:t,originalIndex:n}),a[i]+=s}return o}const o=Array.from({length:r},()=>[]),a=Array(r).fill(0);for(let i=0;i<e.length;i++){const t=e[i],n=Qe(t),s=o.map(e=>e.length),l=0===s.length?0:Math.min(...s);let c=-1;for(let e=0;e<r;e++)o[e].length>l+1||(-1===c||a[e]<a[c]||a[e]===a[c]&&o[e].length<o[c].length)&&(c=e);-1===c&&(c=0),o[c].push({entry:t,originalIndex:i}),a[c]+=n}return o}(De,et,tt.current,nt.current);return tt.current=e,nt.current=De.length,st.current=et,e},[De,et]),ot=M.useMemo(()=>{const e=[];return De.forEach((t,n)=>{if("post"===t.type){const s="text"===Ae?1:Math.max(1,c(t.item.post).length);for(let t=0;t<s;t++)e.push({cardIndex:n,mediaIndex:t})}else e.push({cardIndex:n,mediaIndex:0})}),e},[De,Ae]),at=M.useMemo(()=>{const e=[];let t=0;return De.forEach((n,s)=>{e[s]=t;const r=De[s],o="post"===r.type?"text"===Ae?1:Math.max(1,c(r.item.post).length):1;t+=o}),e},[De,Ae]),it=M.useMemo(()=>{const e=[];return De.forEach((t,n)=>{const s="post"===t.type?"text"===Ae?1:Math.max(1,c(t.item.post).length):1;e[n]=at[n]+s-1}),e},[De,at,Ae]);te.current=Pe,ne.current=z.keyboardFocusIndex,se.current=z.actionsMenuOpenForIndex,M.useLayoutEffect(()=>{const e=_e.current;if(!e)return;const t=()=>{const t=e.getBoundingClientRect().top+window.scrollY;be(t)};t();const n=D(t,150),s=new ResizeObserver(n);return s.observe(e),()=>s.disconnect()},[De.length,ye]),M.useEffect(()=>{const e=z.keyboardFocusIndex;if(e<0)return;if(0===ot.length)return void q({type:"SET_KEYBOARD_FOCUS",index:-1});const t=Math.min(e,ot.length-1);t!==e&&q({type:"SET_KEYBOARD_FOCUS",index:t})},[ot.length,z.keyboardFocusIndex]);const lt=M.useMemo(()=>D(e=>function(e){const t=[...e],n=t.length>2e3?t.slice(-2e3):t;p.set(ze,n)}(e),1e3),[]);M.useEffect(()=>{lt(z.seenUris)},[z.seenUris,lt]),M.useEffect(()=>{const e=new Set;let t=0,n=0;const s=new WeakSet,r=()=>{if(t=0,0===e.size)return;const s=Date.now();if(s-n<400)return void(t=requestAnimationFrame(r));n=s;const o=Array.from(e);e.clear(),M.startTransition(()=>{q({type:"MARK_SEEN",uris:o}),ge.current=new Set([...ge.current,...o])})},o=new IntersectionObserver(n=>{for(const t of n)if(!t.isIntersecting&&t.boundingClientRect.top<0){const n=t.target.getAttribute("data-post-uri");n&&!ge.current.has(n)&&e.add(n)}e.size>0&&!t&&(t=requestAnimationFrame(r))},{threshold:0,rootMargin:"0px"}),a=e=>{e instanceof HTMLElement&&e.hasAttribute("data-post-uri")&&!s.has(e)&&(o.observe(e),s.add(e))},i=_e.current;if(i){i.querySelectorAll("[data-post-uri]").forEach(a);const e=new MutationObserver(e=>{for(const t of e)t.addedNodes.forEach(e=>{if(e instanceof HTMLElement){a(e);e.querySelectorAll("[data-post-uri]").forEach(a)}})});return e.observe(i,{childList:!0,subtree:!0}),()=>{o.disconnect(),e.disconnect(),t&&cancelAnimationFrame(t)}}return()=>{o.disconnect(),t&&cancelAnimationFrame(t)}},[De.length]),M.useEffect(()=>{const e=()=>{ae.current=!0};return window.addEventListener("mousemove",e),()=>window.removeEventListener("mousemove",e)},[]),M.useEffect(()=>{if(!oe.current)return;if(oe.current=!1,z.keyboardFocusIndex===re.current)return;re.current=z.keyboardFocusIndex;const e=ot[z.keyboardFocusIndex],t=requestAnimationFrame(()=>{const t=e?.cardIndex??z.keyboardFocusIndex,n=e?.mediaIndex??0,s=ee.current[t]?.[n],r=s??Z.current[t];r&&r.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})});return()=>cancelAnimationFrame(t)},[z.keyboardFocusIndex,ot]),M.useEffect(()=>{const e=e=>{const n=/[?&](post|profile|tag|forumPost|artboard)=/.test(t.search);if(Q||n)return;const r=e.target;if("INPUT"===r.tagName||"TEXTAREA"===r.tagName||"SELECT"===r.tagName||r.isContentEditable)return void("Escape"===e.key&&(e.preventDefault(),r.blur()));if(e.ctrlKey||e.metaKey)return;const o=ne.current;if(0===De.length||0===ot.length)return;ue(!1);const a=ot[o],i=a?.cardIndex??0,l=De[i],c="post"===l?.type?l.item:"carousel"===l?.type?l.items[0]:null,u=e.key.toLowerCase(),d=document.activeElement?.closest?.('[role="menu"]'),f=z.actionsMenuOpenForIndex===i;if((d||f)&&("w"===u||"s"===u||"e"===u||"enter"===u||"q"===u||"escape"===u))return;if(e.repeat&&("a"===u||"d"===u||"ArrowLeft"===e.key||"ArrowRight"===e.key))return;if(de)return"escape"===u?(e.preventDefault(),void fe(null)):void 0;if("w"!==u&&"s"!==u&&"a"!==u&&"d"!==u&&"e"!==u&&"enter"!==u&&"r"!==u&&"f"!==u&&"c"!==u&&"h"!==u&&"b"!==u&&"m"!==u&&"`"!==u&&"4"!==u&&"ArrowUp"!==e.key&&"ArrowDown"!==e.key&&"ArrowLeft"!==e.key&&"ArrowRight"!==e.key||e.preventDefault(),"b"===u)return void(c?.post?.author&&O?.did!==c.post.author.did&&(fe({did:c.post.author.did,handle:c.post.author.handle??c.post.author.did,avatar:c.post.author.avatar}),requestAnimationFrame(()=>me.current?.focus())));const m=o<0,h=et>=2?rt:null,p=e=>Z.current[e]?.getBoundingClientRect();if("w"===u||"ArrowUp"===e.key){ae.current=!1,le(!0),oe.current=!0;const e=o===at[i],t=m?it[De.length-1]??ot.length-1:e?(()=>{const e=et>=2&&h?function(e,t){for(let n=0;n<e.length;n++){const s=e[n].findIndex(e=>e.originalIndex===t);if(s>0)return e[n][s-1].originalIndex;if(0===s)return t}return t}(h,i):Math.max(0,i-1);return it[e]??at[e]??0})():Math.max(0,o-1);return void q({type:"SET_KEYBOARD_FOCUS",index:t})}if("s"===u||"ArrowDown"===e.key){ae.current=!1,le(!0),oe.current=!0;const e=o===it[i],t=m?0:e?(()=>{const e=et>=2&&h?function(e,t){for(let n=0;n<e.length;n++){const s=e[n].findIndex(e=>e.originalIndex===t);if(s>=0&&s<e[n].length-1)return e[n][s+1].originalIndex;if(s>=0)return t}return t}(h,i):Math.min(De.length-1,i+1);return at[e]??o})():Math.min(ot.length-1,o+1);return void q({type:"SET_KEYBOARD_FOCUS",index:t})}if("a"===u||"ArrowLeft"===e.key){ae.current=!1,le(!0),oe.current=!0;const e=m?0:et>=2&&h?function(e,t,n){for(let s=0;s<e.length;s++){if(e[s].findIndex(e=>e.originalIndex===t)<0)continue;if(0===s)return t;const r=e[s-1],o=n(t);if(!o)return t;let a=t,i=-1;for(const{originalIndex:e}of r){const t=n(e);if(!t)continue;const s=Ze(o,t);s>0&&s>i&&(i=s,a=e)}return a}return t}(h,i,p):i,t=m?0:e!==i?it[e]??o:o;return t!==o&&q({type:"SET_ACTIONS_MENU_OPEN",index:null}),void q({type:"SET_KEYBOARD_FOCUS",index:t})}if("d"===u||"ArrowRight"===e.key){ae.current=!1,le(!0),oe.current=!0;const e=m?0:et>=2&&h?function(e,t,n){for(let s=0;s<e.length;s++){if(e[s].findIndex(e=>e.originalIndex===t)<0)continue;if(s===e.length-1)return t;const r=e[s+1],o=n(t);if(!o)return t;let a=t,i=-1;for(const{originalIndex:e}of r){const t=n(e);if(!t)continue;const s=Ze(o,t);s>0&&s>i&&(i=s,a=e)}return a}return t}(h,i,p):i,t=m?0:e!==i?it[e]??o:o;return t!==o&&q({type:"SET_ACTIONS_MENU_OPEN",index:null}),void q({type:"SET_KEYBOARD_FOCUS",index:t})}if(("m"===u||"`"===u)&&o>=0)q(f?{type:"SET_ACTIONS_MENU_OPEN",index:null}:{type:"SET_ACTIONS_MENU_OPEN",index:i});else if("e"!==u&&"enter"!==u)if("r"!==u){if("f"===u){const e=c;if(!e?.post?.uri||!e?.post?.cid)return;const t=e.post.uri,n=t in $?$[t]??void 0:e.post.viewer?.like;return void(n?s.deleteLike(n).then(()=>{Y(t,null)}).catch(()=>{}):s.like(t,e.post.cid).then(e=>{Y(t,e.uri)}).catch(()=>{}))}if("c"!==u){if("4"===u){const e=c?.post?.author,t=c?.post?.uri;if(e&&O?.did&&O.did!==e.did&&t){const n=e.viewer?.following;n?s.deleteFollow(n).then(()=>{q({type:"UPDATE_ITEMS",updater:e=>e.map(e=>{if(e.post.uri!==t)return e;const n=e.post,s=n.author;return{...e,post:{...n,author:{...s,viewer:{...s.viewer,following:void 0}}}}})})}).catch(()=>{}):s.follow(e.did).then(e=>{q({type:"UPDATE_ITEMS",updater:n=>n.map(n=>{if(n.post.uri!==t)return n;const s=n.post,r=s.author;return{...n,post:{...s,author:{...r,viewer:{...r.viewer,following:e.uri}}}}})})}).catch(()=>{})}}}else J(!0)}else c&&X(c.post.uri,!0);else c&&X(c.post.uri)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[t.search,et,Q,X,de,O,$,z.actionsMenuOpenForIndex,ot,at,it]),M.useEffect(()=>{de&&me.current?.focus()},[de]);const ct=M.useRef(null),ut=M.useContext(I),dt=C({scrollRef:{current:null},touchTargetRef:ut?.wrapperRef??ct,onRefresh:async()=>{await Ie(),requestAnimationFrame(()=>{window.scrollTo(0,0)})},enabled:o,maxTouchStartY:130}),ft=!!Ne&&1===Me.length&&Ne.feedSources.length>1,mt=M.useCallback(e=>{dt.onTouchStart(e),ft&&1===e.touches.length&&(Te.current={x:e.touches[0].clientX,y:e.touches[0].clientY},ke.current="unknown")},[ft,dt]),ht=M.useCallback(e=>{if(ft&&Te.current&&1===e.touches.length){if("unknown"===ke.current){const t=e.touches[0].clientX-Te.current.x,n=e.touches[0].clientY-Te.current.y;(Math.abs(t)>20||Math.abs(n)>20)&&(ke.current=Math.abs(t)>2*Math.abs(n)?"swipe":"pull")}"pull"!==ke.current&&"unknown"!==ke.current||dt.onTouchMove(e)}else dt.onTouchMove(e)},[ft,dt]),pt=M.useCallback(e=>{if(ft&&Ne&&Te.current&&1===e.changedTouches.length){const t=e.changedTouches[0].clientX-Te.current.x,n=e.changedTouches[0].clientY-Te.current.y;if("swipe"===ke.current&&Math.abs(t)>80&&Math.abs(t)>2*Math.abs(n)){const e=Ne.feedSources,n=Me[0].source,s=e.findIndex(e=>{return s=n,((t=e).uri??t.label)===(s.uri??s.label);var t,s});if(s>=0){const n=t<0?(s+1)%e.length:(s-1+e.length)%e.length;Ne.setSingleFeed(e[n])}}Te.current=null,ke.current="unknown"}dt.onTouchEnd(e)},[ft,Ne,Me,dt]);M.useEffect(()=>{const e=ut?.setHandlers;if(e)return e({onTouchStart:mt,onTouchMove:ht,onTouchEnd:pt}),()=>{e(null)}},[ut?.setHandlers,mt,ht,pt]);const gt=!!ut?.wrapperRef;return a.jsx(A,{title:"Feed",showNav:!0,children:a.jsxs(a.Fragment,{children:[a.jsxs("div",{ref:ct,className:P.wrap,onTouchStart:gt?void 0:mt,onTouchMove:gt?void 0:ht,onTouchEnd:gt?void 0:pt,children:[a.jsx("div",{className:`${P.pullRefreshHeader} ${dt.pullDistance>0||dt.isRefreshing?P.pullRefreshHeaderActive:""}`,"aria-hidden":0===dt.pullDistance&&!dt.isRefreshing,"aria-live":"polite","aria-label":dt.isRefreshing?"Refreshing":void 0,children:(dt.pullDistance>0||dt.isRefreshing)&&a.jsx("div",{className:P.pullRefreshSpinner})}),a.jsxs("div",{className:P.pullRefreshContent,style:{transform:`translateY(${dt.pullDistance}px)`},children:[O&&a.jsxs("div",{className:P.suggestedFollowsSection,children:[a.jsx("div",{className:P.suggestedFollowsSectionInner,children:a.jsx("button",{type:"button",className:P.suggestedFollowsToggle,onClick:()=>we(e=>!e),"aria-expanded":ye,"aria-label":ye?"Hide suggestions":"Discover accounts to follow",children:ye?"Hide suggestions":"Discover accounts"})}),ye&&a.jsx(je,{})]}),a.jsxs("div",{className:P.feedContentTransition,children:[z.error&&a.jsx("p",{className:P.error,children:z.error}),z.loading?a.jsx("div",{className:P.loading,children:"Loading…"}):0===De.length?a.jsx("div",{className:P.empty,children:Je?a.jsxs(a.Fragment,{children:[a.jsx("p",{className:P.emptyLoadMoreText,children:Ue.length>0?"You've seen everything visible from this batch. There may be more from your other feeds.":"No posts in this batch."}),a.jsx("button",{type:"button",className:P.loadMoreBtn,onClick:()=>z.cursor&&!z.loadingMore&&Ie(z.cursor),disabled:z.loadingMore,children:z.loadingMore?"Loading…":"Load more"})]}):Be?a.jsxs(a.Fragment,{children:["You've read all the posts in this feed.",a.jsx("br",{}),"New posts will appear as they're posted."]}):"media"===Ae?"No posts with images or videos in this feed.":"No posts in this feed."}):a.jsxs(a.Fragment,{children:[a.jsx("div",{ref:_e,className:`${P.gridColumns} ${P[`gridView${F}`]}`,"data-feed-cards":!0,"data-view-mode":F,"data-keyboard-nav":ie||void 0,onMouseLeave:o&&!Q?()=>q({type:"SET_KEYBOARD_FOCUS",index:-1}):void 0,children:rt.map((e,t)=>a.jsx(He,{column:e,colIndex:t,scrollMargin:ve,loadMoreSentinelRef:z.cursor?e=>{K.current[t]=e}:void 0,hasCursor:!!z.cursor,keyboardFocusIndex:z.keyboardFocusIndex,focusTargets:ot,firstFocusIndexForCard:at,focusSetByMouse:ce,keyboardAddOpen:V,actionsMenuOpenForIndex:z.actionsMenuOpenForIndex,nsfwPreference:Ce,unblurredUris:Oe,setUnblurred:Fe,likeOverrides:$,setLikeOverrides:Y,seenUris:z.seenUris,openPostModal:X,cardRef:e=>t=>{Z.current[e]=t},onMediaRef:(e,t,n)=>{ee.current[e]||(ee.current[e]={}),ee.current[e][t]=n},onActionsMenuOpenChange:(e,t)=>q({type:"SET_ACTIONS_MENU_OPEN",index:t?e:null}),onMouseEnter:e=>{o&&ae.current&&(ae.current=!1,le(!1),ue(!0),q({type:"SET_KEYBOARD_FOCUS",index:at[e]??0}))},onAddClose:()=>J(!1)},`${t}-${e.length}`))}),O&&a.jsxs("div",{className:P.loadMoreRow,children:[z.loadingMore&&a.jsx("p",{className:P.loadingMore,role:"status",children:"Loading more…"}),a.jsx("button",{type:"button",className:P.loadMoreBtn,onClick:()=>z.cursor&&!z.loadingMore&&Ie(z.cursor),disabled:z.loadingMore||!z.cursor,children:z.cursor?"Load more":"No more posts"})]})]})]},1===Me.length?Me[0].source.uri??Me[0].source.label:"mixed"),!O&&a.jsxs("div",{className:P.feedLoginHint,children:[a.jsx("div",{className:P.feedLoginHintBtnRow,children:a.jsx("button",{type:"button",className:P.feedLoginHintBtn,onClick:()=>S(),children:"Log in"})}),a.jsxs("p",{className:P.feedLoginHintText,children:["Or"," ",a.jsx("button",{type:"button",className:P.feedLoginHintLink,onClick:()=>S("create"),children:"create an account"})," to see your own feeds."]})]})]})]}),de&&a.jsx("div",{className:P.blockOverlay,role:"dialog","aria-modal":"true","aria-labelledby":"block-dialog-title",onKeyDown:e=>"Escape"===e.key&&fe(null),onClick:()=>fe(null),children:a.jsxs("div",{className:P.blockDialog,onClick:e=>e.stopPropagation(),children:[a.jsx("h2",{id:"block-dialog-title",className:P.blockTitle,children:"Block user?"}),a.jsxs("div",{className:P.blockUser,children:[de.avatar?a.jsx("img",{src:de.avatar,alt:"",className:P.blockAvatar,loading:"lazy"}):a.jsx("div",{className:P.blockAvatarPlaceholder}),a.jsxs("span",{className:P.blockHandle,children:["@",de.handle]})]}),a.jsxs("div",{className:P.blockActions,children:[a.jsx("button",{ref:me,type:"button",className:P.blockCancelBtn,onClick:()=>fe(null),children:"Cancel"}),a.jsx("button",{ref:he,type:"button",className:P.blockConfirmBtn,onClick:async()=>{if(de)try{await j(de.did),fe(null)}catch(e){}},children:"Block"})]})]})})]})})}export{Xe as buildDisplayEntries,et as default};
