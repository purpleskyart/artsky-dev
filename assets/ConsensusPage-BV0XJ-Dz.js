import{g as e,b as t,D as r,j as s}from"./index-Cixw3jdx.js";import{r as o}from"./react-vendor-rw3WIpbI.js";import{L as a}from"./Layout-CuwbhQDi.js";import{P as i}from"./PostText-0G7hlYgr.js";import{s as n}from"./ForumPage.module-D7Em_nze.js";import"./atproto-JNpM3I1p.js";import"./Icons-D4yuh_Fp.js";const d="app.artsky.forum.post",l="app.artsky.consensus.vote";function c(){const[a,c]=o.useState([]),[m,u]=o.useState(""),[p,g]=o.useState(null),[y,h]=o.useState(!0),f=e(),v=o.useCallback(async()=>{try{const e=f?t:r,s=f?.did?[f.did]:[],o=[],a=new Set;for(const t of s)try{const r=await e.com.atproto.repo.listRecords({repo:t,collection:d,limit:100});for(const e of r.data.records??[]){if(a.has(e.uri))continue;const t=e.value;t.tags?.includes("consensus")&&(a.add(e.uri),o.push({id:e.uri.split("/").pop()??e.uri,uri:e.uri,text:t.title||t.body||"",myVote:null}))}}catch{}if(f?.did)try{const t=await e.com.atproto.repo.listRecords({repo:f.did,collection:l,limit:100});for(const e of t.data.records??[]){const t=e.value;if(t.statement){const e=o.find(e=>e.uri===t.statement);e&&(e.myVote=t.value??null)}}}catch{}if(0===o.length){["Forums should support markdown formatting","Real-time collaboration is more important than async tools","The app should prioritize mobile over desktop","Blender and Godot workflows need dedicated UI sections"].forEach((e,t)=>{o.push({id:`seed-${t}`,uri:"",text:e,myVote:null})})}c([...o])}catch{c([])}finally{h(!1)}},[f?.did]);o.useEffect(()=>{v()},[v]);const x=o.useCallback(async()=>{const e=a.filter(e=>null!==e.myVote).map(e=>({user_id:f?.did??"anonymous",statement_id:e.id,value:e.myVote}));if(e.length>0)try{const t=await async function(e){const t=new Map;for(const o of e){let e=t.get(o.statement_id);e||(e={agree:0,disagree:0,pass:0,voters:new Set},t.set(o.statement_id,e)),e.voters.add(o.user_id),1===o.value?e.agree++:-1===o.value?e.disagree++:e.pass++}const r=Array.from(t.entries()).map(([e,t])=>{const r=t.agree+t.disagree+t.pass,s=r>0?t.agree/r:0,o=r>0?1-Math.abs(t.agree-t.disagree)/r:0;return{statementId:e,agreeCount:t.agree,disagreeCount:t.disagree,passCount:t.pass,totalVoters:t.voters.size,agreementRatio:s,divisiveness:o}}),s=new Set;for(const o of e)s.add(o.user_id);return{statements:r,totalParticipants:s.size,clusterCount:0,clusters:[]}}(e);g(t)}catch{g(null)}else g(null)},[a,f?.did]);async function b(e,r){const s=a.find(t=>t.id===e);if(!s)return;const o=s.myVote===r?null:r;if(c(t=>t.map(t=>t.id===e?{...t,myVote:o}:t)),s.uri&&f?.did)try{const e=`vote-${s.id.replace(/[^a-zA-Z0-9-]/g,"")}`;if(null!==o)await t.com.atproto.repo.putRecord({repo:f.did,collection:l,rkey:e,record:{$type:l,statement:s.uri,value:o,createdAt:(new Date).toISOString()},validate:!1});else try{await t.com.atproto.repo.deleteRecord({repo:f.did,collection:l,rkey:e})}catch{}}catch(i){}setTimeout(x,0)}async function j(){if(!m.trim())return;const e=m.trim();let r="";if(f?.did)try{const s=`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,o=await t.com.atproto.repo.putRecord({repo:f.did,collection:d,rkey:s,record:{$type:d,title:e,body:e,tags:["consensus"],createdAt:(new Date).toISOString()},validate:!1});r=o.data.uri}catch(s){}c(t=>[...t,{id:r?r.split("/").pop():`${Date.now()}`,uri:r,text:e,myVote:null}]),u("")}return s.jsxs("div",{className:n.wrap,children:[s.jsxs("header",{className:n.header,children:[s.jsx("h2",{className:n.title,children:"Consensus"}),s.jsx("p",{className:n.subtitle,children:"Vote on statements to find where the community agrees. Polis-like collaborative decision making."})]}),y&&s.jsx("div",{className:n.loading,children:"Loading…"}),s.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"1rem",marginBottom:"1.5rem"},children:a.map(e=>{const t=(r=e.id,p?.statements.find(e=>e.statementId===r));var r;return s.jsxs("div",{style:{padding:"1rem",background:"var(--surface)",borderRadius:"0.5rem",border:"1px solid var(--border)"},children:[s.jsx("p",{style:{marginBottom:"0.75rem",lineHeight:1.5},children:s.jsx(i,{text:e.text})}),s.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginBottom:t?"0.5rem":0},children:[s.jsx("button",{type:"button",className:1===e.myVote?n.tabActive:n.tab,style:{fontSize:"0.9rem",padding:"6px 16px"},onClick:()=>b(e.id,1),children:"Agree"}),s.jsx("button",{type:"button",className:-1===e.myVote?n.tabActive:n.tab,style:{fontSize:"0.9rem",padding:"6px 16px",background:-1===e.myVote?"var(--error)":void 0,color:-1===e.myVote?"#fff":void 0},onClick:()=>b(e.id,-1),children:"Disagree"}),s.jsx("button",{type:"button",className:0===e.myVote?n.tabActive:n.tab,style:{fontSize:"0.9rem",padding:"6px 16px"},onClick:()=>b(e.id,0),children:"Pass"})]}),t&&s.jsxs("div",{style:{marginTop:"0.5rem"},children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.8rem",color:"var(--muted)",marginBottom:"4px"},children:[s.jsxs("span",{children:[Math.round(100*t.agreementRatio),"% agree"]}),s.jsxs("span",{children:["Divisiveness: ",Math.round(100*t.divisiveness),"%"]})]}),s.jsx("div",{style:{height:6,borderRadius:3,background:"var(--border)",overflow:"hidden"},children:s.jsx("div",{style:{height:"100%",width:100*t.agreementRatio+"%",background:t.agreementRatio>.66?"var(--success, green)":t.agreementRatio>.33?"var(--warning, orange)":"var(--error, red)",borderRadius:3}})})]})]},e.id)})}),f?.did&&s.jsxs("div",{style:{padding:"1rem",background:"var(--surface)",borderRadius:"0.5rem",border:"1px solid var(--border)",marginBottom:"1.5rem"},children:[s.jsx("h3",{style:{marginBottom:"0.5rem"},children:"Add a Statement"}),s.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[s.jsx("input",{type:"text",placeholder:"What should the community decide on?",value:m,onChange:e=>u(e.target.value),onKeyDown:e=>"Enter"===e.key&&j(),style:{flex:1,padding:"0.5rem"}}),s.jsx("button",{type:"button",className:n.tabActive,onClick:j,children:"Add"})]})]}),!f&&s.jsx("div",{className:n.empty,children:"Log in to vote and add statements."}),p&&p.clusterCount>0&&s.jsxs("div",{style:{padding:"1rem",background:"var(--surface)",borderRadius:"0.5rem",border:"1px solid var(--border)"},children:[s.jsx("h3",{style:{marginBottom:"0.5rem"},children:"Opinion Clusters"}),s.jsxs("p",{style:{fontSize:"0.9rem",color:"var(--muted)",marginBottom:"0.75rem"},children:[p.totalParticipants," participant",1!==p.totalParticipants?"s":""," · ",p.clusterCount," opinion group",1!==p.clusterCount?"s":""]}),s.jsx("div",{style:{display:"flex",gap:"0.75rem",flexWrap:"wrap"},children:p.clusters.map(e=>s.jsxs("div",{style:{padding:"0.75rem",flex:"1 1 200px",background:"var(--bg)",borderRadius:"0.5rem"},children:[s.jsxs("h4",{style:{fontSize:"0.9rem",fontWeight:700,marginBottom:"0.25rem"},children:["Group ",e.id+1]}),s.jsxs("p",{style:{fontSize:"0.85rem",color:"var(--muted)"},children:[e.memberCount," member",1!==e.memberCount?"s":""," · Avg agreement:"," ",Math.round(100*e.avgAgreement),"%"]})]},e.id))})]})]})}function m(){return s.jsx(a,{title:"Consensus",showNav:!0,children:s.jsx(c,{})})}export{c as ConsensusContent,m as default};
