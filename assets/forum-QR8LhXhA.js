import{g as t,b as r,D as e,ac as o}from"./index-DO5u49Z-.js";const i="app.artsky.forum.post",a="app.artsky.forum.reply",d="app.artsky.forum.wiki",n="artsky-forum-drafts";async function c(e){const o=t();if(!o?.did)throw new Error("Not logged in");const a=`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,d=await r.com.atproto.repo.putRecord({repo:o.did,collection:i,rkey:a,record:{$type:i,title:e.title.trim(),body:e.body.trim(),tags:e.tags??[],createdAt:(new Date).toISOString()},validate:!1});return{uri:d.data.uri,cid:d.data.cid}}async function s(o,a){const d=t()?r:e;try{const t=await d.com.atproto.repo.listRecords({repo:o,collection:i,limit:a?.limit??30,cursor:a?.cursor,reverse:!0});return{posts:(t.data.records??[]).map(t=>{const r=t.value,e=t.uri.split("/").pop()??"";return{uri:t.uri,cid:t.cid,did:o,rkey:e,title:r.title,body:r.body,tags:r.tags,createdAt:r.createdAt,isPinned:r.isPinned,isWiki:r.isWiki}}),cursor:t.data.cursor}}catch{return{posts:[],cursor:void 0}}}async function l(a){const d=o(a);if(!d)return null;const n=t()?r:e;try{const t=await n.com.atproto.repo.getRecord({repo:d.did,collection:i,rkey:d.rkey}),r=t.data.value;let e,o;try{const t=(await n.getProfile({actor:d.did})).data;e=t.handle,o=t.avatar}catch{}return{uri:t.data.uri,cid:t.data.cid,did:d.did,rkey:d.rkey,title:r.title,body:r.body,tags:r.tags,createdAt:r.createdAt,isPinned:r.isPinned,isWiki:r.isWiki,authorHandle:e,authorAvatar:o}}catch{return null}}async function u(e,o){const a=await l(e);if(!a)throw new Error("Post not found");const d=t();if(!d?.did||d.did!==a.did)throw new Error("Not authorized");await r.com.atproto.repo.putRecord({repo:d.did,collection:i,rkey:a.rkey,record:{$type:i,title:(o.title??a.title??"").trim(),body:(o.body??a.body??"").trim(),tags:o.tags??a.tags??[],createdAt:a.createdAt,isPinned:a.isPinned,isWiki:a.isWiki,editedAt:(new Date).toISOString()},validate:!1})}async function p(e){const a=t();if(!a?.did)throw new Error("Not logged in");const d=o(e);if(!d)throw new Error("Invalid URI");await r.com.atproto.repo.deleteRecord({repo:a.did,collection:i,rkey:d.rkey})}async function y(e){const o=t();if(!o?.did)throw new Error("Not logged in");const i=`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,d=await r.com.atproto.repo.putRecord({repo:o.did,collection:a,rkey:i,record:{$type:a,subject:e.postUri,replyTo:e.replyToUri,text:e.text.trim(),createdAt:(new Date).toISOString()},validate:!1});return{uri:d.data.uri,cid:d.data.cid}}async function w(o,i=[]){const d=t()?r:e,n=t(),c=[...new Set([...n?.did?[n.did]:[],...i])],s=[],l=new Set;for(const t of c)try{const r=await d.com.atproto.repo.listRecords({repo:t,collection:a,limit:100});for(const e of r.data.records??[]){const r=e.value;if(r.subject!==o||l.has(e.uri))continue;l.add(e.uri);let i={did:t,handle:t};try{const r=(await d.getProfile({actor:t})).data;i={did:t,handle:r.handle??t,avatar:r.avatar,displayName:r.displayName}}catch{}s.push({uri:e.uri,cid:e.cid,replyTo:r.replyTo,author:i,record:{text:r.text,createdAt:r.createdAt},isComment:!0})}}catch{}return s.sort((t,r)=>new Date(t.record?.createdAt??0).getTime()-new Date(r.record?.createdAt??0).getTime()),s}async function g(e){const o=await l(e);if(!o)throw new Error("Post not found");const a=t();if(!a?.did)throw new Error("Not logged in");const n=`wiki-${Date.now().toString(36)}`;await r.com.atproto.repo.putRecord({repo:a.did,collection:d,rkey:n,record:{$type:d,sourcePost:e,title:o.title,body:o.body,tags:o.tags,createdAt:(new Date).toISOString(),lastEditedAt:(new Date).toISOString()},validate:!1}),await r.com.atproto.repo.putRecord({repo:a.did,collection:i,rkey:o.rkey,record:{$type:i,title:o.title,body:o.body,tags:o.tags,createdAt:o.createdAt,isPinned:o.isPinned,isWiki:!0},validate:!1})}function f(t){const r=function(){try{const t=localStorage.getItem(n);return t?JSON.parse(t):[]}catch{return[]}}(),e={id:`draft-${Date.now()}`,...t,savedAt:(new Date).toISOString()};r.push(e);try{localStorage.setItem(n,JSON.stringify(r))}catch{}return e}export{w as a,y as b,c,p as d,u as e,l as g,s as l,g as p,f as s};
