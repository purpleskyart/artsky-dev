import{k as e,l as t,u as r,V as n,w as s,e as o,i,j as a,b as c}from"./index-Cos7Ao7g.js";import{d as l,b as u,f as d}from"./react-vendor-DGaPsC2e.js";import{p as f,P as m}from"./ProfileColumn-DTluR8Sv.js";import{L as p}from"./Layout-C96F8kdd.js";import{u as h}from"./ModalScrollContext-ejfEJ1xV.js";import{s as g}from"./TagPage.module-BpGvzkuE.js";import"./atproto-3-1TCh3S.js";import"./PostCard-DKMnmYb4.js";import"./PostActionsMenu-BFlvRje_.js";import"./date-Ct-NsrQr.js";import"./artboards-DNvSVVrd.js";import"./artboardsPds-DWUixJ9h.js";import"./PostText-BK2IkZic.js";import"./postCache-CTqU0alO.js";import"./Icons-BNUJF1V_.js";function w(e){return{post:e}}function v(e){const t=o(e.post);return t?null!=t.aspectRatio&&t.aspectRatio>0?100+280/t.aspectRatio:320:180}function j(e,t){if(t<1)return[];const r=Array.from({length:t},()=>[]),n=Array(t).fill(0);for(let s=0;s<e.length;s++){const o=e[s],i=v(o),a=r.map(e=>e.length),c=0===a.length?0:Math.min(...a);let l=-1;for(let e=0;e<t;e++)r[e].length>c+1||(-1===l||n[e]<n[l]||n[e]===n[l]&&r[e].length<r[l].length)&&(l=e);-1===l&&(l=0),r[l].push({item:o,originalIndex:s}),n[l]+=i}return r}function x({tag:d,inModal:p=!1,onRegisterRefresh:v}){const x=l(),{session:y}=e(),{viewMode:R}=t(),{isModalOpen:k,openPostModal:M}=r(),[b,A]=u.useState([]),[N,C]=u.useState(),[E,I]=u.useState(!0),[L,P]=u.useState(!1),[S,U]=u.useState(null),[O,T]=u.useState(0),[F,$]=u.useState(!1),[D,V]=u.useState({}),q=u.useRef([]),K=u.useRef(null),B=u.useRef([]),H=u.useRef(!1),X=u.useRef(0),z=u.useRef([]),G=u.useRef(!1),J=u.useRef(-1),Q=h(),W=u.useRef(null),Y=u.useCallback(async e=>{if(d)try{e?P(!0):I(!0),U(null);const{posts:t,cursor:r}=await n(d,e),s=t.map(w);A(t=>e?[...t,...s]:s),C(r)}catch(t){U(t instanceof Error?t.message:"Failed to load tag")}finally{I(!1),P(!1)}},[d]);u.useEffect(()=>{d&&(A([]),C(void 0),Y())},[d,Y]),u.useEffect(()=>{v?.(()=>Y())},[v,Y]);const{nsfwPreference:Z,unblurredUris:_,setUnblurred:ee}=s(),te=b.filter(e=>o(e.post)).filter(e=>"sfw"!==Z||!i(e.post)),re="1"===R?1:"2"===R?2:3;return z.current=te,X.current=O,H.current=L,u.useEffect(()=>{if(!N)return;const e=re,t=e>=2?B.current[0]:K.current;if(!t)return;const r=new IntersectionObserver(e=>{e[0]?.isIntersecting&&!H.current&&(H.current=!0,Y(N))},{rootMargin:"600px",threshold:0});if(r.observe(t),e>=2){const t=B.current;for(let n=1;n<e;n++){const e=t[n];e&&r.observe(e)}}return()=>r.disconnect()},[N,Y,re]),u.useEffect(()=>{T(e=>te.length?Math.min(e,te.length-1):0)},[te.length]),u.useEffect(()=>{if(!G.current)return;if(G.current=!1,O===J.current)return;J.current=O;const e=O,t=requestAnimationFrame(()=>{const t=q.current[e];t&&t.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})});return()=>cancelAnimationFrame(t)},[O]),u.useEffect(()=>{const e=e=>{if(!p&&k)return;const t=e.target;if("INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName||t.isContentEditable)return void("Escape"===e.key&&(e.preventDefault(),t.blur()));if(e.ctrlKey||e.metaKey)return;if(0===te.length)return;const r=z.current,n=X.current,s=e.key.toLowerCase();if("w"!==s&&"s"!==s&&"a"!==s&&"d"!==s&&"e"!==s&&"enter"!==s&&"f"!==s&&"c"!==s&&"ArrowUp"!==e.key&&"ArrowDown"!==e.key&&"ArrowLeft"!==e.key&&"ArrowRight"!==e.key||e.preventDefault(),"w"===s||"ArrowUp"===e.key)return G.current=!0,void T(e=>Math.max(0,e-re));if("s"===s||"ArrowDown"===e.key)return G.current=!0,void T(e=>Math.min(r.length-1,e+re));if("a"===s||"ArrowLeft"===e.key)return G.current=!0,void T(e=>Math.max(0,e-1));if("d"===s||"ArrowRight"===e.key)return G.current=!0,void T(e=>Math.min(r.length-1,e+1));if("e"===s||"enter"===s){const e=r[n];return void(e&&(p?M(e.post.uri):x(`/post/${encodeURIComponent(e.post.uri)}`)))}if("f"===s&&y){const e=r[n];if(!e?.post?.uri||!e?.post?.cid)return;const t=e.post.uri,s=t in D?D[t]??void 0:e.post.viewer?.like;return void(s?c.deleteLike(s).then(()=>{V(e=>({...e,[t]:null}))}).catch(()=>{}):c.like(t,e.post.cid).then(e=>{V(r=>({...r,[t]:e.uri}))}).catch(()=>{}))}"c"===s&&$(!0)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[te.length,re,x,k,p,M,D,y]),d?a.jsxs("div",{className:g.wrap,children:[a.jsx("header",{className:g.header,children:a.jsxs("h2",{className:g.title,children:["#",d]})}),S&&a.jsx("p",{className:g.error,children:S}),E?a.jsx("div",{className:g.loading,children:"Loading…"}):0===te.length?a.jsx("div",{className:g.empty,children:"No posts with images or videos for this tag."}):a.jsxs(a.Fragment,{children:[a.jsx("div",{ref:W,className:`${f.gridColumns} ${f[`gridView${R}`]}`,"data-view-mode":R,children:j(te,re).map((e,t)=>a.jsx(m,{column:e,colIndex:t,scrollRef:p?Q:null,loadMoreSentinelRef:N?e=>{re>=2?B.current[t]=e:K.current=e}:void 0,hasCursor:!!N,keyboardFocusIndex:O,keyboardAddOpen:F,actionsMenuOpenForIndex:null,nsfwPreference:Z,unblurredUris:_,setUnblurred:ee,likeOverrides:D,setLikeOverrides:V,openPostModal:p?M:e=>x(`/post/${encodeURIComponent(e)}`),cardRef:e=>t=>{q.current[e]=t},onActionsMenuOpenChange:()=>{},onMouseEnter:e=>T(e),onAddClose:()=>$(!1),constrainMediaHeight:1===re,isSelected:e=>e===O},t))}),L&&a.jsx("div",{className:f.loadingMore,children:"Loading…"})]})]}):null}function y(){const{tag:e}=d(),t=e?decodeURIComponent(e):"";return t?a.jsx(p,{title:`#${t}`,showNav:!0,children:a.jsx(x,{tag:t})}):a.jsx(p,{title:"Tag",showNav:!0,children:a.jsx("div",{className:g.wrap,children:a.jsx("p",{className:g.empty,children:"No tag specified."})})})}export{x as TagContent,y as default};
