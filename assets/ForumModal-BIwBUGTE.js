import{g as e,u as s,W as t,X as a,j as o}from"./index-Cos7Ao7g.js";import{b as l,L as r}from"./react-vendor-DGaPsC2e.js";import{A as i,s as n}from"./AppModal-BwJ0HpJG.js";import{l as c,c as d,s as m}from"./forum-B0iFyUeG.js";import{a as u,b as p}from"./date-Ct-NsrQr.js";import{u as h}from"./useListKeyboardNav-3q-0e0hq.js";import"./Layout-C96F8kdd.js";import{a as f}from"./PostText-BK2IkZic.js";import{CollabContent as b}from"./CollabPage-iXhniyM7.js";import{ConsensusContent as x}from"./ConsensusPage-D8tFgADa.js";import{s as j}from"./ForumPage.module-D7Em_nze.js";import{p as y}from"./PostDetailPage.module-DqeH_Jr6.js";import"./atproto-3-1TCh3S.js";import"./ModalTopBarSlotContext-XWKZv5-E.js";import"./ModalScrollContext-ejfEJ1xV.js";import"./usePullToRefresh-DVlCPYCP.js";import"./Icons-BNUJF1V_.js";const g=["https://pckt.blog","https://leaflet.pub","https://offprint.app"];function v(e){if(!e?.trim())return"";const s=e.replace(/\s+/g," ").trim();return s.length<=140?s:s.slice(0,140).trim()+"…"}function N({inModal:i=!1,onRegisterRefresh:n}){const[N,k]=l.useState("discover"),[C,w]=l.useState("all"),[L,A]=l.useState([]),[B,S]=l.useState([]),[P,F]=l.useState(!0),[M,R]=l.useState(null),[T,$]=l.useState(""),[U,E]=l.useState(0),[D,H]=l.useState(!1),[I,z]=l.useState({title:"",body:"",tags:""}),W=e(),{isModalOpen:G,openForumPostModal:q}=s(),K=l.useRef(null),O=l.useCallback(async()=>{try{if(F(!0),R(null),"all"===C){const e=await t(g);A(e)}else{const e=await a();A("followed"===C?W?.did?e.filter(e=>e.did!==W.did):[]:W?.did?e.filter(e=>e.did===W.did):[])}}catch(e){R(e instanceof Error?e.message:"Failed to load forum")}finally{F(!1)}},[C,W?.did]),V=l.useCallback(async()=>{if(W?.did)try{F(!0);const e=await c(W.did,{limit:50});S(e.posts)}catch{S([])}finally{F(!1)}else S([])},[W?.did]);l.useEffect(()=>{"discover"===N?(A([]),O()):"artsky"===N&&V()},[N,O,V,C]),l.useEffect(()=>{n?.(()=>{"discover"===N?O():"artsky"===N&&V()})},[n,N,O,V]);const X=l.useMemo(()=>L.filter(e=>function(e,s){if(!s.trim())return!0;const t=s.toLowerCase().trim(),a=(e.title??"").toLowerCase(),o=(e.body??"").toLowerCase(),l=(e.authorHandle??"").toLowerCase(),r=(e.path??"").toLowerCase();return a.includes(t)||o.includes(t)||l.includes(t)||r.includes(t)}(e,T)),[L,T]);l.useEffect(()=>{E(e=>X.length?Math.min(e,X.length-1):0)},[X.length]),l.useEffect(()=>{if(!K.current||U<0)return;const e=K.current.querySelector(`[data-forum-index="${U}"]`);e&&e.scrollIntoView({block:"nearest",behavior:"smooth"})},[U]);const Y=B.filter(e=>!T.trim()||(e.title??"").toLowerCase().includes(T.toLowerCase())||(e.body??"").toLowerCase().includes(T.toLowerCase())),_=Math.min(U,Math.max(0,Y.length-1));h({enabled:"discover"===N&&X.length>0&&(i||!G),itemCount:"discover"===N?X.length:"artsky"===N?Y.length:0,focusedIndex:"discover"===N?U:_,setFocusedIndex:E,onActivate:e=>{if("discover"===N){const s=X[e];s&&q(s.uri)}else if("artsky"===N){const s=Y[e];s&&q(s.uri)}},useCapture:!0});const J=("followed"===C||"mine"===C)&&!W;return o.jsxs("div",{className:j.wrap,children:[o.jsxs("header",{className:j.header,children:[o.jsx("h2",{className:j.title,children:"Forums"}),o.jsxs("div",{className:j.tabs,style:{marginTop:"0.5rem"},children:[o.jsx("button",{type:"button",className:"discover"===N?j.tabActive:j.tab,onClick:()=>k("discover"),"aria-pressed":"discover"===N,children:"Discover"}),o.jsx("button",{type:"button",className:"artsky"===N?j.tabActive:j.tab,onClick:()=>k("artsky"),"aria-pressed":"artsky"===N,children:"ArtSky"}),o.jsx("button",{type:"button",className:"collab"===N?j.tabActive:j.tab,onClick:()=>k("collab"),"aria-pressed":"collab"===N,children:"Collab"}),o.jsx("button",{type:"button",className:"consensus"===N?j.tabActive:j.tab,onClick:()=>k("consensus"),"aria-pressed":"consensus"===N,children:"Consensus"})]}),"discover"===N&&o.jsxs(o.Fragment,{children:[o.jsxs("p",{className:j.subtitle,style:{marginTop:"0.5rem"},children:["Posts from the ATmosphere using ",o.jsx("a",{href:"https://standard.site",target:"_blank",rel:"noopener noreferrer",className:j.standardLink,children:"standard.site"})]}),o.jsxs("div",{className:j.tabs,children:[o.jsx("button",{type:"button",className:"all"===C?j.tabActive:j.tab,onClick:()=>w("all"),"aria-pressed":"all"===C,children:"All Posts"}),o.jsx("button",{type:"button",className:"followed"===C?j.tabActive:j.tab,onClick:()=>w("followed"),"aria-pressed":"followed"===C,children:"Followed"}),o.jsx("button",{type:"button",className:"mine"===C?j.tabActive:j.tab,onClick:()=>w("mine"),"aria-pressed":"mine"===C,children:"My Posts"})]})]}),("discover"===N||"artsky"===N)&&o.jsx("div",{className:j.searchRow,children:o.jsx("input",{type:"search",className:j.searchInput,placeholder:"Search posts…",value:T,onChange:e=>$(e.target.value),"aria-label":"Search posts"})})]}),"collab"===N&&o.jsx(b,{}),"consensus"===N&&o.jsx(x,{}),"discover"===N&&o.jsxs(o.Fragment,{children:[M&&o.jsx("p",{className:j.error,children:M}),J?o.jsxs("div",{className:j.empty,children:["Log in to see ","followed"===C?"posts from people you follow":"your posts","."]}):P?o.jsx("div",{className:j.loading,children:"all"===C?"Loading discovered posts…":"followed"===C?"Loading followed posts…":"Loading your posts…"}):0===X.length?o.jsx("div",{className:j.empty,children:0===L.length?"all"===C?"No standard.site posts discovered yet. Add more publication URLs in forum discovery config.":"followed"===C?"No posts yet from people you follow.":"You haven't posted in the forums yet.":"No posts match your search."}):o.jsx("ul",{ref:K,className:j.list,children:X.map((e,s)=>{const t=e.authorHandle??e.did,a=function(e){if(!e.baseUrl)return null;const s=e.baseUrl.replace(/\/$/,""),t=(e.path??"").replace(/^\//,"");return t?`${s}/${t}`:s}(e),l=e.createdAt,i=e.title||e.path||"Untitled",n=o.jsxs("div",{className:y.postHead,children:[e.authorAvatar?o.jsx("img",{src:e.authorAvatar,alt:"",className:y.avatar,loading:"lazy"}):o.jsx("span",{className:j.avatarPlaceholder,"aria-hidden":!0,children:(t||e.did).slice(0,1).toUpperCase()}),o.jsxs("div",{className:y.authorRow,children:[o.jsxs(f,{handle:t,className:y.handleLink,onClick:e=>e.stopPropagation(),children:["@",t]}),l&&o.jsx("span",{className:y.postTimestamp,title:p(l),children:u(l)})]})]}),c=s===U;return o.jsx("li",{"data-forum-index":s,children:o.jsx(r,{to:"#",className:c?`${j.postLink} ${j.postLinkFocused}`:j.postLink,onClick:s=>{s.preventDefault(),q(e.uri)},children:o.jsx("article",{className:y.postBlock,children:o.jsxs("div",{className:y.postBlockContent,children:[n,o.jsx("p",{className:y.postText,children:i}),v(e.body)&&o.jsx("p",{className:j.bodyPreview,children:v(e.body)}),!a&&o.jsx("p",{className:j.noUrl,children:"No publication URL"})]})})})},e.uri)})})]}),"artsky"===N&&o.jsxs(o.Fragment,{children:[W?.did&&o.jsx("button",{type:"button",className:j.tab,style:{marginBottom:"0.75rem"},onClick:()=>H(!D),children:"+ New Post"}),D&&W?.did&&o.jsxs("div",{style:{padding:"1rem",marginBottom:"1rem",background:"var(--surface)",borderRadius:"0.5rem",border:"1px solid var(--border)"},children:[o.jsx("input",{type:"text",placeholder:"Post title",value:I.title,onChange:e=>z(s=>({...s,title:e.target.value})),style:{width:"100%",marginBottom:"0.5rem",padding:"0.5rem"}}),o.jsx("textarea",{placeholder:"Write your post… Use @username for mentions",value:I.body,onChange:e=>z(s=>({...s,body:e.target.value})),style:{width:"100%",minHeight:120,marginBottom:"0.5rem",padding:"0.5rem"}}),o.jsx("input",{type:"text",placeholder:"Tags (comma-separated)",value:I.tags,onChange:e=>z(s=>({...s,tags:e.target.value})),style:{width:"100%",marginBottom:"0.5rem",padding:"0.5rem"}}),o.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[o.jsx("button",{type:"button",className:j.tabActive,onClick:async function(){if(I.title.trim())try{await d({title:I.title,body:I.body,tags:I.tags.split(",").map(e=>e.trim()).filter(Boolean)}),z({title:"",body:"",tags:""}),H(!1),V()}catch(e){alert(e instanceof Error?e.message:"Failed to create post")}},children:"Post"}),o.jsx("button",{type:"button",className:j.tab,onClick:function(){m({title:I.title,body:I.body,tags:I.tags.split(",").map(e=>e.trim()).filter(Boolean)}),H(!1)},children:"Save Draft"}),o.jsx("button",{type:"button",className:j.tab,onClick:()=>H(!1),children:"Cancel"})]})]}),W?P?o.jsx("div",{className:j.loading,children:"Loading posts…"}):0===Y.length?o.jsx("div",{className:j.empty,children:"No forum posts yet. Be the first to start a discussion!"}):o.jsx("ul",{ref:K,className:j.list,children:Y.map((e,s)=>{const t=s===_;return o.jsx("li",{"data-forum-index":s,children:o.jsx(r,{to:"#",className:t?`${j.postLink} ${j.postLinkFocused}`:j.postLink,onClick:s=>{s.preventDefault(),q(e.uri)},children:o.jsx("article",{className:y.postBlock,children:o.jsxs("div",{className:y.postBlockContent,children:[o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.25rem"},children:[e.isPinned&&o.jsx("span",{className:j.commentBadge,children:"Pinned"}),e.isWiki&&o.jsx("span",{className:j.commentBadge,children:"Wiki"}),o.jsx("h3",{style:{fontSize:"1rem",fontWeight:600,margin:0},children:e.title||"Untitled"})]}),e.body&&o.jsxs("p",{className:j.bodyPreview,children:[e.body.slice(0,120),e.body.length>120?"…":""]}),o.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginTop:"0.25rem",fontSize:"0.85rem",color:"var(--muted)"},children:[e.authorHandle&&o.jsxs("span",{children:["@",e.authorHandle]}),e.createdAt&&o.jsx("span",{children:new Date(e.createdAt).toLocaleDateString()}),e.tags?.map(e=>o.jsxs("span",{className:j.commentBadge,style:{fontSize:"0.7rem"},children:["#",e]},e))]})]})})})},`${e.uri}-${s}`)})}):o.jsx("div",{className:j.empty,children:"Log in to create and view ArtSky forum posts."})]})]})}function k({onClose:e,onBack:s,canGoBack:t}){const[a,r]=l.useState(null);return o.jsxs(i,{ariaLabel:"Forums",onClose:e,onBack:s,canGoBack:t,onPullToRefresh:a?()=>a():void 0,children:[o.jsx("div",{className:n.modalBetaAlert,role:"status",children:"BETA"}),o.jsx(N,{inModal:!0,onRegisterRefresh:e=>r(()=>e)})]})}export{k as default};
